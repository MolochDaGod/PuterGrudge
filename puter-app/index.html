<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grudge AI Cloud</title>
  <!-- Error suppression BEFORE Puter SDK -->
  <script>
    (function(){
      const suppress = msg => msg && (
        msg.includes('appInstance') || msg.includes('postMessage') ||
        msg.includes('Unexpected token') || msg.includes('readdir') ||
        (msg.includes('puter') && msg.includes('undefined'))
      );
      window.addEventListener('error', e => { if (suppress(e.message)) { e.preventDefault(); return true; } }, true);
      window.addEventListener('unhandledrejection', e => {
        if (suppress(e.reason?.message || String(e.reason))) e.preventDefault();
      }, true);
    })();
  </script>
  <script src="https://js.puter.com/v2/"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%); color: #e0e0e0; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #333; margin-bottom: 30px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #00f5ff, #8b5cf6); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    h1 { font-size: 24px; background: linear-gradient(90deg, #00f5ff, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .user-info { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: #8b5cf6; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #00f5ff, #8b5cf6); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,245,255,0.3); }
    .btn-secondary { background: #333; color: white; border: 1px solid #444; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .card { background: rgba(20,20,40,0.8); border: 1px solid #333; border-radius: 16px; padding: 24px; }
    .card h2 { font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .card h2 span { font-size: 24px; }
    .stat { font-size: 32px; font-weight: 700; color: #00f5ff; }
    .stat-label { font-size: 14px; color: #888; margin-top: 4px; }
    .chat-container { background: rgba(20,20,40,0.8); border: 1px solid #333; border-radius: 16px; overflow: hidden; }
    .chat-header { padding: 16px 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .chat-messages { height: 400px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
    .message { max-width: 80%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; }
    .message.user { background: #8b5cf6; align-self: flex-end; }
    .message.ai { background: #1a2234; border: 1px solid #333; align-self: flex-start; }
    .message pre { background: #0a0a1a; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; font-size: 13px; }
    .chat-input { display: flex; gap: 12px; padding: 16px 20px; border-top: 1px solid #333; }
    .chat-input input { flex: 1; padding: 12px 16px; background: #1a2234; border: 1px solid #333; border-radius: 8px; color: white; font-size: 14px; }
    .chat-input input:focus { outline: none; border-color: #00f5ff; }
    .model-select { padding: 8px 12px; background: #1a2234; border: 1px solid #333; border-radius: 8px; color: white; font-size: 13px; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-dot.online { background: #00ff88; }
    .status-dot.offline { background: #ff4444; }
    .quick-actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }
    .quick-btn { padding: 8px 16px; background: rgba(0,245,255,0.1); border: 1px solid rgba(0,245,255,0.3); border-radius: 20px; color: #00f5ff; font-size: 13px; cursor: pointer; }
    .quick-btn:hover { background: rgba(0,245,255,0.2); }
    #loading { position: fixed; inset: 0; background: #0a0a1a; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
    .spinner { width: 48px; height: 48px; border: 4px solid #333; border-top-color: #00f5ff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loading"><div class="spinner"></div><p style="margin-top:20px;color:#888">Connecting to Puter...</p></div>
  
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">‚òÅÔ∏è</div>
        <div><h1>Grudge AI Cloud</h1><div class="status"><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting...</span></div></div>
      </div>
      <div class="user-info">
        <div class="avatar" id="userAvatar">?</div>
        <span id="userName">Guest</span>
        <button class="btn btn-primary" id="authBtn" onclick="handleAuth()">Sign In</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h2><span>üß†</span> AI Models</h2>
        <div class="stat" id="modelCount">4</div>
        <div class="stat-label">FREE AI Models Available</div>
        <div class="quick-actions">
          <span class="quick-btn" onclick="askAI('GPT-4o')">GPT-4o</span>
          <span class="quick-btn" onclick="askAI('Claude')">Claude 3.5</span>
          <span class="quick-btn" onclick="askAI('Gemini')">Gemini</span>
          <span class="quick-btn" onclick="askAI('DeepSeek')">DeepSeek</span>
        </div>
      </div>
      <div class="card">
        <h2><span>üíæ</span> Cloud Storage</h2>
        <div class="stat" id="fileCount">--</div>
        <div class="stat-label">Files in your cloud</div>
        <div class="quick-actions">
          <span class="quick-btn" onclick="listFiles()">üìÇ Browse Files</span>
          <span class="quick-btn" onclick="uploadFile()">üì§ Upload</span>
        </div>
      </div>
      <div class="card">
        <h2><span>üöÄ</span> Deployments</h2>
        <div class="stat" id="deployCount">--</div>
        <div class="stat-label">Active sites on puter.site</div>
        <div class="quick-actions">
          <span class="quick-btn" onclick="listSites()">üåê View Sites</span>
          <span class="quick-btn" onclick="deploySite()">üöÄ Deploy New</span>
        </div>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <h2 style="margin:0;font-size:16px;display:flex;align-items:center;gap:8px"><span>üí¨</span> AI Assistant</h2>
        <select class="model-select" id="modelSelect">
          <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
          <option value="gpt-4o">GPT-4o</option>
          <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
          <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
          <option value="deepseek-chat">DeepSeek</option>
        </select>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message ai">üëã Welcome to Grudge AI Cloud! I'm your AI assistant with access to GPT-4o, Claude, Gemini, and more - all FREE through Puter. How can I help you today?</div>
      </div>
      <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Ask anything... (AI, coding, storage, deployments)" onkeypress="if(event.key==='Enter')sendMessage()">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script>
    let user = null;
    let puterReady = false;
    const $ = id => document.getElementById(id);

    // Wait for Puter SDK
    async function waitForPuter(timeout = 5000) {
      const start = Date.now();
      while (typeof puter === 'undefined' && Date.now() - start < timeout) {
        await new Promise(r => setTimeout(r, 100));
      }
      return typeof puter !== 'undefined';
    }

    async function init() {
      try {
        puterReady = await waitForPuter();
        if (!puterReady) {
          console.log('[GrudgeAI] Puter SDK not available');
          $('statusText').textContent = 'Offline Mode';
          $('loading').style.display = 'none';
          return;
        }

        // Try to get current user (don't force sign-in)
        try {
          user = await Promise.race([
            puter.auth.getUser(),
            new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 3000))
          ]);
          if (user && user.username?.startsWith('anon')) user = null;
        } catch { user = null; }

        updateUI();
        await loadStats();
      } catch (e) { console.error('Init error:', e); }
      $('loading').style.display = 'none';
    }

    function updateUI() {
      const isAuth = user && !user.username?.startsWith('anon');
      $('statusDot').className = 'status-dot ' + (isAuth ? 'online' : 'offline');
      $('statusText').textContent = isAuth ? 'Connected' : 'Guest Mode';
      $('userName').textContent = isAuth ? user.username : 'Guest';
      $('userAvatar').textContent = isAuth ? user.username[0].toUpperCase() : '?';
      $('authBtn').textContent = isAuth ? 'Sign Out' : 'Sign In';
    }

    async function handleAuth() {
      if (!puterReady) {
        alert('Puter not available. Please visit puter.com');
        return;
      }

      const btn = $('authBtn');
      btn.disabled = true;
      btn.textContent = 'Working...';

      try {
        if (user && !user.username?.startsWith('anon')) {
          // Sign out
          try { await puter.auth.signOut(); } catch {}
          user = null;
        } else {
          // Sign in
          try {
            await puter.auth.signIn();
            user = await puter.auth.getUser();
            if (user?.username?.startsWith('anon')) {
              user = null;
              alert('Sign-in was cancelled');
            }
          } catch (e) {
            const msg = e.message || String(e);
            if (msg.includes('cancel') || msg.includes('closed')) {
              alert('Sign-in cancelled');
            } else if (msg.includes('popup') || msg.includes('blocked')) {
              alert('Popup blocked! Please allow popups for this site.');
            } else {
              alert('Sign-in error: ' + msg);
            }
            user = null;
          }
        }
      } finally {
        btn.disabled = false;
        updateUI();
        loadStats();
      }
    }

    async function loadStats() {
      if (!puterReady) return;
      try {
        const files = await puter.fs.readdir('/').catch(() => []);
        $('fileCount').textContent = Array.isArray(files) ? files.length : 0;
      } catch { $('fileCount').textContent = '--'; }
      try {
        const sites = await puter.hosting.list().catch(() => []);
        $('deployCount').textContent = Array.isArray(sites) ? sites.length : 0;
      } catch { $('deployCount').textContent = '--'; }
    }

    async function sendMessage() {
      if (!puterReady || !puter.ai) {
        alert('Please sign in to Puter to use AI features');
        return;
      }

      const input = $('chatInput');
      const msg = input.value.trim();
      if (!msg) return;

      const msgs = $('chatMessages');
      msgs.innerHTML += `<div class="message user">${escapeHtml(msg)}</div>`;
      input.value = '';
      msgs.scrollTop = msgs.scrollHeight;

      const model = $('modelSelect').value;
      msgs.innerHTML += `<div class="message ai" id="typing">Thinking...</div>`;

      try {
        const response = await puter.ai.chat(msg, { model });
        const text = typeof response === 'string' ? response : response?.message?.content || String(response);
        $('typing').outerHTML = `<div class="message ai">${formatResponse(text)}</div>`;
      } catch (e) {
        $('typing').outerHTML = `<div class="message ai" style="color:#ff6666">Error: ${e.message || 'AI request failed'}</div>`;
      }
      msgs.scrollTop = msgs.scrollHeight;
    }

    function escapeHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function formatResponse(t) {
      return escapeHtml(t).replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre>$2</pre>').replace(/`([^`]+)`/g, '<code style="background:#1a2234;padding:2px 6px;border-radius:4px">$1</code>').replace(/\n/g, '<br>');
    }

    function askAI(model) { $('chatInput').value = `Tell me about ${model} capabilities`; sendMessage(); }
    async function listFiles() { $('chatInput').value = 'Show me my cloud files'; sendMessage(); }
    async function listSites() { $('chatInput').value = 'List my deployed sites'; sendMessage(); }
    function uploadFile() { alert('Use puter.fs.write() to upload files programmatically'); }
    function deploySite() { $('chatInput').value = 'How do I deploy a website to puter.site?'; sendMessage(); }

    init();
  </script>
</body>
</html>

