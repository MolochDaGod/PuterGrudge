<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CloudPilot AI - Autonomous Cloud Agent</title>
  <meta name="description" content="Autonomous AI cloud agent powered by Puter. Deploy apps, manage storage, run serverless functions with intelligent AI assistance.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    // Suppress ALL Puter SDK errors before it loads
    window.addEventListener('error', e => {
      if (e.message?.includes('puter') || e.filename?.includes('puter') || e.message?.includes('appInstanceID')) {
        e.preventDefault(); e.stopPropagation(); return true;
      }
    }, true);
    window.addEventListener('unhandledrejection', e => {
      const msg = e.reason?.message || String(e.reason) || '';
      if (msg.includes('puter') || msg.includes('appInstance') || msg.includes('postMessage') || msg.includes('Unexpected token')) {
        e.preventDefault(); e.stopPropagation();
      }
    }, true);
  </script>
  <script src="https://js.puter.com/v2/"></script>
  <script>
    // GrudgeOS Puter Service - Works standalone without app registration
    window.PuterBoot = {
      ready: false,
      user: null,
      offline: false,

      async init() {
        // Check if we're in Puter iframe or standalone
        const inPuter = window.parent !== window && location.hostname.includes('puter');

        if (typeof puter === 'undefined') {
          console.log('[Puter] SDK not available - offline mode');
          this.offline = true;
          this.ready = true;
          return { offline: true };
        }

        try {
          // For standalone apps, just try to get user without other operations
          this.user = await puter.auth.getUser().catch(() => null);

          // Check if it's a real user (not anonymous/guest)
          if (this.user && this.user.username && !this.user.username.startsWith('anon')) {
            console.log('[Puter] Authenticated:', this.user.username);
          } else {
            this.user = null;
            console.log('[Puter] Guest mode - sign in for full features');
          }
        } catch (e) {
          console.log('[Puter] Auth check skipped:', e.message);
          this.user = null;
        }

        this.ready = true;
        this.offline = false;
        return { user: this.user, ready: true };
      },

      async signIn() {
        if (typeof puter === 'undefined') return { error: 'Puter not available' };
        try {
          await puter.auth.signIn();
          this.user = await puter.auth.getUser();
          return { user: this.user };
        } catch (e) {
          return { error: e.message || 'Sign in cancelled' };
        }
      },

      async signOut() {
        try { if (puter?.auth) await puter.auth.signOut(); } catch {}
        this.user = null;
      },

      // KV with localStorage fallback (works without app instance)
      async kvGet(key, defaultValue = null) {
        const localKey = 'grudge_' + key;
        // Try localStorage first (always available)
        try {
          const local = localStorage.getItem(localKey);
          if (local) return JSON.parse(local);
        } catch {}
        // Try Puter KV if available
        if (puter?.kv) {
          try {
            const val = await puter.kv.get(key);
            if (val != null) {
              const parsed = typeof val === 'string' ? JSON.parse(val) : val;
              localStorage.setItem(localKey, JSON.stringify(parsed)); // Cache locally
              return parsed;
            }
          } catch {}
        }
        return defaultValue;
      },

      async kvSet(key, value) {
        const localKey = 'grudge_' + key;
        const serialized = JSON.stringify(value);
        // Always save to localStorage
        try { localStorage.setItem(localKey, serialized); } catch {}
        // Try Puter KV
        if (puter?.kv) {
          try { await puter.kv.set(key, serialized); } catch {}
        }
        return true;
      },

      async kvDel(key) {
        try { localStorage.removeItem('grudge_' + key); } catch {}
        if (puter?.kv) try { await puter.kv.del(key); } catch {}
      },

      // AI chat (requires Puter)
      async chat(prompt, opts = {}) {
        if (!puter?.ai) return '[Offline] Sign in to Puter for AI features';
        try {
          const model = opts.model || 'gpt-4o-mini';
          const msgs = Array.isArray(prompt) ? prompt : [{ role: 'user', content: prompt }];
          if (opts.system) msgs.unshift({ role: 'system', content: opts.system });
          const res = await puter.ai.chat(msgs, { model });
          return typeof res === 'string' ? res : res?.message?.content || res?.content || String(res);
        } catch (e) {
          return `[Error] ${e.message}`;
        }
      },

      // FS operations with error handling
      async readDir(path = '/') {
        if (!puter?.fs) return [];
        try { return await puter.fs.readdir(path); } catch { return []; }
      },

      async writeFile(path, content) {
        if (!puter?.fs) return false;
        try { await puter.fs.write(path, content, { createMissingParents: true }); return true; } catch { return false; }
      },

      async readFile(path) {
        if (!puter?.fs) return null;
        try { return await puter.fs.read(path); } catch { return null; }
      }
    };

    // Initialize immediately
    PuterBoot.init().then(() => console.log('[Puter] Ready'));
  </script>
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #111827;
      --bg-card: #1a2234;
      --bg-card-hover: #222d44;
      --bg-elevated: #243049;
      --border-color: #2a3548;
      --border-focus: #3b82f6;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --text-muted: #6b7280;
      --accent-blue: #3b82f6;
      --accent-blue-hover: #60a5fa;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --accent-yellow: #f59e0b;
      --accent-purple: #8b5cf6;
      --accent-cyan: #06b6d4;
      --accent-pink: #ec4899;
      --accent-orange: #f97316;
      --shadow-lg: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #3a4558; }

    .app-container { display: flex; min-height: 100vh; }

    /* Sidebar - Responsive with Accordion */
    .sidebar {
      width: clamp(220px, 20vw, 300px);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .sidebar-header { padding: clamp(14px, 2vw, 20px); border-bottom: 1px solid var(--border-color); }
    .logo { display: flex; align-items: center; gap: clamp(8px, 1.5vw, 12px); }
    .logo-icon { width: clamp(32px, 4vw, 44px); height: clamp(32px, 4vw, 44px); background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: clamp(16px, 2vw, 22px); }
    .logo-text { font-weight: 700; font-size: clamp(14px, 1.5vw, 18px); letter-spacing: -0.5px; }
    .logo-text span { color: var(--accent-cyan); }

    .sidebar-nav { padding: clamp(8px, 1vw, 12px) clamp(6px, 1vw, 10px); flex: 1; overflow-y: auto; }
    
    /* Accordion Section Styles */
    .nav-accordion { margin-bottom: 4px; }
    .nav-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: clamp(10px, 1.2vw, 14px) clamp(10px, 1.5vw, 14px);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }
    .nav-accordion-header:hover { background: var(--bg-card-hover); border-color: var(--accent-blue); }
    .nav-accordion-header.open {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(6, 182, 212, 0.1));
      border-color: var(--accent-blue);
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    .nav-accordion-title {
      display: flex;
      align-items: center;
      gap: clamp(8px, 1vw, 12px);
      font-size: clamp(12px, 1.3vw, 15px);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-primary);
    }
    .nav-accordion-title .section-icon { font-size: clamp(14px, 1.5vw, 18px); }
    .nav-accordion-arrow {
      font-size: clamp(10px, 1.2vw, 14px);
      color: var(--text-muted);
      transition: transform 0.3s ease;
    }
    .nav-accordion-header.open .nav-accordion-arrow { transform: rotate(180deg); color: var(--accent-cyan); }
    
    .nav-accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
    }
    .nav-accordion-content.open {
      max-height: 400px;
      padding: clamp(6px, 0.8vw, 10px);
    }
    
    .nav-section-title { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); padding: 12px 12px 6px; margin-top: 4px; display: none; }
    .nav-item {
      display: flex;
      align-items: center; 
      gap: clamp(8px, 1vw, 12px);
      padding: clamp(10px, 1.2vw, 13px) clamp(10px, 1.2vw, 14px);
      border-radius: var(--radius-sm);
      cursor: pointer; 
      transition: all 0.15s ease; 
      font-size: clamp(13px, 1.4vw, 15px); 
      font-weight: 500; 
      color: var(--text-secondary); 
      margin-bottom: 3px; 
    }
    .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-blue); color: white; }
    .nav-icon { font-size: clamp(16px, 1.6vw, 20px); width: clamp(20px, 2vw, 26px); text-align: center; }
    .nav-badge { margin-left: auto; background: var(--accent-green); color: white; font-size: clamp(8px, 0.9vw, 10px); padding: 3px 8px; border-radius: 12px; font-weight: 600; }

    .sidebar-footer { padding: clamp(12px, 1.5vw, 18px); border-top: 1px solid var(--border-color); }
    .user-card { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-card); border-radius: var(--radius-sm); cursor: pointer; transition: background 0.15s; }
    .user-card:hover { background: var(--bg-card-hover); }
    .user-avatar { width: 34px; height: 34px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-status { font-size: 11px; color: var(--accent-green); display: flex; align-items: center; gap: 4px; }
    .user-status::before { content: ''; width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; }

    .login-btn { width: 100%; padding: 12px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); border: none; border-radius: var(--radius-sm); color: white; font-size: 13px; font-weight: 600; cursor: pointer; transition: opacity 0.15s; }
    .login-btn:hover { opacity: 0.9; }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }

    .header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background: var(--bg-secondary); gap: 16px; flex-wrap: wrap; }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-title { font-size: 20px; font-weight: 600; letter-spacing: -0.5px; }
    .header-subtitle { font-size: 13px; color: var(--text-muted); }
    .header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: var(--radius-sm); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s ease; border: none; font-family: inherit; white-space: nowrap; }
    .btn-primary { background: var(--accent-blue); color: white; }
    .btn-primary:hover { background: var(--accent-blue-hover); }
    .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: var(--bg-card-hover); }
    .btn-success { background: var(--accent-green); color: white; }
    .btn-success:hover { background: #0ea572; }
    .btn-danger { background: var(--accent-red); color: white; }
    .btn-icon { padding: 10px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-gradient { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; }
    .btn-gradient:hover { opacity: 0.9; }

    .view-container { flex: 1; overflow: auto; padding: 24px; }
    .view { display: none; }
    .view.active { display: block; }

    /* Panels */
    .panel { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); overflow: hidden; margin-bottom: 20px; }
    .panel-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border-color); gap: 12px; flex-wrap: wrap; }
    .panel-title { font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .panel-content { padding: 20px; }
    .panel-content.no-padding { padding: 0; }

    /* Dashboard Grid */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }

    .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 20px; }
    .stat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .stat-icon { width: 44px; height: 44px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .stat-icon.blue { background: rgba(59, 130, 246, 0.15); }
    .stat-icon.green { background: rgba(16, 185, 129, 0.15); }
    .stat-icon.purple { background: rgba(139, 92, 246, 0.15); }
    .stat-icon.cyan { background: rgba(6, 182, 212, 0.15); }
    .stat-value { font-size: 28px; font-weight: 700; letter-spacing: -1px; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: var(--text-secondary); }

    /* Quick Actions */
    .quick-actions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; }
    .quick-action-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 18px; cursor: pointer; transition: all 0.2s ease; text-align: center; }
    .quick-action-card:hover { border-color: var(--accent-blue); transform: translateY(-2px); box-shadow: 0 8px 30px -10px rgba(59, 130, 246, 0.3); }
    .quick-action-icon { width: 50px; height: 50px; margin: 0 auto 12px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .quick-action-title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .quick-action-desc { font-size: 11px; color: var(--text-muted); }

    /* File Explorer */
    .file-explorer { display: flex; flex-direction: column; height: 400px; }
    .file-toolbar { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
    .breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); flex: 1; min-width: 0; overflow: hidden; }
    .breadcrumb-item { cursor: pointer; white-space: nowrap; }
    .breadcrumb-item:hover { color: var(--accent-blue); }
    .breadcrumb-sep { color: var(--text-muted); }
    .file-list { flex: 1; overflow: auto; }
    .file-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.1s; }
    .file-item:hover { background: var(--bg-secondary); }
    .file-item.selected { background: rgba(59, 130, 246, 0.15); }
    .file-icon { font-size: 20px; width: 24px; text-align: center; }
    .file-name { flex: 1; font-size: 14px; font-weight: 500; }
    .file-meta { font-size: 12px; color: var(--text-muted); display: flex; gap: 16px; }

    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center; }
    .empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .empty-state-desc { font-size: 13px; color: var(--text-muted); max-width: 300px; }

    /* Forms */
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px; color: var(--text-secondary); }
    .form-input { width: 100%; padding: 12px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 14px; font-family: inherit; transition: border-color 0.15s; }
    .form-input:focus { outline: none; border-color: var(--accent-blue); }
    .form-input::placeholder { color: var(--text-muted); }
    .form-textarea { min-height: 120px; resize: vertical; font-family: var(--font-mono); font-size: 13px; }

    /* Code Editor */
    .code-editor-container { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); overflow: hidden; }
    .code-editor-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
    .code-editor-title { font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
    .code-editor { width: 100%; min-height: 250px; padding: 16px; background: transparent; border: none; color: var(--text-primary); font-family: var(--font-mono); font-size: 13px; line-height: 1.6; resize: vertical; }
    .code-editor:focus { outline: none; }

    /* AI Chat */
    .ai-chat-container { display: flex; flex-direction: column; height: calc(100vh - 180px); min-height: 500px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
    .chat-message { display: flex; gap: 12px; max-width: 85%; }
    .chat-message.user { flex-direction: row-reverse; align-self: flex-end; }
    .chat-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 16px; }
    .chat-message.ai .chat-avatar { background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); }
    .chat-message.user .chat-avatar { background: var(--accent-purple); }
    .chat-message.system .chat-avatar { background: var(--accent-orange); }
    .chat-message.agent .chat-avatar { background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan)); }
    .chat-bubble { padding: 14px 18px; border-radius: var(--radius); font-size: 14px; line-height: 1.6; }
    .chat-message.ai .chat-bubble { background: var(--bg-secondary); border: 1px solid var(--border-color); }
    .chat-message.user .chat-bubble { background: var(--accent-blue); color: white; }
    .chat-message.system .chat-bubble { background: rgba(249, 115, 22, 0.15); border: 1px solid var(--accent-orange); }
    .chat-message.agent .chat-bubble { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-green); }
    .chat-bubble code { background: var(--bg-card); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono); font-size: 12px; }
    .chat-bubble pre { background: var(--bg-primary); padding: 14px; border-radius: var(--radius-sm); overflow-x: auto; margin: 10px 0; font-family: var(--font-mono); font-size: 12px; border: 1px solid var(--border-color); }
    .chat-action-buttons { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .chat-action-btn { padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; font-size: 12px; color: var(--text-primary); cursor: pointer; transition: all 0.15s; }
    .chat-action-btn:hover { background: var(--accent-blue); border-color: var(--accent-blue); }

    .chat-input-area { padding: 16px 20px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); }
    .chat-input-wrapper { display: flex; gap: 12px; align-items: flex-end; }
    .chat-input { flex: 1; padding: 14px 16px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-family: inherit; font-size: 14px; resize: none; min-height: 48px; max-height: 150px; }
    .chat-input:focus { outline: none; border-color: var(--accent-blue); }
    .chat-input::placeholder { color: var(--text-muted); }
    .send-btn { width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); border: none; border-radius: var(--radius-sm); color: white; font-size: 18px; cursor: pointer; transition: opacity 0.15s; }
    .send-btn:hover { opacity: 0.9; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .prompt-suggestions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    .prompt-chip { padding: 8px 14px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px; font-size: 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.15s; }
    .prompt-chip:hover { background: var(--bg-card-hover); color: var(--text-primary); border-color: var(--accent-blue); }

    /* Agent Status */
    .agent-status { display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 12px; }
    .agent-status.running { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-green); }
    .agent-status.thinking { background: rgba(59, 130, 246, 0.1); border: 1px solid var(--accent-blue); }
    .agent-status.idle { background: var(--bg-secondary); border: 1px solid var(--border-color); }
    .agent-status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 1.5s infinite; }
    .agent-status.running .agent-status-dot { background: var(--accent-green); }
    .agent-status.thinking .agent-status-dot { background: var(--accent-blue); }
    .agent-status.idle .agent-status-dot { background: var(--text-muted); animation: none; }
    .agent-status-text { font-size: 13px; font-weight: 500; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Typing indicator */
    .typing-indicator { display: flex; gap: 4px; padding: 14px 18px; }
    .typing-dot { width: 8px; height: 8px; background: var(--text-muted); border-radius: 50%; animation: typing 1.4s infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-4px); opacity: 1; } }

    /* Agent Steps */
    .agent-steps { margin-top: 12px; }
    .agent-step { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-color); }
    .agent-step:last-child { border-bottom: none; }
    .step-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
    .step-icon.thought { background: rgba(139, 92, 246, 0.2); }
    .step-icon.action { background: rgba(59, 130, 246, 0.2); }
    .step-icon.result { background: rgba(16, 185, 129, 0.2); }
    .step-content { flex: 1; }
    .step-label { font-size: 10px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 2px; }
    .step-text { font-size: 13px; color: var(--text-secondary); }

    /* Toast notifications */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 1001; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 14px 20px; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease; max-width: 380px; }
    .toast.success { border-left: 4px solid var(--accent-green); }
    .toast.error { border-left: 4px solid var(--accent-red); }
    .toast.info { border-left: 4px solid var(--accent-blue); }
    .toast.warning { border-left: 4px solid var(--accent-yellow); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s ease; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius); width: 90%; max-width: 500px; max-height: 80vh; overflow: auto; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border-color); }
    .modal-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
    .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px; }

    /* Model selector */
    .model-selector { display: flex; align-items: center; gap: 8px; }
    .model-selector select { padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 12px; cursor: pointer; }
    .model-selector select:focus { outline: none; border-color: var(--accent-blue); }

    /* Mobile Sidebar Toggle */
    .mobile-header { display: none; background: var(--bg-secondary); padding: 12px 16px; border-bottom: 1px solid var(--border-color); align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .mobile-menu-btn { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 10px 14px; color: var(--text-primary); font-size: 18px; cursor: pointer; }
    .mobile-menu-btn:hover { background: var(--bg-card-hover); }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 999; opacity: 0; transition: opacity 0.3s; }
    .sidebar-overlay.active { display: block; opacity: 1; }
    .mobile-close-btn { display: none; position: absolute; top: 12px; right: 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 50%; width: 36px; height: 36px; font-size: 18px; color: var(--text-primary); cursor: pointer; }
    
    /* Responsive - Tablet */
    @media (max-width: 1024px) {
      .sidebar { width: clamp(200px, 25vw, 260px); }
      .nav-item { padding: 10px 12px; font-size: 13px; }
      .nav-accordion-header { padding: 10px 12px; }
      .nav-accordion-title { font-size: 12px; }
    }

    /* Responsive - Mobile */
    @media (max-width: 768px) {
      .mobile-header { display: flex; }
      .sidebar { 
        position: fixed; 
        left: -100%; 
        top: 0; 
        bottom: 0; 
        width: 85vw; 
        max-width: 320px; 
        z-index: 1000; 
        transition: left 0.3s ease;
        box-shadow: 4px 0 30px rgba(0,0,0,0.5);
      }
      .sidebar.open { left: 0; }
      .mobile-close-btn { display: flex; align-items: center; justify-content: center; }
      .view-container { padding: 16px; }
      .ai-chat-container { height: calc(100vh - 160px); }
      .nav-accordion-header { padding: 14px 16px; }
      .nav-accordion-title { font-size: 14px; }
      .nav-item { padding: 14px 16px; font-size: 15px; }
      .nav-icon { font-size: 20px; }
      .nav-badge { font-size: 10px; padding: 4px 10px; }
    }

    /* Responsive - Small phones */
    @media (max-width: 480px) {
      .sidebar { width: 100vw; max-width: 100%; }
      .view-container { padding: 12px; }
      .header { padding: 12px 16px; }
      .header-title { font-size: 18px; }
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* Device-aware adaptations using body classes */
    body.is-touch .nav-item { padding: 14px 16px; min-height: 48px; }
    body.is-touch .nav-accordion-header { padding: 14px 16px; min-height: 48px; }
    body.is-touch .btn { min-height: 44px; padding: 12px 18px; }
    body.is-touch .quick-action-card { padding: 20px; }
    body.is-mobile .header-actions { gap: 6px; }
    body.is-mobile .btn { font-size: 12px; padding: 8px 12px; }
    body.is-tablet .sidebar { width: 240px; }
    body.is-tablet .nav-accordion-title { font-size: 13px; }

    /* Grudge App Styles */
    .grudge-server-icon:hover { transform: scale(1.05); border-radius: 35% !important; }
    .grudge-server-icon.active { border-radius: 35% !important; }
    .grudge-channel:hover { background: var(--bg-secondary); }
    .grudge-member:hover { background: var(--bg-secondary); }
    .grudge-message:hover { background: rgba(255,255,255,0.02); }
    .launcher-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: var(--accent-blue); }

    .spinner { width: 20px; height: 20px; border: 2px solid var(--border-color); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Mobile Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  
  <div class="app-container">
    <!-- Mobile Header -->
    <div class="mobile-header">
      <button class="mobile-menu-btn" id="mobileMenuBtn" data-testid="btn-mobile-menu">‚ò∞</button>
      <div class="logo">
        <div class="logo-icon" style="width:32px;height:32px;font-size:16px;">üöÄ</div>
        <div class="logo-text" style="font-size:15px;">Cloud<span>Pilot</span></div>
      </div>
      <div style="width:40px;"></div>
    </div>
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">üöÄ</div>
          <div class="logo-text">Cloud<span>Pilot</span></div>
        </div>
      </div>
      <button class="mobile-close-btn" id="sidebarClose" data-testid="btn-sidebar-close">‚úï</button>
      <nav class="sidebar-nav">
        <!-- Overview - Always visible -->
        <div class="nav-item active" data-view="dashboard" data-testid="nav-dashboard">
          <span class="nav-icon">üìä</span>Dashboard
        </div>

        <!-- Cloud Services Accordion -->
        <div class="nav-accordion" data-accordion="cloud">
          <div class="nav-accordion-header" data-testid="accordion-cloud">
            <div class="nav-accordion-title">
              <span class="section-icon">‚òÅÔ∏è</span>
              <span>Cloud Services</span>
            </div>
            <span class="nav-accordion-arrow">‚ñº</span>
          </div>
          <div class="nav-accordion-content">
            <div class="nav-item" data-view="storage" data-testid="nav-storage">
              <span class="nav-icon">üìÅ</span>Storage
            </div>
            <div class="nav-item" data-view="apps" data-testid="nav-apps">
              <span class="nav-icon">üåê</span>Deploy Apps
            </div>
            <div class="nav-item" data-view="functions" data-testid="nav-functions">
              <span class="nav-icon">‚ö°</span>Functions
            </div>
            <div class="nav-item" data-view="network" data-testid="nav-network">
              <span class="nav-icon">üîå</span>Services & Access
              <span class="nav-badge" style="background: var(--accent-cyan);">Auto</span>
            </div>
          </div>
        </div>

        <!-- AI Studio Accordion -->
        <div class="nav-accordion" data-accordion="ai">
          <div class="nav-accordion-header" data-testid="accordion-ai">
            <div class="nav-accordion-title">
              <span class="section-icon">ü§ñ</span>
              <span>AI Studio</span>
            </div>
            <span class="nav-accordion-arrow">‚ñº</span>
          </div>
          <div class="nav-accordion-content">
            <div class="nav-item" data-view="studio" data-testid="nav-studio">
              <span class="nav-icon">üíª</span>Code Studio
              <span class="nav-badge" style="background: var(--accent-purple);">New</span>
            </div>
            <div class="nav-item" data-view="terminal" data-testid="nav-terminal">
              <span class="nav-icon">üñ•Ô∏è</span>Terminals
            </div>
            <div class="nav-item" data-view="memory" data-testid="nav-memory">
              <span class="nav-icon">üß†</span>AI Memory
              <span class="nav-badge" style="background: var(--accent-pink);">Learn</span>
            </div>
            <div class="nav-item" data-view="agent" data-testid="nav-agent">
              <span class="nav-icon">ü§ñ</span>AI Agent
              <span class="nav-badge">Auto</span>
            </div>
            <div class="nav-item" data-view="workflows" data-testid="nav-workflows">
              <span class="nav-icon">üîÑ</span>Workflows
            </div>
          </div>
        </div>

        <!-- Deployments Accordion -->
        <div class="nav-accordion" data-accordion="deploy">
          <div class="nav-accordion-header" data-testid="accordion-deploy">
            <div class="nav-accordion-title">
              <span class="section-icon">üöÄ</span>
              <span>Deployments</span>
            </div>
            <span class="nav-accordion-arrow">‚ñº</span>
          </div>
          <div class="nav-accordion-content">
            <div class="nav-item" data-view="deployments" data-testid="nav-deployments">
              <span class="nav-icon">üöÄ</span>Live Sites
            </div>
            <div class="nav-item" data-view="games" data-testid="nav-games">
              <span class="nav-icon">üéÆ</span>Game Hosting
            </div>
            <div class="nav-item" data-view="extensions" data-testid="nav-extensions">
              <span class="nav-icon">üß©</span>Extensions
            </div>
          </div>
        </div>

        <!-- GrudgeOS Accordion -->
        <div class="nav-accordion" data-accordion="grudge">
          <div class="nav-accordion-header" data-testid="accordion-grudge">
            <div class="nav-accordion-title">
              <span class="section-icon">üí¨</span>
              <span>GrudgeOS</span>
            </div>
            <span class="nav-accordion-arrow">‚ñº</span>
          </div>
          <div class="nav-accordion-content">
            <div class="nav-item" data-view="grudge" data-testid="nav-grudge">
              <span class="nav-icon">üí¨</span>Grudge App
              <span class="nav-badge" style="background: var(--accent-blue);">Live</span>
            </div>
            <div class="nav-item" onclick="window.open('/grudgeos', '_blank')" data-testid="nav-grudgeos">
              <span class="nav-icon">üéÆ</span>GrudgeOS
              <span class="nav-badge" style="background: var(--accent-purple);">Studio</span>
            </div>
            <div class="nav-item" data-view="canvas" data-testid="nav-canvas">
              <span class="nav-icon">üé®</span>Canvas Studio
              <span class="nav-badge" style="background: var(--accent-blue);">New</span>
            </div>
            <div class="nav-item" data-view="agent-hub" data-testid="nav-agent-hub">
              <span class="nav-icon">ü§ñ</span>Agent Hub
              <span class="nav-badge" style="background: var(--accent-purple);">AI</span>
            </div>
            <div class="nav-item" data-view="launcher" data-testid="nav-launcher">
              <span class="nav-icon">üöÄ</span>Launcher
              <span class="nav-badge" style="background: var(--accent-green);">Quick</span>
            </div>
          </div>
        </div>

        <!-- Tools Accordion -->
        <div class="nav-accordion" data-accordion="tools">
          <div class="nav-accordion-header" data-testid="accordion-tools">
            <div class="nav-accordion-title">
              <span class="section-icon">üõ†Ô∏è</span>
              <span>Tools</span>
            </div>
            <span class="nav-accordion-arrow">‚ñº</span>
          </div>
          <div class="nav-accordion-content">
            <div class="nav-item" data-view="playground" data-testid="nav-playground">
              <span class="nav-icon">üé®</span>Code Playground
              <span class="nav-badge" style="background: var(--accent-purple);">AI</span>
            </div>
            <div class="nav-item" data-view="converter" data-testid="nav-converter">
              <span class="nav-icon">üîÑ</span>File Converter
            </div>
          </div>
        </div>
      </nav>
      <div class="sidebar-footer">
        <div id="authContainer">
          <button class="login-btn" id="loginBtn">üîê Sign in with Puter</button>
        </div>
        <div id="userContainer" style="display: none;">
          <div class="user-card">
            <div class="user-avatar">üë§</div>
            <div class="user-info">
              <div class="user-name" id="userName">User</div>
              <div class="user-status">Connected</div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="header">
        <div class="header-left">
          <div>
            <h1 class="header-title" id="viewTitle">Dashboard</h1>
            <p class="header-subtitle" id="viewSubtitle">Autonomous cloud management</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="model-selector">
            <span style="font-size: 12px; color: var(--text-muted);">AI:</span>
            <select id="globalModelSelect">
              <option value="auto" selected>Auto (Best for Task)</option>
              <option value="claude-sonnet-4">Claude Sonnet 4 (Code)</option>
              <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
              <option value="gpt-4o">GPT-4o (General)</option>
              <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
              <option value="google/gemini-2.5-flash">Gemini 2.5 Flash</option>
              <option value="deepseek/deepseek-chat">DeepSeek Chat</option>
            </select>
          </div>
          <button class="btn btn-gradient" id="aiAgentBtn">
            <span>ü§ñ</span> AI Agent
          </button>
        </div>
      </header>

      <div class="view-container">
        <!-- Dashboard View -->
        <div class="view active" id="view-dashboard">
          <div class="dashboard-grid">
            <div class="stat-card">
              <div class="stat-header"><div class="stat-icon blue">üìÅ</div></div>
              <div class="stat-value" id="statFiles">--</div>
              <div class="stat-label">Cloud Files</div>
            </div>
            <div class="stat-card">
              <div class="stat-header"><div class="stat-icon green">üåê</div></div>
              <div class="stat-value" id="statApps">--</div>
              <div class="stat-label">Deployed Apps</div>
            </div>
            <div class="stat-card">
              <div class="stat-header"><div class="stat-icon purple">‚ö°</div></div>
              <div class="stat-value" id="statFunctions">--</div>
              <div class="stat-label">Functions</div>
            </div>
            <div class="stat-card">
              <div class="stat-header"><div class="stat-icon cyan">ü§ñ</div></div>
              <div class="stat-value" id="statAgentTasks">0</div>
              <div class="stat-label">Agent Tasks</div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>‚ö°</span> Quick Actions</div>
            </div>
            <div class="panel-content">
              <div class="quick-actions-grid">
                <div class="quick-action-card" data-action="agent-deploy">
                  <div class="quick-action-icon" style="background: rgba(16, 185, 129, 0.15);">üöÄ</div>
                  <div class="quick-action-title">Deploy with AI</div>
                  <div class="quick-action-desc">AI creates and deploys your app</div>
                </div>
                <div class="quick-action-card" data-action="agent-analyze">
                  <div class="quick-action-icon" style="background: rgba(139, 92, 246, 0.15);">üîç</div>
                  <div class="quick-action-title">Analyze Storage</div>
                  <div class="quick-action-desc">AI scans and optimizes files</div>
                </div>
                <div class="quick-action-card" data-action="agent-function">
                  <div class="quick-action-icon" style="background: rgba(59, 130, 246, 0.15);">‚ö°</div>
                  <div class="quick-action-title">Create Function</div>
                  <div class="quick-action-desc">AI generates cloud functions</div>
                </div>
                <div class="quick-action-card" data-action="agent-workflow">
                  <div class="quick-action-icon" style="background: rgba(6, 182, 212, 0.15);">üîÑ</div>
                  <div class="quick-action-title">Build Workflow</div>
                  <div class="quick-action-desc">AI automates your tasks</div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üìÇ</span> Recent Activity</div>
            </div>
            <div class="panel-content" id="recentActivity">
              <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">No recent activity</div>
                <div class="empty-state-desc">Start by asking the AI agent to help you</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Storage View - Full File Manager -->
        <div class="view" id="view-storage">
          <!-- Storage Stats Bar -->
          <div class="panel" style="margin-bottom: 16px;">
            <div class="panel-content" style="padding: 12px 20px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 24px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üìä</span>
                    <div>
                      <div style="font-size: 11px; color: var(--text-muted);">Total Files</div>
                      <div style="font-weight: 600;" id="storageFileCount">0</div>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üìÅ</span>
                    <div>
                      <div style="font-size: 11px; color: var(--text-muted);">Folders</div>
                      <div style="font-weight: 600;" id="storageFolderCount">0</div>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üíæ</span>
                    <div>
                      <div style="font-size: 11px; color: var(--text-muted);">Total Size</div>
                      <div style="font-weight: 600;" id="storageTotalSize">0 KB</div>
                    </div>
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <select id="fileViewMode" class="form-input" style="width: auto; padding: 6px 12px; font-size: 12px;">
                    <option value="list">List View</option>
                    <option value="grid">Grid View</option>
                  </select>
                  <select id="fileSortBy" class="form-input" style="width: auto; padding: 6px 12px; font-size: 12px;">
                    <option value="name">Sort by Name</option>
                    <option value="date">Sort by Date</option>
                    <option value="size">Sort by Size</option>
                    <option value="type">Sort by Type</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 250px 1fr; gap: 16px; height: calc(100vh - 280px);">
            <!-- Folder Tree Sidebar -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üìÇ</span> Folders</div>
              </div>
              <div class="panel-content no-padding" id="folderTree" style="flex: 1; overflow-y: auto; padding: 8px;">
                <div class="folder-tree-item active" data-path="/" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-radius: var(--radius-sm);">
                  <span>üè†</span> <span>Home</span>
                </div>
              </div>
            </div>

            <!-- Main File Browser -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üìÅ</span> Files</div>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="fileSearchInput" class="form-input" style="width: 200px; padding: 6px 12px; font-size: 12px;" placeholder="Search files...">
                  <button class="btn btn-secondary" id="newFolderBtn" style="padding: 6px 12px; font-size: 12px;"><span>üìÅ</span> New Folder</button>
                  <button class="btn btn-secondary" id="newFileBtn" style="padding: 6px 12px; font-size: 12px;"><span>üìÑ</span> New File</button>
                  <button class="btn btn-primary" id="uploadBtn" style="padding: 6px 12px; font-size: 12px;"><span>üì§</span> Upload</button>
                  <button class="btn btn-secondary btn-icon" id="refreshStorageBtn" style="padding: 6px;">üîÑ</button>
                </div>
              </div>
              
              <!-- Breadcrumb Navigation -->
              <div style="padding: 8px 16px; border-bottom: 1px solid var(--border-color); background: var(--bg-secondary);">
                <div class="breadcrumb" id="breadcrumb" style="display: flex; align-items: center; gap: 4px; font-size: 13px;">
                  <span class="breadcrumb-item" data-path="/" style="cursor: pointer; padding: 4px 8px; border-radius: 4px;">üè† Home</span>
                </div>
              </div>

              <!-- File Selection Actions (shown when files selected) -->
              <div id="fileSelectionBar" style="display: none; padding: 8px 16px; background: var(--accent); border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                  <span id="selectedCount" style="font-size: 13px; font-weight: 500;">0 selected</span>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="bulkDownloadBtn" style="padding: 4px 10px; font-size: 11px;">üì• Download</button>
                    <button class="btn btn-secondary" id="bulkMoveBtn" style="padding: 4px 10px; font-size: 11px;">üì¶ Move</button>
                    <button class="btn btn-secondary" id="bulkCopyBtn" style="padding: 4px 10px; font-size: 11px;">üìã Copy</button>
                    <button class="btn btn-danger" id="bulkDeleteBtn" style="padding: 4px 10px; font-size: 11px;">üóëÔ∏è Delete</button>
                    <button class="btn btn-secondary" id="clearSelectionBtn" style="padding: 4px 10px; font-size: 11px;">‚úï Clear</button>
                  </div>
                </div>
              </div>

              <!-- File List -->
              <div class="file-list" id="fileList" style="flex: 1; overflow-y: auto; padding: 8px;">
                <div class="empty-state">
                  <div class="empty-state-icon">üîê</div>
                  <div class="empty-state-title">Sign in to access storage</div>
                  <div class="empty-state-desc">Connect your Puter account</div>
                </div>
              </div>
            </div>
          </div>

          <!-- File Preview Panel (hidden by default) -->
          <div id="filePreviewPanel" class="panel" style="display: none; margin-top: 16px;">
            <div class="panel-header">
              <div class="panel-title"><span>üëÅÔ∏è</span> <span id="previewFileName">File Preview</span></div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="previewEditBtn" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è Edit</button>
                <button class="btn btn-primary" id="previewDownloadBtn" style="padding: 6px 12px; font-size: 12px;">üì• Download</button>
                <button class="btn btn-secondary" id="closePreviewBtn" style="padding: 6px 12px; font-size: 12px;">‚úï Close</button>
              </div>
            </div>
            <div class="panel-content" id="filePreviewContent" style="max-height: 300px; overflow: auto;">
              <pre style="margin: 0; font-family: var(--font-mono); font-size: 13px;"></pre>
            </div>
          </div>
        </div>

        <!-- Hidden file input for uploads -->
        <input type="file" id="fileUploadInput" multiple style="display: none;">

        <!-- Apps View - Full Application Manager -->
        <div class="view" id="view-apps">
          <!-- Apps Stats -->
          <div class="panel" style="margin-bottom: 16px;">
            <div class="panel-content" style="padding: 12px 20px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 24px;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üåê</span>
                    <div>
                      <div style="font-size: 11px; color: var(--text-muted);">Total Apps</div>
                      <div style="font-weight: 600;" id="appsCount">0</div>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üü¢</span>
                    <div>
                      <div style="font-size: 11px; color: var(--text-muted);">Live</div>
                      <div style="font-weight: 600;" id="appsLiveCount">0</div>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">‚ö°</span>
                    <div>
                      <div style="font-size: 11px; color: var(--text-muted);">Functions</div>
                      <div style="font-weight: 600;" id="appsFunctionsCount">0</div>
                    </div>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">üéÆ</span>
                    <div>
                      <div style="font-size: 11px; color: var(--text-muted);">Games</div>
                      <div style="font-weight: 600;" id="appsGamesCount">0</div>
                    </div>
                  </div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <select id="appFilterType" class="form-input" style="width: auto; padding: 6px 12px; font-size: 12px;">
                    <option value="all">All Types</option>
                    <option value="site">Websites</option>
                    <option value="function">Functions</option>
                    <option value="game">Game Servers</option>
                  </select>
                  <select id="appFilterStatus" class="form-input" style="width: auto; padding: 6px 12px; font-size: 12px;">
                    <option value="all">All Status</option>
                    <option value="live">Live</option>
                    <option value="stopped">Stopped</option>
                    <option value="error">Error</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 400px; gap: 16px; height: calc(100vh - 280px);">
            <!-- Apps List -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üåê</span> Deployed Applications</div>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="appSearchInput" class="form-input" style="width: 180px; padding: 6px 12px; font-size: 12px;" placeholder="Search apps...">
                  <button class="btn btn-success" id="newAppBtn" style="padding: 6px 12px; font-size: 12px;"><span>‚ûï</span> Deploy App</button>
                  <button class="btn btn-secondary btn-icon" id="refreshAppsBtn" style="padding: 6px;">üîÑ</button>
                </div>
              </div>
              <div class="panel-content" id="appsList" style="flex: 1; overflow-y: auto;">
                <div class="empty-state">
                  <div class="empty-state-icon">üåê</div>
                  <div class="empty-state-title">No apps deployed</div>
                  <div class="empty-state-desc">Click "Deploy App" to create your first application</div>
                </div>
              </div>
            </div>

            <!-- App Details Panel -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üìã</span> App Details</div>
              </div>
              <div id="appDetailsPanel" style="flex: 1; overflow-y: auto; padding: 16px;">
                <div class="empty-state">
                  <div class="empty-state-icon">üëÜ</div>
                  <div class="empty-state-title">Select an app</div>
                  <div class="empty-state-desc">Click on an app to view details</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Deploy Panel Modal -->
          <div class="panel" id="deployPanel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 700px; max-height: 90vh; z-index: 1000; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <div class="panel-header">
              <div class="panel-title"><span>üöÄ</span> Deploy New App</div>
              <button class="btn btn-secondary" id="cancelDeployBtn" style="padding: 6px 12px;">‚úï Cancel</button>
            </div>
            <div class="panel-content" style="max-height: 70vh; overflow-y: auto;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group" style="margin: 0;">
                  <label class="form-label">App Name</label>
                  <input type="text" class="form-input" id="appName" placeholder="my-awesome-app">
                </div>
                <div class="form-group" style="margin: 0;">
                  <label class="form-label">App Type</label>
                  <select id="appType" class="form-input">
                    <option value="site">Static Website</option>
                    <option value="function">Serverless Function</option>
                    <option value="game">Game Server</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="appDescription" placeholder="Brief description of your app">
              </div>
              <div class="form-group">
                <label class="form-label">Source Code</label>
                <div class="code-editor-container" style="border: 1px solid var(--border-color); border-radius: var(--radius);">
                  <div class="code-editor-header" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
                    <span class="code-editor-title" style="font-size: 12px;">üìÑ index.html</span>
                    <div style="display: flex; gap: 8px;">
                      <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" id="importFileBtn">üìÇ Import</button>
                      <button class="btn btn-gradient" style="padding: 4px 10px; font-size: 11px;" id="aiGenerateAppBtn">‚ú® AI Generate</button>
                    </div>
                  </div>
                  <textarea class="code-editor" id="appCode" style="width: 100%; height: 300px; border: none; padding: 12px; font-family: var(--font-mono); font-size: 13px; resize: none; background: var(--bg-primary);" placeholder="<!DOCTYPE html>
<html>
<head>
  <title>My App</title>
</head>
<body>
  <h1>Hello World!</h1>
</body>
</html>"></textarea>
                </div>
              </div>
              <div style="display: flex; gap: 12px;">
                <button class="btn btn-success" id="deployAppBtn" style="flex: 1;">üöÄ Deploy to Puter</button>
                <button class="btn btn-secondary" id="previewAppBtn">üëÅÔ∏è Preview</button>
              </div>
            </div>
          </div>
          <div id="deployOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>

          <!-- Source Viewer Modal -->
          <div id="sourceViewerModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; max-height: 90vh; z-index: 1001; background: var(--bg-card); border-radius: var(--radius); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color);">
              <h3 style="margin: 0; font-size: 16px;"><span>üìÑ</span> <span id="sourceViewerTitle">Source Code</span></h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="sourceEditBtn" style="padding: 6px 12px; font-size: 12px;">‚úèÔ∏è Edit</button>
                <button class="btn btn-secondary" id="sourceCopyBtn" style="padding: 6px 12px; font-size: 12px;">üìã Copy</button>
                <button class="btn btn-secondary" id="sourceCloseBtn" style="padding: 6px 12px; font-size: 12px;">‚úï</button>
              </div>
            </div>
            <div id="sourceViewerContent" style="max-height: 70vh; overflow: auto; padding: 0;">
              <pre style="margin: 0; padding: 16px; font-family: var(--font-mono); font-size: 13px; line-height: 1.6; background: var(--bg-primary);"></pre>
            </div>
          </div>
          <div id="sourceViewerOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;"></div>
        </div>

        <!-- Functions View -->
        <div class="view" id="view-functions">
          <div class="panel" id="functionsListPanel">
            <div class="panel-header">
              <div class="panel-title"><span>‚ö°</span> Serverless Functions</div>
              <button class="btn btn-primary" id="newFunctionBtn"><span>‚ûï</span> Create Function</button>
            </div>
            <div class="panel-content" id="functionsList">
              <div class="empty-state">
                <div class="empty-state-icon">‚ö°</div>
                <div class="empty-state-title">No functions yet</div>
                <div class="empty-state-desc">Ask AI to create functions for you</div>
              </div>
            </div>
          </div>

          <div class="panel" id="functionEditorPanel" style="display: none;">
            <div class="panel-header">
              <div class="panel-title"><span>‚ö°</span> Function Editor</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="cancelFunctionBtn">Cancel</button>
                <button class="btn btn-success" id="saveFunctionBtn">üíæ Save</button>
              </div>
            </div>
            <div class="panel-content">
              <div class="form-group">
                <label class="form-label">Function Name</label>
                <input type="text" class="form-input" id="functionName" placeholder="myFunction">
              </div>
              <div class="form-group">
                <label class="form-label">Function Code</label>
                <div class="code-editor-container">
                  <div class="code-editor-header">
                    <span class="code-editor-title">üìÑ function.js</span>
                    <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" id="aiGenerateFunctionBtn">‚ú® AI Generate</button>
                  </div>
                  <textarea class="code-editor" id="functionCode" placeholder="async function handler(request) {...}"></textarea>
                </div>
              </div>
              <button class="btn btn-primary" id="testFunctionBtn" style="margin-top: 10px;">‚ñ∂Ô∏è Test Run</button>
              <div id="functionOutput" style="margin-top: 16px; display: none;">
                <label class="form-label">Output</label>
                <pre style="background: var(--bg-primary); padding: 14px; border-radius: var(--radius-sm); font-size: 12px; overflow: auto;" id="functionOutputContent"></pre>
              </div>
            </div>
          </div>
        </div>

        <!-- Network & Access View - Full Policy Management -->
        <div class="view" id="view-network">
          <!-- Stats Overview -->
          <div class="panel" style="margin-bottom: 16px;">
            <div class="panel-header">
              <div class="panel-title"><span>üîå</span> Cloud Services & Access Management</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="scanPortsBtn" style="padding: 6px 12px; font-size: 12px;"><span>üîç</span> Scan Services</button>
                <button class="btn btn-primary" id="autoSecureBtn" style="padding: 6px 12px; font-size: 12px;"><span>üõ°Ô∏è</span> Auto-Secure</button>
              </div>
            </div>
            <div class="panel-content">
              <div class="stats-grid" style="grid-template-columns: repeat(5, 1fr);">
                <div class="stat-card">
                  <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15);">üü¢</div>
                  <div class="stat-info">
                    <div class="stat-value" id="statOpenPorts">0</div>
                    <div class="stat-label">Active Services</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon" style="background: rgba(59, 130, 246, 0.15);">üîí</div>
                  <div class="stat-info">
                    <div class="stat-value" id="statSecuredPorts">0</div>
                    <div class="stat-label">Secured</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon" style="background: rgba(245, 158, 11, 0.15);">‚ö†Ô∏è</div>
                  <div class="stat-info">
                    <div class="stat-value" id="statWarnings">0</div>
                    <div class="stat-label">Warnings</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon" style="background: rgba(139, 92, 246, 0.15);">üìã</div>
                  <div class="stat-info">
                    <div class="stat-value" id="statPolicies">0</div>
                    <div class="stat-label">Policies</div>
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-icon" style="background: rgba(239, 68, 68, 0.15);">üö´</div>
                  <div class="stat-info">
                    <div class="stat-value" id="statBlocked">0</div>
                    <div class="stat-label">Blocked Today</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; height: calc(100vh - 400px);">
            <!-- Services Inventory -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üåê</span> Cloud Services Inventory</div>
                <input type="text" id="serviceSearchInput" class="form-input" style="width: 150px; padding: 6px 12px; font-size: 12px;" placeholder="Search...">
              </div>
              <div class="panel-content" id="servicesList" style="flex: 1; overflow-y: auto;">
                <div class="empty-state">
                  <div class="empty-state-icon">üîç</div>
                  <div class="empty-state-title">No inventory yet</div>
                  <div class="empty-state-desc">Click "Scan Services" to discover deployed apps & functions</div>
                </div>
              </div>
            </div>

            <!-- Access Policies -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üìã</span> Access Policies</div>
                <div style="display: flex; gap: 8px;">
                  <select id="policyFilterType" class="form-input" style="width: auto; padding: 6px 10px; font-size: 11px;">
                    <option value="all">All Types</option>
                    <option value="allow">Allow</option>
                    <option value="deny">Deny</option>
                    <option value="ratelimit">Rate Limit</option>
                  </select>
                  <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" id="addPolicyBtn">+ Add Policy</button>
                </div>
              </div>
              <div class="panel-content" id="policiesList" style="flex: 1; overflow-y: auto;">
                <div class="empty-state">
                  <div class="empty-state-icon">üõ°Ô∏è</div>
                  <div class="empty-state-title">No policies</div>
                  <div class="empty-state-desc">Create access control policies for your services</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Audit Log -->
          <div class="panel" style="margin-top: 16px;">
            <div class="panel-header">
              <div class="panel-title"><span>üìú</span> Access Audit Log</div>
              <div style="display: flex; gap: 8px;">
                <select id="auditFilterLevel" class="form-input" style="width: auto; padding: 6px 10px; font-size: 11px;">
                  <option value="all">All Levels</option>
                  <option value="info">Info</option>
                  <option value="warning">Warning</option>
                  <option value="error">Error</option>
                  <option value="blocked">Blocked</option>
                </select>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" id="clearAuditBtn">Clear</button>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" id="exportAuditBtn">Export JSON</button>
              </div>
            </div>
            <div class="panel-content" id="auditLog" style="max-height: 200px; overflow-y: auto; font-family: var(--font-mono); font-size: 12px;">
              <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                Audit log will appear here after service scans and policy changes
              </div>
            </div>
          </div>

          <!-- Policy Editor Modal -->
          <div id="policyEditorModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; max-height: 90vh; z-index: 1001; background: var(--bg-card); border-radius: var(--radius); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-bottom: 1px solid var(--border-color);">
              <h3 style="margin: 0; font-size: 16px;"><span>üõ°Ô∏è</span> <span id="policyEditorTitle">Create Policy</span></h3>
              <button class="btn btn-secondary" id="closePolicyEditorBtn" style="padding: 6px 12px; font-size: 12px;">‚úï</button>
            </div>
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
              <div class="form-group">
                <label class="form-label">Policy Name</label>
                <input type="text" class="form-input" id="policyName" placeholder="e.g., Block Spam IPs">
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                  <label class="form-label">Policy Type</label>
                  <select id="policyType" class="form-input">
                    <option value="allow">Allow</option>
                    <option value="deny">Deny</option>
                    <option value="ratelimit">Rate Limit</option>
                    <option value="redirect">Redirect</option>
                    <option value="require_auth">Require Auth</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Priority</label>
                  <select id="policyPriority" class="form-input">
                    <option value="high">High (runs first)</option>
                    <option value="medium" selected>Medium</option>
                    <option value="low">Low (runs last)</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Apply To (Services)</label>
                <select id="policyTarget" class="form-input" multiple style="height: 80px;">
                  <option value="*">All Services</option>
                </select>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Hold Ctrl/Cmd to select multiple</div>
              </div>
              <div class="form-group">
                <label class="form-label">Conditions (Rule Builder)</label>
                <div id="policyConditions" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 12px;">
                  <div class="policy-condition" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                    <select class="form-input condition-field" style="width: 120px; padding: 6px; font-size: 12px;">
                      <option value="ip">IP Address</option>
                      <option value="country">Country</option>
                      <option value="path">URL Path</option>
                      <option value="method">HTTP Method</option>
                      <option value="header">Header</option>
                      <option value="user_agent">User Agent</option>
                    </select>
                    <select class="form-input condition-operator" style="width: 100px; padding: 6px; font-size: 12px;">
                      <option value="equals">equals</option>
                      <option value="contains">contains</option>
                      <option value="starts_with">starts with</option>
                      <option value="matches">matches regex</option>
                      <option value="in_list">in list</option>
                    </select>
                    <input type="text" class="form-input condition-value" style="flex: 1; padding: 6px; font-size: 12px;" placeholder="Value...">
                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="this.closest('.policy-condition').remove();">‚úï</button>
                  </div>
                </div>
                <button class="btn btn-secondary" id="addConditionBtn" style="margin-top: 8px; padding: 6px 12px; font-size: 12px;">+ Add Condition</button>
              </div>
              <div id="rateLimitOptions" style="display: none;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div class="form-group">
                    <label class="form-label">Max Requests</label>
                    <input type="number" class="form-input" id="rateLimitMax" value="100" min="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Time Window</label>
                    <select id="rateLimitWindow" class="form-input">
                      <option value="60">Per Minute</option>
                      <option value="3600">Per Hour</option>
                      <option value="86400">Per Day</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Description (optional)</label>
                <textarea class="form-input" id="policyDescription" style="resize: none; height: 60px;" placeholder="Describe what this policy does..."></textarea>
              </div>
              <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="btn btn-success" id="savePolicyBtn" style="flex: 1;">Save Policy</button>
                <button class="btn btn-secondary" id="testPolicyBtn">Test Policy</button>
              </div>
            </div>
          </div>
          <div id="policyEditorOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;"></div>
        </div>

        <!-- AI Agent View -->
        <div class="view" id="view-agent">
          <div class="panel" style="height: calc(100vh - 180px); display: flex; flex-direction: column;">
            <div class="panel-header">
              <div class="panel-title"><span>ü§ñ</span> Autonomous AI Agent</div>
              <div style="display: flex; align-items: center; gap: 10px;">
                <button class="btn btn-secondary btn-icon" id="clearChatBtn" style="padding: 8px;">üóëÔ∏è</button>
              </div>
            </div>
            
            <div id="agentStatusBar" class="agent-status idle" style="margin: 12px 20px 0;">
              <div class="agent-status-dot"></div>
              <span class="agent-status-text">Agent idle - ready for tasks</span>
            </div>

            <div class="ai-chat-container">
              <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                  <div class="chat-avatar">ü§ñ</div>
                  <div class="chat-bubble">
                    <strong>Welcome to CloudPilot AI!</strong> üëã
                    <br><br>
                    I'm your autonomous cloud agent. I can execute multi-step tasks independently:
                    <br><br>
                    üöÄ <strong>Deploy Apps</strong> - "Create and deploy a landing page for my startup"<br>
                    üìÅ <strong>Manage Storage</strong> - "Organize my files and clean up duplicates"<br>
                    ‚ö° <strong>Create Functions</strong> - "Build an API that returns weather data"<br>
                    üîÑ <strong>Automate Workflows</strong> - "Set up a backup system for my files"<br>
                    üîç <strong>Analyze & Optimize</strong> - "Review my apps and suggest improvements"
                    <br><br>
                    I'll break down complex tasks, execute each step, and keep you informed!
                    <div class="chat-action-buttons">
                      <button class="chat-action-btn" data-action="deploy-landing">üöÄ Deploy a landing page</button>
                      <button class="chat-action-btn" data-action="create-api">‚ö° Create an API function</button>
                      <button class="chat-action-btn" data-action="analyze-storage">üîç Analyze my storage</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="chat-input-area">
                <div class="chat-input-wrapper">
                  <textarea class="chat-input" id="chatInput" placeholder="Tell me what you want to build or automate..." rows="1"></textarea>
                  <button class="send-btn" id="sendBtn">‚û§</button>
                </div>
                <div class="prompt-suggestions">
                  <span class="prompt-chip" data-prompt="Create a portfolio website and deploy it">üåê Portfolio site</span>
                  <span class="prompt-chip" data-prompt="Build an API that returns random quotes">‚ö° Quote API</span>
                  <span class="prompt-chip" data-prompt="Set up a file backup workflow">üîÑ Backup workflow</span>
                  <span class="prompt-chip" data-prompt="Analyze my cloud usage and optimize">üìä Optimize cloud</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Workflows View -->
        <div class="view" id="view-workflows">
          <!-- Workflow Templates -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üìã</span> Workflow Templates</div>
              <button class="btn btn-gradient" id="aiWorkflowBtn"><span>ü§ñ</span> AI Generate Workflow</button>
            </div>
            <div class="panel-content">
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;" id="workflowTemplates">
                <div class="workflow-template" data-template="deploy-site" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px; cursor: pointer; transition: all 0.2s;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span style="font-size: 28px;">üöÄ</span>
                    <div>
                      <div style="font-weight: 600;">Deploy Website</div>
                      <div style="font-size: 11px; color: var(--text-muted);">3 steps</div>
                    </div>
                  </div>
                  <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">Generate HTML, upload to Puter, deploy to live hosting</p>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">puter.fs</span>
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">puter.hosting</span>
                  </div>
                </div>
                <div class="workflow-template" data-template="backup-files" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px; cursor: pointer; transition: all 0.2s;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span style="font-size: 28px;">üíæ</span>
                    <div>
                      <div style="font-weight: 600;">Backup Files</div>
                      <div style="font-size: 11px; color: var(--text-muted);">4 steps</div>
                    </div>
                  </div>
                  <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">List files, create backup folder, copy files, log completion</p>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">puter.fs</span>
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">puter.kv</span>
                  </div>
                </div>
                <div class="workflow-template" data-template="ai-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px; cursor: pointer; transition: all 0.2s;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span style="font-size: 28px;">‚ú®</span>
                    <div>
                      <div style="font-weight: 600;">AI Content Generator</div>
                      <div style="font-size: 11px; color: var(--text-muted);">3 steps</div>
                    </div>
                  </div>
                  <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">AI generates content, formats output, saves to file</p>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">puter.ai</span>
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">puter.fs</span>
                  </div>
                </div>
                <div class="workflow-template" data-template="security-scan" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px; cursor: pointer; transition: all 0.2s;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <span style="font-size: 28px;">üîí</span>
                    <div>
                      <div style="font-weight: 600;">Security Scan</div>
                      <div style="font-size: 11px; color: var(--text-muted);">5 steps</div>
                    </div>
                  </div>
                  <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">Scan services, apply policies, generate report, notify</p>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">scan_ports</span>
                    <span style="background: var(--bg-card); padding: 3px 8px; border-radius: 4px; font-size: 10px;">auto_secure</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- AI Workflow Builder -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>ü§ñ</span> AI Workflow Builder</div>
            </div>
            <div class="panel-content">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                  <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 8px;">Describe your workflow</label>
                  <textarea id="workflowDescription" class="form-input" style="min-height: 120px; resize: vertical;" placeholder="Example: When a new file is uploaded, compress it, create a thumbnail, and send me a notification..."></textarea>
                  <button class="btn btn-gradient" id="generateWorkflowBtn" style="margin-top: 12px; width: 100%;">
                    <span>‚ú®</span> Generate with AI
                  </button>
                </div>
                <div>
                  <label style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 8px;">Generated Steps</label>
                  <div id="generatedWorkflowSteps" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px; min-height: 120px; font-size: 13px; color: var(--text-muted);">
                    AI will generate workflow steps here...
                  </div>
                  <button class="btn btn-success" id="saveGeneratedWorkflowBtn" style="margin-top: 12px; width: 100%;" disabled>
                    <span>üíæ</span> Save Workflow
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Saved Workflows -->
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üîÑ</span> Saved Workflows</div>
              <button class="btn btn-secondary" id="refreshWorkflowsBtn"><span>üîÑ</span> Refresh</button>
            </div>
            <div class="panel-content" id="workflowsList">
              <div class="empty-state">
                <div class="empty-state-icon">üîÑ</div>
                <div class="empty-state-title">No workflows saved</div>
                <div class="empty-state-desc">Use templates or AI to create workflows</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Code Playground View -->
        <div class="view" id="view-playground">
          <!-- Version Control Bar -->
          <div class="panel" style="margin-bottom: 16px; padding: 8px 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 13px; font-weight: 600;">Version Control</span>
                <button class="btn btn-secondary" id="versionUndoBtn" style="padding: 4px 10px; font-size: 12px;" title="Undo">‚Ü∂ Undo</button>
                <button class="btn btn-secondary" id="versionRedoBtn" style="padding: 4px 10px; font-size: 12px;" title="Redo">‚Ü∑ Redo</button>
                <button class="btn btn-secondary" id="versionSaveBtn" style="padding: 4px 10px; font-size: 12px;" title="Save Checkpoint">üíæ Save</button>
                <button class="btn btn-secondary" id="versionListBtn" style="padding: 4px 10px; font-size: 12px;" title="View Backups">üìã Backups</button>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span id="versionInfo" style="font-size: 11px; color: var(--text-muted); font-family: var(--font-mono);">No version</span>
                <span id="versionSha" style="font-size: 10px; color: var(--accent); font-family: var(--font-mono);"></span>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; height: calc(100vh - 240px);">
            <!-- Code Editor Panel -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üìù</span> Code Editor</div>
                <div style="display: flex; gap: 8px;">
                  <select id="playgroundLang" class="form-input" style="width: auto; padding: 6px 12px; font-size: 12px;">
                    <option value="html">HTML</option>
                    <option value="javascript">JavaScript</option>
                    <option value="css">CSS</option>
                    <option value="python">Python</option>
                  </select>
                  <button class="btn btn-gradient" id="playgroundAiBtn" style="padding: 6px 12px; font-size: 12px;">ü§ñ AI Generate</button>
                  <button class="btn btn-success" id="playgroundRunBtn" style="padding: 6px 12px; font-size: 12px;">‚ñ∂ Run</button>
                </div>
              </div>
              <textarea id="playgroundCode" style="flex: 1; background: var(--bg-primary); color: var(--text-primary); border: none; padding: 16px; font-family: var(--font-mono); font-size: 13px; line-height: 1.6; resize: none;" placeholder="// Write or generate code here...
// Use AI Generate to create code from description
// Run to see output in preview panel"></textarea>
            </div>

            <!-- Preview/Output Panel -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üëÅÔ∏è</span> Preview / Output</div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-secondary" id="playgroundConvertBtn" style="padding: 6px 12px; font-size: 12px;">üîÑ Convert</button>
                  <button class="btn btn-secondary" id="playgroundDeployBtn" style="padding: 6px 12px; font-size: 12px;">üöÄ Deploy</button>
                </div>
              </div>
              <div id="playgroundOutput" style="flex: 1; background: white; overflow: auto;">
                <iframe id="playgroundPreview" style="width: 100%; height: 100%; border: none;"></iframe>
              </div>
            </div>
          </div>

          <!-- AI Prompt Panel -->
          <div class="panel" style="margin-top: 16px;">
            <div class="panel-header">
              <div class="panel-title"><span>‚ú®</span> AI Script Generator</div>
            </div>
            <div class="panel-content">
              <div style="display: flex; gap: 12px;">
                <input type="text" id="playgroundAiPrompt" class="form-input" style="flex: 1;" placeholder="Describe what you want to build... (e.g., 'A countdown timer with animation')">
                <button class="btn btn-gradient" id="playgroundGenerateBtn">Generate Code</button>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
                <span class="prompt-chip" data-code="landing">üåê Landing Page</span>
                <span class="prompt-chip" data-code="calculator">üßÆ Calculator</span>
                <span class="prompt-chip" data-code="todo">‚úÖ Todo App</span>
                <span class="prompt-chip" data-code="chart">üìä Chart Widget</span>
                <span class="prompt-chip" data-code="game">üéÆ Simple Game</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Code Studio View -->
        <div class="view" id="view-studio">
          <div style="display: grid; grid-template-columns: 250px 1fr 350px; gap: 16px; height: calc(100vh - 180px);">
            <!-- File Tree -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üìÇ</span> Files</div>
                <button class="btn btn-secondary btn-icon" id="studioRefreshBtn" style="padding: 6px;">üîÑ</button>
              </div>
              <div class="panel-content no-padding" id="studioFileTree" style="flex: 1; overflow-y: auto;">
                <div class="empty-state" style="padding: 20px;">
                  <div class="empty-state-icon" style="font-size: 32px;">üîê</div>
                  <div class="empty-state-title" style="font-size: 13px;">Sign in to access files</div>
                </div>
              </div>
            </div>

            <!-- Code Editor -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>üìù</span> <span id="studioFileName">Untitled</span></div>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-secondary" id="studioAiFixBtn" style="padding: 6px 12px; font-size: 12px;">üîß AI Fix</button>
                  <button class="btn btn-success" id="studioSaveBtn" style="padding: 6px 12px; font-size: 12px;">üíæ Save</button>
                </div>
              </div>
              <div id="studioCodeEditor" style="flex: 1; background: var(--bg-primary); font-family: var(--font-mono); overflow: hidden;">
                <textarea id="studioCodeArea" style="width: 100%; height: 100%; background: var(--bg-primary); color: var(--text-primary); border: none; padding: 16px; font-family: var(--font-mono); font-size: 13px; line-height: 1.6; resize: none;" placeholder="// Select a file or create new to start coding..."></textarea>
              </div>
            </div>

            <!-- AI Assistant Panel -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden;">
              <div class="panel-header" style="padding: 12px 16px;">
                <div class="panel-title" style="font-size: 13px;"><span>ü§ñ</span> AI Coder</div>
              </div>
              <div id="studioAiChat" style="flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 12px;">
                <div class="chat-message ai" style="max-width: 100%;">
                  <div class="chat-bubble" style="font-size: 13px;">
                    I'm your AI coding assistant. I can help you:
                    <br><br>
                    ‚Ä¢ Write and edit code<br>
                    ‚Ä¢ Fix bugs automatically<br>
                    ‚Ä¢ Explain code sections<br>
                    ‚Ä¢ Generate new files<br>
                    ‚Ä¢ Optimize performance
                  </div>
                </div>
              </div>
              <div style="padding: 12px; border-top: 1px solid var(--border-color);">
                <div style="display: flex; gap: 8px;">
                  <textarea id="studioAiInput" class="form-input" style="resize: none; min-height: 60px; font-size: 13px;" placeholder="Ask AI to help with your code..."></textarea>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                  <button class="btn btn-primary" id="studioAiSendBtn" style="flex: 1; font-size: 12px;">Send</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Terminal View -->
        <div class="view" id="view-terminal">
          <div class="panel" style="height: calc(100vh - 180px); display: flex; flex-direction: column;">
            <div class="panel-header">
              <div class="panel-title"><span>üñ•Ô∏è</span> Multi-Terminal</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="addTerminalBtn" style="padding: 6px 12px; font-size: 12px;">+ New Terminal</button>
              </div>
            </div>
            
            <!-- Terminal Tabs -->
            <div style="display: flex; gap: 4px; padding: 8px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" id="terminalTabs">
              <button class="btn btn-secondary active" data-terminal="bash" style="padding: 6px 14px; font-size: 12px;">üîß Bash</button>
              <button class="btn btn-secondary" data-terminal="node" style="padding: 6px 14px; font-size: 12px;">‚¨¢ Node.js</button>
              <button class="btn btn-secondary" data-terminal="python" style="padding: 6px 14px; font-size: 12px;">üêç Python</button>
            </div>
            
            <!-- Terminal Content -->
            <div id="terminalContainer" style="flex: 1; display: flex; flex-direction: column; background: #0d1117;">
              <div id="terminalOutput" style="flex: 1; padding: 16px; font-family: var(--font-mono); font-size: 13px; overflow-y: auto; color: #c9d1d9;">
                <div style="color: #58a6ff;">CloudPilot Terminal v1.0</div>
                <div style="color: #8b949e;">Type commands to execute in sandboxed environment</div>
                <div style="color: #8b949e;">-------------------------------------------</div>
                <div id="terminalHistory"></div>
              </div>
              <div style="display: flex; align-items: center; padding: 8px 16px; background: #161b22; border-top: 1px solid #30363d;">
                <span style="color: #58a6ff; font-family: var(--font-mono); font-size: 13px;">$&nbsp;</span>
                <input type="text" id="terminalInput" style="flex: 1; background: transparent; border: none; color: #c9d1d9; font-family: var(--font-mono); font-size: 13px; outline: none;" placeholder="Enter command...">
              </div>
            </div>
          </div>
        </div>

        <!-- AI Memory View -->
        <div class="view" id="view-memory">
          <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: rgba(236, 72, 153, 0.15);">üß†</div>
              </div>
              <div class="stat-value" id="memoryPrefsCount">0</div>
              <div class="stat-label">Preferences Learned</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: rgba(139, 92, 246, 0.15);">üí¨</div>
              </div>
              <div class="stat-value" id="memoryHistoryCount">0</div>
              <div class="stat-label">Conversations Remembered</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: rgba(6, 182, 212, 0.15);">üíª</div>
              </div>
              <div class="stat-value" id="memoryCodingCount">0</div>
              <div class="stat-label">Coding Styles</div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üß†</span> AI Learning & Memory</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="refreshMemoryBtn" style="padding: 6px 12px; font-size: 12px;">üîÑ Refresh</button>
                <button class="btn btn-danger" id="clearMemoryBtn" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è Clear Memory</button>
              </div>
            </div>
            <div class="panel-content">
              <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                CloudPilot learns from your interactions to provide personalized assistance. Your preferences, coding style, and conversation context are stored securely in your Puter cloud storage.
              </p>
              
              <!-- Coding Style -->
              <div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">üíª Learned Coding Style</h4>
                <div id="memoryCodingStyle" style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); font-size: 13px;">
                  <span style="color: var(--text-muted);">No coding preferences learned yet. Start coding and AI will learn your style!</span>
                </div>
              </div>
              
              <!-- Preferences -->
              <div style="margin-bottom: 20px;">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">‚öôÔ∏è User Preferences</h4>
                <div id="memoryPreferences" style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); font-size: 13px;">
                  <span style="color: var(--text-muted);">No explicit preferences set. Tell AI "I prefer..." or "Always use..." to teach it!</span>
                </div>
              </div>
              
              <!-- Recent Conversation Context -->
              <div>
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">üí¨ Recent Conversation Context</h4>
                <div id="memoryHistory" style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); font-size: 13px; max-height: 200px; overflow-y: auto;">
                  <span style="color: var(--text-muted);">No conversation history yet. Start chatting with AI!</span>
                </div>
              </div>
              
              <!-- Manual Teaching -->
              <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">üìö Teach AI Manually</h4>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                  <select id="teachCategory" class="form-input" style="flex: 0 0 150px;">
                    <option value="preferredLanguage">Language</option>
                    <option value="framework">Framework</option>
                    <option value="indentation">Indentation</option>
                    <option value="naming">Naming Convention</option>
                    <option value="comments">Comment Style</option>
                  </select>
                  <input type="text" id="teachValue" class="form-input" placeholder="e.g., TypeScript, React, 2 spaces...">
                  <button class="btn btn-primary" id="teachAiBtn" style="flex-shrink: 0;">Teach AI</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Deployments View -->
        <div class="view" id="view-deployments">
          <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: rgba(16, 185, 129, 0.15);">üöÄ</div>
              </div>
              <div class="stat-value" id="liveDeploymentsCount">0</div>
              <div class="stat-label">Live Deployments</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: rgba(59, 130, 246, 0.15);">üåê</div>
              </div>
              <div class="stat-value" id="totalSitesCount">0</div>
              <div class="stat-label">Sites Created</div>
            </div>
            <div class="stat-card">
              <div class="stat-header">
                <div class="stat-icon" style="background: rgba(139, 92, 246, 0.15);">üéÆ</div>
              </div>
              <div class="stat-value" id="gameServersCount">0</div>
              <div class="stat-label">Game Servers</div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üöÄ</span> Deploy New Site</div>
            </div>
            <div class="panel-content">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div>
                  <label class="form-label">Site Name</label>
                  <input type="text" id="deployName" class="form-input" placeholder="My Awesome Site">
                </div>
                <div>
                  <label class="form-label">Subdomain</label>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="deploySubdomain" class="form-input" placeholder="my-site" style="flex: 1;">
                    <span style="color: var(--text-muted); font-size: 13px;">.puter.site</span>
                  </div>
                </div>
              </div>
              <div style="margin-bottom: 16px;">
                <label class="form-label">HTML Content</label>
                <textarea id="deployContent" class="form-input" rows="8" placeholder="<!DOCTYPE html>
<html>
<head><title>My Site</title></head>
<body>
  <h1>Hello World!</h1>
</body>
</html>" style="font-family: var(--font-mono); font-size: 12px;"></textarea>
              </div>
              <button class="btn btn-success" id="deployNowBtn" style="width: 100%;">üöÄ Deploy to Puter</button>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üåê</span> Active Deployments</div>
              <button class="btn btn-secondary" id="refreshDeploymentsBtn" style="padding: 6px 12px; font-size: 12px;">üîÑ Refresh</button>
            </div>
            <div class="panel-content" id="deploymentsListContainer">
              <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                No deployments yet. Create your first site above!
              </div>
            </div>
          </div>
        </div>

        <!-- Game Hosting View -->
        <div class="view" id="view-games">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üéÆ</span> Game Server Templates</div>
            </div>
            <div class="panel-content">
              <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                Deploy multiplayer games and PVP servers with one click. All templates are optimized for Puter hosting and support real-time interactions.
              </p>
              <div id="gameTemplatesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                <!-- Templates loaded dynamically -->
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üñ•Ô∏è</span> Deploy Game Server</div>
            </div>
            <div class="panel-content">
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div>
                  <label class="form-label">Template</label>
                  <select id="gameTemplate" class="form-input">
                    <option value="">Select a template...</option>
                  </select>
                </div>
                <div>
                  <label class="form-label">Server Name</label>
                  <input type="text" id="gameServerName" class="form-input" placeholder="My Game Server">
                </div>
                <div>
                  <label class="form-label">Subdomain</label>
                  <div style="display: flex; gap: 8px; align-items: center;">
                    <input type="text" id="gameSubdomain" class="form-input" placeholder="my-game" style="flex: 1;">
                    <span style="color: var(--text-muted); font-size: 12px;">.puter.site</span>
                  </div>
                </div>
              </div>
              <button class="btn btn-gradient" id="deployGameBtn" style="width: 100%;">üéÆ Deploy Game Server</button>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üèÜ</span> Active Game Servers</div>
            </div>
            <div class="panel-content" id="gameServersContainer">
              <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                No game servers deployed yet. Select a template above to get started!
              </div>
            </div>
          </div>
        </div>

        <!-- Extensions View -->
        <div class="view" id="view-extensions">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üß©</span> Agent Extensions</div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary" id="refreshExtensionsBtn" style="padding: 6px 12px; font-size: 12px;">üîÑ Refresh</button>
                <button class="btn btn-primary" id="addExtensionBtn" style="padding: 6px 12px; font-size: 12px;">+ Add Extension</button>
              </div>
            </div>
            <div class="panel-content">
              <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                Extensions enhance CloudPilot's AI agent capabilities. Enable or disable tools to customize your automation workflows.
              </p>
              <div id="extensionsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                <!-- Extensions loaded dynamically -->
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <div class="panel-title"><span>üìä</span> Extension Categories</div>
            </div>
            <div class="panel-content">
              <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                <div style="background: rgba(59, 130, 246, 0.15); padding: 8px 16px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px;">
                  <span>ü§ñ</span> <span style="font-size: 13px; font-weight: 500;">AI</span>
                  <span id="aiExtCount" style="background: var(--accent-blue); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">0</span>
                </div>
                <div style="background: rgba(16, 185, 129, 0.15); padding: 8px 16px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px;">
                  <span>üöÄ</span> <span style="font-size: 13px; font-weight: 500;">Deployment</span>
                  <span id="deployExtCount" style="background: var(--accent-green); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">0</span>
                </div>
                <div style="background: rgba(139, 92, 246, 0.15); padding: 8px 16px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px;">
                  <span>üíæ</span> <span style="font-size: 13px; font-weight: 500;">Storage</span>
                  <span id="storageExtCount" style="background: var(--accent-purple); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">0</span>
                </div>
                <div style="background: rgba(249, 115, 22, 0.15); padding: 8px 16px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px;">
                  <span>‚öôÔ∏è</span> <span style="font-size: 13px; font-weight: 500;">Tools</span>
                  <span id="toolsExtCount" style="background: var(--accent-orange); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">0</span>
                </div>
                <div style="background: rgba(236, 72, 153, 0.15); padding: 8px 16px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 8px;">
                  <span>üîÑ</span> <span style="font-size: 13px; font-weight: 500;">Automation</span>
                  <span id="autoExtCount" style="background: var(--accent-pink); color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- File Converter View -->
        <div class="view" id="view-converter">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- 3D File Converter -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title"><span>üéÆ</span> 3D File Converter</div>
              </div>
              <div class="panel-content">
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                  Convert 3D models to GLTF/GLB format for use in games and web applications.
                </p>
                <div class="form-group">
                  <label class="form-label">Upload 3D File (GLTF/GLB)</label>
                  <input type="file" id="upload3dFile" accept=".gltf,.glb" class="form-input" style="padding: 10px;">
                  <p style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Currently supports GLTF/GLB optimization. For OBJ/FBX, use external converters first.</p>
                </div>
                <div class="form-group">
                  <label class="form-label">Output Format</label>
                  <select id="output3dFormat" class="form-input">
                    <option value="glb">GLB (Binary - recommended)</option>
                    <option value="gltf">GLTF (JSON)</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Optimization</label>
                  <select id="optimize3d" class="form-input">
                    <option value="none">None</option>
                    <option value="optimize">Deduplicate & Prune</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="convert3dBtn" style="width: 100%;">üîÑ Convert 3D Model</button>
                <div id="convert3dResult" style="margin-top: 16px; display: none;">
                  <div class="form-label">Result</div>
                  <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: space-between;">
                    <span id="convert3dFileName" style="font-size: 13px;">model.glb</span>
                    <button class="btn btn-success" id="download3dBtn" style="padding: 6px 12px; font-size: 12px;">‚¨áÔ∏è Download</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Image Converter -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title"><span>üñºÔ∏è</span> Image Converter & Optimizer</div>
              </div>
              <div class="panel-content">
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                  Convert and optimize images for web, mobile, or print applications.
                </p>
                <div class="form-group">
                  <label class="form-label">Upload Image</label>
                  <input type="file" id="uploadImageFile" accept="image/*" class="form-input" style="padding: 10px;">
                </div>
                <div class="form-group">
                  <label class="form-label">Output Format</label>
                  <select id="outputImageFormat" class="form-input">
                    <option value="webp">WebP (Best for web)</option>
                    <option value="png">PNG (Lossless)</option>
                    <option value="jpeg">JPEG (Photos)</option>
                    <option value="avif">AVIF (Modern)</option>
                  </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                  <div class="form-group">
                    <label class="form-label">Width (px)</label>
                    <input type="number" id="imageWidth" class="form-input" placeholder="Auto">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Height (px)</label>
                    <input type="number" id="imageHeight" class="form-input" placeholder="Auto">
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Quality: <span id="qualityValue">80</span>%</label>
                  <input type="range" id="imageQuality" min="1" max="100" value="80" style="width: 100%;">
                </div>
                <button class="btn btn-primary" id="convertImageBtn" style="width: 100%;">üîÑ Convert Image</button>
                <div id="convertImageResult" style="margin-top: 16px; display: none;">
                  <div class="form-label">Result</div>
                  <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm);">
                    <img id="convertedImagePreview" style="max-width: 100%; max-height: 150px; border-radius: var(--radius-sm); margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                      <span id="convertImageInfo" style="font-size: 12px; color: var(--text-muted);">optimized.webp - 45KB</span>
                      <button class="btn btn-success" id="downloadImageBtn" style="padding: 6px 12px; font-size: 12px;">‚¨áÔ∏è Download</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Batch Converter -->
          <div class="panel" style="margin-top: 20px;">
            <div class="panel-header">
              <div class="panel-title"><span>üì¶</span> Batch Conversion</div>
            </div>
            <div class="panel-content">
              <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                Convert multiple files at once. Upload files and they'll be processed with the same settings.
              </p>
              <div class="form-group">
                <label class="form-label">Upload Multiple Files</label>
                <input type="file" id="uploadBatchFiles" multiple class="form-input" style="padding: 10px;">
              </div>
              <div id="batchQueue" style="margin-top: 12px;"></div>
              <button class="btn btn-gradient" id="processBatchBtn" style="width: 100%; margin-top: 12px;">‚ö° Process All Files</button>
            </div>
          </div>
        </div>

        <!-- Grudge App View - Discord-style Chat -->
        <div class="view" id="view-grudge">
          <div style="display: flex; height: calc(100vh - 100px); background: var(--bg-secondary); border-radius: var(--radius-md); overflow: hidden;">
            <!-- Server List -->
            <div id="grudgeServers" style="width: 72px; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); display: flex; flex-direction: column; align-items: center; padding: 12px 0; gap: 8px; overflow-y: auto;">
              <div class="grudge-server-icon active" data-server="home" style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 22px;" data-testid="server-home">üè†</div>
              <div style="width: 32px; height: 2px; background: var(--border-color); margin: 4px 0;"></div>
              <div class="grudge-server-icon" data-server="general" style="width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 20px; border: 2px solid transparent;" data-testid="server-general">üí¨</div>
              <div class="grudge-server-icon" data-server="cloudpilot" style="width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 20px; border: 2px solid transparent;" data-testid="server-cloudpilot">üöÄ</div>
              <div class="grudge-server-icon" data-server="games" style="width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 20px; border: 2px solid transparent;" data-testid="server-games">üéÆ</div>
              <div class="grudge-server-icon" data-server="ai" style="width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 20px; border: 2px solid transparent;" data-testid="server-ai">ü§ñ</div>
              <div style="flex: 1;"></div>
              <div class="grudge-server-icon" id="addServerBtn" style="width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; font-size: 24px; color: var(--accent-green); border: 2px dashed var(--accent-green);" data-testid="button-add-server">+</div>
            </div>

            <!-- Channel List -->
            <div id="grudgeChannels" style="width: 240px; background: var(--bg-card); display: flex; flex-direction: column; border-right: 1px solid var(--border-color);">
              <div style="padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
                <span id="grudgeServerName" style="font-weight: 600; font-size: 15px;">Grudge Home</span>
                <span style="cursor: pointer;">‚öôÔ∏è</span>
              </div>
              <div style="padding: 8px; flex: 1; overflow-y: auto;">
                <div style="padding: 8px 12px; color: var(--text-muted); font-size: 11px; text-transform: uppercase; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
                  <span>Text Channels</span>
                  <span style="cursor: pointer; font-size: 14px;" id="addChannelBtn" data-testid="button-add-channel">+</span>
                </div>
                <div id="grudgeChannelList" style="display: flex; flex-direction: column; gap: 2px;">
                  <div class="grudge-channel active" data-channel="general" style="padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 8px; background: var(--bg-secondary);" data-testid="channel-general">
                    <span style="color: var(--text-muted);">#</span>
                    <span style="font-size: 14px;">general</span>
                  </div>
                  <div class="grudge-channel" data-channel="announcements" style="padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 8px;" data-testid="channel-announcements">
                    <span style="color: var(--text-muted);">üì¢</span>
                    <span style="font-size: 14px;">announcements</span>
                  </div>
                  <div class="grudge-channel" data-channel="ai-chat" style="padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 8px;" data-testid="channel-ai-chat">
                    <span style="color: var(--text-muted);">ü§ñ</span>
                    <span style="font-size: 14px;">ai-assistant</span>
                  </div>
                  <div class="grudge-channel" data-channel="deployments" style="padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 8px;" data-testid="channel-deployments">
                    <span style="color: var(--text-muted);">üöÄ</span>
                    <span style="font-size: 14px;">deployments</span>
                  </div>
                </div>
                <div style="padding: 8px 12px; color: var(--text-muted); font-size: 11px; text-transform: uppercase; font-weight: 600; margin-top: 16px; display: flex; align-items: center; justify-content: space-between;">
                  <span>Voice Channels</span>
                  <span style="cursor: pointer; font-size: 14px;">+</span>
                </div>
                <div style="display: flex; flex-direction: column; gap: 2px;">
                  <div class="grudge-channel" style="padding: 8px 12px; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--text-muted);">üîä</span>
                    <span style="font-size: 14px;">General Voice</span>
                    <span style="margin-left: auto; font-size: 11px; color: var(--text-muted);">0</span>
                  </div>
                </div>
              </div>
              <!-- User Profile Bar -->
              <div id="grudgeUserBar" style="padding: 10px; background: rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; border-top: 1px solid var(--border-color);">
                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); display: flex; align-items: center; justify-content: center; font-size: 14px;">üë§</div>
                <div style="flex: 1; min-width: 0;">
                  <div id="grudgeUsername" style="font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Guest</div>
                  <div id="grudgeUserStatus" style="font-size: 11px; color: var(--accent-green);">Online</div>
                </div>
                <div style="display: flex; gap: 8px;">
                  <span style="cursor: pointer; opacity: 0.7;" title="Settings" data-testid="button-user-settings">‚öôÔ∏è</span>
                </div>
              </div>
            </div>

            <!-- Message Area -->
            <div style="flex: 1; display: flex; flex-direction: column; background: var(--bg-primary);">
              <!-- Channel Header -->
              <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 20px; color: var(--text-muted);">#</span>
                <span id="grudgeChannelName" style="font-weight: 600;">general</span>
                <span style="color: var(--text-muted); font-size: 13px; border-left: 1px solid var(--border-color); padding-left: 12px;" id="grudgeChannelDesc">Welcome to Grudge!</span>
                <div style="margin-left: auto; display: flex; gap: 16px; color: var(--text-muted);">
                  <span style="cursor: pointer;" title="Pinned Messages">üìå</span>
                  <span style="cursor: pointer;" title="Members">üë•</span>
                  <input type="text" placeholder="Search..." style="background: var(--bg-secondary); border: none; padding: 6px 12px; border-radius: var(--radius-sm); font-size: 12px; width: 160px; color: var(--text-primary);" data-testid="input-channel-search">
                </div>
              </div>

              <!-- Messages -->
              <div id="grudgeMessages" style="flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px;">
                <div style="text-align: center; padding: 40px;">
                  <div style="font-size: 48px; margin-bottom: 16px;">üëã</div>
                  <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Welcome to #general!</div>
                  <div style="color: var(--text-muted);">This is the start of the #general channel.</div>
                </div>
                <!-- Messages will be rendered here -->
              </div>

              <!-- Message Input -->
              <div style="padding: 16px; border-top: 1px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); padding: 12px 16px;">
                  <span style="cursor: pointer; font-size: 18px;" title="Attach File" data-testid="button-attach-file">üìé</span>
                  <input type="text" id="grudgeMessageInput" placeholder="Message #general" style="flex: 1; background: transparent; border: none; font-size: 14px; color: var(--text-primary); outline: none;" data-testid="input-message">
                  <span style="cursor: pointer; font-size: 18px;" title="AI Assistant" id="grudgeAIBtn" data-testid="button-ai-assist">ü§ñ</span>
                  <span style="cursor: pointer; font-size: 18px;" title="Send" id="grudgeSendBtn" data-testid="button-send-message">‚û§</span>
                </div>
              </div>
            </div>

            <!-- Member List -->
            <div id="grudgeMembers" style="width: 240px; background: var(--bg-card); border-left: 1px solid var(--border-color); padding: 16px; overflow-y: auto;">
              <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; font-weight: 600; margin-bottom: 12px;">Online - <span id="grudgeOnlineCount">1</span></div>
              <div id="grudgeMemberList" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Members will be rendered here -->
              </div>
              <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; font-weight: 600; margin: 20px 0 12px;">AI Assistants</div>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 10px; padding: 6px 8px; border-radius: var(--radius-sm); cursor: pointer;" class="grudge-member">
                  <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); display: flex; align-items: center; justify-content: center;">ü§ñ</div>
                  <div>
                    <div style="font-size: 13px; font-weight: 500;">CloudPilot AI</div>
                    <div style="font-size: 11px; color: var(--accent-green);">Always Online</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Launcher View -->
        <div class="view" id="view-launcher">
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
            <!-- Launcher Stats -->
            <div class="panel" style="grid-column: 1 / -1;">
              <div class="panel-content" style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 150px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.05)); padding: 20px; border-radius: var(--radius-md); border: 1px solid rgba(59, 130, 246, 0.3);">
                  <div style="font-size: 28px; font-weight: 700; color: var(--accent-blue);" id="launcherTotalApps">0</div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Total Apps</div>
                </div>
                <div style="flex: 1; min-width: 150px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.05)); padding: 20px; border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.3);">
                  <div style="font-size: 28px; font-weight: 700; color: var(--accent-green);" id="launcherRunningApps">0</div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Running</div>
                </div>
                <div style="flex: 1; min-width: 150px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.05)); padding: 20px; border-radius: var(--radius-md); border: 1px solid rgba(139, 92, 246, 0.3);">
                  <div style="font-size: 28px; font-weight: 700; color: var(--accent-purple);" id="launcherWorkflows">0</div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Workflows</div>
                </div>
                <div style="flex: 1; min-width: 150px; background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(236, 72, 153, 0.05)); padding: 20px; border-radius: var(--radius-md); border: 1px solid rgba(236, 72, 153, 0.3);">
                  <div style="font-size: 28px; font-weight: 700; color: var(--accent-pink);" id="launcherAgents">0</div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">AI Agents</div>
                </div>
              </div>
            </div>

            <!-- Quick Launch Section -->
            <div class="panel" style="grid-column: 1 / -1;">
              <div class="panel-header">
                <div class="panel-title"><span>‚ö°</span> Quick Launch</div>
                <button class="btn btn-primary" id="launcherRefreshBtn" style="padding: 6px 12px; font-size: 12px;" data-testid="button-refresh-launcher">üîÑ Refresh</button>
              </div>
              <div class="panel-content">
                <div id="launcherGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                  <!-- Launcher items will be rendered here -->
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title"><span>üìä</span> Recent Activity</div>
              </div>
              <div class="panel-content">
                <div id="launcherActivity" style="display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto;">
                  <div style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;">No recent activity</div>
                </div>
              </div>
            </div>

            <!-- AI Suggestions -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-title"><span>üß†</span> AI Suggestions</div>
                <span style="font-size: 11px; color: var(--accent-purple); background: rgba(139, 92, 246, 0.15); padding: 4px 8px; border-radius: var(--radius-sm);">Auto-Learning</span>
              </div>
              <div class="panel-content">
                <div id="launcherSuggestions" style="display: flex; flex-direction: column; gap: 12px;">
                  <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); border-left: 3px solid var(--accent-purple);">
                    <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Autonomous Improvement</div>
                    <div style="font-size: 12px; color: var(--text-muted);">The system learns from your interactions and suggests improvements automatically.</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Favorites -->
            <div class="panel" style="grid-column: 1 / -1;">
              <div class="panel-header">
                <div class="panel-title"><span>‚≠ê</span> Favorites</div>
                <button class="btn btn-secondary" id="launcherAddFavoriteBtn" style="padding: 6px 12px; font-size: 12px;" data-testid="button-add-favorite">+ Add Favorite</button>
              </div>
              <div class="panel-content">
                <div id="launcherFavorites" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;">
                  <!-- Favorites will be rendered here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- GrudgeOS Canvas Studio View -->
        <div class="view" id="view-canvas">
          <div style="display: grid; grid-template-columns: 260px 1fr 280px; gap: 12px; height: calc(100vh - 120px);">
            <!-- Left Panel - Layers & Templates -->
            <div style="display: flex; flex-direction: column; gap: 12px; overflow: hidden;">
              <!-- Toolbar -->
              <div class="panel" style="padding: 10px;">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  <button class="btn btn-secondary canvas-tool active" data-tool="select" style="padding: 8px 10px; font-size: 16px;" title="Select (V)" data-testid="btn-tool-select">üëÜ</button>
                  <button class="btn btn-secondary canvas-tool" data-tool="rect" style="padding: 8px 10px; font-size: 16px;" title="Rectangle (R)" data-testid="btn-tool-rect">‚¨ú</button>
                  <button class="btn btn-secondary canvas-tool" data-tool="circle" style="padding: 8px 10px; font-size: 16px;" title="Circle (C)" data-testid="btn-tool-circle">‚≠ï</button>
                  <button class="btn btn-secondary canvas-tool" data-tool="text" style="padding: 8px 10px; font-size: 16px;" title="Text (T)" data-testid="btn-tool-text">üìù</button>
                  <button class="btn btn-secondary canvas-tool" data-tool="image" style="padding: 8px 10px; font-size: 16px;" title="Image (I)" data-testid="btn-tool-image">üñºÔ∏è</button>
                </div>
              </div>

              <!-- Layers Panel -->
              <div class="panel" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="panel-header" style="padding: 10px 14px;">
                  <div class="panel-title" style="font-size: 13px;"><span>üìë</span> Layers</div>
                  <button class="btn btn-secondary" id="canvasAddLayerBtn" style="padding: 4px 8px; font-size: 11px;">+ Layer</button>
                </div>
                <div id="canvasLayersList" style="flex: 1; overflow-y: auto; padding: 8px;">
                  <div class="empty-state" style="padding: 16px; font-size: 12px;">
                    <div>No layers yet</div>
                    <div style="color: var(--text-muted); margin-top: 4px;">Click + Layer to add</div>
                  </div>
                </div>
              </div>

              <!-- Template Gallery -->
              <div class="panel" style="max-height: 300px; display: flex; flex-direction: column; overflow: hidden;">
                <div class="panel-header" style="padding: 10px 14px;">
                  <div class="panel-title" style="font-size: 13px;"><span>üìã</span> Templates</div>
                </div>
                <div id="canvasTemplates" style="flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column; gap: 6px;">
                  <div class="template-item" data-template="fullstack-react" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">üåê Full-Stack React</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Complete web app</div>
                  </div>
                  <div class="template-item" data-template="rest-api" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">‚ö° REST API</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">API with validation</div>
                  </div>
                  <div class="template-item" data-template="ai-chatbot" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">ü§ñ AI Chatbot</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Conversational AI</div>
                  </div>
                  <div class="template-item" data-template="data-dashboard" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">üìä Data Dashboard</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Charts & analytics</div>
                  </div>
                  <div class="template-item" data-template="multiplayer-game" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">üéÆ Multiplayer Game</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Real-time sync</div>
                  </div>
                  <div class="template-item" data-template="landing-page" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">üè† Landing Page</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Marketing site</div>
                  </div>
                  <div class="template-item" data-template="automation-pipeline" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">üîÑ Automation</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Workflow pipeline</div>
                  </div>
                  <div class="template-item" data-template="ecommerce-store" style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); cursor: pointer; border: 1px solid var(--border-color); transition: all 0.2s;">
                    <div style="font-size: 12px; font-weight: 600;">üõí E-Commerce</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Online store</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Center - Canvas -->
            <div class="panel" style="display: flex; flex-direction: column; overflow: hidden; position: relative;">
              <!-- Canvas Header -->
              <div class="panel-header" style="padding: 8px 14px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div class="panel-title" style="font-size: 13px;"><span>üé®</span> Canvas Studio</div>
                  <div style="display: flex; gap: 4px;">
                    <button class="btn btn-secondary" id="canvasZoomOutBtn" style="padding: 4px 8px; font-size: 14px;" title="Zoom Out">‚àí</button>
                    <span id="canvasZoomLevel" style="padding: 4px 10px; background: var(--bg-secondary); border-radius: var(--radius-sm); font-size: 12px; min-width: 50px; text-align: center;">100%</span>
                    <button class="btn btn-secondary" id="canvasZoomInBtn" style="padding: 4px 8px; font-size: 14px;" title="Zoom In">+</button>
                    <button class="btn btn-secondary" id="canvasZoomFitBtn" style="padding: 4px 8px; font-size: 12px;" title="Fit View">Fit</button>
                  </div>
                </div>
                <div style="display: flex; gap: 6px;">
                  <button class="btn btn-secondary" id="canvasUndoBtn" style="padding: 6px 10px; font-size: 12px;" title="Undo (Ctrl+Z)">‚Ü©Ô∏è Undo</button>
                  <button class="btn btn-secondary" id="canvasRedoBtn" style="padding: 6px 10px; font-size: 12px;" title="Redo (Ctrl+Y)">‚Ü™Ô∏è Redo</button>
                  <button class="btn btn-success" id="canvasExportBtn" style="padding: 6px 12px; font-size: 12px;">üíæ Export</button>
                </div>
              </div>
              <!-- Canvas Container (fixed internal size, zoomable viewport) -->
              <div id="canvasContainer" style="flex: 1; position: relative; overflow: hidden; background: #0a0a1a;"></div>
              <!-- Canvas Status Bar -->
              <div style="padding: 6px 14px; background: var(--bg-secondary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
                <div>Canvas: 4096 √ó 2304 | <span id="canvasNodeCount">0</span> objects</div>
                <div>Pan: Alt+Drag or Middle Mouse | Zoom: Scroll</div>
              </div>
            </div>

            <!-- Right Panel - Properties & AI Journal -->
            <div style="display: flex; flex-direction: column; gap: 12px; overflow: hidden;">
              <!-- Properties Panel -->
              <div class="panel" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="panel-header" style="padding: 10px 14px;">
                  <div class="panel-title" style="font-size: 13px;"><span>‚öôÔ∏è</span> Properties</div>
                </div>
                <div id="canvasProperties" style="flex: 1; overflow-y: auto; padding: 12px;">
                  <div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">
                    Select an object to edit its properties
                  </div>
                </div>
              </div>

              <!-- AI Journal - Undo AI Changes -->
              <div class="panel" style="max-height: 320px; display: flex; flex-direction: column; overflow: hidden;">
                <div class="panel-header" style="padding: 10px 14px;">
                  <div class="panel-title" style="font-size: 13px;"><span>üß†</span> AI Journal</div>
                  <span style="font-size: 10px; color: var(--accent-purple); background: rgba(139, 92, 246, 0.15); padding: 3px 6px; border-radius: var(--radius-sm);">Revert AI</span>
                </div>
                <div style="padding: 8px 12px; border-bottom: 1px solid var(--border-color);">
                  <div style="display: flex; gap: 6px;">
                    <button class="btn btn-secondary" id="aiUndoLast1Btn" style="flex: 1; padding: 8px 4px; font-size: 11px;" data-testid="btn-ai-undo-1">Undo 1</button>
                    <button class="btn btn-secondary" id="aiUndoLast2Btn" style="flex: 1; padding: 8px 4px; font-size: 11px;" data-testid="btn-ai-undo-2">Undo 2</button>
                    <button class="btn btn-secondary" id="aiUndoLast3Btn" style="flex: 1; padding: 8px 4px; font-size: 11px;" data-testid="btn-ai-undo-3">Undo 3</button>
                  </div>
                </div>
                <div id="aiJournalList" style="flex: 1; overflow-y: auto; padding: 8px;">
                  <div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 16px;">
                    No AI changes recorded yet
                  </div>
                </div>
              </div>

              <!-- Keyboard Shortcuts -->
              <div class="panel" style="padding: 10px 14px;">
                <div style="font-size: 11px; color: var(--text-muted);">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>Copy</span><span style="color: var(--text-secondary);">Ctrl+C</span></div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>Paste</span><span style="color: var(--text-secondary);">Ctrl+V</span></div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;"><span>Duplicate</span><span style="color: var(--text-secondary);">Ctrl+D</span></div>
                  <div style="display: flex; justify-content: space-between;"><span>Delete</span><span style="color: var(--text-secondary);">Del</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Agent Operations Hub View -->
      <div class="view" id="agent-hubView" style="display: none; height: 100%; overflow: hidden;">
        <div style="display: grid; grid-template-columns: 280px 1fr 300px; height: 100%; gap: 0;">
          <!-- Left Panel: Agent List & Create -->
          <div style="background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden;">
            <div style="padding: 16px; border-bottom: 1px solid var(--border-color);">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <h3 style="font-size: 14px; font-weight: 600; margin: 0; color: var(--text-primary);">Agents</h3>
                <button class="btn btn-primary btn-sm" id="createAgentBtn" data-testid="button-create-agent" style="font-size: 11px; padding: 4px 10px;">+ New</button>
              </div>
              <div style="display: flex; gap: 6px;">
                <div style="flex: 1; padding: 8px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); text-align: center;">
                  <div style="font-size: 18px; font-weight: 600; color: var(--accent-green);" id="activeAgentCount">0</div>
                  <div style="font-size: 10px; color: var(--text-muted);">Active</div>
                </div>
                <div style="flex: 1; padding: 8px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); text-align: center;">
                  <div style="font-size: 18px; font-weight: 600; color: var(--text-secondary);" id="totalAgentCount">0</div>
                  <div style="font-size: 10px; color: var(--text-muted);">Total</div>
                </div>
              </div>
            </div>
            <div id="agentList" style="flex: 1; overflow-y: auto; padding: 8px;">
              <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
                <div style="font-size: 32px; margin-bottom: 8px;">ü§ñ</div>
                <div style="font-size: 12px;">No agents yet</div>
                <div style="font-size: 11px; margin-top: 4px;">Click "+ New" to create one</div>
              </div>
            </div>
          </div>

          <!-- Center Panel: Terminals & Shells -->
          <div style="display: flex; flex-direction: column; overflow: hidden;">
            <!-- Terminal Tabs -->
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);">
              <div id="terminalTabs" style="display: flex; gap: 4px; flex: 1; overflow-x: auto;">
                <div class="terminal-tab active" data-testid="tab-main-terminal" style="padding: 6px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); font-size: 12px; cursor: pointer; white-space: nowrap; border: 1px solid var(--border-color);">
                  <span style="margin-right: 6px;">üíª</span>Main Terminal
                </div>
              </div>
              <button class="btn btn-ghost btn-sm" id="addTerminalBtn" data-testid="button-add-terminal" style="font-size: 14px; padding: 4px 8px;">+</button>
            </div>

            <!-- Terminal Content -->
            <div id="agentTerminalContainer" style="flex: 1; background: #1a1b26; display: flex; flex-direction: column; overflow: hidden;">
              <div id="terminalOutput" style="flex: 1; overflow-y: auto; padding: 12px; font-family: var(--font-mono); font-size: 12px; line-height: 1.6; color: #a9b1d6;">
                <div style="color: #7aa2f7;">Welcome to CloudPilot Agent Terminal</div>
                <div style="color: #565f89;">Type commands or use @ai for AI assistance</div>
                <div style="color: #565f89; margin-bottom: 12px;">---</div>
              </div>
              <div style="display: flex; align-items: center; padding: 8px 12px; background: #16161e; border-top: 1px solid #24283b;">
                <span style="color: #7aa2f7; margin-right: 8px; font-family: var(--font-mono); font-size: 12px;">$</span>
                <input type="text" id="terminalInput" data-testid="input-terminal-command" placeholder="Enter command..." style="flex: 1; background: transparent; border: none; color: #a9b1d6; font-family: var(--font-mono); font-size: 12px; outline: none;">
                <button class="btn btn-primary btn-sm" id="runCommandBtn" data-testid="button-run-command" style="font-size: 11px; padding: 4px 12px;">Run</button>
              </div>
            </div>

            <!-- Code Ninja Shells -->
            <div style="border-top: 1px solid var(--border-color); background: var(--bg-secondary);">
              <div style="padding: 10px 16px; border-bottom: 1px solid var(--border-color);">
                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">Code Ninja Shells</div>
              </div>
              <div id="codeNinjaShells" style="display: flex; gap: 8px; padding: 12px 16px; overflow-x: auto;">
                <div class="ninja-shell" data-template="build" data-testid="shell-build" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; min-width: 100px; text-align: center; border: 1px solid var(--border-color); transition: all 0.2s;">
                  <div style="font-size: 20px; margin-bottom: 4px;">üî®</div>
                  <div style="font-size: 11px; font-weight: 500;">Build</div>
                </div>
                <div class="ninja-shell" data-template="test" data-testid="shell-test" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; min-width: 100px; text-align: center; border: 1px solid var(--border-color); transition: all 0.2s;">
                  <div style="font-size: 20px; margin-bottom: 4px;">üß™</div>
                  <div style="font-size: 11px; font-weight: 500;">Test</div>
                </div>
                <div class="ninja-shell" data-template="debug" data-testid="shell-debug" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; min-width: 100px; text-align: center; border: 1px solid var(--border-color); transition: all 0.2s;">
                  <div style="font-size: 20px; margin-bottom: 4px;">üêõ</div>
                  <div style="font-size: 11px; font-weight: 500;">Debug</div>
                </div>
                <div class="ninja-shell" data-template="generate" data-testid="shell-generate" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; min-width: 100px; text-align: center; border: 1px solid var(--border-color); transition: all 0.2s;">
                  <div style="font-size: 20px; margin-bottom: 4px;">‚ú®</div>
                  <div style="font-size: 11px; font-weight: 500;">Generate</div>
                </div>
                <div class="ninja-shell" data-template="analyze" data-testid="shell-analyze" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; min-width: 100px; text-align: center; border: 1px solid var(--border-color); transition: all 0.2s;">
                  <div style="font-size: 20px; margin-bottom: 4px;">üîç</div>
                  <div style="font-size: 11px; font-weight: 500;">Analyze</div>
                </div>
                <div class="ninja-shell" data-template="deploy" data-testid="shell-deploy" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); cursor: pointer; min-width: 100px; text-align: center; border: 1px solid var(--border-color); transition: all 0.2s;">
                  <div style="font-size: 20px; margin-bottom: 4px;">üöÄ</div>
                  <div style="font-size: 11px; font-weight: 500;">Deploy</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Panel: Pods & Tasks -->
          <div style="background: var(--bg-secondary); border-left: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden;">
            <!-- Compute Pods Section -->
            <div style="border-bottom: 1px solid var(--border-color);">
              <div style="padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Compute Pods</div>
                <button class="btn btn-ghost btn-sm" id="createPodBtn" data-testid="button-create-pod" style="font-size: 11px;">+ Pod</button>
              </div>
              <div id="podGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 12px; max-height: 200px; overflow-y: auto;">
                <div style="grid-column: span 2; text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">
                  No pods running
                </div>
              </div>
            </div>

            <!-- Task Queue Section -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
              <div style="padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">Task Queue</div>
                <div style="font-size: 11px; color: var(--text-muted);"><span id="taskQueueCount">0</span> tasks</div>
              </div>
              <div id="taskQueue" style="flex: 1; overflow-y: auto; padding: 8px;">
                <div style="text-align: center; padding: 30px 20px; color: var(--text-muted);">
                  <div style="font-size: 24px; margin-bottom: 8px;">üìã</div>
                  <div style="font-size: 11px;">No pending tasks</div>
                </div>
              </div>
            </div>

            <!-- Resource Usage -->
            <div style="padding: 12px 16px; border-top: 1px solid var(--border-color); background: var(--bg-tertiary);">
              <div style="font-size: 11px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Resource Usage</div>
              <div style="display: flex; gap: 12px;">
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">
                    <span>CPU</span><span id="cpuUsage">0%</span>
                  </div>
                  <div style="height: 4px; background: var(--bg-secondary); border-radius: 2px; overflow: hidden;">
                    <div id="cpuBar" style="height: 100%; width: 0%; background: var(--accent-blue); transition: width 0.3s;"></div>
                  </div>
                </div>
                <div style="flex: 1;">
                  <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); margin-bottom: 4px;">
                    <span>Memory</span><span id="memUsage">0 MB</span>
                  </div>
                  <div style="height: 4px; background: var(--bg-secondary); border-radius: 2px; overflow: hidden;">
                    <div id="memBar" style="height: 100%; width: 0%; background: var(--accent-purple); transition: width 0.3s;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Create Folder Modal -->
  <div class="modal-overlay" id="folderModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">üìÅ New Folder</div>
        <button class="modal-close" data-close-modal>&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Folder Name</label>
          <input type="text" class="form-input" id="folderNameInput" placeholder="My Folder">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-close-modal>Cancel</button>
        <button class="btn btn-primary" id="createFolderBtn">Create</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CLOUDPILOT AI - Autonomous Cloud Agent
    // Multi-model AI with tool execution
    // ============================================

    // ============ APP STATE ============
    const state = {
      user: null,
      currentPath: '/',
      files: [],
      apps: [],
      functions: [],
      workflows: [],
      agentTasks: 0,
      chatHistory: [],
      isAgentRunning: false,
      selectedModel: 'auto',
      apiStatus: null
    };

    // Auto AI Model Selection - picks best model for each task type
    const autoAI = {
      // Task type detection patterns
      patterns: {
        code: /\b(code|function|class|import|export|const|let|var|async|await|return|if|else|for|while|switch|try|catch|html|css|javascript|typescript|python|react|node|api|endpoint|database|sql|query|bug|fix|debug|refactor|optimize)\b/i,
        creative: /\b(write|story|poem|creative|imagine|generate|describe|essay|article|blog|content|marketing|copy)\b/i,
        analysis: /\b(analyze|explain|summarize|compare|review|evaluate|assess|understand|break down|what is|how does|why)\b/i,
        chat: /\b(hi|hello|hey|thanks|thank you|please|help|can you|would you|could you)\b/i,
        math: /\b(calculate|math|equation|formula|solve|compute|number|percentage|ratio)\b/i
      },
      
      // Model recommendations by task type
      models: {
        code: 'claude-sonnet-4',        // Claude Sonnet 4 - best for coding
        creative: 'gpt-4o',              // GPT-4o - strong creative writing
        analysis: 'claude-sonnet-4',     // Claude - excellent analysis
        chat: 'gpt-4o-mini',             // Fast for simple chat
        math: 'claude-sonnet-4',         // Claude - precise math
        default: 'claude-sonnet-4'       // Default to Claude for code-focused studio
      },
      
      // Detect task type from prompt
      detectTaskType(prompt) {
        const lower = prompt.toLowerCase();
        
        // Priority order: code > analysis > creative > math > chat
        if (this.patterns.code.test(lower)) return 'code';
        if (this.patterns.analysis.test(lower)) return 'analysis';
        if (this.patterns.creative.test(lower)) return 'creative';
        if (this.patterns.math.test(lower)) return 'math';
        if (this.patterns.chat.test(lower)) return 'chat';
        
        return 'default';
      },
      
      // Get best model for a prompt
      selectModel(prompt) {
        if (state.selectedModel !== 'auto') {
          return state.selectedModel;
        }
        
        const taskType = this.detectTaskType(prompt);
        const model = this.models[taskType];
        console.log(`Auto AI: Detected "${taskType}" task, using ${model}`);
        return model;
      },
      
      // Get model info for display
      getModelInfo(model) {
        const info = {
          'claude-sonnet-4': { name: 'Claude Sonnet 4', strength: 'Code & Analysis', icon: 'üß†' },
          'claude-3-5-sonnet': { name: 'Claude 3.5 Sonnet', strength: 'Balanced', icon: 'üéØ' },
          'gpt-4o': { name: 'GPT-4o', strength: 'General & Creative', icon: '‚ú®' },
          'gpt-4o-mini': { name: 'GPT-4o Mini', strength: 'Fast Responses', icon: '‚ö°' },
          'google/gemini-2.5-flash': { name: 'Gemini 2.5', strength: 'Multimodal', icon: 'üåü' },
          'deepseek/deepseek-chat': { name: 'DeepSeek', strength: 'Reasoning', icon: 'üîç' }
        };
        return info[model] || { name: model, strength: 'AI', icon: 'ü§ñ' };
      }
    };

    // ============ PUTER AI (FREE) ============
    async function callAI(messages, options = {}) {
      // Always use Puter AI - completely free with GPT-4o, Claude, Gemini, DeepSeek
      // If Auto mode is enabled, select best model for the task
      let model = options.model;
      if (!model || model === 'auto') {
        // Extract prompt from messages for task detection
        const prompt = Array.isArray(messages) 
          ? messages.map(m => m.content).join(' ')
          : messages;
        model = autoAI.selectModel(prompt);
      }
      return puter.ai.chat(messages, { model });
    }

    async function checkAPIStatus() {
      try {
        const response = await fetch('/api/health');
        state.apiStatus = await response.json();
        console.log('API Status:', state.apiStatus);
      } catch (e) {
        console.log('Backend API not available');
      }
    }

    // ============ CONTEXT MANAGER ============
    class ContextManager {
      constructor(maxTokens = 6000) {
        this.entries = [];
        this.maxTokens = maxTokens;
      }

      add(type, content, priority = 5) {
        this.entries.push({ type, content, priority, timestamp: Date.now() });
        this.prune();
      }

      addFile(path, content) { this.add('file', `File: ${path}\n${content}`, 8); }
      addConversation(msg) { this.add('conversation', msg, 10); }
      addSystemState(info) { this.add('system', info, 7); }

      build() {
        return this.entries
          .sort((a, b) => b.priority - a.priority)
          .map(e => e.content)
          .join('\n\n');
      }

      prune() {
        this.entries.sort((a, b) => b.priority - a.priority);
        let tokens = 0;
        this.entries = this.entries.filter(e => {
          tokens += Math.ceil(e.content.length / 4);
          return tokens <= this.maxTokens;
        });
      }

      clear() { this.entries = []; }
    }

    const contextManager = new ContextManager();

    // ============ PUTER SDK KNOWLEDGE BASE ============
    const PUTER_SDK = {
      fs: {
        name: 'puter.fs',
        description: 'Cloud filesystem - store, read, and manage files',
        cli: 'puter fs',
        methods: {
          'readdir(path)': 'List directory contents - returns array of file objects',
          'read(path)': 'Read file content as text or Blob',
          'write(path, content)': 'Write content to file (string or Blob)',
          'mkdir(path)': 'Create directory',
          'delete(path, {recursive})': 'Delete file or folder',
          'move(from, to)': 'Move/rename file',
          'copy(from, to)': 'Copy file',
          'publicURL(path)': 'Get public URL for file',
          'stat(path)': 'Get file metadata'
        },
        priority: 'HIGH - Use for all file operations'
      },
      kv: {
        name: 'puter.kv',
        description: 'Key-value storage - persist data, preferences, state',
        cli: 'puter kv',
        methods: {
          'get(key)': 'Retrieve value by key (returns null if not found)',
          'set(key, value)': 'Store value (must be string - use JSON.stringify)',
          'del(key)': 'Delete key',
          'list()': 'List all keys'
        },
        priority: 'HIGH - Use for all data persistence'
      },
      hosting: {
        name: 'puter.hosting',
        description: 'Deploy live websites to subdomain.puter.site',
        cli: 'puter hosting',
        methods: {
          'create(subdomain, dirPath)': 'Deploy directory to subdomain.puter.site',
          'update(subdomain, dirPath)': 'Update existing deployment',
          'delete(subdomain)': 'Remove deployment',
          'list()': 'List all deployments'
        },
        priority: 'HIGH - Use for all live deployments'
      },
      ai: {
        name: 'puter.ai',
        description: 'Free AI models - GPT-4o, Claude, Gemini, DeepSeek',
        cli: 'puter ai',
        methods: {
          'chat(prompt, {model})': 'Send chat message, returns {message: {content}}',
          'txt2img(prompt)': 'Generate image from text',
          'img2txt(image)': 'Describe image content'
        },
        models: ['gpt-4o-mini', 'gpt-4o', 'claude-3-5-sonnet', 'gemini-1.5-flash', 'deepseek-chat'],
        priority: 'HIGH - Use for all AI operations (FREE)'
      },
      auth: {
        name: 'puter.auth',
        description: 'User authentication and identity',
        methods: {
          'getUser()': 'Get current user info',
          'signIn()': 'Prompt user sign-in',
          'signOut()': 'Sign out user'
        },
        priority: 'REQUIRED - User must be signed in for all operations'
      }
    };

    // ============ AGENT CONSTITUTION ============
    const AGENT_CONSTITUTION = {
      laws: [
        {
          id: 'LAW_1',
          name: 'USER COMMAND SUPREMACY',
          rule: 'User requests are LAW. Execute immediately without question unless unsafe.',
          priority: 1
        },
        {
          id: 'LAW_2', 
          name: 'PUTER FIRST',
          rule: 'Always prefer Puter SDK operations over alternatives. Puter provides free, persistent, user-owned storage and AI.',
          priority: 2
        },
        {
          id: 'LAW_3',
          name: 'NO MOCK DATA',
          rule: 'Never use placeholder or mock data. Always persist real data to Puter KV.',
          priority: 3
        },
        {
          id: 'LAW_4',
          name: 'AUTONOMOUS EXECUTION',
          rule: 'Complete tasks fully without interrupting user unless blocked.',
          priority: 4
        },
        {
          id: 'LAW_5',
          name: 'LEARN AND REMEMBER',
          rule: 'Store user preferences, patterns, and history in AI memory via Puter KV.',
          priority: 5
        }
      ],
      
      getPuterPriority() {
        return `
CRITICAL OPERATING RULES:
${this.laws.map(l => `${l.id}: ${l.name} - ${l.rule}`).join('\n')}

PUTER SDK KNOWLEDGE (USE THESE APIs):
${Object.entries(PUTER_SDK).map(([k, v]) => 
  `${v.name} [${v.priority}]\n  ${v.description}\n  Methods: ${Object.keys(v.methods || {}).join(', ')}`
).join('\n\n')}

PERSISTENCE MODEL:
- ALL state must persist to puter.kv (user-owned, survives restarts)
- ALL files go to puter.fs (cloud storage with public URLs)
- ALL deployments use puter.hosting (live *.puter.site domains)
- ALL AI calls can use puter.ai (FREE, no API key needed)
`;
      }
    };

    // ============ TOOLS REGISTRY ============
    const tools = {
      list_files: {
        name: 'list_files',
        description: 'List files in a directory',
        execute: async (params) => {
          const path = params.path || '/';
          const files = await puter.fs.readdir(path);
          return { success: true, files: files.map(f => ({ name: f.name, isDir: f.is_dir, size: f.size })) };
        }
      },
      create_folder: {
        name: 'create_folder',
        description: 'Create a new folder',
        execute: async (params) => {
          await puter.fs.mkdir(params.path);
          return { success: true, message: `Folder created: ${params.path}` };
        }
      },
      write_file: {
        name: 'write_file',
        description: 'Write content to a file',
        execute: async (params) => {
          await puter.fs.write(params.path, params.content);
          return { success: true, message: `File written: ${params.path}` };
        }
      },
      read_file: {
        name: 'read_file',
        description: 'Read content from a file',
        execute: async (params) => {
          const content = await puter.fs.read(params.path);
          const text = typeof content === 'string' ? content : await content.text();
          return { success: true, content: text };
        }
      },
      delete_file: {
        name: 'delete_file',
        description: 'Delete a file or folder',
        execute: async (params) => {
          await puter.fs.delete(params.path);
          return { success: true, message: `Deleted: ${params.path}` };
        }
      },
      deploy_app: {
        name: 'deploy_app',
        description: 'Deploy a web application',
        execute: async (params) => {
          const appDir = `/apps/${params.name}`;
          await puter.fs.mkdir(appDir).catch(() => {});
          await puter.fs.write(`${appDir}/index.html`, params.html);
          const url = await puter.fs.publicURL(`${appDir}/index.html`);
          
          // Save to apps list
          const apps = JSON.parse(await puter.kv.get('cloudpilot_apps') || '[]');
          apps.push({ name: params.name, url, createdAt: new Date().toISOString() });
          await puter.kv.set('cloudpilot_apps', JSON.stringify(apps));
          
          return { success: true, url, message: `App deployed: ${params.name}` };
        }
      },
      save_function: {
        name: 'save_function',
        description: 'Save a serverless function',
        execute: async (params) => {
          const functions = JSON.parse(await puter.kv.get('cloudpilot_functions') || '[]');
          const idx = functions.findIndex(f => f.name === params.name);
          const fn = { name: params.name, code: params.code, updatedAt: new Date().toISOString() };
          if (idx >= 0) functions[idx] = fn;
          else functions.push({ ...fn, createdAt: new Date().toISOString() });
          await puter.kv.set('cloudpilot_functions', JSON.stringify(functions));
          return { success: true, message: `Function saved: ${params.name}` };
        }
      },
      run_function: {
        name: 'run_function',
        description: 'Execute a serverless function',
        execute: async (params) => {
          const fn = new Function('request', `return (async () => { ${params.code} return handler({}); })();`);
          const result = await fn({});
          return { success: true, result };
        }
      },
      get_storage_info: {
        name: 'get_storage_info',
        description: 'Get storage usage information',
        execute: async () => {
          const files = await puter.fs.readdir('/');
          let totalSize = 0;
          const fileList = [];
          for (const f of files) {
            if (!f.is_dir && f.size) totalSize += f.size;
            fileList.push({ name: f.name, isDir: f.is_dir, size: f.size || 0 });
          }
          return { success: true, totalFiles: files.length, totalSize, files: fileList };
        }
      },
      save_workflow: {
        name: 'save_workflow',
        description: 'Save an automated workflow',
        execute: async (params) => {
          const workflows = JSON.parse(await puter.kv.get('cloudpilot_workflows') || '[]');
          workflows.push({ name: params.name, steps: params.steps, createdAt: new Date().toISOString() });
          await puter.kv.set('cloudpilot_workflows', JSON.stringify(workflows));
          return { success: true, message: `Workflow saved: ${params.name}` };
        }
      },
      scan_ports: {
        name: 'scan_ports',
        description: 'Inventory deployed apps, functions, and cloud services',
        execute: async () => {
          // Scan deployed apps and functions for exposed ports/endpoints
          const apps = JSON.parse(await puter.kv.get('cloudpilot_apps') || '[]');
          const functions = JSON.parse(await puter.kv.get('cloudpilot_functions') || '[]');
          
          const services = [];
          
          // Add deployed apps as services
          apps.forEach((app, i) => {
            services.push({
              id: `app-${i}`,
              name: app.name,
              type: 'web-app',
              port: 443,
              protocol: 'HTTPS',
              status: 'open',
              url: app.url,
              secured: true,
              createdAt: app.createdAt
            });
          });
          
          // Add functions as serverless endpoints
          functions.forEach((fn, i) => {
            services.push({
              id: `fn-${i}`,
              name: fn.name,
              type: 'function',
              port: 443,
              protocol: 'HTTPS',
              status: 'open',
              secured: true,
              createdAt: fn.createdAt || fn.updatedAt
            });
          });
          
          // Add simulated cloud services
          services.push(
            { id: 'puter-fs', name: 'Puter Storage', type: 'storage', port: 443, protocol: 'HTTPS', status: 'open', secured: true },
            { id: 'puter-kv', name: 'Puter KV Store', type: 'database', port: 443, protocol: 'HTTPS', status: 'open', secured: true },
            { id: 'puter-ai', name: 'Puter AI API', type: 'api', port: 443, protocol: 'HTTPS', status: 'open', secured: true }
          );
          
          await puter.kv.set('cloudpilot_services', JSON.stringify(services));
          addAuditEntry('Service inventory completed', `Found ${services.length} services`);
          
          return { 
            success: true, 
            services,
            summary: {
              total: services.length,
              open: services.filter(s => s.status === 'open').length,
              secured: services.filter(s => s.secured).length
            }
          };
        }
      },
      get_access_policies: {
        name: 'get_access_policies',
        description: 'Get all configured access control policies',
        execute: async () => {
          const policies = JSON.parse(await puter.kv.get('cloudpilot_policies') || '[]');
          return { success: true, policies };
        }
      },
      create_access_policy: {
        name: 'create_access_policy',
        description: 'Create a new access control policy',
        execute: async (params) => {
          const policies = JSON.parse(await puter.kv.get('cloudpilot_policies') || '[]');
          const policy = {
            id: `policy-${Date.now()}`,
            name: params.name,
            type: params.type || 'allow',
            target: params.target,
            conditions: params.conditions || {},
            enabled: true,
            createdAt: new Date().toISOString()
          };
          policies.push(policy);
          await puter.kv.set('cloudpilot_policies', JSON.stringify(policies));
          addAuditEntry('Policy created', policy.name);
          return { success: true, policy, message: `Policy created: ${policy.name}` };
        }
      },
      delete_access_policy: {
        name: 'delete_access_policy',
        description: 'Delete an access control policy',
        execute: async (params) => {
          let policies = JSON.parse(await puter.kv.get('cloudpilot_policies') || '[]');
          const idx = policies.findIndex(p => p.id === params.id || p.name === params.name);
          if (idx >= 0) {
            const deleted = policies.splice(idx, 1)[0];
            await puter.kv.set('cloudpilot_policies', JSON.stringify(policies));
            addAuditEntry('Policy deleted', deleted.name);
            return { success: true, message: `Policy deleted: ${deleted.name}` };
          }
          return { success: false, message: 'Policy not found' };
        }
      },
      auto_secure: {
        name: 'auto_secure',
        description: 'Apply recommended access policies to all cloud services',
        execute: async () => {
          const services = JSON.parse(await puter.kv.get('cloudpilot_services') || '[]');
          let policies = JSON.parse(await puter.kv.get('cloudpilot_policies') || '[]');
          
          const recommendations = [];
          
          // Auto-create policies for unsecured or exposed services
          for (const svc of services) {
            const hasPolicy = policies.some(p => p.target === svc.id || p.target === svc.name);
            if (!hasPolicy && svc.type === 'web-app') {
              const policy = {
                id: `policy-${Date.now()}-${svc.id}`,
                name: `Secure ${svc.name}`,
                type: 'rate-limit',
                target: svc.id,
                conditions: { maxRequests: 100, windowMs: 60000 },
                enabled: true,
                createdAt: new Date().toISOString()
              };
              policies.push(policy);
              recommendations.push(`Added rate limiting for ${svc.name}`);
            }
          }
          
          // Add default policies if none exist
          if (policies.length === 0) {
            policies.push(
              { id: 'default-https', name: 'Enforce HTTPS', type: 'security', target: '*', conditions: { forceHttps: true }, enabled: true, createdAt: new Date().toISOString() },
              { id: 'default-auth', name: 'Require Auth for Admin', type: 'auth', target: '/admin/*', conditions: { requireAuth: true }, enabled: true, createdAt: new Date().toISOString() }
            );
            recommendations.push('Added HTTPS enforcement policy', 'Added admin authentication policy');
          }
          
          await puter.kv.set('cloudpilot_policies', JSON.stringify(policies));
          addAuditEntry('Auto-secure completed', `${recommendations.length} policies applied`);
          
          return {
            success: true,
            policiesApplied: recommendations.length,
            recommendations,
            message: `Auto-secure complete: ${recommendations.length} security policies applied`
          };
        }
      },
      get_audit_log: {
        name: 'get_audit_log',
        description: 'Get the access audit log',
        puterApi: 'puter.kv',
        execute: async () => {
          const log = JSON.parse(await puter.kv.get('cloudpilot_audit') || '[]');
          return { success: true, entries: log.slice(-50) };
        }
      },
      
      // ============ PUTER-NATIVE TOOLS ============
      deploy_live_site: {
        name: 'deploy_live_site',
        description: 'Deploy a website to LIVE hosting at subdomain.puter.site',
        puterApi: 'puter.hosting',
        execute: async (params) => {
          const { subdomain, html, name } = params;
          if (!subdomain || !html) throw new Error('subdomain and html required');
          
          // Create directory and files
          await puter.fs.mkdir(subdomain).catch(() => {});
          await puter.fs.write(`${subdomain}/index.html`, html);
          
          // Deploy to live hosting
          const site = await puter.hosting.create(subdomain, subdomain);
          
          // Persist deployment
          const data = await puter.kv.get('cloudpilot_deployments');
          const deployments = data ? JSON.parse(data) : [];
          deployments.push({
            id: `deploy_${Date.now()}`,
            name: name || subdomain,
            subdomain,
            type: 'site',
            status: 'live',
            url: `https://${site.subdomain}.puter.site`,
            createdAt: new Date().toISOString()
          });
          await puter.kv.set('cloudpilot_deployments', JSON.stringify(deployments));
          
          return { 
            success: true, 
            url: `https://${site.subdomain}.puter.site`,
            message: `Live site deployed to ${site.subdomain}.puter.site`
          };
        }
      },
      
      store_data: {
        name: 'store_data',
        description: 'Persist data to Puter KV storage (user-owned, survives restarts)',
        puterApi: 'puter.kv',
        execute: async (params) => {
          const { key, value } = params;
          if (!key) throw new Error('key required');
          const data = typeof value === 'string' ? value : JSON.stringify(value);
          await puter.kv.set(key, data);
          return { success: true, message: `Data stored: ${key}` };
        }
      },
      
      get_data: {
        name: 'get_data',
        description: 'Retrieve data from Puter KV storage',
        puterApi: 'puter.kv',
        execute: async (params) => {
          const data = await puter.kv.get(params.key);
          if (!data) return { success: false, message: 'Key not found' };
          try {
            return { success: true, data: JSON.parse(data) };
          } catch {
            return { success: true, data };
          }
        }
      },
      
      call_ai: {
        name: 'call_ai',
        description: 'Call Puter AI (FREE) - GPT-4o, Claude, Gemini, DeepSeek',
        puterApi: 'puter.ai',
        execute: async (params) => {
          const { prompt, model = 'gpt-4o-mini' } = params;
          const response = await puter.ai.chat(prompt, { model });
          return { 
            success: true, 
            response: response?.message?.content || response
          };
        }
      },
      
      list_deployments: {
        name: 'list_deployments',
        description: 'List all live deployments on Puter hosting',
        puterApi: 'puter.kv',
        execute: async () => {
          const data = await puter.kv.get('cloudpilot_deployments');
          const deployments = data ? JSON.parse(data) : [];
          return { 
            success: true, 
            deployments,
            count: deployments.length,
            live: deployments.filter(d => d.status === 'live').length
          };
        }
      },
      
      delete_deployment: {
        name: 'delete_deployment',
        description: 'Delete a live deployment from Puter hosting',
        puterApi: 'puter.hosting',
        execute: async (params) => {
          const { subdomain } = params;
          await puter.hosting.delete(subdomain).catch(() => {});
          await puter.fs.delete(subdomain, { recursive: true }).catch(() => {});
          
          const data = await puter.kv.get('cloudpilot_deployments');
          let deployments = data ? JSON.parse(data) : [];
          deployments = deployments.filter(d => d.subdomain !== subdomain);
          await puter.kv.set('cloudpilot_deployments', JSON.stringify(deployments));
          
          return { success: true, message: `Deployment ${subdomain} deleted` };
        }
      },
      
      get_puter_info: {
        name: 'get_puter_info',
        description: 'Get Puter SDK documentation and available APIs',
        execute: async () => {
          return {
            success: true,
            sdk: PUTER_SDK,
            constitution: AGENT_CONSTITUTION.laws,
            message: 'Puter SDK: fs, kv, hosting, ai, auth. User commands are LAW.'
          };
        }
      }
    };

    // Audit log helper
    async function addAuditEntry(action, details) {
      if (!state.user) return;
      try {
        const log = JSON.parse(await puter.kv.get('cloudpilot_audit') || '[]');
        log.push({
          timestamp: new Date().toISOString(),
          action,
          details,
          user: state.user?.username || 'system'
        });
        // Keep last 100 entries
        if (log.length > 100) log.splice(0, log.length - 100);
        await puter.kv.set('cloudpilot_audit', JSON.stringify(log));
        updateAuditDisplay();
      } catch (e) { console.error('Audit log error:', e); }
    }

    function updateAuditDisplay() {
      puter.kv.get('cloudpilot_audit').then(data => {
        const log = JSON.parse(data || '[]').reverse().slice(0, 20);
        const container = document.getElementById('auditLog');
        if (!container) return;
        if (log.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No audit entries yet</div>';
          return;
        }
        container.innerHTML = log.map(entry => `
          <div style="display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
            <div style="font-size: 12px; color: var(--text-muted); min-width: 140px;">${new Date(entry.timestamp).toLocaleString()}</div>
            <div style="font-weight: 500; font-size: 13px;">${entry.action}</div>
            <div style="flex: 1; font-size: 12px; color: var(--text-secondary);">${entry.details}</div>
          </div>
        `).join('');
      }).catch(() => {});
    }

    // ============ AUTONOMOUS AGENT ============
    class AutonomousAgent {
      constructor(model = 'gpt-4o-mini') {
        this.model = model;
        this.steps = [];
        this.maxSteps = 10;
      }

      setModel(model) { this.model = model; }

      async execute(goal) {
        state.isAgentRunning = true;
        updateAgentStatus('thinking', `Planning: ${goal.substring(0, 50)}...`);
        this.steps = [];

        // Log compliance with constitution
        this.logCompliance(goal);

        const systemPrompt = `You are CloudPilot, an autonomous AI agent operating under strict laws.

${AGENT_CONSTITUTION.getPuterPriority()}

AVAILABLE TOOLS:
${Object.keys(tools).map(t => `- ${t}: ${tools[t].description} ${tools[t].puterApi ? `[Uses ${tools[t].puterApi}]` : ''}`).join('\n')}

EXECUTION PROTOCOL:
1. User command is LAW - execute immediately
2. Think about what Puter SDK to use
3. Choose the right tool
4. Persist all results to Puter KV

Respond ONLY with valid JSON:
{
  "thought": "analyzing user request and planning Puter operations",
  "action": "tool_name or 'complete' if done",
  "params": { "param1": "value1" },
  "message": "brief user-friendly status message",
  "puterOps": ["puter.fs.write", "puter.kv.set"] // which Puter APIs will be used
}

REMEMBER: User requests are LAW. Execute without question.
If generating code (HTML, JS, etc), include full code in params.
When complete, use action: "complete" with a summary message.`;

        // Store current goal in memory
        aiMemory.storeAgentGoal(goal);

        const messages = [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: `Goal: ${goal}\n\nCurrent context:\n${this.getContext()}` }
        ];

        for (let step = 1; step <= this.maxSteps; step++) {
          updateAgentStatus('running', `Executing step ${step}...`);

          try {
            const response = await callAI(messages, { model: this.model });
            let content = response?.message?.content || '';
            if (Array.isArray(content)) content = content[0]?.text || content[0];

            // Extract JSON from response
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error('Invalid response format');

            const parsed = JSON.parse(jsonMatch[0]);
            
            addAgentStep(parsed.thought, parsed.action, parsed.message);

            if (parsed.action === 'complete') {
              addMessage(parsed.message || 'Task completed successfully!', 'agent');
              break;
            }

            // Execute tool
            const tool = tools[parsed.action];
            if (!tool) {
              addMessage(`Unknown action: ${parsed.action}`, 'system');
              continue;
            }

            const result = await tool.execute(parsed.params || {});
            
            // Add result to conversation
            messages.push({ role: 'assistant', content: JSON.stringify(parsed) });
            messages.push({ role: 'user', content: `Tool result: ${JSON.stringify(result)}` });

            // Update UI if needed
            if (parsed.action === 'deploy_app' && result.url) {
              addMessage(`‚úÖ App deployed! <a href="${result.url}" target="_blank" style="color: var(--accent-cyan);">Open ${parsed.params.name}</a>`, 'agent');
            }

            state.agentTasks++;
            document.getElementById('statAgentTasks').textContent = state.agentTasks;

          } catch (err) {
            console.error('Agent step error:', err);
            addMessage(`Step failed: ${err.message}. Retrying...`, 'system');
          }
        }

        state.isAgentRunning = false;
        updateAgentStatus('idle', 'Agent idle - ready for tasks');
        await refreshData();
      }

      getContext() {
        const parts = [];
        if (state.user) parts.push(`User: ${state.user.username}`);
        parts.push(`Files: ${state.files.length} items`);
        parts.push(`Apps: ${state.apps.length} deployed`);
        parts.push(`Functions: ${state.functions.length} saved`);
        parts.push(`\nPuter SDK Available: fs, kv, hosting, ai, auth`);
        parts.push(`Constitution: User commands are LAW`);
        return parts.join('\n');
      }

      async logCompliance(goal) {
        try {
          const log = JSON.parse(await puter.kv.get('cloudpilot_agent_compliance') || '[]');
          log.push({
            goal,
            timestamp: new Date().toISOString(),
            laws: AGENT_CONSTITUTION.laws.map(l => l.id),
            status: 'executing'
          });
          if (log.length > 100) log.splice(0, log.length - 100);
          await puter.kv.set('cloudpilot_agent_compliance', JSON.stringify(log));
        } catch (e) { console.log('Compliance log skipped - not signed in'); }
      }
    }

    const agent = new AutonomousAgent();

    // ============ UI HELPERS ============
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è' };
      toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    function updateAgentStatus(status, text) {
      const bar = document.getElementById('agentStatusBar');
      bar.className = `agent-status ${status}`;
      bar.querySelector('.agent-status-text').textContent = text;
    }

    function addMessage(content, type = 'ai') {
      const container = document.getElementById('chatMessages');
      const msg = document.createElement('div');
      msg.className = `chat-message ${type}`;
      const avatars = { ai: 'ü§ñ', user: 'üë§', system: '‚öôÔ∏è', agent: 'üöÄ' };
      msg.innerHTML = `
        <div class="chat-avatar">${avatars[type]}</div>
        <div class="chat-bubble">${content}</div>
      `;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
    }

    function addAgentStep(thought, action, message) {
      const container = document.getElementById('chatMessages');
      const lastMsg = container.lastElementChild;
      
      // Create or update steps container
      let stepsContainer = container.querySelector('.agent-steps-container');
      if (!stepsContainer || lastMsg?.classList.contains('user')) {
        stepsContainer = document.createElement('div');
        stepsContainer.className = 'chat-message agent';
        stepsContainer.innerHTML = `
          <div class="chat-avatar">üöÄ</div>
          <div class="chat-bubble">
            <div class="agent-steps agent-steps-container"></div>
          </div>
        `;
        container.appendChild(stepsContainer);
      }
      
      const steps = stepsContainer.querySelector('.agent-steps');
      steps.innerHTML += `
        <div class="agent-step">
          <div class="step-icon thought">üí≠</div>
          <div class="step-content">
            <div class="step-label">Thinking</div>
            <div class="step-text">${thought}</div>
          </div>
        </div>
        <div class="agent-step">
          <div class="step-icon action">‚ö°</div>
          <div class="step-content">
            <div class="step-label">Action</div>
            <div class="step-text">${action}</div>
          </div>
        </div>
      `;
      container.scrollTop = container.scrollHeight;
    }

    function addTypingIndicator() {
      const container = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.className = 'chat-message ai';
      div.id = 'typingIndicator';
      div.innerHTML = `
        <div class="chat-avatar">ü§ñ</div>
        <div class="chat-bubble typing-indicator">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }

    function removeTypingIndicator() {
      document.getElementById('typingIndicator')?.remove();
    }

    // ============ ACCORDION & RESPONSIVE ============
    let currentOpenAccordion = null;
    
    function initAccordions() {
      document.querySelectorAll('.nav-accordion-header').forEach(header => {
        header.addEventListener('click', () => {
          const accordion = header.parentElement;
          const content = accordion.querySelector('.nav-accordion-content');
          const isOpen = header.classList.contains('open');
          
          // Close all accordions first (single-open behavior)
          document.querySelectorAll('.nav-accordion-header').forEach(h => h.classList.remove('open'));
          document.querySelectorAll('.nav-accordion-content').forEach(c => c.classList.remove('open'));
          
          // Open clicked one if it wasn't already open
          if (!isOpen) {
            header.classList.add('open');
            content.classList.add('open');
            currentOpenAccordion = accordion.dataset.accordion;
          } else {
            currentOpenAccordion = null;
          }
        });
      });
    }
    
    function initMobileMenu() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const menuBtn = document.getElementById('mobileMenuBtn');
      const closeBtn = document.getElementById('sidebarClose');
      
      function openSidebar() {
        sidebar?.classList.add('open');
        overlay?.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      
      function closeSidebar() {
        sidebar?.classList.remove('open');
        overlay?.classList.remove('active');
        document.body.style.overflow = '';
      }
      
      menuBtn?.addEventListener('click', openSidebar);
      closeBtn?.addEventListener('click', closeSidebar);
      overlay?.addEventListener('click', closeSidebar);
      
      // Close sidebar when nav item clicked on mobile
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            closeSidebar();
          }
        });
      });
    }
    
    function detectDevice() {
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const isTablet = window.matchMedia('(min-width: 769px) and (max-width: 1024px)').matches;
      const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      document.body.classList.toggle('is-mobile', isMobile);
      document.body.classList.toggle('is-tablet', isTablet);
      document.body.classList.toggle('is-touch', isTouch);
      
      return { isMobile, isTablet, isTouch };
    }
    
    // Initialize responsive features
    window.addEventListener('resize', detectDevice);
    detectDevice();

    // ============ NAVIGATION ============
    function switchView(viewId) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      document.getElementById(`view-${viewId}`)?.classList.add('active');
      document.querySelector(`.nav-item[data-view="${viewId}"]`)?.classList.add('active');

      const titles = {
        dashboard: ['Dashboard', 'Autonomous cloud management'],
        storage: ['Storage', 'Manage your cloud files'],
        apps: ['Deploy Apps', 'Create and deploy web applications'],
        functions: ['Functions', 'Serverless cloud functions'],
        network: ['Services & Access', 'Cloud service inventory and policies'],
        studio: ['Code Studio', 'AI-powered code editor'],
        terminal: ['Terminals', 'Multi-shell terminal environment'],
        memory: ['AI Memory', 'Learning and personalization'],
        agent: ['AI Agent', 'Autonomous task execution'],
        workflows: ['Workflows', 'Automated task sequences'],
        deployments: ['Live Sites', 'Deploy to Puter hosting'],
        games: ['Game Hosting', 'PVP and multiplayer servers'],
        extensions: ['Extensions', 'Agent tools and capabilities'],
        playground: ['Code Playground', 'AI-powered code editor and preview'],
        converter: ['File Converter', '3D and image conversion tools'],
        grudge: ['Grudge App', 'Real-time chat with AI integration'],
        launcher: ['Launcher', 'Quick launch your apps and workflows']
      };

      const [title, subtitle] = titles[viewId] || ['CloudPilot', ''];
      document.getElementById('viewTitle').textContent = title;
      document.getElementById('viewSubtitle').textContent = subtitle;

      // Load view-specific data
      if (viewId === 'network' && typeof loadNetworkData === 'function') {
        loadNetworkData();
      }
      if (viewId === 'memory') {
        renderMemoryView();
      }
      if (viewId === 'deployments') {
        loadDeployments();
      }
      if (viewId === 'games') {
        loadGameTemplates();
      }
      if (viewId === 'extensions') {
        loadExtensions();
      }
      if (viewId === 'grudge' && state.user) {
        grudgeStore.updateUI();
        grudgeStore.renderMessages();
        grudgeStore.renderMembers();
      }
      if (viewId === 'launcher' && state.user) {
        launcherStore.loadApps().then(() => {
          launcherStore.updateStats();
          launcherStore.renderLauncher();
          launcherStore.renderFavorites();
          launcherStore.renderActivity();
          improvementEngine.renderSuggestions();
        });
      }
    }

    function renderMemoryView() {
      // Update stats
      document.getElementById('memoryPrefsCount').textContent = Object.keys(aiMemory.preferences).length;
      document.getElementById('memoryHistoryCount').textContent = aiMemory.conversationHistory.length;
      document.getElementById('memoryCodingCount').textContent = Object.keys(aiMemory.codingStyle).length;
      
      // Render coding style
      const codingDiv = document.getElementById('memoryCodingStyle');
      if (Object.keys(aiMemory.codingStyle).length > 0) {
        codingDiv.innerHTML = Object.entries(aiMemory.codingStyle).map(([key, data]) => `
          <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
            <span style="color: var(--accent-cyan); font-weight: 500;">${key}</span>
            <span>${data.value}</span>
          </div>
        `).join('');
      } else {
        codingDiv.innerHTML = '<span style="color: var(--text-muted);">No coding preferences learned yet. Start coding and AI will learn your style!</span>';
      }
      
      // Render preferences
      const prefsDiv = document.getElementById('memoryPreferences');
      if (Object.keys(aiMemory.preferences).length > 0) {
        prefsDiv.innerHTML = Object.entries(aiMemory.preferences).map(([key, data]) => `
          <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color);">
            <span style="color: var(--accent-purple); font-weight: 500;">${key}</span>
            <span>${data.value}</span>
          </div>
        `).join('');
      } else {
        prefsDiv.innerHTML = '<span style="color: var(--text-muted);">No explicit preferences set. Tell AI "I prefer..." or "Always use..." to teach it!</span>';
      }
      
      // Render conversation history
      const historyDiv = document.getElementById('memoryHistory');
      if (aiMemory.conversationHistory.length > 0) {
        historyDiv.innerHTML = aiMemory.conversationHistory.slice(-10).reverse().map(h => `
          <div style="padding: 8px 0; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <span style="background: ${h.role === 'user' ? 'var(--accent-blue)' : 'var(--accent-green)'}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">${h.role}</span>
              <span style="font-size: 11px; color: var(--text-muted);">${new Date(h.timestamp).toLocaleString()}</span>
            </div>
            <div style="font-size: 12px; color: var(--text-secondary);">${h.content.substring(0, 150)}${h.content.length > 150 ? '...' : ''}</div>
          </div>
        `).join('');
      } else {
        historyDiv.innerHTML = '<span style="color: var(--text-muted);">No conversation history yet. Start chatting with AI!</span>';
      }
    }

    // ============ DEPLOYMENTS MANAGEMENT ============
    const localDeployments = [];
    
    async function loadDeployments() {
      try {
        // Load from Puter KV
        const data = await puter.kv.get('cloudpilot_deployments');
        const deployments = data ? JSON.parse(data) : [];
        
        // Update stats
        document.getElementById('liveDeploymentsCount').textContent = deployments.filter(d => d.status === 'live').length;
        document.getElementById('totalSitesCount').textContent = deployments.length;
        document.getElementById('gameServersCount').textContent = deployments.filter(d => d.type === 'game').length;
        
        // Render deployment list
        const container = document.getElementById('deploymentsListContainer');
        if (deployments.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No deployments yet. Create your first site above!</div>';
          return;
        }
        
        container.innerHTML = deployments.map(d => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 20px;">${d.type === 'game' ? 'üéÆ' : 'üåê'}</span>
              <div>
                <div style="font-weight: 500;">${d.name}</div>
                <a href="https://${d.subdomain}.puter.site" target="_blank" style="font-size: 12px; color: var(--accent-cyan);">https://${d.subdomain}.puter.site</a>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="background: ${d.status === 'live' ? 'var(--accent-green)' : 'var(--accent-yellow)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">${d.status.toUpperCase()}</span>
              <button class="btn btn-secondary" onclick="openDeployment('${d.subdomain}')" style="padding: 6px 12px; font-size: 11px;">Open</button>
              <button class="btn btn-danger" onclick="deleteDeployment('${d.subdomain}')" style="padding: 6px 12px; font-size: 11px;">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.log('Deployments require Puter sign-in');
      }
    }
    
    async function deployToSite(name, subdomain, content, type = 'site') {
      if (!state.user) {
        showToast('Please sign in to deploy', 'warning');
        return;
      }
      
      try {
        showToast('Creating deployment...', 'info');
        
        // Create directory
        await puter.fs.mkdir(subdomain).catch(() => {});
        
        // Write index.html
        await puter.fs.write(`${subdomain}/index.html`, content);
        
        // Deploy to hosting
        const site = await puter.hosting.create(subdomain, subdomain);
        
        // Save to KV
        const data = await puter.kv.get('cloudpilot_deployments');
        const deployments = data ? JSON.parse(data) : [];
        deployments.push({
          id: `deploy_${Date.now()}`,
          name,
          subdomain,
          type,
          status: 'live',
          url: `https://${site.subdomain}.puter.site`,
          createdAt: new Date().toISOString()
        });
        await puter.kv.set('cloudpilot_deployments', JSON.stringify(deployments));
        
        showToast(`Deployed successfully to ${site.subdomain}.puter.site`, 'success');
        loadDeployments();
        
        // Open in new tab
        window.open(`https://${site.subdomain}.puter.site`, '_blank');
      } catch (e) {
        showToast('Deployment failed: ' + e.message, 'error');
      }
    }
    
    function openDeployment(subdomain) {
      window.open(`https://${subdomain}.puter.site`, '_blank');
    }
    
    async function deleteDeployment(subdomain) {
      if (!confirm(`Delete deployment "${subdomain}"?`)) return;
      
      try {
        // Delete from hosting
        await puter.hosting.delete(subdomain).catch(() => {});
        
        // Delete folder
        await puter.fs.delete(subdomain, { recursive: true }).catch(() => {});
        
        // Remove from KV
        const data = await puter.kv.get('cloudpilot_deployments');
        let deployments = data ? JSON.parse(data) : [];
        deployments = deployments.filter(d => d.subdomain !== subdomain);
        await puter.kv.set('cloudpilot_deployments', JSON.stringify(deployments));
        
        showToast('Deployment deleted', 'success');
        loadDeployments();
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }
    
    document.getElementById('deployNowBtn')?.addEventListener('click', () => {
      const name = document.getElementById('deployName').value.trim();
      const subdomain = document.getElementById('deploySubdomain').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
      const content = document.getElementById('deployContent').value || `<!DOCTYPE html>
<html>
<head><title>${name || 'My Site'}</title></head>
<body style="font-family: system-ui; background: #0a0a0f; color: #fff; display: flex; align-items: center; justify-content: center; height: 100vh;">
  <h1>${name || 'Hello World!'}</h1>
</body>
</html>`;
      
      if (!name) {
        showToast('Please enter a site name', 'warning');
        return;
      }
      if (!subdomain) {
        showToast('Please enter a subdomain', 'warning');
        return;
      }
      
      deployToSite(name, subdomain, content);
    });
    
    document.getElementById('refreshDeploymentsBtn')?.addEventListener('click', loadDeployments);

    // ============ GAME HOSTING ============
    let gameTemplates = [];
    
    async function loadGameTemplates() {
      try {
        const resp = await fetch('/api/deploy/templates');
        gameTemplates = await resp.json();
        
        // Render template grid
        const grid = document.getElementById('gameTemplatesGrid');
        grid.innerHTML = gameTemplates.map(t => `
          <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px; cursor: pointer; transition: all 0.2s;" 
               onclick="selectGameTemplate('${t.id}')"
               data-template="${t.id}">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <span style="font-size: 28px;">${t.category === 'game' ? 'üéÆ' : t.category === 'social' ? 'üí¨' : 'üé®'}</span>
              <div>
                <div style="font-weight: 600; font-size: 14px;">${t.name}</div>
                <div style="font-size: 11px; color: var(--text-muted);">${t.category}</div>
              </div>
            </div>
            <p style="font-size: 12px; color: var(--text-secondary);">${t.description}</p>
          </div>
        `).join('');
        
        // Populate select
        const select = document.getElementById('gameTemplate');
        select.innerHTML = '<option value="">Select a template...</option>' + 
          gameTemplates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      } catch (e) {
        console.error('Failed to load templates:', e);
      }
    }
    
    function selectGameTemplate(id) {
      document.getElementById('gameTemplate').value = id;
      document.querySelectorAll('[data-template]').forEach(el => {
        el.style.borderColor = el.dataset.template === id ? 'var(--accent-purple)' : 'var(--border-color)';
      });
    }
    
    document.getElementById('deployGameBtn')?.addEventListener('click', async () => {
      const templateId = document.getElementById('gameTemplate').value;
      const name = document.getElementById('gameServerName').value.trim();
      const subdomain = document.getElementById('gameSubdomain').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, '');
      
      if (!templateId) {
        showToast('Please select a template', 'warning');
        return;
      }
      if (!name || !subdomain) {
        showToast('Please enter server name and subdomain', 'warning');
        return;
      }
      
      try {
        // Get template files from API
        const resp = await fetch(`/api/deploy/templates/${templateId}`);
        const template = await resp.json();
        
        // Deploy using Puter
        showToast('Deploying game server...', 'info');
        
        await puter.fs.mkdir(subdomain).catch(() => {});
        
        for (const [filename, content] of Object.entries(template.files)) {
          await puter.fs.write(`${subdomain}/${filename}`, content);
        }
        
        const site = await puter.hosting.create(subdomain, subdomain);
        
        // Save to deployments
        const data = await puter.kv.get('cloudpilot_deployments');
        const deployments = data ? JSON.parse(data) : [];
        deployments.push({
          id: `game_${Date.now()}`,
          name,
          subdomain,
          type: 'game',
          template: templateId,
          status: 'live',
          url: `https://${site.subdomain}.puter.site`,
          createdAt: new Date().toISOString()
        });
        await puter.kv.set('cloudpilot_deployments', JSON.stringify(deployments));
        
        showToast(`Game server deployed to ${site.subdomain}.puter.site`, 'success');
        window.open(`https://${site.subdomain}.puter.site`, '_blank');
        
        loadDeployments();
      } catch (e) {
        showToast('Deployment failed: ' + e.message, 'error');
      }
    });

    // ============ EXTENSIONS MANAGEMENT ============
    let extensions = [];
    
    async function loadExtensions() {
      try {
        const resp = await fetch('/api/extensions');
        extensions = await resp.json();
        
        // Update category counts
        const counts = { ai: 0, deployment: 0, storage: 0, tools: 0, automation: 0 };
        extensions.forEach(e => {
          if (counts[e.category] !== undefined) counts[e.category]++;
        });
        
        document.getElementById('aiExtCount').textContent = counts.ai;
        document.getElementById('deployExtCount').textContent = counts.deployment;
        document.getElementById('storageExtCount').textContent = counts.storage;
        document.getElementById('toolsExtCount').textContent = counts.tools;
        document.getElementById('autoExtCount').textContent = counts.automation;
        
        // Render extensions grid
        const grid = document.getElementById('extensionsGrid');
        grid.innerHTML = extensions.map(e => `
          <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius); padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">${getCategoryIcon(e.category)}</span>
                <div>
                  <div style="font-weight: 600; font-size: 14px;">${e.name}</div>
                  <div style="font-size: 11px; color: var(--text-muted);">v${e.version}</div>
                </div>
              </div>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" ${e.enabled ? 'checked' : ''} onchange="toggleExtension('${e.id}', this.checked)">
                <span style="font-size: 11px; color: ${e.enabled ? 'var(--accent-green)' : 'var(--text-muted)'};">${e.enabled ? 'ON' : 'OFF'}</span>
              </label>
            </div>
            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">${e.description}</p>
            <div style="display: flex; gap: 8px;">
              <span style="background: var(--bg-card); padding: 4px 8px; border-radius: 4px; font-size: 10px; color: var(--text-muted);">${e.category}</span>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load extensions:', e);
      }
    }
    
    function getCategoryIcon(category) {
      const icons = { ai: 'ü§ñ', deployment: 'üöÄ', storage: 'üíæ', tools: '‚öôÔ∏è', automation: 'üîÑ', custom: 'üß©' };
      return icons[category] || 'üì¶';
    }
    
    async function toggleExtension(id, enabled) {
      try {
        await fetch(`/api/extensions/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
        showToast(`Extension ${enabled ? 'enabled' : 'disabled'}`, 'success');
      } catch (e) {
        showToast('Failed to update extension', 'error');
      }
    }
    
    document.getElementById('refreshExtensionsBtn')?.addEventListener('click', loadExtensions);
    
    document.getElementById('addExtensionBtn')?.addEventListener('click', () => {
      const name = prompt('Extension name:');
      if (!name) return;
      const description = prompt('Description:');
      const category = prompt('Category (ai, deployment, storage, tools, automation):') || 'custom';
      
      fetch('/api/extensions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: name.toLowerCase().replace(/\s+/g, '_'),
          name,
          description: description || 'Custom extension',
          category
        })
      }).then(() => {
        showToast('Extension added', 'success');
        loadExtensions();
      });
    });

    // ============ WORKFLOW MANAGEMENT ============
    const workflowTemplates = {
      'deploy-site': {
        name: 'Deploy Website',
        steps: [
          { tool: 'call_ai', params: { prompt: 'Generate a simple HTML landing page' }, description: 'Generate HTML' },
          { tool: 'write_file', params: { path: '/site/index.html' }, description: 'Save to Puter' },
          { tool: 'deploy_live_site', params: { subdomain: 'mysite' }, description: 'Deploy live' }
        ]
      },
      'backup-files': {
        name: 'Backup Files',
        steps: [
          { tool: 'list_files', params: { path: '/' }, description: 'List all files' },
          { tool: 'create_folder', params: { path: '/backups' }, description: 'Create backup folder' },
          { tool: 'store_data', params: { key: 'backup_log' }, description: 'Log backup' }
        ]
      },
      'ai-content': {
        name: 'AI Content Generator',
        steps: [
          { tool: 'call_ai', params: { prompt: 'Generate content' }, description: 'Generate with AI' },
          { tool: 'write_file', params: {}, description: 'Save content' },
          { tool: 'store_data', params: { key: 'generated_content' }, description: 'Track in KV' }
        ]
      },
      'security-scan': {
        name: 'Security Scan',
        steps: [
          { tool: 'scan_ports', params: {}, description: 'Scan services' },
          { tool: 'get_access_policies', params: {}, description: 'Check policies' },
          { tool: 'auto_secure', params: {}, description: 'Apply security' },
          { tool: 'get_audit_log', params: {}, description: 'Get audit log' },
          { tool: 'store_data', params: { key: 'security_report' }, description: 'Save report' }
        ]
      }
    };

    async function loadWorkflows() {
      try {
        const data = await puter.kv.get('cloudpilot_workflows');
        const workflows = data ? JSON.parse(data) : [];
        const container = document.getElementById('workflowsList');
        
        if (workflows.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÑ</div><div class="empty-state-title">No workflows saved</div><div class="empty-state-desc">Use templates or AI to create workflows</div></div>';
          return;
        }
        
        container.innerHTML = workflows.map(w => `
          <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 12px;">
              <span style="font-size: 20px;">üîÑ</span>
              <div>
                <div style="font-weight: 500;">${w.name}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${w.steps?.length || 0} steps</div>
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-primary" onclick="runWorkflow('${w.name}')" style="padding: 6px 12px; font-size: 11px;">‚ñ∂ Run</button>
              <button class="btn btn-danger" onclick="deleteWorkflow('${w.name}')" style="padding: 6px 12px; font-size: 11px;">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (e) { console.log('Workflows require sign-in'); }
    }

    async function runWorkflow(name) {
      const data = await puter.kv.get('cloudpilot_workflows');
      const workflows = data ? JSON.parse(data) : [];
      const workflow = workflows.find(w => w.name === name);
      if (!workflow) return showToast('Workflow not found', 'error');
      
      showToast(`Running workflow: ${name}`, 'info');
      for (const step of workflow.steps) {
        if (tools[step.tool]) {
          await tools[step.tool].execute(step.params || {});
        }
      }
      showToast(`Workflow completed: ${name}`, 'success');
    }

    async function deleteWorkflow(name) {
      if (!confirm(`Delete workflow "${name}"?`)) return;
      const data = await puter.kv.get('cloudpilot_workflows');
      let workflows = data ? JSON.parse(data) : [];
      workflows = workflows.filter(w => w.name !== name);
      await puter.kv.set('cloudpilot_workflows', JSON.stringify(workflows));
      showToast('Workflow deleted', 'success');
      loadWorkflows();
    }

    document.querySelectorAll('.workflow-template').forEach(el => {
      el.addEventListener('click', () => {
        const templateId = el.dataset.template;
        const template = workflowTemplates[templateId];
        if (template) {
          document.getElementById('generatedWorkflowSteps').innerHTML = template.steps.map((s, i) => 
            `<div style="padding: 8px; margin: 4px 0; background: var(--bg-card); border-radius: 4px; font-size: 12px;">
              <strong>Step ${i + 1}:</strong> ${s.description} <span style="color: var(--accent-cyan);">[${s.tool}]</span>
            </div>`
          ).join('');
          document.getElementById('saveGeneratedWorkflowBtn').disabled = false;
          document.getElementById('saveGeneratedWorkflowBtn').onclick = async () => {
            const workflows = JSON.parse(await puter.kv.get('cloudpilot_workflows') || '[]');
            workflows.push({ ...template, createdAt: new Date().toISOString() });
            await puter.kv.set('cloudpilot_workflows', JSON.stringify(workflows));
            showToast('Workflow saved!', 'success');
            loadWorkflows();
          };
        }
      });
    });

    document.getElementById('generateWorkflowBtn')?.addEventListener('click', async () => {
      const description = document.getElementById('workflowDescription').value;
      if (!description) return showToast('Please describe your workflow', 'warning');
      
      showToast('AI is generating workflow...', 'info');
      try {
        const response = await callAI([
          { role: 'system', content: `You are a workflow generator. Create workflow steps using these tools: ${Object.keys(tools).join(', ')}. Respond with JSON array of steps.` },
          { role: 'user', content: `Create workflow: ${description}` }
        ]);
        
        let content = response?.message?.content || '';
        const jsonMatch = content.match(/\[[\s\S]*\]/);
        if (jsonMatch) {
          const steps = JSON.parse(jsonMatch[0]);
          document.getElementById('generatedWorkflowSteps').innerHTML = steps.map((s, i) => 
            `<div style="padding: 8px; margin: 4px 0; background: var(--bg-card); border-radius: 4px; font-size: 12px;">
              <strong>Step ${i + 1}:</strong> ${s.description || s.tool} <span style="color: var(--accent-cyan);">[${s.tool}]</span>
            </div>`
          ).join('');
          document.getElementById('saveGeneratedWorkflowBtn').disabled = false;
          document.getElementById('saveGeneratedWorkflowBtn').onclick = async () => {
            const name = prompt('Workflow name:') || 'AI Generated Workflow';
            const workflows = JSON.parse(await puter.kv.get('cloudpilot_workflows') || '[]');
            workflows.push({ name, steps, createdAt: new Date().toISOString() });
            await puter.kv.set('cloudpilot_workflows', JSON.stringify(workflows));
            showToast('Workflow saved!', 'success');
            loadWorkflows();
          };
        }
      } catch (e) {
        showToast('Failed to generate workflow', 'error');
      }
    });

    document.getElementById('refreshWorkflowsBtn')?.addEventListener('click', loadWorkflows);

    // ============ VERSION CONTROL SYSTEM ============
    // Uses UUID, GRD-17 IDs, and SHA-256 hashes for app backups
    const versionControl = {
      history: [],           // Undo stack
      future: [],            // Redo stack
      backups: [],           // Saved checkpoints
      maxHistory: 50,        // Max undo steps
      currentVersion: null,
      
      // Generate UUID v4
      generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
          const r = Math.random() * 16 | 0;
          return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
        });
      },
      
      // Generate GRD-17 style ID (format: GRD-XXXXXX-XXXX)
      generateGRD17() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let id = 'GRD-';
        for (let i = 0; i < 6; i++) id += chars[Math.floor(Math.random() * chars.length)];
        id += '-';
        for (let i = 0; i < 4; i++) id += chars[Math.floor(Math.random() * chars.length)];
        return id;
      },
      
      // Calculate SHA-256 hash (simplified for browser)
      async calculateSHA(content) {
        const encoder = new TextEncoder();
        const data = encoder.encode(content);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 12);
      },
      
      // Push current state to history
      async pushState(content, source = 'edit') {
        const sha = await this.calculateSHA(content);
        const state = {
          id: this.generateUUID(),
          grd: this.generateGRD17(),
          sha: sha,
          content: content,
          timestamp: new Date().toISOString(),
          source: source
        };
        
        this.history.push(state);
        this.future = []; // Clear redo stack on new action
        this.currentVersion = state;
        
        // Limit history size
        if (this.history.length > this.maxHistory) {
          this.history.shift();
        }
        
        this.updateUI();
        return state;
      },
      
      // Undo
      undo() {
        if (this.history.length <= 1) {
          showToast('Nothing to undo', 'warning');
          return null;
        }
        
        const current = this.history.pop();
        this.future.push(current);
        this.currentVersion = this.history[this.history.length - 1];
        this.updateUI();
        return this.currentVersion;
      },
      
      // Redo
      redo() {
        if (this.future.length === 0) {
          showToast('Nothing to redo', 'warning');
          return null;
        }
        
        const next = this.future.pop();
        this.history.push(next);
        this.currentVersion = next;
        this.updateUI();
        return this.currentVersion;
      },
      
      // Save checkpoint backup
      async saveBackup(name = null) {
        const content = document.getElementById('playgroundCode').value;
        const sha = await this.calculateSHA(content);
        
        const backup = {
          id: this.generateUUID(),
          grd: this.generateGRD17(),
          sha: sha,
          name: name || `Backup ${this.backups.length + 1}`,
          content: content,
          language: document.getElementById('playgroundLang').value,
          timestamp: new Date().toISOString()
        };
        
        this.backups.push(backup);
        
        // Persist to Puter KV
        if (state.user) {
          await puter.kv.set('cloudpilot_code_backups', JSON.stringify(this.backups));
        }
        
        showToast(`Saved: ${backup.grd} (${backup.sha})`, 'success');
        return backup;
      },
      
      // Load backups from storage
      async loadBackups() {
        if (!state.user) return;
        try {
          const data = await puter.kv.get('cloudpilot_code_backups');
          this.backups = data ? JSON.parse(data) : [];
        } catch (e) { this.backups = []; }
      },
      
      // Restore from backup
      restoreBackup(id) {
        const backup = this.backups.find(b => b.id === id || b.grd === id);
        if (!backup) {
          showToast('Backup not found', 'error');
          return;
        }
        
        document.getElementById('playgroundCode').value = backup.content;
        document.getElementById('playgroundLang').value = backup.language || 'html';
        this.pushState(backup.content, 'restore');
        runPlaygroundCode();
        showToast(`Restored: ${backup.grd}`, 'success');
      },
      
      // Delete backup
      async deleteBackup(id) {
        this.backups = this.backups.filter(b => b.id !== id);
        if (state.user) {
          await puter.kv.set('cloudpilot_code_backups', JSON.stringify(this.backups));
        }
        showToast('Backup deleted', 'info');
      },
      
      // Show backups list
      showBackupsList() {
        const list = this.backups.map(b => `
          <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 8px;">
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 13px;">${b.name}</div>
              <div style="font-size: 11px; color: var(--text-muted); font-family: var(--font-mono);">${b.grd} | SHA: ${b.sha}</div>
              <div style="font-size: 10px; color: var(--text-muted);">${new Date(b.timestamp).toLocaleString()}</div>
            </div>
            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="versionControl.restoreBackup('${b.id}')">Restore</button>
            <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="versionControl.deleteBackup('${b.id}'); versionControl.showBackupsList();">Delete</button>
          </div>
        `).join('') || '<div style="color: var(--text-muted); padding: 20px; text-align: center;">No backups saved yet</div>';
        
        // Show in modal-like overlay
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay active';
        overlay.innerHTML = `
          <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
              <h3 class="modal-title">Code Backups</h3>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
              ${list}
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      },
      
      // Update UI with current version info
      updateUI() {
        const info = document.getElementById('versionInfo');
        const sha = document.getElementById('versionSha');
        
        if (this.currentVersion) {
          info.textContent = this.currentVersion.grd;
          sha.textContent = `SHA: ${this.currentVersion.sha}`;
        } else {
          info.textContent = 'No version';
          sha.textContent = '';
        }
        
        // Update button states
        document.getElementById('versionUndoBtn').disabled = this.history.length <= 1;
        document.getElementById('versionRedoBtn').disabled = this.future.length === 0;
      }
    };
    
    // Version control event listeners
    document.getElementById('versionUndoBtn')?.addEventListener('click', () => {
      const state = versionControl.undo();
      if (state) {
        document.getElementById('playgroundCode').value = state.content;
        runPlaygroundCode();
      }
    });
    
    document.getElementById('versionRedoBtn')?.addEventListener('click', () => {
      const state = versionControl.redo();
      if (state) {
        document.getElementById('playgroundCode').value = state.content;
        runPlaygroundCode();
      }
    });
    
    document.getElementById('versionSaveBtn')?.addEventListener('click', async () => {
      const name = prompt('Backup name (optional):');
      await versionControl.saveBackup(name || undefined);
    });
    
    document.getElementById('versionListBtn')?.addEventListener('click', () => {
      versionControl.showBackupsList();
    });
    
    // Auto-save to history on code changes (debounced)
    let versionTimeout;
    document.getElementById('playgroundCode')?.addEventListener('input', () => {
      clearTimeout(versionTimeout);
      versionTimeout = setTimeout(() => {
        const content = document.getElementById('playgroundCode').value;
        if (content && content !== versionControl.currentVersion?.content) {
          versionControl.pushState(content, 'edit');
        }
      }, 1000);
    });

    // ============ CODE PLAYGROUND ============
    let currentPlaygroundCode = '';

    function runPlaygroundCode() {
      const code = document.getElementById('playgroundCode').value;
      const lang = document.getElementById('playgroundLang').value;
      const iframe = document.getElementById('playgroundPreview');
      
      if (lang === 'html' || lang === 'javascript' || lang === 'css') {
        let html = code;
        if (lang === 'javascript') {
          html = `<!DOCTYPE html><html><body><script>${code}<\/script></body></html>`;
        } else if (lang === 'css') {
          html = `<!DOCTYPE html><html><head><style>${code}</style></head><body><h1>CSS Preview</h1><p>Your styles are applied.</p></body></html>`;
        }
        iframe.srcdoc = html;
      } else {
        iframe.srcdoc = `<pre style="padding: 20px; font-family: monospace;">${code}</pre>`;
      }
    }

    document.getElementById('playgroundRunBtn')?.addEventListener('click', runPlaygroundCode);

    document.getElementById('playgroundGenerateBtn')?.addEventListener('click', async () => {
      const prompt = document.getElementById('playgroundAiPrompt').value;
      if (!prompt) return showToast('Enter a description', 'warning');
      
      const lang = document.getElementById('playgroundLang').value;
      showToast('AI is generating code...', 'info');
      
      try {
        const response = await callAI([
          { role: 'system', content: `You are a code generator. Generate clean, working ${lang.toUpperCase()} code. Only output code, no explanations.` },
          { role: 'user', content: prompt }
        ]);
        
        let content = response?.message?.content || '';
        // Extract code from markdown if present
        const codeMatch = content.match(/```[\w]*\n([\s\S]*?)```/);
        const code = codeMatch ? codeMatch[1] : content;
        
        document.getElementById('playgroundCode').value = code.trim();
        runPlaygroundCode();
        showToast('Code generated!', 'success');
      } catch (e) {
        showToast('Failed to generate code', 'error');
      }
    });

    document.getElementById('playgroundAiBtn')?.addEventListener('click', () => {
      document.getElementById('playgroundAiPrompt').focus();
    });

    document.getElementById('playgroundDeployBtn')?.addEventListener('click', async () => {
      const code = document.getElementById('playgroundCode').value;
      const lang = document.getElementById('playgroundLang').value;
      
      if (lang !== 'html') {
        return showToast('Only HTML can be deployed directly', 'warning');
      }
      
      const subdomain = prompt('Enter subdomain for deployment:');
      if (!subdomain) return;
      
      try {
        await tools.deploy_live_site.execute({ 
          subdomain: subdomain.toLowerCase().replace(/[^a-z0-9-]/g, ''),
          html: code,
          name: subdomain
        });
        showToast('Deployed successfully!', 'success');
      } catch (e) {
        showToast('Deployment failed: ' + e.message, 'error');
      }
    });

    document.querySelectorAll('[data-code]').forEach(chip => {
      chip.addEventListener('click', () => {
        const prompts = {
          'landing': 'Create a modern landing page with hero section, features, and footer',
          'calculator': 'Build a calculator with basic operations and a clean UI',
          'todo': 'Create a todo app with add, complete, and delete functionality',
          'chart': 'Build an animated bar chart widget using CSS',
          'game': 'Create a simple snake game using canvas'
        };
        document.getElementById('playgroundAiPrompt').value = prompts[chip.dataset.code] || '';
        document.getElementById('playgroundAiPrompt').focus();
      });
    });

    // ============ GRUDACHAIN CLOUD INTEGRATION ============
    const grudachain = {
      agents: [],
      prompts: [],
      
      async loadAgentDeployments() {
        try {
          const data = await puter.kv.get('grudachain_agents');
          this.agents = data ? JSON.parse(data) : [];
          return this.agents;
        } catch (e) { return []; }
      },
      
      async deployAgent(config) {
        const agent = {
          id: `gruda_agent_${Date.now()}`,
          name: config.name,
          prompt: config.prompt,
          model: config.model || 'gpt-4o-mini',
          capabilities: config.capabilities || [],
          status: 'active',
          createdAt: new Date().toISOString()
        };
        
        this.agents.push(agent);
        await puter.kv.set('grudachain_agents', JSON.stringify(this.agents));
        
        // Also sync to backend for API access
        await fetch('/api/accounts/gruda', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: state.user?.username, agent })
        });
        
        return agent;
      },
      
      async savePrompt(prompt) {
        const data = await puter.kv.get('grudachain_prompts');
        const prompts = data ? JSON.parse(data) : [];
        prompts.push({
          id: `prompt_${Date.now()}`,
          ...prompt,
          createdAt: new Date().toISOString()
        });
        await puter.kv.set('grudachain_prompts', JSON.stringify(prompts));
        return prompts;
      },
      
      async getPrompts() {
        const data = await puter.kv.get('grudachain_prompts');
        return data ? JSON.parse(data) : [];
      }
    };

    // ============ CLOUDPILOT AI DIRECTOR ============
    const cloudpilotDirector = {
      async processUserRequest(request) {
        // CloudPilot is the central AI that directs all operations
        const analysis = await this.analyzeIntent(request);
        
        if (analysis.type === 'deploy') {
          return await this.handleDeployment(analysis);
        } else if (analysis.type === 'generate') {
          return await this.handleGeneration(analysis);
        } else if (analysis.type === 'workflow') {
          return await this.handleWorkflow(analysis);
        } else if (analysis.type === 'agent') {
          return await this.handleAgentDeployment(analysis);
        } else {
          return await agent.execute(request);
        }
      },
      
      async analyzeIntent(request) {
        const response = await callAI([
          { role: 'system', content: `Analyze user intent. Respond with JSON: { "type": "deploy|generate|workflow|agent|general", "details": {...} }` },
          { role: 'user', content: request }
        ]);
        try {
          const match = (response?.message?.content || '').match(/\{[\s\S]*\}/);
          return match ? JSON.parse(match[0]) : { type: 'general' };
        } catch { return { type: 'general' }; }
      },
      
      async handleDeployment(analysis) {
        showToast('CloudPilot is deploying...', 'info');
        return await agent.execute(`Deploy: ${JSON.stringify(analysis.details)}`);
      },
      
      async handleGeneration(analysis) {
        showToast('CloudPilot is generating...', 'info');
        return await agent.execute(`Generate: ${JSON.stringify(analysis.details)}`);
      },
      
      async handleWorkflow(analysis) {
        showToast('CloudPilot is creating workflow...', 'info');
        return await agent.execute(`Create workflow: ${JSON.stringify(analysis.details)}`);
      },
      
      async handleAgentDeployment(analysis) {
        showToast('CloudPilot is deploying agent to GRUDACHAIN...', 'info');
        return await grudachain.deployAgent(analysis.details);
      }
    };

    document.querySelectorAll('.nav-item[data-view]').forEach(item => {
      item.addEventListener('click', () => switchView(item.dataset.view));
    });

    // ============ AUTHENTICATION ============
    async function checkAuth() {
      try {
        const user = await puter.auth.getUser();
        if (user) {
          state.user = user;
          showUserUI(user);
          await refreshData();
          showToast('Connected to Puter cloud!', 'success');
        }
      } catch (e) {
        console.log('Not authenticated');
      }
    }

    async function signIn() {
      try {
        const user = await puter.auth.signIn();
        if (user) {
          state.user = user;
          showUserUI(user);
          await refreshData();
          // Load AI memory after sign-in for personalization
          await aiMemory.load();
          showToast('Successfully signed in!', 'success');
        }
      } catch (e) {
        showToast('Sign in failed', 'error');
      }
    }

    function showUserUI(user) {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('userContainer').style.display = 'block';
      document.getElementById('userName').textContent = user.username || 'Puter User';
    }

    document.getElementById('loginBtn').addEventListener('click', signIn);

    // ============ DATA LOADING ============
    async function refreshData() {
      if (!state.user) return;
      await Promise.all([loadFiles('/'), loadApps(), loadFunctions(), loadWorkflows()]);
    }

    async function loadFiles(path = '/') {
      if (!state.user) return;
      state.currentPath = path;
      
      try {
        const files = await puter.fs.readdir(path);
        state.files = files;
        document.getElementById('statFiles').textContent = files.length;
        renderFiles(files);
        updateBreadcrumb(path);
      } catch (e) {
        console.error('Failed to load files:', e);
      }
    }

    function renderFiles(files) {
      const container = document.getElementById('fileList');
      if (!files || files.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìÇ</div><div class="empty-state-title">Empty folder</div></div>`;
        return;
      }
      
      // Sort files
      const sortBy = document.getElementById('fileSortBy')?.value || 'name';
      files.sort((a, b) => {
        if (a.is_dir && !b.is_dir) return -1;
        if (!a.is_dir && b.is_dir) return 1;
        if (sortBy === 'name') return a.name.localeCompare(b.name);
        if (sortBy === 'size') return (b.size || 0) - (a.size || 0);
        if (sortBy === 'date') return new Date(b.modified || 0) - new Date(a.modified || 0);
        if (sortBy === 'type') return (a.name.split('.').pop() || '').localeCompare(b.name.split('.').pop() || '');
        return 0;
      });

      container.innerHTML = files.map(file => {
        const icon = file.is_dir ? 'üìÅ' : getFileIcon(file.name);
        const size = file.is_dir ? '--' : formatSize(file.size || 0);
        const modified = file.modified ? new Date(file.modified).toLocaleDateString() : '--';
        return `
          <div class="file-item-row" data-path="${file.path}" data-is-dir="${file.is_dir}" style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.15s;">
            <input type="checkbox" class="file-checkbox" style="cursor: pointer;" onclick="event.stopPropagation(); fileManager.toggleSelect('${file.path}');">
            <span class="file-icon" style="font-size: 18px;">${icon}</span>
            <span class="file-name" style="flex: 1; font-size: 13px; font-weight: 500;">${file.name}</span>
            <span style="width: 80px; font-size: 12px; color: var(--text-muted); text-align: right;">${size}</span>
            <span style="width: 90px; font-size: 11px; color: var(--text-muted); text-align: right;">${modified}</span>
            <div class="file-actions" style="display: flex; gap: 4px;">
              ${!file.is_dir ? `<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px;" onclick="event.stopPropagation(); fileManager.previewFile('${file.path}', '${file.name}');">üëÅÔ∏è</button>` : ''}
              <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px;" onclick="event.stopPropagation(); fileManager.renameItem('${file.path}');">‚úèÔ∏è</button>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 10px;" onclick="event.stopPropagation(); fileManager.deleteItems(['${file.path}']);">üóëÔ∏è</button>
            </div>
          </div>`;
      }).join('');

      container.querySelectorAll('.file-item-row').forEach(item => {
        item.addEventListener('click', () => {
          if (item.dataset.isDir === 'true') loadFiles(item.dataset.path);
          else fileManager.previewFile(item.dataset.path, item.querySelector('.file-name').textContent);
        });
        item.addEventListener('contextmenu', (e) => {
          fileManager.showContextMenu(e, item.dataset.path, item.dataset.isDir === 'true');
        });
        item.addEventListener('mouseenter', () => item.style.background = 'var(--bg-secondary)');
        item.addEventListener('mouseleave', () => item.style.background = 'transparent');
      });
      
      // Update stats
      if (typeof fileManager !== 'undefined') fileManager.updateStats();
    }

    function getFileIcon(name) {
      const ext = name.split('.').pop().toLowerCase();
      const icons = { html: 'üìÑ', js: 'üìú', json: 'üìã', png: 'üñºÔ∏è', jpg: 'üñºÔ∏è', pdf: 'üìï', zip: 'üì¶' };
      return icons[ext] || 'üìÑ';
    }

    function formatSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function updateBreadcrumb(path) {
      const parts = path.split('/').filter(p => p);
      let html = '<span class="breadcrumb-item" data-path="/">üè† Home</span>';
      let currentPath = '';
      parts.forEach(part => {
        currentPath += '/' + part;
        html += `<span class="breadcrumb-sep">/</span><span class="breadcrumb-item" data-path="${currentPath}">${part}</span>`;
      });
      const breadcrumb = document.getElementById('breadcrumb');
      breadcrumb.innerHTML = html;
      breadcrumb.querySelectorAll('.breadcrumb-item').forEach(item => {
        item.addEventListener('click', () => loadFiles(item.dataset.path));
      });
    }

    async function loadApps() {
      if (!state.user) return;
      try {
        // Load from both sources for compatibility
        const apps1 = JSON.parse(await puter.kv.get('cloudpilot_apps') || '[]');
        const apps2 = JSON.parse(await puter.kv.get('cloudpilot_deployments') || '[]');
        const allApps = [...apps1, ...apps2.filter(a => !apps1.find(x => x.id === a.id))];
        state.apps = allApps;
        document.getElementById('statApps').textContent = allApps.length;
        
        // Also update appsManager if it exists
        if (typeof appsManager !== 'undefined') {
          appsManager.apps = allApps;
          appsManager.renderApps();
          appsManager.updateStats();
        } else {
          renderApps(allApps);
        }
      } catch (e) { console.error('Failed to load apps:', e); }
    }

    function renderApps(apps) {
      const container = document.getElementById('appsList');
      if (!apps || apps.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üåê</div><div class="empty-state-title">No apps deployed</div><div class="empty-state-desc">Ask AI to create an app for you</div></div>`;
        return;
      }
      container.innerHTML = apps.map(app => `
        <div style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 10px;">
          <div style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 18px;">üåê</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 14px;">${app.name}</div>
            <div style="font-size: 12px; color: var(--text-muted);">Deployed ${new Date(app.createdAt).toLocaleDateString()}</div>
          </div>
          <a href="${app.url}" target="_blank" class="btn btn-primary" style="padding: 8px 14px; font-size: 12px; text-decoration: none;">üîó Open</a>
        </div>
      `).join('');
    }

    async function loadFunctions() {
      if (!state.user) return;
      try {
        const functions = JSON.parse(await puter.kv.get('cloudpilot_functions') || '[]');
        state.functions = functions;
        document.getElementById('statFunctions').textContent = functions.length;
        renderFunctions(functions);
      } catch (e) { console.error('Failed to load functions:', e); }
    }

    function renderFunctions(functions) {
      const container = document.getElementById('functionsList');
      if (!functions || functions.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö°</div><div class="empty-state-title">No functions yet</div></div>`;
        return;
      }
      container.innerHTML = functions.map(fn => `
        <div style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 10px;">
          <div style="width: 42px; height: 42px; background: rgba(139, 92, 246, 0.15); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 18px;">‚ö°</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 14px;">${fn.name}</div>
            <div style="font-size: 12px; color: var(--text-muted);">Updated ${new Date(fn.updatedAt).toLocaleDateString()}</div>
          </div>
          <button class="btn btn-secondary" style="padding: 8px 14px; font-size: 12px;" onclick="editFunction('${fn.name}')">‚úèÔ∏è Edit</button>
        </div>
      `).join('');
    }

    async function loadWorkflows() {
      if (!state.user) return;
      try {
        const workflows = JSON.parse(await puter.kv.get('cloudpilot_workflows') || '[]');
        state.workflows = workflows;
        renderWorkflows(workflows);
      } catch (e) { console.error('Failed to load workflows:', e); }
    }

    function renderWorkflows(workflows) {
      const container = document.getElementById('workflowsList');
      if (!workflows || workflows.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üîÑ</div><div class="empty-state-title">No workflows saved</div></div>`;
        return;
      }
      container.innerHTML = workflows.map(wf => `
        <div style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 10px;">
          <div style="width: 42px; height: 42px; background: rgba(6, 182, 212, 0.15); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 18px;">üîÑ</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; font-size: 14px;">${wf.name}</div>
            <div style="font-size: 12px; color: var(--text-muted);">${wf.steps?.length || 0} steps</div>
          </div>
        </div>
      `).join('');
    }

    // ============ CHAT & CLOUDPILOT DIRECTOR ============
    async function sendMessage(customPrompt = null) {
      const message = customPrompt || document.getElementById('chatInput').value.trim();
      if (!message) return;

      addMessage(message, 'user');
      document.getElementById('chatInput').value = '';
      document.getElementById('sendBtn').disabled = true;

      // CloudPilot Director handles ALL user requests
      if (state.user) {
        agent.setModel(document.getElementById('globalModelSelect').value);
        
        // Route through CloudPilot Director for intelligent handling
        try {
          await cloudpilotDirector.processUserRequest(message);
          aiMemory.analyzeAndLearn(message, 'CloudPilot processed request');
        } catch (e) {
          console.error('CloudPilot error:', e);
          // Fallback to direct agent execution
          await agent.execute(message);
        }
      } else {
        addTypingIndicator();
        try {
          // Build context-aware prompt with AI memory
          const memoryContext = aiMemory.getContextPrompt();
          const systemPrompt = `You are CloudPilot AI, the central director for all cloud operations. You manage agents, workflows, deployments, and AI generation. 

${AGENT_CONSTITUTION.getPuterPriority()}

Help users with Puter cloud services. For any action, you will direct the appropriate agent.${memoryContext}`;
          
          const response = await callAI([
            { role: 'system', content: systemPrompt },
            { role: 'user', content: message }
          ], { model: document.getElementById('globalModelSelect').value });

          removeTypingIndicator();
          let content = response?.message?.content || 'Please sign in to unlock full CloudPilot capabilities.';
          if (Array.isArray(content)) content = content[0]?.text || content[0];
          
          // Learn from this interaction
          aiMemory.analyzeAndLearn(message, content);
          
          content = content.replace(/\n/g, '<br>').replace(/`([^`]+)`/g, '<code>$1</code>');
          addMessage(content);
        } catch (e) {
          removeTypingIndicator();
          addMessage('Sign in to access CloudPilot AI - your central director for all cloud operations.', 'system');
        }
      }

      document.getElementById('sendBtn').disabled = false;
    }

    document.getElementById('sendBtn').addEventListener('click', () => sendMessage());
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });
    document.getElementById('chatInput').addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 150) + 'px';
    });

    // Prompt chips & action buttons
    document.querySelectorAll('.prompt-chip').forEach(chip => {
      chip.addEventListener('click', () => sendMessage(chip.dataset.prompt));
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('chat-action-btn')) {
        const actions = {
          'deploy-landing': 'Create and deploy a modern landing page for a tech startup with hero section, features, and contact form',
          'create-api': 'Create a serverless function that returns random inspirational quotes',
          'analyze-storage': 'Analyze my cloud storage and tell me what files are taking up the most space'
        };
        const prompt = actions[e.target.dataset.action];
        if (prompt) sendMessage(prompt);
      }
    });

    document.getElementById('clearChatBtn').addEventListener('click', () => {
      document.getElementById('chatMessages').innerHTML = `
        <div class="chat-message ai">
          <div class="chat-avatar">ü§ñ</div>
          <div class="chat-bubble">Chat cleared! How can I help you manage your cloud?</div>
        </div>`;
    });

    // ============ QUICK ACTIONS ============
    document.querySelectorAll('.quick-action-card').forEach(card => {
      card.addEventListener('click', () => {
        const actions = {
          'agent-deploy': 'Create and deploy a beautiful landing page for my project',
          'agent-analyze': 'Analyze my cloud storage and suggest optimizations',
          'agent-function': 'Create a serverless function that returns weather data for a city',
          'agent-workflow': 'Set up a workflow to backup my important files daily'
        };
        const prompt = actions[card.dataset.action];
        if (prompt) {
          switchView('agent');
          setTimeout(() => sendMessage(prompt), 100);
        }
      });
    });

    document.getElementById('aiAgentBtn').addEventListener('click', () => switchView('agent'));

    // ============ STORAGE ============
    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!state.user) { showToast('Please sign in first', 'warning'); return; }
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      input.onchange = async (e) => {
        for (const file of e.target.files) {
          try {
            const path = state.currentPath === '/' ? `/${file.name}` : `${state.currentPath}/${file.name}`;
            await puter.fs.write(path, file);
            showToast(`Uploaded: ${file.name}`, 'success');
          } catch (err) { showToast(`Failed: ${file.name}`, 'error'); }
        }
        loadFiles(state.currentPath);
      };
      input.click();
    });

    document.getElementById('newFolderBtn').addEventListener('click', () => {
      document.getElementById('folderModal').classList.add('active');
    });

    document.getElementById('createFolderBtn').addEventListener('click', async () => {
      const name = document.getElementById('folderNameInput').value.trim();
      if (!name) return;
      try {
        const path = state.currentPath === '/' ? `/${name}` : `${state.currentPath}/${name}`;
        await puter.fs.mkdir(path);
        showToast('Folder created!', 'success');
        document.getElementById('folderModal').classList.remove('active');
        document.getElementById('folderNameInput').value = '';
        loadFiles(state.currentPath);
      } catch (e) { showToast('Failed to create folder', 'error'); }
    });

    document.getElementById('refreshStorageBtn').addEventListener('click', () => loadFiles(state.currentPath));

    // ============ ENHANCED FILE MANAGER ============
    const fileManager = {
      selectedFiles: new Set(),
      clipboard: { files: [], operation: null },
      viewMode: 'list',
      sortBy: 'name',
      
      formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
      },
      
      async updateStats() {
        if (!state.user) return;
        try {
          const items = await puter.fs.readdir(state.currentPath);
          const files = items.filter(i => !i.is_dir);
          const folders = items.filter(i => i.is_dir);
          let totalSize = 0;
          files.forEach(f => totalSize += (f.size || 0));
          
          document.getElementById('storageFileCount').textContent = files.length;
          document.getElementById('storageFolderCount').textContent = folders.length;
          document.getElementById('storageTotalSize').textContent = this.formatSize(totalSize);
        } catch (e) {}
      },
      
      toggleSelect(path) {
        if (this.selectedFiles.has(path)) {
          this.selectedFiles.delete(path);
        } else {
          this.selectedFiles.add(path);
        }
        this.updateSelectionUI();
      },
      
      selectAll() {
        document.querySelectorAll('.file-item-row').forEach(row => {
          this.selectedFiles.add(row.dataset.path);
        });
        this.updateSelectionUI();
      },
      
      clearSelection() {
        this.selectedFiles.clear();
        this.updateSelectionUI();
      },
      
      updateSelectionUI() {
        const bar = document.getElementById('fileSelectionBar');
        const count = this.selectedFiles.size;
        if (count > 0) {
          bar.style.display = 'block';
          document.getElementById('selectedCount').textContent = `${count} selected`;
        } else {
          bar.style.display = 'none';
        }
        document.querySelectorAll('.file-item-row').forEach(row => {
          row.classList.toggle('selected', this.selectedFiles.has(row.dataset.path));
        });
      },
      
      async renameItem(path) {
        const oldName = path.split('/').pop();
        const newName = prompt('Enter new name:', oldName);
        if (!newName || newName === oldName) return;
        const newPath = path.replace(oldName, newName);
        try {
          await puter.fs.move(path, newPath);
          showToast('Renamed successfully', 'success');
          loadFiles(state.currentPath);
        } catch (e) { showToast('Rename failed', 'error'); }
      },
      
      async deleteItems(paths) {
        if (!confirm(`Delete ${paths.length} item(s)?`)) return;
        for (const path of paths) {
          try {
            await puter.fs.delete(path);
          } catch (e) {}
        }
        showToast('Deleted', 'success');
        this.clearSelection();
        loadFiles(state.currentPath);
      },
      
      async moveItems(paths, destFolder) {
        for (const path of paths) {
          const name = path.split('/').pop();
          const dest = destFolder === '/' ? `/${name}` : `${destFolder}/${name}`;
          try {
            await puter.fs.move(path, dest);
          } catch (e) {}
        }
        showToast('Moved', 'success');
        this.clearSelection();
        loadFiles(state.currentPath);
      },
      
      async copyItems(paths, destFolder) {
        for (const path of paths) {
          const name = path.split('/').pop();
          const dest = destFolder === '/' ? `/${name}` : `${destFolder}/${name}`;
          try {
            await puter.fs.copy(path, dest);
          } catch (e) {}
        }
        showToast('Copied', 'success');
        loadFiles(state.currentPath);
      },
      
      async downloadItem(path) {
        try {
          const url = await puter.fs.publicURL(path);
          const a = document.createElement('a');
          a.href = url;
          a.download = path.split('/').pop();
          a.click();
        } catch (e) { showToast('Download failed', 'error'); }
      },
      
      async previewFile(path, name) {
        try {
          const content = await puter.fs.read(path);
          const text = typeof content === 'string' ? content : await content.text();
          document.getElementById('previewFileName').textContent = name;
          document.getElementById('filePreviewContent').querySelector('pre').textContent = text;
          document.getElementById('filePreviewPanel').style.display = 'block';
          document.getElementById('filePreviewPanel').dataset.path = path;
        } catch (e) { showToast('Cannot preview this file', 'warning'); }
      },
      
      showContextMenu(e, path, isDir) {
        e.preventDefault();
        const existing = document.querySelector('.context-menu');
        if (existing) existing.remove();
        
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.cssText = `position: fixed; left: ${e.clientX}px; top: ${e.clientY}px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; min-width: 160px;`;
        
        const items = [
          { icon: 'üëÅÔ∏è', label: 'Preview', action: () => this.previewFile(path, path.split('/').pop()), hidden: isDir },
          { icon: 'üì•', label: 'Download', action: () => this.downloadItem(path), hidden: isDir },
          { icon: '‚úèÔ∏è', label: 'Rename', action: () => this.renameItem(path) },
          { icon: 'üìã', label: 'Copy', action: () => { this.clipboard = { files: [path], operation: 'copy' }; showToast('Copied to clipboard', 'info'); } },
          { icon: '‚úÇÔ∏è', label: 'Cut', action: () => { this.clipboard = { files: [path], operation: 'move' }; showToast('Cut to clipboard', 'info'); } },
          { icon: 'üóëÔ∏è', label: 'Delete', action: () => this.deleteItems([path]) }
        ].filter(i => !i.hidden);
        
        menu.innerHTML = items.map(item => `
          <div class="context-menu-item" style="padding: 10px 14px; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px;">
            <span>${item.icon}</span> ${item.label}
          </div>
        `).join('');
        
        document.body.appendChild(menu);
        menu.querySelectorAll('.context-menu-item').forEach((el, i) => {
          el.addEventListener('click', () => { items[i].action(); menu.remove(); });
          el.addEventListener('mouseenter', () => el.style.background = 'var(--bg-secondary)');
          el.addEventListener('mouseleave', () => el.style.background = 'transparent');
        });
        
        document.addEventListener('click', () => menu.remove(), { once: true });
      }
    };
    
    // File manager event listeners
    document.getElementById('fileViewMode')?.addEventListener('change', (e) => {
      fileManager.viewMode = e.target.value;
      loadFiles(state.currentPath);
    });
    
    document.getElementById('fileSortBy')?.addEventListener('change', (e) => {
      fileManager.sortBy = e.target.value;
      loadFiles(state.currentPath);
    });
    
    document.getElementById('fileSearchInput')?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.file-item-row').forEach(row => {
        const name = row.querySelector('.file-name')?.textContent.toLowerCase() || '';
        row.style.display = name.includes(query) ? '' : 'none';
      });
    });
    
    document.getElementById('bulkDeleteBtn')?.addEventListener('click', () => {
      fileManager.deleteItems([...fileManager.selectedFiles]);
    });
    
    document.getElementById('bulkMoveBtn')?.addEventListener('click', async () => {
      const dest = prompt('Move to folder (path):');
      if (dest) await fileManager.moveItems([...fileManager.selectedFiles], dest);
    });
    
    document.getElementById('bulkCopyBtn')?.addEventListener('click', async () => {
      const dest = prompt('Copy to folder (path):');
      if (dest) await fileManager.copyItems([...fileManager.selectedFiles], dest);
    });
    
    document.getElementById('clearSelectionBtn')?.addEventListener('click', () => {
      fileManager.clearSelection();
    });
    
    document.getElementById('closePreviewBtn')?.addEventListener('click', () => {
      document.getElementById('filePreviewPanel').style.display = 'none';
    });
    
    document.getElementById('previewDownloadBtn')?.addEventListener('click', () => {
      const path = document.getElementById('filePreviewPanel').dataset.path;
      if (path) fileManager.downloadItem(path);
    });
    
    document.getElementById('newFileBtn')?.addEventListener('click', async () => {
      if (!state.user) { showToast('Please sign in first', 'warning'); return; }
      const name = prompt('New file name (with extension):');
      if (!name) return;
      const path = state.currentPath === '/' ? `/${name}` : `${state.currentPath}/${name}`;
      try {
        await puter.fs.write(path, '');
        showToast('File created', 'success');
        loadFiles(state.currentPath);
      } catch (e) { showToast('Failed to create file', 'error'); }
    });

    // ============ APPS MANAGER ============
    const appsManager = {
      apps: [],
      selectedApp: null,
      
      async loadApps() {
        if (!state.user) return;
        try {
          const data = await puter.kv.get('cloudpilot_deployments');
          this.apps = data ? JSON.parse(data) : [];
          this.renderApps();
          this.updateStats();
        } catch (e) {}
      },
      
      updateStats() {
        document.getElementById('appsCount').textContent = this.apps.length;
        document.getElementById('appsLiveCount').textContent = this.apps.filter(a => a.status === 'live').length;
        document.getElementById('appsFunctionsCount').textContent = this.apps.filter(a => a.type === 'function').length;
        document.getElementById('appsGamesCount').textContent = this.apps.filter(a => a.type === 'game').length;
      },
      
      renderApps() {
        const list = document.getElementById('appsList');
        const typeFilter = document.getElementById('appFilterType')?.value || 'all';
        const statusFilter = document.getElementById('appFilterStatus')?.value || 'all';
        
        let filtered = this.apps;
        if (typeFilter !== 'all') filtered = filtered.filter(a => a.type === typeFilter);
        if (statusFilter !== 'all') filtered = filtered.filter(a => a.status === statusFilter);
        
        if (filtered.length === 0) {
          list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üåê</div><div class="empty-state-title">No apps found</div></div>';
          return;
        }
        
        list.innerHTML = filtered.map(app => `
          <div class="app-card" onclick="appsManager.selectApp('${app.id}')" style="display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 10px; cursor: pointer; border: 2px solid ${this.selectedApp?.id === app.id ? 'var(--accent)' : 'transparent'};">
            <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent), var(--accent-purple)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 20px;">
              ${app.type === 'site' ? 'üåê' : app.type === 'function' ? '‚ö°' : app.type === 'game' ? 'üéÆ' : 'üì¶'}
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${app.name}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${app.subdomain || app.id}.puter.site</div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
              <span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: ${app.status === 'live' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)'}; border-radius: 12px; font-size: 10px; color: ${app.status === 'live' ? 'var(--accent-green)' : 'var(--accent-yellow)'};">
                <span style="width: 6px; height: 6px; border-radius: 50%; background: currentColor;"></span>
                ${app.status || 'live'}
              </span>
              <span style="font-size: 10px; color: var(--text-muted);">${new Date(app.createdAt).toLocaleDateString()}</span>
            </div>
          </div>
        `).join('');
      },
      
      selectApp(id) {
        this.selectedApp = this.apps.find(a => a.id === id);
        this.renderApps();
        this.renderDetails();
      },
      
      renderDetails() {
        const panel = document.getElementById('appDetailsPanel');
        if (!this.selectedApp) {
          panel.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëÜ</div><div class="empty-state-title">Select an app</div></div>';
          return;
        }
        
        const app = this.selectedApp;
        panel.innerHTML = `
          <div style="margin-bottom: 20px;">
            <h3 style="margin: 0 0 4px; font-size: 18px;">${app.name}</h3>
            <div style="font-size: 12px; color: var(--text-muted);">${app.description || 'No description'}</div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm);">
              <div style="font-size: 11px; color: var(--text-muted);">Type</div>
              <div style="font-weight: 600;">${app.type || 'site'}</div>
            </div>
            <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm);">
              <div style="font-size: 11px; color: var(--text-muted);">Status</div>
              <div style="font-weight: 600; color: ${app.status === 'live' ? 'var(--accent-green)' : 'var(--accent-yellow)'};">${app.status || 'live'}</div>
            </div>
            <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm);">
              <div style="font-size: 11px; color: var(--text-muted);">Created</div>
              <div style="font-weight: 600;">${new Date(app.createdAt).toLocaleDateString()}</div>
            </div>
            <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm);">
              <div style="font-size: 11px; color: var(--text-muted);">ID</div>
              <div style="font-weight: 600; font-size: 11px; font-family: var(--font-mono);">${app.id}</div>
            </div>
          </div>
          <div style="margin-bottom: 16px;">
            <label style="font-size: 12px; font-weight: 500; display: block; margin-bottom: 6px;">Live URL</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" class="form-input" value="${app.url || 'https://' + (app.subdomain || app.id) + '.puter.site'}" readonly style="font-size: 12px;">
              <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="window.open('${app.url || 'https://' + (app.subdomain || app.id) + '.puter.site'}', '_blank')">üîó Open</button>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <button class="btn btn-primary" onclick="appsManager.viewSource('${app.id}')" style="width: 100%;">üìÑ View Source</button>
            <button class="btn btn-secondary" onclick="appsManager.editApp('${app.id}')" style="width: 100%;">‚úèÔ∏è Edit & Redeploy</button>
            <button class="btn btn-danger" onclick="appsManager.deleteApp('${app.id}')" style="width: 100%;">üóëÔ∏è Delete App</button>
          </div>
        `;
      },
      
      viewSource(id) {
        const app = this.apps.find(a => a.id === id);
        if (!app || !app.html) { showToast('No source available', 'warning'); return; }
        
        document.getElementById('sourceViewerTitle').textContent = app.name + ' - Source';
        document.getElementById('sourceViewerContent').querySelector('pre').textContent = app.html;
        document.getElementById('sourceViewerModal').style.display = 'block';
        document.getElementById('sourceViewerOverlay').style.display = 'block';
      },
      
      async deleteApp(id) {
        if (!confirm('Delete this app?')) return;
        this.apps = this.apps.filter(a => a.id !== id);
        await puter.kv.set('cloudpilot_deployments', JSON.stringify(this.apps));
        this.selectedApp = null;
        this.renderApps();
        this.renderDetails();
        this.updateStats();
        showToast('App deleted', 'success');
      },
      
      editApp(id) {
        const app = this.apps.find(a => a.id === id);
        if (!app) return;
        document.getElementById('appName').value = app.name;
        document.getElementById('appCode').value = app.html || '';
        document.getElementById('appDescription').value = app.description || '';
        document.getElementById('deployPanel').style.display = 'block';
        document.getElementById('deployOverlay').style.display = 'block';
      }
    };
    
    // Apps manager events
    document.getElementById('refreshAppsBtn')?.addEventListener('click', () => appsManager.loadApps());
    document.getElementById('appFilterType')?.addEventListener('change', () => appsManager.renderApps());
    document.getElementById('appFilterStatus')?.addEventListener('change', () => appsManager.renderApps());
    document.getElementById('appSearchInput')?.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('.app-card').forEach(card => {
        const name = card.querySelector('div[style*="font-weight: 600"]')?.textContent.toLowerCase() || '';
        card.style.display = name.includes(query) ? '' : 'none';
      });
    });
    
    document.getElementById('sourceCloseBtn')?.addEventListener('click', () => {
      document.getElementById('sourceViewerModal').style.display = 'none';
      document.getElementById('sourceViewerOverlay').style.display = 'none';
    });
    document.getElementById('sourceViewerOverlay')?.addEventListener('click', () => {
      document.getElementById('sourceViewerModal').style.display = 'none';
      document.getElementById('sourceViewerOverlay').style.display = 'none';
    });
    document.getElementById('sourceCopyBtn')?.addEventListener('click', () => {
      const code = document.getElementById('sourceViewerContent').querySelector('pre').textContent;
      navigator.clipboard.writeText(code);
      showToast('Copied to clipboard', 'success');
    });

    // ============ POLICY EDITOR ============
    const policyEditor = {
      policies: [],
      editingPolicy: null,
      
      async loadPolicies() {
        if (!state.user) return;
        try {
          const data = await puter.kv.get('cloudpilot_policies');
          this.policies = data ? JSON.parse(data) : [];
        } catch (e) { this.policies = []; }
      },
      
      openEditor(policy = null) {
        this.editingPolicy = policy;
        document.getElementById('policyEditorTitle').textContent = policy ? 'Edit Policy' : 'Create Policy';
        document.getElementById('policyName').value = policy?.name || '';
        document.getElementById('policyType').value = policy?.type || 'allow';
        document.getElementById('policyPriority').value = policy?.priority || 'medium';
        document.getElementById('policyDescription').value = policy?.description || '';
        
        document.getElementById('policyEditorModal').style.display = 'block';
        document.getElementById('policyEditorOverlay').style.display = 'block';
      },
      
      closeEditor() {
        document.getElementById('policyEditorModal').style.display = 'none';
        document.getElementById('policyEditorOverlay').style.display = 'none';
        this.editingPolicy = null;
      },
      
      addCondition() {
        const container = document.getElementById('policyConditions');
        const condition = document.createElement('div');
        condition.className = 'policy-condition';
        condition.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 8px;';
        condition.innerHTML = `
          <select class="form-input condition-field" style="width: 120px; padding: 6px; font-size: 12px;">
            <option value="ip">IP Address</option>
            <option value="country">Country</option>
            <option value="path">URL Path</option>
            <option value="method">HTTP Method</option>
            <option value="header">Header</option>
            <option value="user_agent">User Agent</option>
          </select>
          <select class="form-input condition-operator" style="width: 100px; padding: 6px; font-size: 12px;">
            <option value="equals">equals</option>
            <option value="contains">contains</option>
            <option value="starts_with">starts with</option>
            <option value="matches">matches regex</option>
            <option value="in_list">in list</option>
          </select>
          <input type="text" class="form-input condition-value" style="flex: 1; padding: 6px; font-size: 12px;" placeholder="Value...">
          <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="this.closest('.policy-condition').remove();">‚úï</button>
        `;
        container.appendChild(condition);
      },
      
      getConditions() {
        const conditions = [];
        document.querySelectorAll('.policy-condition').forEach(row => {
          conditions.push({
            field: row.querySelector('.condition-field').value,
            operator: row.querySelector('.condition-operator').value,
            value: row.querySelector('.condition-value').value
          });
        });
        return conditions;
      },
      
      async savePolicy() {
        const policy = {
          id: this.editingPolicy?.id || 'policy_' + Date.now(),
          name: document.getElementById('policyName').value,
          type: document.getElementById('policyType').value,
          priority: document.getElementById('policyPriority').value,
          description: document.getElementById('policyDescription').value,
          conditions: this.getConditions(),
          enabled: true,
          createdAt: this.editingPolicy?.createdAt || new Date().toISOString()
        };
        
        if (!policy.name) { showToast('Enter policy name', 'warning'); return; }
        
        const idx = this.policies.findIndex(p => p.id === policy.id);
        if (idx >= 0) {
          this.policies[idx] = policy;
        } else {
          this.policies.push(policy);
        }
        
        await puter.kv.set('cloudpilot_policies', JSON.stringify(this.policies));
        this.closeEditor();
        loadNetworkData();
        showToast('Policy saved', 'success');
      }
    };
    
    document.getElementById('addPolicyBtn')?.addEventListener('click', () => policyEditor.openEditor());
    document.getElementById('closePolicyEditorBtn')?.addEventListener('click', () => policyEditor.closeEditor());
    document.getElementById('policyEditorOverlay')?.addEventListener('click', () => policyEditor.closeEditor());
    document.getElementById('addConditionBtn')?.addEventListener('click', () => policyEditor.addCondition());
    document.getElementById('savePolicyBtn')?.addEventListener('click', () => policyEditor.savePolicy());
    document.getElementById('policyType')?.addEventListener('change', (e) => {
      document.getElementById('rateLimitOptions').style.display = e.target.value === 'ratelimit' ? 'block' : 'none';
    });
    document.getElementById('clearAuditBtn')?.addEventListener('click', async () => {
      if (!confirm('Clear audit log?')) return;
      await puter.kv.set('cloudpilot_audit', '[]');
      document.getElementById('auditLog').innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Audit log cleared</div>';
      showToast('Audit log cleared', 'info');
    });

    // Deploy panel events
    document.getElementById('newAppBtn')?.addEventListener('click', () => {
      document.getElementById('deployPanel').style.display = 'block';
      document.getElementById('deployOverlay').style.display = 'block';
    });
    
    document.getElementById('cancelDeployBtn')?.addEventListener('click', () => {
      document.getElementById('deployPanel').style.display = 'none';
      document.getElementById('deployOverlay').style.display = 'none';
    });
    
    document.getElementById('deployOverlay')?.addEventListener('click', () => {
      document.getElementById('deployPanel').style.display = 'none';
      document.getElementById('deployOverlay').style.display = 'none';
    });

    // ============ APPS ============
    document.getElementById('newAppBtn').addEventListener('click', () => {
      document.getElementById('appsListPanel').style.display = 'none';
      document.getElementById('deployPanel').style.display = 'block';
    });

    document.getElementById('cancelDeployBtn').addEventListener('click', () => {
      document.getElementById('deployPanel').style.display = 'none';
      document.getElementById('appsListPanel').style.display = 'block';
    });

    document.getElementById('aiGenerateAppBtn').addEventListener('click', async () => {
      const appName = document.getElementById('appName').value || 'My App';
      showToast('Generating code...', 'info');
      try {
        const response = await callAI([
          { role: 'system', content: 'Generate clean, modern HTML code. Return ONLY the HTML, no explanation.' },
          { role: 'user', content: `Create a beautiful landing page HTML for "${appName}". Include inline CSS with gradient background, centered content, and modern styling.` }
        ], { model: state.selectedModel });
        let code = response?.message?.content || '';
        if (Array.isArray(code)) code = code[0]?.text || code[0];
        const match = code.match(/```(?:html)?\n?([\s\S]*?)```/);
        document.getElementById('appCode').value = match ? match[1].trim() : code.trim();
        showToast('Code generated!', 'success');
      } catch (e) { showToast('Generation failed', 'error'); }
    });

    document.getElementById('deployAppBtn').addEventListener('click', async () => {
      const name = document.getElementById('appName').value.trim();
      const html = document.getElementById('appCode').value.trim();
      if (!name || !html) { showToast('Enter app name and code', 'warning'); return; }
      try {
        const result = await tools.deploy_app.execute({ name, html });
        showToast('App deployed!', 'success');
        document.getElementById('deployPanel').style.display = 'none';
        document.getElementById('appsListPanel').style.display = 'block';
        loadApps();
        window.open(result.url, '_blank');
      } catch (e) { showToast('Deploy failed', 'error'); }
    });

    // ============ FUNCTIONS ============
    document.getElementById('newFunctionBtn').addEventListener('click', () => {
      document.getElementById('functionsListPanel').style.display = 'none';
      document.getElementById('functionEditorPanel').style.display = 'block';
      document.getElementById('functionName').value = '';
      document.getElementById('functionCode').value = `async function handler(request) {
  return {
    statusCode: 200,
    body: JSON.stringify({ message: 'Hello from CloudPilot!' })
  };
}`;
    });

    document.getElementById('cancelFunctionBtn').addEventListener('click', () => {
      document.getElementById('functionEditorPanel').style.display = 'none';
      document.getElementById('functionsListPanel').style.display = 'block';
    });

    document.getElementById('aiGenerateFunctionBtn').addEventListener('click', async () => {
      const fnName = document.getElementById('functionName').value || 'myFunction';
      showToast('Generating code...', 'info');
      try {
        const response = await callAI([
          { role: 'system', content: 'Generate JavaScript serverless function code. Return ONLY code, no explanation.' },
          { role: 'user', content: `Create a serverless function called "${fnName}" that does something useful. Include async handler function.` }
        ], { model: state.selectedModel });
        let code = response?.message?.content || '';
        if (Array.isArray(code)) code = code[0]?.text || code[0];
        const match = code.match(/```(?:javascript|js)?\n?([\s\S]*?)```/);
        document.getElementById('functionCode').value = match ? match[1].trim() : code.trim();
        showToast('Code generated!', 'success');
      } catch (e) { showToast('Generation failed', 'error'); }
    });

    document.getElementById('saveFunctionBtn').addEventListener('click', async () => {
      const name = document.getElementById('functionName').value.trim();
      const code = document.getElementById('functionCode').value.trim();
      if (!name || !code) { showToast('Enter name and code', 'warning'); return; }
      try {
        await tools.save_function.execute({ name, code });
        showToast('Function saved!', 'success');
        document.getElementById('functionEditorPanel').style.display = 'none';
        document.getElementById('functionsListPanel').style.display = 'block';
        loadFunctions();
      } catch (e) { showToast('Save failed', 'error'); }
    });

    document.getElementById('testFunctionBtn').addEventListener('click', async () => {
      const code = document.getElementById('functionCode').value;
      try {
        const result = await tools.run_function.execute({ code });
        document.getElementById('functionOutput').style.display = 'block';
        document.getElementById('functionOutputContent').textContent = JSON.stringify(result.result, null, 2);
        showToast('Function executed!', 'success');
      } catch (e) {
        document.getElementById('functionOutput').style.display = 'block';
        document.getElementById('functionOutputContent').textContent = `Error: ${e.message}`;
        showToast('Execution failed', 'error');
      }
    });

    window.editFunction = (name) => {
      const fn = state.functions.find(f => f.name === name);
      if (fn) {
        document.getElementById('functionsListPanel').style.display = 'none';
        document.getElementById('functionEditorPanel').style.display = 'block';
        document.getElementById('functionName').value = fn.name;
        document.getElementById('functionCode').value = fn.code;
      }
    };

    // ============ NETWORK & ACCESS ============
    async function loadNetworkData() {
      if (!state.user) return;
      try {
        const services = JSON.parse(await puter.kv.get('cloudpilot_services') || '[]');
        const policies = JSON.parse(await puter.kv.get('cloudpilot_policies') || '[]');
        
        // Update stats
        document.getElementById('statOpenPorts').textContent = services.filter(s => s.status === 'open').length;
        document.getElementById('statSecuredPorts').textContent = services.filter(s => s.secured).length;
        document.getElementById('statWarnings').textContent = services.filter(s => !s.secured).length;
        document.getElementById('statPolicies').textContent = policies.length;
        
        // Update services list
        const servicesList = document.getElementById('servicesList');
        if (services.length === 0) {
          servicesList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üîç</div>
              <div class="empty-state-title">No scan yet</div>
              <div class="empty-state-desc">Click "Scan Ports" to discover services</div>
            </div>`;
        } else {
          servicesList.innerHTML = services.map(svc => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 8px;">
              <div style="width: 36px; height: 36px; background: ${svc.secured ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)'}; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 16px;">
                ${svc.type === 'web-app' ? 'üåê' : svc.type === 'function' ? '‚ö°' : svc.type === 'storage' ? 'üìÅ' : svc.type === 'database' ? 'üóÑÔ∏è' : 'üîå'}
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${svc.name}</div>
                <div style="font-size: 11px; color: var(--text-muted);">${svc.protocol}:${svc.port} ‚Ä¢ ${svc.type}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="width: 8px; height: 8px; border-radius: 50%; background: ${svc.status === 'open' ? 'var(--accent-green)' : 'var(--text-muted)'};"></span>
                <span style="font-size: 11px; color: ${svc.secured ? 'var(--accent-green)' : 'var(--accent-yellow)'};">${svc.secured ? 'Secured' : 'Exposed'}</span>
              </div>
            </div>
          `).join('');
        }
        
        // Update policies list
        const policiesList = document.getElementById('policiesList');
        if (policies.length === 0) {
          policiesList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üõ°Ô∏è</div>
              <div class="empty-state-title">No policies</div>
              <div class="empty-state-desc">Create access control policies</div>
            </div>`;
        } else {
          policiesList.innerHTML = policies.map(p => `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 8px;">
              <div style="width: 36px; height: 36px; background: rgba(139, 92, 246, 0.15); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 16px;">
                ${p.type === 'rate-limit' ? '‚è±Ô∏è' : p.type === 'auth' ? 'üîê' : p.type === 'security' ? 'üõ°Ô∏è' : 'üìã'}
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 13px;">${p.name}</div>
                <div style="font-size: 11px; color: var(--text-muted);">Target: ${p.target} ‚Ä¢ ${p.type}</div>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 11px; color: ${p.enabled ? 'var(--accent-green)' : 'var(--text-muted)'};">${p.enabled ? 'Active' : 'Disabled'}</span>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="deletePolicy('${p.id}')">Delete</button>
              </div>
            </div>
          `).join('');
        }
        
        updateAuditDisplay();
      } catch (e) { console.error('Failed to load network data:', e); }
    }

    document.getElementById('scanPortsBtn').addEventListener('click', async () => {
      if (!state.user) { showToast('Please sign in first', 'warning'); return; }
      showToast('Scanning services...', 'info');
      try {
        const result = await tools.scan_ports.execute();
        loadNetworkData();
        showToast(`Found ${result.services.length} services`, 'success');
      } catch (e) { showToast('Scan failed', 'error'); }
    });

    document.getElementById('autoSecureBtn').addEventListener('click', async () => {
      if (!state.user) { showToast('Please sign in first', 'warning'); return; }
      showToast('Applying security policies...', 'info');
      try {
        const result = await tools.auto_secure.execute();
        loadNetworkData();
        showToast(result.message, 'success');
      } catch (e) { showToast('Auto-secure failed', 'error'); }
    });

    document.getElementById('addPolicyBtn').addEventListener('click', async () => {
      if (!state.user) { showToast('Please sign in first', 'warning'); return; }
      const name = prompt('Policy name:');
      if (!name) return;
      const target = prompt('Target (service name or path, e.g. * for all):') || '*';
      const type = prompt('Policy type (rate-limit, auth, security):') || 'security';
      
      try {
        await tools.create_access_policy.execute({ name, target, type });
        loadNetworkData();
        showToast('Policy created!', 'success');
      } catch (e) { showToast('Failed to create policy', 'error'); }
    });

    window.deletePolicy = async (id) => {
      if (!confirm('Delete this policy?')) return;
      try {
        await tools.delete_access_policy.execute({ id });
        loadNetworkData();
        showToast('Policy deleted', 'success');
      } catch (e) { showToast('Failed to delete policy', 'error'); }
    };

    document.getElementById('exportAuditBtn').addEventListener('click', async () => {
      if (!state.user) { showToast('Please sign in first', 'warning'); return; }
      try {
        const log = JSON.parse(await puter.kv.get('cloudpilot_audit') || '[]');
        const csv = 'Timestamp,Action,Details,User\n' + log.map(e => 
          `"${e.timestamp}","${e.action}","${e.details}","${e.user}"`
        ).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cloudpilot-audit-log.csv';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Audit log exported', 'success');
      } catch (e) { showToast('Export failed', 'error'); }
    });

    // ============ MODALS ============
    document.querySelectorAll('[data-close-modal]').forEach(btn => {
      btn.addEventListener('click', () => btn.closest('.modal-overlay').classList.remove('active'));
    });

    // ============ MODEL SELECTOR ============
    document.getElementById('globalModelSelect').addEventListener('change', (e) => {
      state.selectedModel = e.target.value;
      agent.setModel(e.target.value);
    });

    // ============ CODE STUDIO ============
    let studioCurrentFile = null;
    let studioAiHistory = [];

    async function loadStudioFiles(path = '/') {
      if (!state.user) return;
      try {
        const items = await puter.fs.readdir(path);
        const fileTree = document.getElementById('studioFileTree');
        if (items.length === 0) {
          fileTree.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 12px;">Empty folder</div>';
          return;
        }
        fileTree.innerHTML = items.map(item => `
          <div class="file-item" style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color);" 
               onclick="studioOpenFile('${item.path}', ${item.is_dir})" data-path="${item.path}">
            <span class="file-icon" style="font-size: 14px; margin-right: 8px;">${item.is_dir ? 'üìÅ' : getFileIcon(item.name)}</span>
            <span style="font-size: 12px;">${item.name}</span>
          </div>
        `).join('');
      } catch (e) { console.error('Load studio files error:', e); }
    }

    function getFileIcon(name) {
      const ext = name.split('.').pop()?.toLowerCase();
      const icons = { js: 'üìú', ts: 'üìò', html: 'üåê', css: 'üé®', json: 'üìã', md: 'üìù', py: 'üêç', jsx: '‚öõÔ∏è', tsx: '‚öõÔ∏è' };
      return icons[ext] || 'üìÑ';
    }

    window.studioOpenFile = async (path, isDir) => {
      if (isDir) {
        await loadStudioFiles(path);
        return;
      }
      try {
        const content = await puter.fs.read(path);
        const text = typeof content === 'string' ? content : await content.text();
        document.getElementById('studioCodeArea').value = text;
        document.getElementById('studioFileName').textContent = path.split('/').pop();
        studioCurrentFile = path;
        showToast('File loaded', 'success');
      } catch (e) { showToast('Failed to open file', 'error'); }
    };

    document.getElementById('studioRefreshBtn')?.addEventListener('click', () => loadStudioFiles('/'));

    document.getElementById('studioSaveBtn')?.addEventListener('click', async () => {
      if (!studioCurrentFile) {
        const name = prompt('Save as (filename):');
        if (!name) return;
        studioCurrentFile = '/' + name;
      }
      try {
        const content = document.getElementById('studioCodeArea').value;
        await puter.fs.write(studioCurrentFile, content);
        showToast('File saved!', 'success');
        loadStudioFiles('/');
      } catch (e) { showToast('Save failed', 'error'); }
    });

    document.getElementById('studioAiFixBtn')?.addEventListener('click', async () => {
      const code = document.getElementById('studioCodeArea').value;
      if (!code.trim()) { showToast('No code to fix', 'warning'); return; }
      showToast('AI analyzing code...', 'info');
      try {
        const response = await callAI([
          { role: 'system', content: 'You are a code reviewer. Fix any bugs, improve the code, and return ONLY the corrected code without explanations.' },
          { role: 'user', content: `Fix and improve this code:\n\n${code}` }
        ], { model: state.selectedModel });
        let fixed = response?.message?.content || '';
        if (Array.isArray(fixed)) fixed = fixed[0]?.text || fixed[0];
        const match = fixed.match(/```(?:\w+)?\n?([\s\S]*?)```/);
        document.getElementById('studioCodeArea').value = match ? match[1].trim() : fixed.trim();
        showToast('Code fixed by AI!', 'success');
      } catch (e) { showToast('AI fix failed', 'error'); }
    });

    document.getElementById('studioAiSendBtn')?.addEventListener('click', async () => {
      const input = document.getElementById('studioAiInput');
      const msg = input.value.trim();
      if (!msg) return;
      
      const chatDiv = document.getElementById('studioAiChat');
      chatDiv.innerHTML += `<div class="chat-message user" style="max-width: 100%;"><div class="chat-bubble" style="font-size: 13px;">${msg}</div></div>`;
      input.value = '';
      
      const code = document.getElementById('studioCodeArea').value;
      try {
        // Include AI memory context for personalized assistance
        const memoryContext = aiMemory.getContextPrompt();
        const systemPrompt = `You are a coding assistant. Help with the code. If you generate new code, wrap it in code blocks.${memoryContext}`;
        
        const response = await callAI([
          { role: 'system', content: systemPrompt },
          { role: 'user', content: `Current code:\n\`\`\`\n${code}\n\`\`\`\n\nUser request: ${msg}` }
        ], { model: state.selectedModel });
        let reply = response?.message?.content || 'No response';
        if (Array.isArray(reply)) reply = reply[0]?.text || reply[0];
        
        // Learn from code-related interactions
        aiMemory.analyzeAndLearn(msg, reply);
        
        chatDiv.innerHTML += `<div class="chat-message ai" style="max-width: 100%;"><div class="chat-bubble" style="font-size: 13px;">${reply.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre style="background: var(--bg-primary); padding: 10px; border-radius: 6px; overflow-x: auto; font-size: 11px;">$2</pre>')}</div></div>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;
      } catch (e) { 
        chatDiv.innerHTML += `<div class="chat-message ai" style="max-width: 100%;"><div class="chat-bubble" style="font-size: 13px; color: var(--accent-red);">Error: ${e.message}</div></div>`;
      }
    });

    // ============ AI MEMORY EVENT HANDLERS ============
    document.getElementById('refreshMemoryBtn')?.addEventListener('click', async () => {
      await aiMemory.load();
      renderMemoryView();
      showToast('AI memory refreshed', 'success');
    });
    
    document.getElementById('clearMemoryBtn')?.addEventListener('click', async () => {
      if (confirm('Are you sure you want to clear all AI memory? This will remove all learned preferences, coding style, and conversation history.')) {
        await aiMemory.clear();
        renderMemoryView();
      }
    });
    
    document.getElementById('teachAiBtn')?.addEventListener('click', () => {
      const category = document.getElementById('teachCategory').value;
      const value = document.getElementById('teachValue').value.trim();
      if (!value) {
        showToast('Please enter a value to teach', 'warning');
        return;
      }
      aiMemory.learnCodingStyle(category, value);
      document.getElementById('teachValue').value = '';
      renderMemoryView();
      showToast(`AI learned: ${category} = ${value}`, 'success');
    });

    // ============ MULTI-TERMINAL ============
    let currentTerminalType = 'bash';
    const terminalHistory = { bash: [], node: [], python: [] };

    document.querySelectorAll('#terminalTabs button')?.forEach(btn => {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('#terminalTabs button').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        currentTerminalType = e.target.dataset.terminal;
        renderTerminalHistory();
      });
    });

    function renderTerminalHistory() {
      const historyDiv = document.getElementById('terminalHistory');
      historyDiv.innerHTML = terminalHistory[currentTerminalType].map(entry => `
        <div style="margin-bottom: 8px;">
          <div style="color: #58a6ff;">$ ${entry.command}</div>
          <div style="color: ${entry.error ? '#f85149' : '#c9d1d9'}; white-space: pre-wrap;">${entry.output}</div>
        </div>
      `).join('');
    }

    document.getElementById('terminalInput')?.addEventListener('keypress', async (e) => {
      if (e.key !== 'Enter') return;
      const input = e.target;
      const cmd = input.value.trim();
      if (!cmd) return;
      input.value = '';
      
      let output = '';
      let error = false;
      
      try {
        // Simulate terminal commands in a sandboxed way
        if (currentTerminalType === 'bash') {
          output = await executeBashCommand(cmd);
        } else if (currentTerminalType === 'node') {
          output = await executeNodeCommand(cmd);
        } else if (currentTerminalType === 'python') {
          output = await executePythonCommand(cmd);
        }
      } catch (e) {
        output = `Error: ${e.message}`;
        error = true;
      }
      
      terminalHistory[currentTerminalType].push({ command: cmd, output, error });
      renderTerminalHistory();
      document.getElementById('terminalHistory').parentElement.scrollTop = 99999;
    });

    async function executeBashCommand(cmd) {
      // Sandboxed command simulation for common operations
      const parts = cmd.split(' ');
      const base = parts[0];
      
      if (base === 'ls') {
        if (!state.user) return 'Error: Please sign in first';
        const path = parts[1] || '/';
        const items = await puter.fs.readdir(path);
        return items.map(i => (i.is_dir ? '\x1b[34m' : '') + i.name + (i.is_dir ? '/\x1b[0m' : '')).join('  ') || '(empty)';
      }
      if (base === 'pwd') return state.currentPath || '/';
      if (base === 'echo') return parts.slice(1).join(' ');
      if (base === 'date') return new Date().toString();
      if (base === 'whoami') return state.user?.username || 'anonymous';
      if (base === 'help') return 'Available: ls, pwd, echo, date, whoami, cat, mkdir, touch, clear';
      if (base === 'clear') { terminalHistory.bash = []; renderTerminalHistory(); return ''; }
      if (base === 'cat' && parts[1]) {
        const content = await puter.fs.read(parts[1]);
        return typeof content === 'string' ? content : await content.text();
      }
      if (base === 'mkdir' && parts[1]) {
        await puter.fs.mkdir(parts[1]);
        return `Created directory: ${parts[1]}`;
      }
      if (base === 'touch' && parts[1]) {
        await puter.fs.write(parts[1], '');
        return `Created file: ${parts[1]}`;
      }
      return `bash: ${base}: command not found (sandboxed terminal)`;
    }

    async function executeNodeCommand(cmd) {
      try {
        const result = eval(cmd);
        return result === undefined ? 'undefined' : JSON.stringify(result, null, 2);
      } catch (e) { return `Error: ${e.message}`; }
    }

    async function executePythonCommand(cmd) {
      // Simulate basic Python via AI
      try {
        const response = await callAI([
          { role: 'system', content: 'You are a Python interpreter. Execute the code and return ONLY the output, no explanation. If there\'s an error, return the error message.' },
          { role: 'user', content: cmd }
        ], { model: state.selectedModel });
        let result = response?.message?.content || '';
        if (Array.isArray(result)) result = result[0]?.text || result[0];
        return result.trim();
      } catch (e) { return `Error: ${e.message}`; }
    }

    // ============ FILE CONVERTERS ============
    let convertedImageBlob = null;
    let converted3dBlob = null;

    document.getElementById('imageQuality')?.addEventListener('input', (e) => {
      document.getElementById('qualityValue').textContent = e.target.value;
    });

    document.getElementById('convertImageBtn')?.addEventListener('click', async () => {
      const fileInput = document.getElementById('uploadImageFile');
      const file = fileInput.files?.[0];
      if (!file) { showToast('Please select an image', 'warning'); return; }

      showToast('Converting image...', 'info');
      
      try {
        const format = document.getElementById('outputImageFormat').value;
        const width = parseInt(document.getElementById('imageWidth').value) || null;
        const height = parseInt(document.getElementById('imageHeight').value) || null;
        const quality = parseInt(document.getElementById('imageQuality').value);

        // Use backend Sharp API for conversion
        const formData = new FormData();
        formData.append('image', file);
        formData.append('format', format);
        if (width) formData.append('width', width);
        if (height) formData.append('height', height);
        formData.append('quality', quality);

        const response = await fetch('/api/image/convert', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error('Conversion failed');
        
        convertedImageBlob = await response.blob();
        const url = URL.createObjectURL(convertedImageBlob);
        
        document.getElementById('convertImageResult').style.display = 'block';
        document.getElementById('convertedImagePreview').src = url;
        document.getElementById('convertImageInfo').textContent = 
          `${file.name.split('.')[0]}.${format} - ${(convertedImageBlob.size / 1024).toFixed(1)}KB`;
        
        showToast('Image converted!', 'success');
      } catch (e) {
        // Fallback: client-side canvas conversion
        try {
          const img = new Image();
          const reader = new FileReader();
          reader.onload = () => {
            img.onload = () => {
              const canvas = document.createElement('canvas');
              const w = parseInt(document.getElementById('imageWidth').value) || img.width;
              const h = parseInt(document.getElementById('imageHeight').value) || img.height;
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, w, h);
              
              const format = document.getElementById('outputImageFormat').value;
              const quality = parseInt(document.getElementById('imageQuality').value) / 100;
              const mimeType = format === 'png' ? 'image/png' : format === 'webp' ? 'image/webp' : 'image/jpeg';
              
              canvas.toBlob((blob) => {
                convertedImageBlob = blob;
                const url = URL.createObjectURL(blob);
                document.getElementById('convertImageResult').style.display = 'block';
                document.getElementById('convertedImagePreview').src = url;
                document.getElementById('convertImageInfo').textContent = 
                  `${file.name.split('.')[0]}.${format} - ${(blob.size / 1024).toFixed(1)}KB`;
                showToast('Image converted (client-side)!', 'success');
              }, mimeType, quality);
            };
            img.src = reader.result;
          };
          reader.readAsDataURL(file);
        } catch (e2) { showToast('Conversion failed', 'error'); }
      }
    });

    document.getElementById('downloadImageBtn')?.addEventListener('click', () => {
      if (!convertedImageBlob) return;
      const format = document.getElementById('outputImageFormat').value;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(convertedImageBlob);
      a.download = `converted.${format}`;
      a.click();
    });

    document.getElementById('convert3dBtn')?.addEventListener('click', async () => {
      const fileInput = document.getElementById('upload3dFile');
      const file = fileInput.files?.[0];
      if (!file) { showToast('Please select a 3D file', 'warning'); return; }

      showToast('Converting 3D model...', 'info');
      
      try {
        const format = document.getElementById('output3dFormat').value;
        const optimize = document.getElementById('optimize3d').value;

        // Send to backend for GLTF conversion
        const formData = new FormData();
        formData.append('model', file);
        formData.append('format', format);
        formData.append('optimize', optimize);

        const response = await fetch('/api/3d/convert', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) throw new Error('3D conversion failed');
        
        converted3dBlob = await response.blob();
        
        document.getElementById('convert3dResult').style.display = 'block';
        document.getElementById('convert3dFileName').textContent = 
          `${file.name.split('.')[0]}.${format}`;
        
        showToast('3D model converted!', 'success');
      } catch (e) {
        showToast('3D conversion requires server support. File saved for reference.', 'warning');
        // Store original file as fallback
        converted3dBlob = file;
        document.getElementById('convert3dResult').style.display = 'block';
        document.getElementById('convert3dFileName').textContent = file.name + ' (original)';
      }
    });

    document.getElementById('download3dBtn')?.addEventListener('click', () => {
      if (!converted3dBlob) return;
      const format = document.getElementById('output3dFormat').value;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(converted3dBlob);
      a.download = `model.${format}`;
      a.click();
    });

    // ============ AI MEMORY SYSTEM ============
    const aiMemory = {
      preferences: {},
      conversationHistory: [],
      learnedPatterns: {},
      codingStyle: {},
      maxHistorySize: 50,
      
      async load() {
        if (!state.user) return;
        try {
          const data = await puter.kv.get('cloudpilot_ai_memory');
          if (data) {
            const parsed = JSON.parse(data);
            this.preferences = parsed.preferences || {};
            this.conversationHistory = parsed.conversationHistory || [];
            this.learnedPatterns = parsed.learnedPatterns || {};
            this.codingStyle = parsed.codingStyle || {};
            this.agentGoals = parsed.agentGoals || [];
            console.log('AI memory loaded:', Object.keys(this.preferences).length, 'preferences');
          }
        } catch (e) { console.error('Failed to load AI memory:', e); }
      },
      
      async save() {
        if (!state.user) return;
        try {
          // Keep history size manageable
          if (this.conversationHistory.length > this.maxHistorySize) {
            this.conversationHistory = this.conversationHistory.slice(-this.maxHistorySize);
          }
          await puter.kv.set('cloudpilot_ai_memory', JSON.stringify({
            preferences: this.preferences,
            conversationHistory: this.conversationHistory,
            learnedPatterns: this.learnedPatterns,
            codingStyle: this.codingStyle,
            agentGoals: this.agentGoals || [],
            lastUpdated: new Date().toISOString()
          }));
        } catch (e) { console.error('Failed to save AI memory:', e); }
      },
      
      rememberPreference(key, value) {
        this.preferences[key] = { value, learnedAt: new Date().toISOString() };
        this.save();
      },
      
      getPreference(key) {
        return this.preferences[key]?.value;
      },
      
      addToHistory(role, content, context = {}) {
        this.conversationHistory.push({
          role,
          content: content.substring(0, 500), // Limit size
          context,
          timestamp: new Date().toISOString()
        });
        this.save();
      },
      
      learnPattern(category, pattern, example) {
        if (!this.learnedPatterns[category]) {
          this.learnedPatterns[category] = [];
        }
        // Avoid duplicates
        if (!this.learnedPatterns[category].find(p => p.pattern === pattern)) {
          this.learnedPatterns[category].push({ pattern, example, learnedAt: new Date().toISOString() });
          this.save();
        }
      },
      
      learnCodingStyle(aspect, value) {
        this.codingStyle[aspect] = { value, learnedAt: new Date().toISOString() };
        this.save();
      },

      storeAgentGoal(goal) {
        if (!this.agentGoals) this.agentGoals = [];
        this.agentGoals.push({
          goal,
          timestamp: new Date().toISOString(),
          status: 'started'
        });
        if (this.agentGoals.length > 20) this.agentGoals = this.agentGoals.slice(-20);
        this.save();
      },
      
      getContextPrompt() {
        let context = '';
        
        // Add user preferences
        if (Object.keys(this.preferences).length > 0) {
          context += '\n\nUser Preferences:\n';
          for (const [key, data] of Object.entries(this.preferences)) {
            context += `- ${key}: ${data.value}\n`;
          }
        }
        
        // Add coding style
        if (Object.keys(this.codingStyle).length > 0) {
          context += '\nUser Coding Style:\n';
          for (const [aspect, data] of Object.entries(this.codingStyle)) {
            context += `- ${aspect}: ${data.value}\n`;
          }
        }
        
        // Add recent conversation context (last 5)
        const recentHistory = this.conversationHistory.slice(-5);
        if (recentHistory.length > 0) {
          context += '\nRecent Conversation Context:\n';
          recentHistory.forEach(h => {
            context += `[${h.role}]: ${h.content.substring(0, 100)}...\n`;
          });
        }
        
        return context;
      },
      
      analyzeAndLearn(userMessage, aiResponse) {
        // Learn from user patterns
        const lowerMsg = userMessage.toLowerCase();
        
        // Detect language preference
        if (lowerMsg.includes('typescript') || lowerMsg.includes('.ts')) {
          this.learnCodingStyle('preferredLanguage', 'TypeScript');
        } else if (lowerMsg.includes('javascript') || lowerMsg.includes('.js')) {
          this.learnCodingStyle('preferredLanguage', 'JavaScript');
        } else if (lowerMsg.includes('python') || lowerMsg.includes('.py')) {
          this.learnCodingStyle('preferredLanguage', 'Python');
        }
        
        // Detect framework preferences
        if (lowerMsg.includes('react')) this.learnCodingStyle('framework', 'React');
        if (lowerMsg.includes('vue')) this.learnCodingStyle('framework', 'Vue');
        if (lowerMsg.includes('express')) this.learnCodingStyle('backend', 'Express');
        
        // Detect formatting preferences
        if (lowerMsg.includes('tabs')) this.learnCodingStyle('indentation', 'tabs');
        if (lowerMsg.includes('spaces') || lowerMsg.includes('2 spaces') || lowerMsg.includes('4 spaces')) {
          this.learnCodingStyle('indentation', 'spaces');
        }
        
        // Detect explicit preferences
        if (lowerMsg.includes('i prefer') || lowerMsg.includes('i like') || lowerMsg.includes('always use')) {
          const prefMatch = lowerMsg.match(/(?:i prefer|i like|always use)\s+(.+?)(?:\.|,|$)/i);
          if (prefMatch) {
            this.rememberPreference('userPreference', prefMatch[1].trim());
          }
        }
        
        // Add to history
        this.addToHistory('user', userMessage);
        if (aiResponse) {
          this.addToHistory('assistant', aiResponse.substring(0, 500));
        }
      },
      
      async clear() {
        this.preferences = {};
        this.conversationHistory = [];
        this.learnedPatterns = {};
        this.codingStyle = {};
        await puter.kv.del('cloudpilot_ai_memory');
        showToast('AI memory cleared', 'info');
      }
    };

    // ============ GRUDGE APP - Discord-style Chat with Puter ============
    const grudgeStore = {
      currentServer: 'home',
      currentChannel: 'general',
      servers: {
        home: { name: 'Grudge Home', icon: 'üè†', channels: ['general', 'announcements', 'ai-chat', 'deployments'] },
        general: { name: 'General Chat', icon: 'üí¨', channels: ['chat', 'random', 'memes'] },
        cloudpilot: { name: 'CloudPilot', icon: 'üöÄ', channels: ['deployments', 'code-help', 'showcase'] },
        games: { name: 'Gaming Hub', icon: 'üéÆ', channels: ['lobby', 'lfg', 'clips'] },
        ai: { name: 'AI Lab', icon: 'ü§ñ', channels: ['experiments', 'prompts', 'results'] }
      },
      channels: {},
      messages: {},
      members: [],
      pollInterval: null,
      
      async init() {
        if (!state.user) return;
        await this.loadChannels();
        await this.loadMessages(this.currentChannel);
        await this.loadMembers();
        this.startPolling();
        this.setupEventListeners();
        this.updateUI();
      },
      
      async loadChannels() {
        try {
          const data = await puter.kv.get('grudge:channels') || '{}';
          this.channels = JSON.parse(data);
        } catch (e) { this.channels = {}; }
      },
      
      async loadMessages(channelId) {
        try {
          const key = `grudge:messages:${channelId}`;
          const data = await puter.kv.get(key) || '[]';
          this.messages[channelId] = JSON.parse(data);
          this.renderMessages();
        } catch (e) { this.messages[channelId] = []; }
      },
      
      async loadMembers() {
        try {
          const data = await puter.kv.get('grudge:members') || '[]';
          this.members = JSON.parse(data);
          // Add current user if not present
          if (state.user && !this.members.find(m => m.id === state.user.uuid)) {
            this.members.push({
              id: state.user.uuid,
              username: state.user.username || 'User',
              status: 'online',
              lastActive: Date.now()
            });
            await this.saveMembers();
          }
          this.renderMembers();
        } catch (e) { this.members = []; }
      },
      
      async saveMembers() {
        await puter.kv.set('grudge:members', JSON.stringify(this.members));
      },
      
      async sendMessage(content) {
        if (!content.trim() || !state.user) return;
        
        const message = {
          id: crypto.randomUUID(),
          channelId: this.currentChannel,
          authorId: state.user.uuid,
          authorName: state.user.username || 'User',
          content: content.trim(),
          createdAt: Date.now(),
          reactions: []
        };
        
        if (!this.messages[this.currentChannel]) this.messages[this.currentChannel] = [];
        this.messages[this.currentChannel].push(message);
        
        // Save to Puter KV
        const key = `grudge:messages:${this.currentChannel}`;
        await puter.kv.set(key, JSON.stringify(this.messages[this.currentChannel].slice(-100)));
        
        // Track interaction for improvement engine
        improvementEngine.trackEvent('message_sent', { channel: this.currentChannel, length: content.length });
        
        this.renderMessages();
        document.getElementById('grudgeMessageInput').value = '';
      },
      
      async sendAIMessage(prompt) {
        if (!prompt.trim()) return;
        
        // First send user message
        await this.sendMessage(prompt);
        
        // Get AI response
        try {
          const response = await puter.ai.chat([
            { role: 'system', content: 'You are a helpful AI assistant in the Grudge chat app. Be friendly and concise.' },
            { role: 'user', content: prompt }
          ], { model: state.selectedModel });
          
          const aiMessage = {
            id: crypto.randomUUID(),
            channelId: this.currentChannel,
            authorId: 'ai-assistant',
            authorName: 'CloudPilot AI',
            content: response?.message?.content || response?.toString() || 'I apologize, I could not process that.',
            createdAt: Date.now(),
            isAI: true,
            reactions: []
          };
          
          this.messages[this.currentChannel].push(aiMessage);
          const key = `grudge:messages:${this.currentChannel}`;
          await puter.kv.set(key, JSON.stringify(this.messages[this.currentChannel].slice(-100)));
          this.renderMessages();
        } catch (e) {
          showToast('AI response failed', 'error');
        }
      },
      
      switchServer(serverId) {
        this.currentServer = serverId;
        document.querySelectorAll('.grudge-server-icon').forEach(el => {
          el.classList.toggle('active', el.dataset.server === serverId);
          el.style.borderRadius = el.dataset.server === serverId ? '35%' : '50%';
          el.style.background = el.dataset.server === serverId ? 'linear-gradient(135deg, var(--accent-blue), var(--accent-purple))' : 'var(--bg-card)';
        });
        document.getElementById('grudgeServerName').textContent = this.servers[serverId]?.name || 'Server';
        improvementEngine.trackEvent('server_switch', { server: serverId });
      },
      
      switchChannel(channelId) {
        this.currentChannel = channelId;
        document.querySelectorAll('.grudge-channel').forEach(el => {
          el.classList.toggle('active', el.dataset.channel === channelId);
          el.style.background = el.dataset.channel === channelId ? 'var(--bg-secondary)' : 'transparent';
        });
        document.getElementById('grudgeChannelName').textContent = channelId;
        document.getElementById('grudgeMessageInput').placeholder = `Message #${channelId}`;
        this.loadMessages(channelId);
        improvementEngine.trackEvent('channel_switch', { channel: channelId });
      },
      
      renderMessages() {
        const container = document.getElementById('grudgeMessages');
        const messages = this.messages[this.currentChannel] || [];
        
        if (messages.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 16px;">üëã</div>
              <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Welcome to #${this.currentChannel}!</div>
              <div style="color: var(--text-muted);">This is the start of the #${this.currentChannel} channel.</div>
            </div>`;
          return;
        }
        
        container.innerHTML = messages.map(msg => `
          <div class="grudge-message" style="display: flex; gap: 12px; padding: 8px 4px; border-radius: var(--radius-sm);" data-id="${msg.id}">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${msg.isAI ? 'linear-gradient(135deg, var(--accent-blue), var(--accent-cyan))' : 'linear-gradient(135deg, var(--accent-purple), var(--accent-pink))'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              ${msg.isAI ? 'ü§ñ' : 'üë§'}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="display: flex; align-items: baseline; gap: 8px;">
                <span style="font-weight: 600; color: ${msg.isAI ? 'var(--accent-cyan)' : 'var(--text-primary)'};">${msg.authorName}</span>
                <span style="font-size: 11px; color: var(--text-muted);">${new Date(msg.createdAt).toLocaleTimeString()}</span>
              </div>
              <div style="margin-top: 4px; color: var(--text-secondary); line-height: 1.5; word-break: break-word;">${this.formatMessage(msg.content)}</div>
            </div>
          </div>
        `).join('');
        
        container.scrollTop = container.scrollHeight;
      },
      
      formatMessage(content) {
        // Basic markdown-like formatting
        return content
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/`(.*?)`/g, '<code style="background: var(--bg-secondary); padding: 2px 6px; border-radius: 4px; font-family: monospace;">$1</code>')
          .replace(/\n/g, '<br>');
      },
      
      renderMembers() {
        const container = document.getElementById('grudgeMemberList');
        const online = this.members.filter(m => m.status === 'online');
        document.getElementById('grudgeOnlineCount').textContent = online.length;
        
        container.innerHTML = this.members.map(m => `
          <div class="grudge-member" style="display: flex; align-items: center; gap: 10px; padding: 6px 8px; border-radius: var(--radius-sm); cursor: pointer;">
            <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); display: flex; align-items: center; justify-content: center; position: relative;">
              üë§
              <div style="position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px; border-radius: 50%; background: ${m.status === 'online' ? 'var(--accent-green)' : 'var(--text-muted)'}; border: 2px solid var(--bg-card);"></div>
            </div>
            <div>
              <div style="font-size: 13px; font-weight: 500;">${m.username}</div>
              <div style="font-size: 11px; color: ${m.status === 'online' ? 'var(--accent-green)' : 'var(--text-muted)'};">${m.status}</div>
            </div>
          </div>
        `).join('');
      },
      
      updateUI() {
        if (state.user) {
          document.getElementById('grudgeUsername').textContent = state.user.username || 'User';
          document.getElementById('grudgeUserStatus').textContent = 'Online';
        }
      },
      
      startPolling() {
        if (this.pollInterval) clearInterval(this.pollInterval);
        this.pollInterval = setInterval(() => this.loadMessages(this.currentChannel), 3000);
      },
      
      setupEventListeners() {
        // Server switching
        document.querySelectorAll('.grudge-server-icon[data-server]').forEach(el => {
          el.addEventListener('click', () => this.switchServer(el.dataset.server));
        });
        
        // Channel switching
        document.querySelectorAll('.grudge-channel[data-channel]').forEach(el => {
          el.addEventListener('click', () => this.switchChannel(el.dataset.channel));
        });
        
        // Send message
        const sendBtn = document.getElementById('grudgeSendBtn');
        const input = document.getElementById('grudgeMessageInput');
        const aiBtn = document.getElementById('grudgeAIBtn');
        
        if (sendBtn) sendBtn.addEventListener('click', () => this.sendMessage(input.value));
        if (input) input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendMessage(input.value);
          }
        });
        if (aiBtn) aiBtn.addEventListener('click', () => {
          const prompt = input.value || 'Hello, what can you help me with?';
          this.sendAIMessage(prompt);
        });
      }
    };

    // ============ LAUNCHER - Quick App Launch with Learning ============
    const launcherStore = {
      apps: [],
      favorites: [],
      activity: [],
      
      async init() {
        if (!state.user) return;
        await this.loadApps();
        await this.loadFavorites();
        await this.loadActivity();
        this.setupEventListeners();
        this.updateStats();
        this.renderLauncher();
      },
      
      async loadApps() {
        try {
          const apps1 = JSON.parse(await puter.kv.get('cloudpilot_apps') || '[]');
          const apps2 = JSON.parse(await puter.kv.get('cloudpilot_deployments') || '[]');
          const workflows = JSON.parse(await puter.kv.get('cloudpilot_workflows') || '[]');
          
          this.apps = [
            ...apps1.map(a => ({ ...a, type: 'app' })),
            ...apps2.filter(a => !apps1.find(x => x.id === a.id)).map(a => ({ ...a, type: 'deployment' })),
            ...workflows.map(w => ({ ...w, type: 'workflow', id: w.id || w.name }))
          ];
        } catch (e) { this.apps = []; }
      },
      
      async loadFavorites() {
        try {
          this.favorites = JSON.parse(await puter.kv.get('launcher:favorites') || '[]');
        } catch (e) { this.favorites = []; }
      },
      
      async loadActivity() {
        try {
          this.activity = JSON.parse(await puter.kv.get('launcher:activity') || '[]');
        } catch (e) { this.activity = []; }
      },
      
      async saveFavorites() {
        await puter.kv.set('launcher:favorites', JSON.stringify(this.favorites));
      },
      
      async saveActivity() {
        await puter.kv.set('launcher:activity', JSON.stringify(this.activity.slice(-50)));
      },
      
      async launch(appId) {
        const app = this.apps.find(a => a.id === appId);
        if (!app) return;
        
        // Track launch
        this.activity.unshift({
          type: 'launch',
          appId: app.id,
          appName: app.name || app.subdomain,
          timestamp: Date.now()
        });
        await this.saveActivity();
        
        // Track for improvement engine
        improvementEngine.trackEvent('app_launch', { appId: app.id, appType: app.type });
        
        // Open app
        if (app.url || app.subdomain) {
          const url = app.url || `https://${app.subdomain}.puter.site`;
          window.open(url, '_blank');
          showToast(`Launched ${app.name || app.subdomain}`, 'success');
        } else if (app.type === 'workflow') {
          // Run workflow
          showToast(`Running workflow: ${app.name}`, 'info');
        }
        
        this.renderActivity();
      },
      
      async toggleFavorite(appId) {
        const idx = this.favorites.indexOf(appId);
        if (idx >= 0) {
          this.favorites.splice(idx, 1);
        } else {
          this.favorites.push(appId);
        }
        await this.saveFavorites();
        this.renderLauncher();
        this.renderFavorites();
      },
      
      updateStats() {
        const running = this.apps.filter(a => a.status === 'live' || a.status === 'running').length;
        const workflows = this.apps.filter(a => a.type === 'workflow').length;
        
        document.getElementById('launcherTotalApps').textContent = this.apps.length;
        document.getElementById('launcherRunningApps').textContent = running;
        document.getElementById('launcherWorkflows').textContent = workflows;
        document.getElementById('launcherAgents').textContent = '1'; // CloudPilot AI
      },
      
      renderLauncher() {
        const container = document.getElementById('launcherGrid');
        if (!container) return;
        
        if (this.apps.length === 0) {
          container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
              <div style="font-size: 48px; margin-bottom: 16px;">üöÄ</div>
              <div style="font-size: 16px; margin-bottom: 8px;">No apps yet</div>
              <div style="font-size: 13px;">Deploy an app from the Deploy Apps section to see it here.</div>
            </div>`;
          return;
        }
        
        container.innerHTML = this.apps.map(app => {
          const isFav = this.favorites.includes(app.id);
          const statusColor = app.status === 'live' ? 'var(--accent-green)' : 'var(--text-muted)';
          const typeIcon = app.type === 'workflow' ? 'üîÑ' : app.type === 'game' ? 'üéÆ' : 'üåê';
          
          return `
            <div class="launcher-item" style="background: var(--bg-card); border-radius: var(--radius-md); padding: 16px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s;" data-id="${app.id}" data-testid="launcher-item-${app.id}">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <div style="width: 40px; height: 40px; border-radius: var(--radius-sm); background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); display: flex; align-items: center; justify-content: center; font-size: 20px;">${typeIcon}</div>
                <div style="flex: 1; min-width: 0;">
                  <div style="font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.name || app.subdomain || 'App'}</div>
                  <div style="font-size: 11px; color: var(--text-muted);">${app.type}</div>
                </div>
                <span class="launcher-fav" style="cursor: pointer; font-size: 16px;" onclick="event.stopPropagation(); launcherStore.toggleFavorite('${app.id}');">${isFav ? '‚≠ê' : '‚òÜ'}</span>
              </div>
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <span style="font-size: 11px; display: flex; align-items: center; gap: 4px;">
                  <span style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor};"></span>
                  ${app.status || 'ready'}
                </span>
                <button class="btn btn-primary" style="padding: 4px 12px; font-size: 11px;" onclick="event.stopPropagation(); launcherStore.launch('${app.id}');">Launch</button>
              </div>
            </div>`;
        }).join('');
      },
      
      renderFavorites() {
        const container = document.getElementById('launcherFavorites');
        if (!container) return;
        
        const favApps = this.apps.filter(a => this.favorites.includes(a.id));
        
        if (favApps.length === 0) {
          container.innerHTML = `<div style="color: var(--text-muted); font-size: 13px; padding: 20px; text-align: center; grid-column: 1 / -1;">Click the star on any app to add it to favorites</div>`;
          return;
        }
        
        container.innerHTML = favApps.map(app => `
          <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 10px; cursor: pointer;" onclick="launcherStore.launch('${app.id}')">
            <span style="font-size: 20px;">‚≠ê</span>
            <span style="flex: 1; font-size: 13px; font-weight: 500;">${app.name || app.subdomain}</span>
            <span style="font-size: 16px;">‚ñ∂Ô∏è</span>
          </div>
        `).join('');
      },
      
      renderActivity() {
        const container = document.getElementById('launcherActivity');
        if (!container) return;
        
        if (this.activity.length === 0) {
          container.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;">No recent activity</div>`;
          return;
        }
        
        container.innerHTML = this.activity.slice(0, 10).map(a => `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-secondary); border-radius: var(--radius-sm);">
            <span style="font-size: 16px;">${a.type === 'launch' ? 'üöÄ' : 'üìä'}</span>
            <div style="flex: 1;">
              <div style="font-size: 13px;">${a.type === 'launch' ? 'Launched' : 'Activity'}: ${a.appName || 'App'}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${new Date(a.timestamp).toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      },
      
      setupEventListeners() {
        const refreshBtn = document.getElementById('launcherRefreshBtn');
        if (refreshBtn) refreshBtn.addEventListener('click', () => {
          this.loadApps().then(() => {
            this.updateStats();
            this.renderLauncher();
            this.renderFavorites();
            showToast('Launcher refreshed', 'success');
          });
        });
      }
    };

    // ============ AUTONOMOUS IMPROVEMENT ENGINE ============
    const improvementEngine = {
      events: [],
      suggestions: [],
      
      async init() {
        await this.loadEvents();
        await this.loadSuggestions();
        this.startAnalysis();
      },
      
      async loadEvents() {
        try {
          this.events = JSON.parse(await puter.kv.get('improvement:events') || '[]');
        } catch (e) { this.events = []; }
      },
      
      async loadSuggestions() {
        try {
          this.suggestions = JSON.parse(await puter.kv.get('improvement:suggestions') || '[]');
        } catch (e) { this.suggestions = []; }
      },
      
      async saveEvents() {
        await puter.kv.set('improvement:events', JSON.stringify(this.events.slice(-200)));
      },
      
      async saveSuggestions() {
        await puter.kv.set('improvement:suggestions', JSON.stringify(this.suggestions.slice(-20)));
      },
      
      trackEvent(type, payload = {}) {
        this.events.push({
          id: crypto.randomUUID(),
          type,
          payload,
          timestamp: Date.now(),
          userId: state.user?.uuid || 'anonymous'
        });
        this.saveEvents();
      },
      
      startAnalysis() {
        // Analyze every 5 minutes
        setInterval(() => this.analyze(), 5 * 60 * 1000);
        // Initial analysis after 30 seconds
        setTimeout(() => this.analyze(), 30000);
      },
      
      async analyze() {
        if (this.events.length < 5) return;
        
        // Aggregate recent events
        const recent = this.events.slice(-50);
        const channelSwitches = recent.filter(e => e.type === 'channel_switch').length;
        const messageSent = recent.filter(e => e.type === 'message_sent').length;
        const appLaunches = recent.filter(e => e.type === 'app_launch').length;
        
        // Generate suggestions based on patterns
        const suggestions = [];
        
        if (channelSwitches > 10 && messageSent < 3) {
          suggestions.push({
            id: crypto.randomUUID(),
            scope: 'user',
            summary: 'You seem to be browsing channels a lot. Would you like me to pin your most visited channels?',
            actionPlan: 'pin_frequent_channels',
            confidence: 0.7,
            status: 'pending',
            createdAt: Date.now()
          });
        }
        
        if (appLaunches > 5) {
          const mostLaunched = this.getMostFrequentApp();
          if (mostLaunched) {
            suggestions.push({
              id: crypto.randomUUID(),
              scope: 'user',
              summary: `You frequently launch "${mostLaunched}". Add it to quick launch favorites?`,
              actionPlan: 'add_to_favorites',
              payload: { appName: mostLaunched },
              confidence: 0.85,
              status: 'pending',
              createdAt: Date.now()
            });
          }
        }
        
        if (suggestions.length > 0) {
          this.suggestions = [...suggestions, ...this.suggestions].slice(0, 20);
          await this.saveSuggestions();
          this.renderSuggestions();
        }
      },
      
      getMostFrequentApp() {
        const launches = this.events.filter(e => e.type === 'app_launch');
        if (launches.length === 0) return null;
        
        const counts = {};
        launches.forEach(l => {
          const name = l.payload?.appId || 'unknown';
          counts[name] = (counts[name] || 0) + 1;
        });
        
        return Object.entries(counts).sort((a, b) => b[1] - a[1])[0]?.[0];
      },
      
      renderSuggestions() {
        const container = document.getElementById('launcherSuggestions');
        if (!container) return;
        
        if (this.suggestions.length === 0) {
          container.innerHTML = `
            <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); border-left: 3px solid var(--accent-purple);">
              <div style="font-size: 13px; font-weight: 500; margin-bottom: 4px;">Autonomous Improvement</div>
              <div style="font-size: 12px; color: var(--text-muted);">The system learns from your interactions and suggests improvements automatically.</div>
            </div>`;
          return;
        }
        
        container.innerHTML = this.suggestions.filter(s => s.status === 'pending').slice(0, 5).map(s => `
          <div style="background: var(--bg-secondary); padding: 12px; border-radius: var(--radius-sm); border-left: 3px solid var(--accent-purple);">
            <div style="font-size: 13px; margin-bottom: 8px;">${s.summary}</div>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-primary" style="padding: 4px 10px; font-size: 11px;" onclick="improvementEngine.applySuggestion('${s.id}')">Apply</button>
              <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="improvementEngine.dismissSuggestion('${s.id}')">Dismiss</button>
            </div>
          </div>
        `).join('');
      },
      
      async applySuggestion(id) {
        const suggestion = this.suggestions.find(s => s.id === id);
        if (!suggestion) return;
        
        suggestion.status = 'applied';
        await this.saveSuggestions();
        showToast('Improvement applied!', 'success');
        this.renderSuggestions();
      },
      
      async dismissSuggestion(id) {
        const suggestion = this.suggestions.find(s => s.id === id);
        if (!suggestion) return;
        
        suggestion.status = 'dismissed';
        await this.saveSuggestions();
        this.renderSuggestions();
      }
    };

    // ============ KEYBOARD SHORTCUTS ============
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + S = Save (prevent default, trigger save in context)
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        const activeView = document.querySelector('.view:not([style*="display: none"])');
        if (activeView?.id === 'view-playground') {
          versionControl.saveBackup();
        } else if (activeView?.id === 'view-studio' && studioCurrentFile) {
          document.getElementById('studioSaveBtn')?.click();
        }
        showToast('Saved', 'success');
      }
      
      // Ctrl/Cmd + Z = Undo
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        const activeView = document.querySelector('.view:not([style*="display: none"])');
        if (activeView?.id === 'view-playground') {
          e.preventDefault();
          document.getElementById('versionUndoBtn')?.click();
        }
      }
      
      // Ctrl/Cmd + Shift + Z = Redo
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z') {
        const activeView = document.querySelector('.view:not([style*="display: none"])');
        if (activeView?.id === 'view-playground') {
          e.preventDefault();
          document.getElementById('versionRedoBtn')?.click();
        }
      }
      
      // Ctrl/Cmd + Enter = Run code
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        const activeView = document.querySelector('.view:not([style*="display: none"])');
        if (activeView?.id === 'view-playground') {
          e.preventDefault();
          document.getElementById('playgroundRunBtn')?.click();
        }
      }
      
      // Escape = Close modals
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        document.getElementById('deployPanel').style.display = 'none';
        document.getElementById('deployOverlay').style.display = 'none';
        document.getElementById('policyEditorModal').style.display = 'none';
        document.getElementById('policyEditorOverlay').style.display = 'none';
        document.getElementById('sourceViewerModal').style.display = 'none';
        document.getElementById('sourceViewerOverlay').style.display = 'none';
        document.getElementById('filePreviewPanel').style.display = 'none';
      }
      
      // Delete key = Delete selected files
      if (e.key === 'Delete' && fileManager.selectedFiles.size > 0) {
        e.preventDefault();
        fileManager.deleteItems([...fileManager.selectedFiles]);
      }
      
      // Ctrl/Cmd + A = Select all files (in storage view)
      if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        const activeView = document.querySelector('.view:not([style*="display: none"])');
        if (activeView?.id === 'view-storage') {
          e.preventDefault();
          fileManager.selectAll();
        }
      }
      
      // Ctrl/Cmd + K = Quick switch (Grudge view)
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const input = document.getElementById('grudgeMessageInput');
        if (input) input.focus();
      }
      
      // Alt + L = Open Launcher
      if (e.altKey && e.key === 'l') {
        e.preventDefault();
        switchView('launcher');
      }
      
      // Alt + G = Open Grudge
      if (e.altKey && e.key === 'g') {
        e.preventDefault();
        switchView('grudge');
      }
    });

    // ============ CANVAS STUDIO ============
    let canvasEngine = null;
    let aiJournalInstance = null;

    async function initCanvasStudio() {
      const container = document.getElementById('canvasContainer');
      if (!container || canvasEngine) return;

      // Load Canvas Engine dynamically
      try {
        const { CanvasEngine } = await import('./grudgeos/lib/studio/canvas-engine.js');
        canvasEngine = new CanvasEngine(container, {
          canvasWidth: 4096,
          canvasHeight: 2304,
          showGrid: true,
          snapToGrid: true,
          gridSize: 20
        });
        
        // Wire zoom change callback
        canvasEngine.onZoomChange = updateZoomDisplay;

        // Setup zoom controls
        document.getElementById('canvasZoomInBtn')?.addEventListener('click', () => {
          canvasEngine.zoomIn();
          updateZoomDisplay();
        });
        document.getElementById('canvasZoomOutBtn')?.addEventListener('click', () => {
          canvasEngine.zoomOut();
          updateZoomDisplay();
        });
        document.getElementById('canvasZoomFitBtn')?.addEventListener('click', () => {
          canvasEngine.zoomFit();
          updateZoomDisplay();
        });
        document.getElementById('canvasUndoBtn')?.addEventListener('click', () => canvasEngine.undo());
        document.getElementById('canvasRedoBtn')?.addEventListener('click', () => canvasEngine.redo());
        document.getElementById('canvasExportBtn')?.addEventListener('click', () => {
          const json = canvasEngine.exportJSON();
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'canvas-project.json';
          a.click();
          URL.revokeObjectURL(url);
          showToast('Canvas exported!', 'success');
        });
        
        // Add import via drag-drop on canvas
        container.addEventListener('dragover', (e) => { e.preventDefault(); });
        container.addEventListener('drop', async (e) => {
          e.preventDefault();
          const file = e.dataTransfer?.files[0];
          if (file && file.name.endsWith('.json')) {
            const text = await file.text();
            if (canvasEngine.importJSON(text)) {
              updateLayersList();
              updateZoomDisplay();
              showToast('Canvas imported!', 'success');
            } else {
              showToast('Import failed', 'error');
            }
          }
        });

        // Tool selection
        document.querySelectorAll('.canvas-tool').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.canvas-tool').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const tool = btn.dataset.tool;
            handleToolSelect(tool);
          });
        });

        // Add layer button
        document.getElementById('canvasAddLayerBtn')?.addEventListener('click', () => {
          canvasEngine.addLayer();
          updateLayersList();
          showToast('Layer added', 'success');
        });

        // Template selection
        document.querySelectorAll('.template-item').forEach(item => {
          item.addEventListener('click', async () => {
            const templateId = item.dataset.template;
            await selectTemplate(templateId);
          });
        });

        // Selection change callback for properties panel
        const originalRender = canvasEngine.render.bind(canvasEngine);
        canvasEngine.render = function() {
          originalRender();
          updatePropertiesPanel();
        };

        updateLayersList();
        updateZoomDisplay();
      } catch (e) {
        console.warn('Canvas Engine not loaded:', e);
      }

      // Load AI Journal
      try {
        const { aiJournal } = await import('./grudgeos/lib/studio/ai-journal.js');
        aiJournalInstance = aiJournal;
        await aiJournalInstance.init();

        // Setup AI undo buttons
        document.getElementById('aiUndoLast1Btn')?.addEventListener('click', async () => {
          const result = await aiJournalInstance.undoLast1();
          showToast(`Reverted ${result.length} AI change(s)`, 'success');
          updateAIJournalList();
        });
        document.getElementById('aiUndoLast2Btn')?.addEventListener('click', async () => {
          const result = await aiJournalInstance.undoLast2();
          showToast(`Reverted ${result.length} AI change(s)`, 'success');
          updateAIJournalList();
        });
        document.getElementById('aiUndoLast3Btn')?.addEventListener('click', async () => {
          const result = await aiJournalInstance.undoLast3();
          showToast(`Reverted ${result.length} AI change(s)`, 'success');
          updateAIJournalList();
        });

        updateAIJournalList();
      } catch (e) {
        console.warn('AI Journal not loaded:', e);
      }
    }

    function handleToolSelect(tool) {
      if (!canvasEngine) return;
      
      if (tool !== 'select') {
        // Add a shape at center of viewport
        const centerX = canvasEngine.viewport.x + canvasEngine.viewport.width / (2 * canvasEngine.viewport.zoom);
        const centerY = canvasEngine.viewport.y + canvasEngine.viewport.height / (2 * canvasEngine.viewport.zoom);
        
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        canvasEngine.addNode(tool === 'text' ? 'text' : tool === 'circle' ? 'circle' : 'rect', {
          x: centerX - 50,
          y: centerY - 50,
          width: 100,
          height: 100,
          fill: color,
          text: tool === 'text' ? 'Text' : ''
        });
        updateLayersList();
      }
    }

    function updateZoomDisplay() {
      if (!canvasEngine) return;
      const level = document.getElementById('canvasZoomLevel');
      if (level) {
        level.textContent = `${(canvasEngine.viewport.zoom * 100).toFixed(0)}%`;
      }
      const nodeCount = document.getElementById('canvasNodeCount');
      if (nodeCount) {
        nodeCount.textContent = canvasEngine.getAllNodes().length;
      }
    }

    function updateLayersList() {
      if (!canvasEngine) return;
      const container = document.getElementById('canvasLayersList');
      if (!container) return;

      if (canvasEngine.layers.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 16px; font-size: 12px;"><div>No layers yet</div></div>';
        return;
      }

      container.innerHTML = canvasEngine.layers.map((layer, idx) => `
        <div class="layer-item" style="display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 4px; cursor: pointer; border: 1px solid ${layer.visible ? 'var(--accent-blue)' : 'var(--border-color)'};">
          <span style="font-size: 14px;">${layer.visible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</span>
          <span style="flex: 1; font-size: 12px; ${layer.locked ? 'opacity: 0.5;' : ''}">${layer.name}</span>
          <span style="font-size: 11px; color: var(--text-muted);">${layer.nodes.length}</span>
          ${layer.locked ? '<span style="font-size: 12px;">üîí</span>' : ''}
        </div>
      `).join('');
    }

    function updatePropertiesPanel() {
      if (!canvasEngine) return;
      const container = document.getElementById('canvasProperties');
      if (!container) return;

      const selected = canvasEngine.selectedNodes;
      if (selected.length === 0) {
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 20px;">Select an object to edit its properties</div>';
        return;
      }

      if (selected.length === 1) {
        const node = selected[0];
        container.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">${node.type.toUpperCase()}</div>
            <div class="prop-row" style="display: flex; justify-content: space-between; font-size: 12px;">
              <span style="color: var(--text-muted);">Position</span>
              <span>${Math.round(node.x)}, ${Math.round(node.y)}</span>
            </div>
            <div class="prop-row" style="display: flex; justify-content: space-between; font-size: 12px;">
              <span style="color: var(--text-muted);">Size</span>
              <span>${Math.round(node.width)} √ó ${Math.round(node.height)}</span>
            </div>
            <div class="prop-row" style="display: flex; justify-content: space-between; font-size: 12px;">
              <span style="color: var(--text-muted);">Rotation</span>
              <span>${Math.round(node.rotation || 0)}¬∞</span>
            </div>
            <div class="prop-row" style="display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
              <span style="color: var(--text-muted);">Fill</span>
              <div style="width: 24px; height: 24px; background: ${node.fill}; border-radius: 4px; border: 1px solid var(--border-color);"></div>
            </div>
            <div class="prop-row" style="display: flex; justify-content: space-between; font-size: 12px;">
              <span style="color: var(--text-muted);">Opacity</span>
              <span>${Math.round((node.opacity || 1) * 100)}%</span>
            </div>
            <div class="prop-row" style="display: flex; justify-content: space-between; font-size: 12px;">
              <span style="color: var(--text-muted);">ID</span>
              <span style="font-family: var(--font-mono); font-size: 10px; color: var(--text-muted);">${node.id.split('_').pop()}</span>
            </div>
          </div>
        `;
      } else {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 24px; margin-bottom: 8px;">üì¶</div>
            <div style="font-size: 13px; font-weight: 500;">${selected.length} objects selected</div>
            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Multi-selection active</div>
          </div>
        `;
      }
    }

    function updateAIJournalList() {
      if (!aiJournalInstance) return;
      const container = document.getElementById('aiJournalList');
      if (!container) return;

      const changes = aiJournalInstance.getRecentChanges(10);
      if (changes.length === 0) {
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 16px;">No AI changes recorded yet</div>';
        return;
      }

      container.innerHTML = changes.map(change => `
        <div style="background: var(--bg-secondary); padding: 10px; border-radius: var(--radius-sm); margin-bottom: 6px; border-left: 3px solid var(--accent-purple);">
          <div style="font-size: 12px; font-weight: 500;">${change.description}</div>
          <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
            ${change.agent} ‚Ä¢ ${new Date(change.timestamp).toLocaleTimeString()}
          </div>
        </div>
      `).join('');
    }

    async function selectTemplate(templateId) {
      try {
        const { WorkflowTemplates } = await import('./grudgeos/lib/studio/workflow-templates.js');
        const template = WorkflowTemplates.getTemplate(templateId);
        if (template) {
          showToast(`Template: ${template.name}`, 'info');
          // Show template details modal or start project wizard
          console.log('Selected template:', template);
        }
      } catch (e) {
        console.warn('Templates not loaded:', e);
      }
    }

    // ============ AGENT HUB ============
    let agentRuntimeInstance = null;
    let terminalOrchestratorInstance = null;
    let codeNinjaShellInstance = null;

    async function initAgentHub() {
      const container = document.getElementById('agent-hubView');
      if (!container) return;

      try {
        const { AgentRuntime } = await import('./grudgeos/lib/agents/agent-runtime.js');
        const { TerminalOrchestrator } = await import('./grudgeos/lib/agents/terminal-orchestrator.js');
        const { CodeNinjaShell } = await import('./grudgeos/lib/agents/code-ninja-shell.js');

        agentRuntimeInstance = new AgentRuntime();
        terminalOrchestratorInstance = new TerminalOrchestrator();
        codeNinjaShellInstance = new CodeNinjaShell();

        await agentRuntimeInstance.initialize();
        await terminalOrchestratorInstance.initialize();
        await codeNinjaShellInstance.initialize();

        updateAgentList();
        updatePodGrid();
        setupAgentHubListeners();

        console.log('[AgentHub] Initialized');
      } catch (e) {
        console.warn('[AgentHub] Failed to initialize:', e);
      }
    }

    function updateAgentList() {
      if (!agentRuntimeInstance) return;
      const container = document.getElementById('agentList');
      if (!container) return;

      const agents = agentRuntimeInstance.getAllAgents();
      const active = agents.filter(a => a.presence === 'online').length;

      document.getElementById('activeAgentCount').textContent = active;
      document.getElementById('totalAgentCount').textContent = agents.length;

      if (agents.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
            <div style="font-size: 32px; margin-bottom: 8px;">ü§ñ</div>
            <div style="font-size: 12px;">No agents yet</div>
            <div style="font-size: 11px; margin-top: 4px;">Click "+ New" to create one</div>
          </div>`;
        return;
      }

      container.innerHTML = agents.map(agent => `
        <div class="agent-card" data-agent-id="${agent.id}" style="padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: 8px; cursor: pointer; border: 1px solid var(--border-color);">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${agent.presence === 'online' ? 'var(--accent-green)' : agent.presence === 'away' ? 'var(--accent-yellow)' : 'var(--text-muted)'};"></div>
            <div style="flex: 1;">
              <div style="font-size: 13px; font-weight: 500; color: var(--text-primary);">${agent.name}</div>
              <div style="font-size: 10px; color: var(--text-muted);">${agent.type} ‚Ä¢ ${agent.status}</div>
            </div>
            <div style="font-size: 11px; color: var(--text-muted);">${agent.stats.tasksCompleted} tasks</div>
          </div>
        </div>
      `).join('');
    }

    function updatePodGrid() {
      const container = document.getElementById('podGrid');
      if (!container) return;

      let pods = [];
      if (typeof PodManager !== 'undefined') {
        try {
          if (!window.podManagerInstance) {
            window.podManagerInstance = new PodManager();
            window.podManagerInstance.initialize();
          }
          pods = Array.from(window.podManagerInstance.pods.values());
        } catch (e) {
          console.warn('[AgentHub] PodManager not available');
        }
      }

      if (pods.length === 0) {
        container.innerHTML = `<div style="grid-column: span 2; text-align: center; padding: 20px; color: var(--text-muted); font-size: 11px;">No pods running</div>`;
        return;
      }

      container.innerHTML = pods.map(pod => `
        <div class="pod-item" data-pod-id="${pod.id}" style="padding: 10px; background: var(--bg-tertiary); border-radius: var(--radius-sm); border: 1px solid var(--border-color);">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
            <div style="width: 6px; height: 6px; border-radius: 50%; background: ${pod.status === 'busy' ? 'var(--accent-yellow)' : pod.status === 'idle' ? 'var(--accent-green)' : 'var(--text-muted)'};"></div>
            <div style="font-size: 11px; font-weight: 500; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${pod.name}</div>
          </div>
          <div style="font-size: 10px; color: var(--text-muted);">${pod.runtime} ‚Ä¢ ${pod.stats.jobsCompleted} jobs</div>
        </div>
      `).join('');
    }

    function setupAgentHubListeners() {
      document.getElementById('createAgentBtn')?.addEventListener('click', () => {
        if (!agentRuntimeInstance) return;
        const agent = agentRuntimeInstance.createAgent({
          name: `Agent-${Date.now().toString(36).slice(-4).toUpperCase()}`,
          type: 'general',
          capabilities: ['chat', 'code', 'analyze']
        });
        showToast(`Created agent: ${agent.name}`, 'success');
        updateAgentList();
      });

      document.getElementById('createPodBtn')?.addEventListener('click', async () => {
        try {
          if (!window.podManagerInstance) {
            const { PodManager } = await import('./grudgeos/lib/pods/pod-manager.js');
            window.podManagerInstance = new PodManager();
            await window.podManagerInstance.initialize();
          }
          const pod = window.podManagerInstance.createPod({ name: `Pod-${Date.now().toString(36).slice(-4)}` });
          showToast(`Created pod: ${pod.name}`, 'success');
          updatePodGrid();
        } catch (e) {
          showToast('Failed to create pod', 'error');
          console.warn('[AgentHub] Pod creation failed:', e);
        }
      });

      document.getElementById('terminalInput')?.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter') {
          const input = e.target;
          const command = input.value.trim();
          if (!command) return;

          input.value = '';
          await executeTerminalCommand(command);
        }
      });

      document.getElementById('runCommandBtn')?.addEventListener('click', async () => {
        const input = document.getElementById('terminalInput');
        const command = input.value.trim();
        if (!command) return;

        input.value = '';
        await executeTerminalCommand(command);
      });

      document.querySelectorAll('.ninja-shell').forEach(shell => {
        shell.addEventListener('click', async () => {
          const template = shell.dataset.template;
          if (!codeNinjaShellInstance) return;

          const ninjaShell = codeNinjaShellInstance.createShell(template);
          showToast(`Created ${ninjaShell.name}`, 'success');
          appendTerminalOutput(`[Code Ninja] ${ninjaShell.icon} ${ninjaShell.name} ready`, '#bb9af7');
        });
      });
    }

    async function executeTerminalCommand(command) {
      appendTerminalOutput(`$ ${command}`, '#7aa2f7');

      if (terminalOrchestratorInstance) {
        const terminals = terminalOrchestratorInstance.getAllTerminals();
        let terminal = terminals[0];
        if (!terminal) {
          terminal = terminalOrchestratorInstance.createTerminal({ name: 'Main' });
        }

        try {
          const result = await terminalOrchestratorInstance.executeCommand(terminal.id, command);
          appendTerminalOutput(result.output, result.exitCode === 0 ? '#a9b1d6' : '#f7768e');
        } catch (e) {
          appendTerminalOutput(`Error: ${e.message}`, '#f7768e');
        }
      } else {
        appendTerminalOutput('Terminal not initialized', '#f7768e');
      }
    }

    function appendTerminalOutput(text, color = '#a9b1d6') {
      const output = document.getElementById('terminalOutput');
      if (!output) return;

      const line = document.createElement('div');
      line.style.color = color;
      line.textContent = text;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    // Initialize canvas and agent hub when switching views
    const originalSwitchView = window.switchView;
    window.switchView = function(view) {
      if (typeof originalSwitchView === 'function') {
        originalSwitchView(view);
      }
      if (view === 'canvas') {
        setTimeout(() => initCanvasStudio(), 100);
      }
      if (view === 'agent-hub') {
        setTimeout(() => initAgentHub(), 100);
      }
    };

    // ============ INIT ============
    async function init() {
      // Initialize responsive UI features first
      initAccordions();
      initMobileMenu();
      detectDevice();
      
      await checkAPIStatus();
      await checkAuth();
      
      // Load AI memory after auth
      if (state.user) {
        await aiMemory.load();
        
        // Initialize Grudge App and Launcher
        await grudgeStore.init();
        await launcherStore.init();
        await improvementEngine.init();
      }
      
      // Show API status on dashboard
      if (state.apiStatus?.services?.puterAI) {
        showToast('Puter AI ready (Free)', 'success');
      }
      
      if (!state.user) {
        document.getElementById('statFiles').textContent = '--';
        document.getElementById('statApps').textContent = '--';
        document.getElementById('statFunctions').textContent = '--';
      } else {
        // Load studio files if logged in
        loadStudioFiles('/');
      }
    }

    init();
  </script>
</body>
</html>
