<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GrudgeOS Desktop</title>
  <script src="https://js.puter.com/v2/"></script>
  <script>
    // Suppress Puter SDK internal JSON parsing errors (benign - occurs when SDK polls unavailable services)
    window.addEventListener('unhandledrejection', function(event) {
      if (event.reason && event.reason.message && event.reason.message.includes("Unexpected token '<'")) {
        event.preventDefault();
      }
    });
    window.addEventListener('error', function(event) {
      if (event.message && event.message.includes("Unexpected token '<'")) {
        event.preventDefault();
        return true;
      }
    });
  </script>
  <script src="lib/icon-generator.js"></script>
  <script src="lib/agent-registry.js"></script>
  <script src="lib/network-containers.js"></script>
  <script src="lib/agent-squad.js"></script>
  <script src="lib/ai-rest-client.js"></script>
  <script src="lib/pods/pod-manager.js"></script>
  <script src="lib/pods/snapshot-manager.js"></script>
  <script src="lib/runtime/wasm-runtime.js"></script>
  <script src="lib/runtime/webgl-visualizer.js"></script>
  <script src="lib/game/input-manager.js"></script>
  <script src="lib/game/third-person-camera.js"></script>
  <script src="lib/game/character-controller.js"></script>
  <link rel="stylesheet" href="styles/agent-runner.css">
  <link rel="stylesheet" href="styles/grudge-cloud.css">
  <link rel="stylesheet" href="styles/system-apps.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@400;500;600;700&display=swap');
    
    :root {
      --bg-dark: #0a0a12;
      --bg-panel: rgba(13, 13, 26, 0.95);
      --bg-card: rgba(18, 18, 31, 0.95);
      --bg-glass: rgba(20, 20, 40, 0.85);
      --neon-cyan: #00f5ff;
      --neon-pink: #ff00aa;
      --neon-purple: #8b5cf6;
      --neon-blue: #3b82f6;
      --neon-green: #00ff88;
      --neon-orange: #ff6b35;
      --text: #e8e8ff;
      --text-secondary: #9090b0;
      --text-muted: #505070;
      --border: rgba(139, 92, 246, 0.3);
      --glow-cyan: 0 0 20px rgba(0, 245, 255, 0.5);
      --glow-pink: 0 0 20px rgba(255, 0, 170, 0.5);
      --glow-purple: 0 0 20px rgba(139, 92, 246, 0.5);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: #1a1a2e;
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #desktop-shell {
      position: relative;
      width: calc(100vw - 40px);
      height: calc(100vh - 40px);
      max-width: 1600px;
      max-height: 1000px;
      background: var(--bg-dark);
      border-radius: 16px;
      border: 3px solid rgba(139, 92, 246, 0.4);
      box-shadow: 
        0 0 60px rgba(139, 92, 246, 0.3),
        0 20px 60px rgba(0, 0, 0, 0.6),
        inset 0 0 100px rgba(139, 92, 246, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    #desktop-shell::before {
      content: '';
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
      border-radius: 0 0 4px 4px;
    }
    
    #desktop-viewport {
      position: relative;
      flex: 1;
      overflow: hidden;
      background-image: 
        radial-gradient(ellipse at 20% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(0, 245, 255, 0.1) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(255, 0, 170, 0.08) 0%, transparent 70%);
    }
    
    #desktop {
      position: absolute;
      inset: 0;
    }
    
    .desktop-icon {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px;
      width: 90px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, border 0.2s;
    }
    
    .desktop-icon:hover {
      background: rgba(139, 92, 246, 0.2);
    }
    
    .desktop-icon.selected {
      background: rgba(0, 245, 255, 0.2);
      border: 1px solid var(--neon-cyan);
    }
    
    .desktop-icon.dragging {
      opacity: 0.7;
      z-index: 1000;
    }
    
    #selection-box {
      position: absolute;
      border: 1px solid var(--neon-cyan);
      background: rgba(0, 245, 255, 0.1);
      pointer-events: none;
      z-index: 999;
      display: none;
    }
    
    .desktop-icon-img {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: background 0.2s, box-shadow 0.2s;
    }
    
    /* Icon background styles - controlled by settings */
    .icon-bg-gradient .desktop-icon-img {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    .icon-bg-dark .desktop-icon-img {
      background: rgba(0, 0, 0, 0.55);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .icon-bg-transparent .desktop-icon-img {
      background: transparent;
      box-shadow: none;
    }
    .icon-bg-glass .desktop-icon-img {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .icon-letter {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
      letter-spacing: 1px;
    }
    
    .icon-letter-sm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      font-family: 'Orbitron', sans-serif;
      font-size: 9px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
      letter-spacing: 0.5px;
    }
    
    .desktop-icon-label {
      font-size: 12px;
      text-align: center;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    #taskbar {
      position: relative;
      height: 56px;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 12px;
      z-index: 9999;
      flex-shrink: 0;
    }
    
    #launcher-btn {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: var(--glow-cyan);
      overflow: hidden;
      padding: 4px;
    }
    
    #launcher-btn img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 6px;
    }
    
    #launcher-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 30px rgba(0, 245, 255, 0.6);
    }
    
    #running-apps {
      flex: 1;
      display: flex;
      gap: 6px;
      padding: 0 16px;
      overflow-x: auto;
    }
    
    .taskbar-app {
      height: 42px;
      padding: 0 16px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid transparent;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .taskbar-app:hover {
      background: rgba(139, 92, 246, 0.25);
      border-color: var(--neon-purple);
    }
    
    .taskbar-app.active {
      background: rgba(0, 245, 255, 0.2);
      border-color: var(--neon-cyan);
      box-shadow: 0 0 15px rgba(0, 245, 255, 0.3);
    }
    
    .taskbar-app-icon {
      font-size: 18px;
    }
    
    .taskbar-app-title {
      font-size: 13px;
      font-weight: 500;
    }
    
    #system-tray {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-left: 16px;
      border-left: 1px solid var(--border);
    }
    
    .tray-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    
    .tray-img, .channel-icon-img, .console-icon-img, .toggle-icon-img,
    .model-icon-img, .menu-icon-img, .notif-icon-img {
      width: 18px;
      height: 18px;
      object-fit: contain;
      vertical-align: middle;
    }
    
    .toggle-icon-img {
      width: 22px;
      height: 22px;
    }
    
    .model-icon-img {
      width: 24px;
      height: 24px;
    }
    
    .tray-icon:hover {
      background: rgba(139, 92, 246, 0.2);
    }
    
    #clock {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      color: var(--neon-cyan);
      padding: 0 10px;
    }
    
    .window {
      position: absolute;
      min-width: 400px;
      min-height: 300px;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), var(--glow-purple);
    }
    
    .window.focused {
      z-index: 1000;
      border-color: var(--neon-cyan);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), var(--glow-cyan);
    }
    
    .window.minimized {
      display: none;
    }
    
    .window.maximized {
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: calc(100% - 56px) !important;
      border-radius: 0;
    }
    
    .window.split-left {
      top: 0 !important;
      left: 0 !important;
      width: 50% !important;
      height: calc(100% - 56px) !important;
      border-radius: 0;
    }
    
    .window.split-right {
      top: 0 !important;
      left: 50% !important;
      width: 50% !important;
      height: calc(100% - 56px) !important;
      border-radius: 0;
    }
    
    .window.split-top {
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: calc(50% - 28px) !important;
      border-radius: 0;
    }
    
    .window.split-bottom {
      top: calc(50% - 28px) !important;
      left: 0 !important;
      width: 100% !important;
      height: calc(50% - 28px) !important;
      border-radius: 0;
    }
    
    #snap-indicator {
      position: absolute;
      background: rgba(0, 245, 255, 0.15);
      border: 2px solid var(--neon-cyan);
      border-radius: 8px;
      z-index: 9998;
      pointer-events: none;
      display: none;
      transition: all 0.15s ease;
    }
    
    .window-titlebar {
      height: 40px;
      background: linear-gradient(90deg, rgba(139, 92, 246, 0.3), rgba(0, 245, 255, 0.2));
      display: flex;
      align-items: center;
      padding: 0 12px;
      cursor: move;
      flex-shrink: 0;
    }
    
    .window-icon {
      font-size: 18px;
      margin-right: 10px;
    }
    
    .window-title {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      font-family: 'Orbitron', sans-serif;
    }
    
    .window-controls {
      display: flex;
      gap: 8px;
    }
    
    .window-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .window-btn:hover { background: rgba(255,255,255,0.1); }
    .window-btn.close:hover { background: #ff4444; }
    
    .window-content {
      flex: 1;
      overflow: auto;
      background: var(--bg-dark);
    }
    
    .window-content iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .resize-handle {
      position: absolute;
      background: transparent;
    }
    
    .resize-handle.se {
      right: 0;
      bottom: 0;
      width: 20px;
      height: 20px;
      cursor: se-resize;
    }
    
    .resize-handle.e {
      right: 0;
      top: 40px;
      width: 6px;
      height: calc(100% - 60px);
      cursor: e-resize;
    }
    
    .resize-handle.s {
      bottom: 0;
      left: 20px;
      width: calc(100% - 40px);
      height: 6px;
      cursor: s-resize;
    }
    
    #context-menu {
      position: fixed;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 0;
      min-width: 180px;
      z-index: 10000;
      display: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.6);
    }
    
    .context-item {
      padding: 10px 16px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.15s;
    }
    
    .context-item:hover {
      background: rgba(139, 92, 246, 0.3);
    }
    
    .context-item.disabled {
      opacity: 0.4;
      pointer-events: none;
    }
    
    .context-divider {
      height: 1px;
      background: var(--border);
      margin: 6px 0;
    }
    
    #launcher-menu {
      position: fixed;
      bottom: 66px;
      left: 12px;
      width: 360px;
      max-height: calc(100vh - 120px);
      background: rgba(10, 10, 18, 0.98);
      backdrop-filter: blur(24px);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 16px;
      z-index: 10000;
      display: none;
      box-shadow: 
        0 12px 48px rgba(0, 0, 0, 0.7),
        0 0 60px rgba(139, 92, 246, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }
    
    .launcher-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(0, 245, 255, 0.1));
      border-bottom: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .launcher-logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 18px;
      box-shadow: 0 0 20px rgba(0, 245, 255, 0.4);
    }
    
    .launcher-search {
      flex: 1;
    }
    
    .launcher-search input {
      width: 100%;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 10px;
      padding: 10px 14px;
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      transition: all 0.25s;
    }
    
    .launcher-search input:focus {
      outline: none;
      border-color: var(--neon-cyan);
      box-shadow: 0 0 20px rgba(0, 245, 255, 0.2);
    }
    
    .launcher-search input::placeholder {
      color: var(--text-muted);
    }
    
    .launcher-sections {
      max-height: 400px;
      overflow-y: auto;
      padding: 8px;
    }
    
    .launcher-section {
      margin-bottom: 8px;
    }
    
    .launcher-section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: rgba(139, 92, 246, 0.1);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .launcher-section-header:hover {
      background: rgba(139, 92, 246, 0.2);
    }
    
    .section-icon {
      font-size: 16px;
    }
    
    .section-title {
      flex: 1;
      font-family: 'Orbitron', sans-serif;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--neon-cyan);
    }
    
    .section-arrow {
      font-size: 10px;
      transition: transform 0.25s;
      color: var(--text-muted);
    }
    
    .launcher-section-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .launcher-section-content.open {
      max-height: 600px;
    }
    
    .launcher-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 12px 8px;
    }
    
    .launcher-app {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 14px 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid transparent;
    }
    
    .launcher-app:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: rgba(139, 92, 246, 0.4);
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(139, 92, 246, 0.2);
    }
    
    .launcher-app-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s;
    }
    
    .launcher-app:hover .launcher-app-icon {
      transform: scale(1.08);
    }
    
    .launcher-app-name {
      font-size: 11px;
      text-align: center;
      color: var(--text);
      font-weight: 500;
    }
    
    /* Channel Categories */
    .channel-category {
      margin: 4px 0;
    }
    
    .category-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 8px;
    }
    
    .category-header:hover {
      background: rgba(139, 92, 246, 0.15);
    }
    
    .category-icon {
      font-size: 14px;
    }
    
    .category-name {
      flex: 1;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .category-arrow {
      font-size: 10px;
      color: var(--text-muted);
      transition: transform 0.25s;
    }
    
    .category-channels {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      padding-left: 8px;
    }
    
    .category-channels.open {
      max-height: 300px;
    }
    
    .channel-quick-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin: 2px 0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 2px solid transparent;
    }
    
    .channel-quick-item:hover {
      background: rgba(0, 245, 255, 0.1);
      border-left-color: var(--neon-cyan);
    }
    
    .channel-quick-item .channel-type-icon {
      font-size: 14px;
      width: 20px;
      text-align: center;
    }
    
    .channel-quick-item .channel-name {
      flex: 1;
      font-size: 13px;
      color: var(--text);
    }
    
    .channel-badge {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    
    .channel-badge.live {
      background: linear-gradient(135deg, #ff0044, #ff00aa);
      color: white;
      animation: pulse-badge 1.5s infinite;
    }
    
    .channel-badge.ai {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      color: white;
    }
    
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    /* Launcher Footer */
    .launcher-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(139, 92, 246, 0.2);
    }
    
    .user-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Orbitron', sans-serif;
      font-weight: 700;
      font-size: 14px;
    }
    
    .user-info {
      display: flex;
      flex-direction: column;
    }
    
    .user-name {
      font-size: 13px;
      font-weight: 600;
    }
    
    .user-status-indicator {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .user-status-indicator.online {
      color: var(--neon-green);
    }
    
    .quick-actions {
      display: flex;
      gap: 8px;
    }
    
    .quick-action-btn {
      width: 34px;
      height: 34px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    
    .quick-action-btn:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: var(--neon-purple);
      transform: scale(1.05);
    }
    
    /* Scrollbar for launcher */
    .launcher-sections::-webkit-scrollbar {
      width: 5px;
    }
    
    .launcher-sections::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .launcher-sections::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.4);
      border-radius: 3px;
    }
    
    /* Channel Type Tag */
    .channel-type-tag {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 4px;
      background: rgba(0, 245, 255, 0.2);
      color: var(--neon-cyan);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: auto;
      margin-right: 12px;
    }
    
    /* Channel Window Content */
    .channel-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-dark);
    }
    
    .channel-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(139, 92, 246, 0.1);
      border-bottom: 1px solid var(--border);
    }
    
    .channel-members-count {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .channel-actions {
      display: flex;
      gap: 8px;
    }
    
    .channel-action-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .channel-action-btn:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: var(--neon-purple);
    }
    
    .channel-action-btn.primary {
      background: linear-gradient(135deg, #ff0044, #ff00aa);
      border-color: transparent;
      color: white;
      width: auto;
      padding: 0 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    /* Chat Messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .chat-welcome {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }
    
    .chat-welcome .welcome-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .chat-welcome h3 {
      font-family: 'Orbitron', sans-serif;
      color: var(--neon-cyan);
      margin-bottom: 8px;
    }
    
    .chat-message {
      display: flex;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .chat-message:last-child {
      border-bottom: none;
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .message-body {
      flex: 1;
      min-width: 0;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }
    
    .message-author {
      font-weight: 600;
      color: var(--neon-cyan);
      font-size: 14px;
    }
    
    .message-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .message-content {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    
    /* Chat Input */
    .chat-input-container {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(18, 18, 31, 0.9);
      border-top: 1px solid var(--border);
    }
    
    .input-action {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }
    
    .input-action:hover {
      background: rgba(139, 92, 246, 0.2);
    }
    
    .chat-input {
      flex: 1;
      background: rgba(10, 10, 18, 0.9);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 10px;
      padding: 10px 14px;
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      transition: all 0.25s;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--neon-cyan);
      box-shadow: 0 0 15px rgba(0, 245, 255, 0.2);
    }
    
    .send-button {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .send-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
    }
    
    /* Voice/Video Grids */
    .voice-participants-grid, .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      padding: 16px;
      overflow-y: auto;
    }
    
    .voice-participant, .video-tile {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: rgba(18, 18, 31, 0.8);
      border-radius: 12px;
      border: 1px solid transparent;
      transition: all 0.25s;
    }
    
    .voice-participant.self, .video-tile.self {
      border-color: var(--neon-cyan);
      background: rgba(0, 245, 255, 0.1);
    }
    
    .participant-avatar {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .participant-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }
    
    .participant-status {
      display: flex;
      gap: 8px;
    }
    
    .status-icon {
      font-size: 14px;
      opacity: 0.5;
    }
    
    .status-icon.muted {
      color: #ff4444;
      opacity: 1;
    }
    
    .video-tile video {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 8px;
      background: #000;
    }
    
    .video-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    /* Voice/Video Controls Bar */
    .voice-controls-bar, .video-controls-bar {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 16px;
      background: rgba(18, 18, 31, 0.9);
      border-top: 1px solid var(--border);
    }
    
    .voice-control, .video-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 20px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.25s;
    }
    
    .voice-control .icon, .video-control .icon {
      font-size: 20px;
    }
    
    .voice-control .label {
      font-size: 11px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }
    
    .voice-control:hover, .video-control:hover {
      background: rgba(139, 92, 246, 0.3);
      border-color: var(--neon-purple);
    }
    
    .voice-control.active, .video-control.active {
      background: rgba(0, 245, 255, 0.2);
      border-color: var(--neon-cyan);
    }
    
    .voice-control.danger:hover, .video-control.danger:hover {
      background: rgba(255, 68, 68, 0.3);
      border-color: #ff4444;
    }
    
    /* Stream Layout */
    .stream-layout {
      display: grid;
      grid-template-columns: 1fr 250px;
      flex: 1;
      overflow: hidden;
    }
    
    .stream-player {
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .stream-player video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .stream-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      color: var(--text-muted);
    }
    
    .stream-placeholder span {
      font-size: 64px;
    }
    
    .stream-overlay {
      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .live-badge {
      background: linear-gradient(135deg, #ff0044, #ff00aa);
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 4px;
      animation: pulse-badge 1.5s infinite;
    }
    
    .stop-stream-btn {
      background: rgba(255, 68, 68, 0.9);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .stop-stream-btn:hover {
      background: #ff4444;
    }
    
    .btn-start-stream {
      background: linear-gradient(135deg, #ff0044, #ff00aa);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-start-stream:hover {
      box-shadow: 0 0 30px rgba(255, 0, 170, 0.5);
      transform: scale(1.05);
    }
    
    .stream-chat {
      display: flex;
      flex-direction: column;
      background: rgba(10, 10, 18, 0.95);
      border-left: 1px solid var(--border);
    }
    
    .stream-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .stream-chat-input {
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid var(--border);
    }
    
    .stream-chat-input input {
      flex: 1;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 13px;
    }
    
    .stream-chat-input button {
      width: 36px;
      height: 36px;
      background: var(--neon-purple);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }
    
    .app-content {
      padding: 20px;
      height: 100%;
      overflow: auto;
    }
    
    .app-header {
      font-family: 'Orbitron', sans-serif;
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--neon-cyan);
    }
    
    .app-section {
      background: var(--bg-card);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
    }
    
    .app-section-title {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    
    .status-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .status-item:last-child { border-bottom: none; }
    
    .status-value {
      color: var(--neon-green);
      font-weight: 600;
    }
    
    .btn {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn:hover {
      box-shadow: var(--glow-pink);
      transform: translateY(-2px);
    }
    
    .audio-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-dark);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .audio-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--neon-pink), var(--neon-orange));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .audio-info { flex: 1; }
    .audio-name { font-weight: 600; font-size: 14px; }
    .audio-size { font-size: 12px; color: var(--text-muted); }
    
    .ai-model-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: var(--bg-dark);
      border-radius: 10px;
      margin-bottom: 10px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-model-card:hover {
      border-color: var(--neon-purple);
    }
    
    .ai-model-card.active {
      border-color: var(--neon-green);
      background: rgba(0, 255, 136, 0.1);
    }
    
    .ai-model-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }
    
    .ai-model-info { flex: 1; }
    .ai-model-name { font-weight: 600; font-size: 15px; }
    .ai-model-desc { font-size: 12px; color: var(--text-muted); }
    
    .ai-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--neon-green);
      box-shadow: 0 0 10px var(--neon-green);
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { 
      background: linear-gradient(180deg, var(--neon-purple), var(--neon-pink)); 
      border-radius: 4px;
    }
    
    #ai-console {
      position: fixed;
      right: -400px;
      top: 0;
      bottom: 56px;
      width: 400px;
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      z-index: 9998;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    
    #ai-console.visible { right: 0; }
    
    .console-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-glass);
    }
    
    .console-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      color: var(--neon-cyan);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .console-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
    }
    
    .console-tab {
      flex: 1;
      padding: 10px 16px;
      text-align: center;
      font-size: 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .console-tab:hover { background: rgba(139, 92, 246, 0.1); }
    .console-tab.active { border-bottom-color: var(--neon-cyan); color: var(--neon-cyan); }
    
    .console-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .console-log {
      padding: 10px 12px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 8px;
      border-left: 3px solid var(--neon-cyan);
      font-size: 12px;
    }
    
    .console-log.ai { border-left-color: var(--neon-purple); }
    .console-log.event { border-left-color: var(--neon-green); }
    .console-log.error { border-left-color: var(--neon-pink); }
    
    .console-log-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    
    .console-log-type {
      font-size: 10px;
      text-transform: uppercase;
      font-weight: 600;
      color: var(--neon-cyan);
    }
    
    .console-log-time {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .console-log-msg {
      color: var(--text-secondary);
      line-height: 1.4;
    }
    
    #ai-canvas {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      width: 900px;
      height: 600px;
      background: var(--bg-panel);
      border: 1px solid var(--neon-purple);
      border-radius: 16px;
      z-index: 9997;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 60px rgba(139, 92, 246, 0.4);
    }
    
    #ai-canvas.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }
    
    .canvas-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .canvas-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      color: var(--neon-purple);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .canvas-close {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .canvas-close:hover { background: rgba(255, 0, 170, 0.3); }
    
    .canvas-tabs {
      display: flex;
      gap: 4px;
    }
    
    .canvas-tab {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
    }
    
    .canvas-tab:hover {
      background: rgba(139, 92, 246, 0.15);
      color: var(--text);
    }
    
    .canvas-tab.active {
      background: rgba(139, 92, 246, 0.25);
      color: var(--neon-purple);
    }
    
    .canvas-agents-sidebar {
      width: 200px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .canvas-agents-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .canvas-agent-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 6px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .canvas-agent-item:hover {
      background: rgba(139, 92, 246, 0.15);
    }
    
    .canvas-agent-item.active {
      background: rgba(139, 92, 246, 0.2);
      border-left-color: var(--neon-purple);
    }
    
    .canvas-agent-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    
    .canvas-agent-item-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }
    
    .canvas-agent-item-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: auto;
    }
    
    .canvas-agent-item-status.active {
      background: rgba(34, 197, 94, 0.2);
      color: var(--neon-green);
    }
    
    .canvas-agent-item-status.idle {
      background: rgba(100, 100, 100, 0.2);
      color: var(--text-muted);
    }
    
    .canvas-agent-item-task {
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .canvas-agent-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .canvas-agent-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(0, 0, 0, 0.1);
    }
    
    .canvas-agent-name {
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      color: var(--neon-purple);
    }
    
    .canvas-agent-work {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    
    .agent-work-item {
      padding: 14px 16px;
      border-radius: 10px;
      margin-bottom: 12px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border);
    }
    
    .agent-work-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .agent-work-item-type {
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 10px;
    }
    
    .agent-work-item-type.analysis {
      background: rgba(0, 245, 255, 0.15);
      color: var(--neon-cyan);
    }
    
    .agent-work-item-type.code {
      background: rgba(139, 92, 246, 0.15);
      color: var(--neon-purple);
    }
    
    .agent-work-item-type.result {
      background: rgba(34, 197, 94, 0.15);
      color: var(--neon-green);
    }
    
    .agent-work-item-type.info {
      background: rgba(255, 170, 0, 0.15);
      color: #ffaa00;
    }
    
    .agent-work-item-content {
      font-size: 13px;
      color: var(--text);
      line-height: 1.5;
    }
    
    .agent-work-code {
      margin-top: 10px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--neon-cyan);
      overflow-x: auto;
      white-space: pre-wrap;
    }
    
    .canvas-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    .canvas-scripts {
      width: 200px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .canvas-scripts-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
      font-weight: 600;
      color: var(--neon-cyan);
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .canvas-scripts-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .canvas-script-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      transition: all 0.2s;
      border-left: 2px solid transparent;
    }
    
    .canvas-script-item:hover {
      background: rgba(139, 92, 246, 0.15);
    }
    
    .canvas-script-item.active {
      background: rgba(139, 92, 246, 0.2);
      border-left-color: var(--neon-purple);
    }
    
    .canvas-script-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .canvas-script-meta {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .canvas-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .canvas-toolbar {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0, 0, 0, 0.1);
    }
    
    .canvas-toolbar-btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .canvas-toolbar-btn:hover {
      background: rgba(139, 92, 246, 0.2);
      border-color: var(--neon-purple);
    }
    
    .canvas-toolbar-btn.primary {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      border: none;
      color: white;
    }
    
    .canvas-toolbar-btn.primary:hover {
      filter: brightness(1.1);
      box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
    }
    
    .canvas-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    .canvas-code {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }
    
    .canvas-code-header {
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 600;
      color: var(--neon-cyan);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .canvas-code-area {
      flex: 1;
      overflow: auto;
      background: rgba(0, 0, 0, 0.3);
    }
    
    .canvas-code-area pre {
      margin: 0;
      padding: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.5;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .canvas-output {
      width: 300px;
      display: flex;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.15);
    }
    
    .canvas-output-header {
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 600;
      color: var(--neon-green);
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .canvas-output-area {
      flex: 1;
      overflow: auto;
      padding: 16px;
    }
    
    .canvas-output-item {
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .canvas-output-item.success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: var(--neon-green);
    }
    
    .canvas-output-item.error {
      background: rgba(255, 0, 170, 0.1);
      border: 1px solid rgba(255, 0, 170, 0.3);
      color: var(--neon-pink);
    }
    
    .canvas-output-item.info {
      background: rgba(0, 245, 255, 0.1);
      border: 1px solid rgba(0, 245, 255, 0.3);
      color: var(--neon-cyan);
    }
    
    .canvas-output-value {
      font-family: 'JetBrains Mono', monospace;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      margin-top: 8px;
      font-size: 13px;
      color: var(--neon-cyan);
    }
    
    .canvas-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      text-align: center;
      color: var(--text-muted);
    }
    
    .canvas-empty-icon {
      margin-bottom: 16px;
    }
    
    .canvas-area {
      flex: 1;
      position: relative;
      overflow: hidden;
    }
    
    .canvas-area canvas {
      width: 100%;
      height: 100%;
    }
    
    .canvas-message {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
    
    .canvas-message-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }
    
    .canvas-message-text {
      font-size: 18px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    #notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 99999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }
    
    .notification {
      background: var(--bg-panel);
      border: 1px solid var(--neon-purple);
      border-radius: 12px;
      padding: 16px 20px;
      min-width: 320px;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      animation: slideIn 0.3s ease;
      pointer-events: auto;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .notification-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .notification-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .notification-title {
      font-weight: 600;
      font-size: 14px;
    }
    
    .notification-close {
      margin-left: auto;
      cursor: pointer;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    
    .notification-close:hover { opacity: 1; }
    
    .notification-content {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    
    .notification-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .notification-btn {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: 'Rajdhani', sans-serif;
    }
    
    .notification-btn.primary {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      color: white;
    }
    
    .notification-btn.secondary {
      background: var(--bg-card);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .console-toggle {
      position: fixed;
      right: 20px;
      bottom: 76px;
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      z-index: 9996;
      box-shadow: 0 4px 20px rgba(139, 92, 246, 0.5);
      transition: all 0.3s;
    }
    
    .console-toggle:hover {
      transform: scale(1.1);
    }
    
    .console-toggle.active {
      background: var(--neon-cyan);
    }
    
    /* Pods App Styles */
    .pods-content, .snapshots-content, .studio3d-content, .wasm-content {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: var(--bg-panel);
    }
    
    .pods-header, .snapshots-header, .studio3d-header, .wasm-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(0, 245, 255, 0.1));
      border-bottom: 1px solid var(--border);
    }
    
    .pods-title, .snapshots-title, .studio3d-title, .wasm-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      font-weight: 600;
      font-family: 'Orbitron', sans-serif;
    }
    
    .pods-stats, .wasm-status {
      display: flex;
      gap: 16px;
    }
    
    .pods-tabs, .snapshots-tabs, .wasm-tabs {
      display: flex;
      gap: 4px;
      padding: 8px 12px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
    }
    
    .pods-tab, .snapshots-tab, .wasm-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 6px;
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .pods-tab.active, .snapshots-tab.active, .wasm-tab.active {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      color: white;
    }
    
    .pods-body, .snapshots-body, .wasm-body {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    
    .pods-tab-content, .snapshots-tab-content, .wasm-tab-content {
      display: none;
    }
    
    .pods-tab-content.active, .snapshots-tab-content.active, .wasm-tab-content.active {
      display: block;
    }
    
    .pods-grid, .snapshots-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .pod-card, .snapshot-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .pod-card:hover, .snapshot-card:hover {
      border-color: var(--neon-cyan);
      box-shadow: 0 0 15px rgba(0, 245, 255, 0.2);
    }
    
    .pod-card-header, .snapshot-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .pod-name, .snapshot-name {
      font-weight: 600;
      font-size: 14px;
    }
    
    .pod-status {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      text-transform: uppercase;
    }
    
    .pod-status.idle { background: rgba(0, 255, 136, 0.2); color: var(--neon-green); }
    .pod-status.busy { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .pod-status.warming { background: rgba(59, 130, 246, 0.2); color: var(--neon-blue); }
    
    .pod-stats, .snapshot-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .pods-action-btn, .snapshot-action-btn, .snapshot-create-btn, .wasm-action-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .pods-action-btn:hover, .snapshot-action-btn:hover, .snapshot-create-btn:hover, .wasm-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    
    .job-form, .snapshot-form, .wasm-execute-form, .wasm-load-section, .import-export-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 500px;
    }
    
    .job-form label, .snapshot-form label, .wasm-execute-form label, .wasm-load-section label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .job-form select, .job-form textarea, .snapshot-form input, .snapshot-form select, .snapshot-form textarea,
    .wasm-execute-form select, .wasm-execute-form input, .wasm-load-section input, .import-export-section select, .import-export-section textarea {
      padding: 10px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
    }
    
    .job-form textarea, .snapshot-form textarea, .import-export-section textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .jobs-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .job-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    
    .job-item-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .job-item-type {
      font-weight: 600;
      font-size: 14px;
    }
    
    .job-item-id {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .job-item-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      text-transform: uppercase;
    }
    
    .job-item-status.pending { background: rgba(139, 92, 246, 0.2); color: var(--neon-purple); }
    .job-item-status.running { background: rgba(0, 245, 255, 0.2); color: var(--neon-cyan); }
    .job-item-status.completed { background: rgba(0, 255, 136, 0.2); color: var(--neon-green); }
    .job-item-status.failed { background: rgba(255, 0, 170, 0.2); color: var(--neon-pink); }
    
    .no-pods, .no-jobs, .no-snapshots, .no-modules {
      padding: 30px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }
    
    /* 3D Studio Styles */
    .studio3d-controls {
      display: flex;
      gap: 8px;
    }
    
    .studio3d-btn {
      padding: 6px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .studio3d-btn:hover {
      border-color: var(--neon-cyan);
      background: rgba(0, 245, 255, 0.1);
    }
    
    .studio3d-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    #webgl-canvas {
      flex: 1;
      background: #0a0a12;
    }
    
    .studio3d-sidebar {
      width: 200px;
      padding: 16px;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
    }
    
    .studio3d-sidebar h4 {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .scene-info p {
      font-size: 13px;
      margin-bottom: 6px;
    }
    
    .camera-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .camera-controls button {
      padding: 8px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .camera-controls button:hover {
      border-color: var(--neon-cyan);
    }
    
    /* Studio3D Tabs */
    .studio3d-tabs {
      display: flex;
      gap: 0;
      padding: 0 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    
    .studio3d-tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      transition: all 0.2s;
    }
    
    .studio3d-tab:hover {
      color: var(--text);
    }
    
    .studio3d-tab.active {
      color: var(--neon-cyan);
      border-bottom-color: var(--neon-cyan);
    }
    
    .studio3d-tab-content {
      display: none;
      flex: 1;
      overflow: hidden;
    }
    
    .studio3d-tab-content.active {
      display: flex;
    }
    
    /* AI Console Styles */
    .ai-console-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    .ai-console-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;
    }
    
    .ai-console-sidebar {
      width: 260px;
      padding: 16px;
      background: var(--bg-card);
      border-left: 1px solid var(--border);
      overflow-y: auto;
    }
    
    .ai-gen-section {
      margin-bottom: 24px;
    }
    
    .ai-gen-section h4 {
      font-size: 14px;
      color: var(--neon-cyan);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-gen-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .ai-gen-form textarea {
      width: 100%;
      padding: 10px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      resize: vertical;
      min-height: 80px;
    }
    
    .ai-gen-form textarea:focus {
      outline: none;
      border-color: var(--neon-cyan);
    }
    
    .ai-gen-btn {
      padding: 10px 16px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      border: none;
      border-radius: 8px;
      color: #fff;
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-gen-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(0, 245, 255, 0.3);
    }
    
    .ai-gen-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .ai-gen-result {
      margin-top: 16px;
      padding: 16px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .ai-gen-result img, .ai-gen-result video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 8px;
    }
    
    .ai-gen-placeholder {
      color: var(--text-muted);
      font-size: 13px;
      text-align: center;
    }
    
    .ai-gen-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      color: var(--neon-cyan);
    }
    
    .ai-gen-loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--neon-cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .ai-asset-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .ai-asset-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ai-asset-item:hover {
      border-color: var(--neon-cyan);
    }
    
    .ai-asset-thumb {
      width: 48px;
      height: 48px;
      border-radius: 6px;
      object-fit: cover;
      background: var(--bg-secondary);
    }
    
    .ai-asset-info {
      flex: 1;
      overflow: hidden;
    }
    
    .ai-asset-name {
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .ai-asset-type {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .ai-asset-actions {
      display: flex;
      gap: 6px;
    }
    
    .ai-asset-actions button {
      padding: 6px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.2s;
    }
    
    .ai-asset-actions button:hover {
      border-color: var(--neon-cyan);
      color: var(--neon-cyan);
    }
    
    .link-asset-menu {
      position: absolute;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 0;
      min-width: 160px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5);
      z-index: 10000;
    }
    
    .link-asset-menu-item {
      padding: 10px 16px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .link-asset-menu-item:hover {
      background: rgba(0, 245, 255, 0.1);
    }
    
    /* Game Editor Pro Styles */
    .ge-pro-editor {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: #0d0d12;
      font-size: 12px;
    }
    
    .ge-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      background: linear-gradient(180deg, #1a1a24 0%, #14141c 100%);
      border-bottom: 1px solid rgba(100, 100, 140, 0.2);
      min-height: 40px;
    }
    
    .ge-toolbar-left, .ge-toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .ge-toolbar-center {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .ge-toolbar-title {
      font-weight: 600;
      color: var(--neon-cyan);
      font-size: 13px;
    }
    
    .ge-toolbar-divider {
      width: 1px;
      height: 20px;
      background: rgba(100, 100, 140, 0.3);
      margin: 0 8px;
    }
    
    .ge-tool-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(60, 60, 80, 0.3);
      border: 1px solid rgba(100, 100, 140, 0.2);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .ge-tool-btn:hover {
      background: rgba(0, 245, 255, 0.15);
      border-color: rgba(0, 245, 255, 0.4);
    }
    
    .ge-tool-btn.active {
      background: rgba(0, 245, 255, 0.25);
      border-color: var(--neon-cyan);
      box-shadow: 0 0 8px rgba(0, 245, 255, 0.3);
    }
    
    .ge-play-btn, .ge-pause-btn, .ge-stop-btn {
      height: 28px;
      padding: 0 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.15s;
    }
    
    .ge-play-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .ge-play-btn:hover { background: linear-gradient(135deg, #16a34a, #15803d); }
    
    .ge-pause-btn, .ge-stop-btn {
      width: 28px;
      padding: 0;
      background: rgba(60, 60, 80, 0.4);
      color: #a0a0b0;
    }
    
    .ge-pause-btn:hover { background: rgba(250, 204, 21, 0.3); color: #fbbf24; }
    .ge-stop-btn:hover { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
    
    .ge-device-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: #a0a0b0;
      padding: 4px 10px;
      background: rgba(40, 40, 55, 0.6);
      border-radius: 4px;
    }
    
    /* Main Editor Area */
    .ge-main-area {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* Left Panel: Hierarchy */
    .ge-left-panel {
      width: 200px;
      background: #12121a;
      border-right: 1px solid rgba(100, 100, 140, 0.15);
      display: flex;
      flex-direction: column;
    }
    
    .ge-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: rgba(30, 30, 45, 0.6);
      border-bottom: 1px solid rgba(100, 100, 140, 0.15);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      color: #8080a0;
    }
    
    .ge-panel-btn {
      width: 20px;
      height: 20px;
      background: rgba(0, 245, 255, 0.15);
      border: 1px solid rgba(0, 245, 255, 0.3);
      border-radius: 3px;
      color: var(--neon-cyan);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
    }
    
    .ge-hierarchy-tree {
      flex: 1;
      overflow-y: auto;
      padding: 6px 0;
    }
    
    .ge-tree-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      cursor: pointer;
      transition: background 0.1s;
      font-size: 12px;
    }
    
    .ge-tree-item:hover { background: rgba(0, 245, 255, 0.08); }
    .ge-tree-item.selected { background: rgba(0, 245, 255, 0.2); border-left: 2px solid var(--neon-cyan); }
    
    .ge-tree-expand {
      width: 12px;
      font-size: 8px;
      color: #6060a0;
    }
    
    .ge-tree-icon { font-size: 12px; }
    .ge-tree-name { color: #c0c0d0; }
    
    /* Center: Viewport */
    .ge-center-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #0a0a0f;
    }
    
    .ge-viewport-tabs {
      display: flex;
      gap: 2px;
      padding: 4px 8px;
      background: #14141c;
      border-bottom: 1px solid rgba(100, 100, 140, 0.15);
    }
    
    .ge-viewport-tab {
      padding: 6px 14px;
      background: transparent;
      border: none;
      border-radius: 4px 4px 0 0;
      color: #7070a0;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      transition: all 0.15s;
    }
    
    .ge-viewport-tab:hover { background: rgba(100, 100, 140, 0.15); color: #a0a0c0; }
    .ge-viewport-tab.active {
      background: rgba(0, 245, 255, 0.15);
      color: var(--neon-cyan);
      border-bottom: 2px solid var(--neon-cyan);
    }
    
    .ge-viewport-content {
      flex: 1;
      position: relative;
      display: none;
      overflow: auto;
    }
    
    .ge-viewport-content.active { display: flex; flex-direction: column; }
    
    #game-canvas {
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }
    
    .ge-viewport-overlay {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      pointer-events: none;
    }
    
    .ge-camera-mode {
      background: rgba(0, 245, 255, 0.2);
      border: 1px solid rgba(0, 245, 255, 0.4);
      padding: 4px 12px;
      border-radius: 4px;
      color: var(--neon-cyan);
      font-size: 11px;
      font-weight: 600;
    }
    
    .ge-controls-hint {
      background: rgba(0, 0, 0, 0.7);
      padding: 6px 12px;
      border-radius: 4px;
      color: #8080a0;
      font-size: 10px;
    }
    
    .ge-gizmo-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 4px;
    }
    
    .ge-gizmo-btn {
      padding: 4px 10px;
      background: rgba(40, 40, 55, 0.8);
      border: 1px solid rgba(100, 100, 140, 0.3);
      border-radius: 3px;
      color: #8080a0;
      cursor: pointer;
      font-size: 10px;
    }
    
    .ge-gizmo-btn.active {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.6);
      color: #a78bfa;
    }
    
    /* Right Panel: Inspector */
    .ge-right-panel {
      width: 260px;
      background: #12121a;
      border-left: 1px solid rgba(100, 100, 140, 0.15);
      display: flex;
      flex-direction: column;
    }
    
    .ge-inspector {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }
    
    .ge-inspector-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .ge-inspector-title span:first-child {
      font-weight: 600;
      color: #c0c0e0;
    }
    
    .ge-active-tag {
      font-size: 9px;
      padding: 2px 6px;
      background: rgba(0, 255, 136, 0.2);
      border-radius: 3px;
      color: var(--neon-green);
    }
    
    .ge-component {
      background: rgba(30, 30, 45, 0.5);
      border: 1px solid rgba(100, 100, 140, 0.15);
      border-radius: 4px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    
    .ge-component-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      background: rgba(50, 50, 70, 0.4);
      font-size: 11px;
      font-weight: 600;
      color: #a0a0c0;
      cursor: pointer;
    }
    
    .ge-component-header:hover { background: rgba(60, 60, 85, 0.5); }
    
    .ge-component-expand {
      font-size: 8px;
      color: #6060a0;
    }
    
    .ge-component-body {
      padding: 10px;
    }
    
    .ge-prop-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .ge-prop-row label {
      color: #8080a0;
      font-size: 11px;
    }
    
    .ge-vec3 {
      display: flex;
      gap: 4px;
    }
    
    .ge-input-sm {
      width: 50px;
      padding: 4px 6px;
      background: rgba(20, 20, 30, 0.8);
      border: 1px solid rgba(100, 100, 140, 0.2);
      border-radius: 3px;
      color: #c0c0d0;
      font-size: 11px;
      text-align: center;
    }
    
    .ge-input-sm:focus {
      border-color: var(--neon-cyan);
      outline: none;
    }
    
    .ge-state-badge {
      padding: 3px 8px;
      background: rgba(0, 255, 136, 0.2);
      border-radius: 3px;
      color: var(--neon-green);
      font-size: 10px;
      font-weight: 600;
    }
    
    .ge-axis-viz { margin-top: 4px; }
    
    .ge-axis-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    
    .ge-axis-label {
      width: 50px;
      font-size: 10px;
      color: #7070a0;
    }
    
    .ge-axis-bar {
      flex: 1;
      height: 6px;
      background: rgba(40, 40, 60, 0.6);
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }
    
    .ge-axis-fill {
      position: absolute;
      left: 50%;
      height: 100%;
      background: var(--neon-cyan);
      transition: all 0.05s;
    }
    
    .ge-action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }
    
    .ge-action-indicator {
      padding: 6px;
      text-align: center;
      font-size: 10px;
      background: rgba(40, 40, 60, 0.4);
      border-radius: 3px;
      color: #6060a0;
      transition: all 0.1s;
    }
    
    .ge-action-indicator.active {
      background: rgba(0, 255, 136, 0.25);
      color: var(--neon-green);
      box-shadow: 0 0 8px rgba(0, 255, 136, 0.3);
    }
    
    .ge-add-component-btn {
      width: 100%;
      padding: 8px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px dashed rgba(139, 92, 246, 0.4);
      border-radius: 4px;
      color: #a78bfa;
      cursor: pointer;
      font-size: 11px;
      margin-top: 8px;
      transition: all 0.15s;
    }
    
    .ge-add-component-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      border-style: solid;
    }
    
    /* Bottom Panel: Asset Browser */
    .ge-bottom-panel {
      height: 120px;
      background: #14141c;
      border-top: 1px solid rgba(100, 100, 140, 0.15);
      display: flex;
      flex-direction: column;
    }
    
    .ge-asset-tabs {
      display: flex;
      gap: 2px;
      padding: 4px 8px;
      background: rgba(20, 20, 30, 0.6);
      border-bottom: 1px solid rgba(100, 100, 140, 0.1);
    }
    
    .ge-asset-tab {
      padding: 4px 12px;
      background: transparent;
      border: none;
      color: #6060a0;
      cursor: pointer;
      font-size: 10px;
      border-radius: 3px;
    }
    
    .ge-asset-tab:hover { background: rgba(100, 100, 140, 0.15); }
    .ge-asset-tab.active {
      background: rgba(0, 245, 255, 0.15);
      color: var(--neon-cyan);
    }
    
    .ge-asset-grid {
      flex: 1;
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      overflow-x: auto;
    }
    
    .ge-asset-item {
      min-width: 70px;
      padding: 8px;
      background: rgba(40, 40, 60, 0.3);
      border: 1px solid rgba(100, 100, 140, 0.2);
      border-radius: 6px;
      text-align: center;
      cursor: grab;
      transition: all 0.15s;
    }
    
    .ge-asset-item:hover {
      background: rgba(0, 245, 255, 0.1);
      border-color: rgba(0, 245, 255, 0.4);
      transform: translateY(-2px);
    }
    
    .ge-asset-icon { font-size: 24px; margin-bottom: 4px; }
    .ge-asset-name { font-size: 10px; color: #a0a0b0; }
    
    /* Config Panels (Input, Camera, Scripts) */
    .ge-config-panel {
      padding: 20px;
      overflow-y: auto;
      height: 100%;
    }
    
    .ge-config-header {
      margin-bottom: 20px;
    }
    
    .ge-config-header h3 {
      color: var(--neon-cyan);
      font-size: 16px;
      margin-bottom: 4px;
    }
    
    .ge-config-header p {
      color: #7070a0;
      font-size: 12px;
    }
    
    .ge-config-section {
      background: rgba(30, 30, 45, 0.5);
      border: 1px solid rgba(100, 100, 140, 0.15);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
    }
    
    .ge-config-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: #8b5cf6;
      margin-bottom: 12px;
      letter-spacing: 0.5px;
    }
    
    .ge-action-mapping { display: flex; flex-direction: column; gap: 8px; }
    
    .ge-action-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 10px;
      background: rgba(40, 40, 60, 0.4);
      border-radius: 4px;
    }
    
    .ge-action-name {
      width: 120px;
      color: #c0c0d0;
      font-size: 12px;
    }
    
    .ge-bindings {
      flex: 1;
      display: flex;
      gap: 6px;
    }
    
    .ge-key-bind {
      padding: 4px 10px;
      background: rgba(0, 245, 255, 0.15);
      border: 1px solid rgba(0, 245, 255, 0.3);
      border-radius: 3px;
      color: var(--neon-cyan);
      font-size: 11px;
      font-weight: 500;
    }
    
    .ge-rebind-btn {
      padding: 4px 10px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 3px;
      color: #a78bfa;
      cursor: pointer;
      font-size: 10px;
    }
    
    .ge-rebind-btn:hover {
      background: rgba(139, 92, 246, 0.35);
    }
    
    .ge-input-settings, .ge-camera-settings {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .ge-setting-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .ge-setting-row label {
      width: 140px;
      color: #a0a0b0;
      font-size: 12px;
    }
    
    .ge-setting-row input[type="range"] {
      flex: 1;
      max-width: 150px;
    }
    
    .ge-setting-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--neon-cyan);
    }
    
    .ge-setting-row span {
      width: 40px;
      text-align: right;
      color: var(--neon-cyan);
      font-size: 11px;
    }
    
    .ge-config-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    
    .ge-btn-primary {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--neon-cyan), #0891b2);
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .ge-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 245, 255, 0.3);
    }
    
    .ge-btn-secondary {
      padding: 10px 20px;
      background: rgba(100, 100, 140, 0.2);
      border: 1px solid rgba(100, 100, 140, 0.4);
      border-radius: 4px;
      color: #a0a0b0;
      cursor: pointer;
    }
    
    .ge-btn-secondary:hover {
      background: rgba(100, 100, 140, 0.3);
      color: #c0c0d0;
    }
    
    /* Camera Modes Grid */
    .ge-camera-modes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .ge-camera-mode-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(40, 40, 60, 0.3);
      border: 1px solid rgba(100, 100, 140, 0.2);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .ge-camera-mode-card:hover {
      background: rgba(0, 245, 255, 0.08);
      border-color: rgba(0, 245, 255, 0.3);
    }
    
    .ge-camera-mode-card.active {
      background: rgba(0, 245, 255, 0.15);
      border-color: var(--neon-cyan);
      box-shadow: 0 0 10px rgba(0, 245, 255, 0.2);
    }
    
    .ge-cam-icon { font-size: 28px; }
    
    .ge-cam-name {
      color: #c0c0d0;
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 2px;
    }
    
    .ge-cam-desc {
      color: #7070a0;
      font-size: 11px;
    }
    
    /* Scripts Grid */
    .ge-scripts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .ge-script-card {
      padding: 16px;
      background: rgba(40, 40, 60, 0.3);
      border: 1px solid rgba(100, 100, 140, 0.2);
      border-radius: 6px;
      text-align: center;
      transition: all 0.15s;
    }
    
    .ge-script-card:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.4);
      transform: translateY(-2px);
    }
    
    .ge-script-icon { font-size: 32px; margin-bottom: 8px; }
    .ge-script-name { color: #c0c0d0; font-weight: 600; margin-bottom: 4px; }
    .ge-script-desc { color: #7070a0; font-size: 11px; margin-bottom: 10px; }
    
    .ge-btn-sm {
      padding: 6px 12px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 4px;
      color: #a78bfa;
      cursor: pointer;
      font-size: 11px;
    }
    
    .ge-btn-sm:hover { background: rgba(139, 92, 246, 0.35); }
    
    .ge-template-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .ge-template-btn {
      padding: 8px 16px;
      background: rgba(0, 245, 255, 0.1);
      border: 1px solid rgba(0, 245, 255, 0.3);
      border-radius: 4px;
      color: var(--neon-cyan);
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s;
    }
    
    .ge-template-btn:hover {
      background: rgba(0, 245, 255, 0.2);
      transform: translateY(-1px);
    }
    
    /* WASM Runner Styles */
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    
    .status-indicator.ready { background: var(--neon-green); }
    .status-indicator.loading { background: var(--neon-orange); }
    .status-indicator.error { background: var(--neon-pink); }
    
    .wasm-modules-list {
      margin-bottom: 20px;
    }
    
    .wasm-module-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .wasm-module-name {
      font-weight: 600;
    }
    
    .wasm-module-exports {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .wasm-result {
      margin-top: 16px;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    
    .wasm-result pre {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      color: var(--neon-green);
      margin-top: 8px;
    }
    
    .memory-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .memory-controls input {
      width: 80px;
      padding: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
    }
    
    .memory-controls button {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
    }
    
    .memory-dump {
      background: #0a0a12;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      color: var(--neon-cyan);
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    /* Settings App Styles */
    .settings-app {
      display: flex;
      height: 100%;
      background: var(--bg-dark);
    }
    
    .settings-sidebar {
      width: 180px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      font-size: 13px;
    }
    
    .settings-nav-item:hover {
      background: rgba(139, 92, 246, 0.1);
      color: var(--text);
    }
    
    .settings-nav-item.active {
      background: rgba(139, 92, 246, 0.2);
      color: var(--neon-purple);
    }
    
    .settings-nav-item svg {
      flex-shrink: 0;
    }
    
    .settings-content {
      flex: 1;
      padding: 20px 24px;
      overflow-y: auto;
    }
    
    .settings-section {
      display: none;
    }
    
    .settings-section.active {
      display: block;
      animation: fadeIn 0.25s ease;
    }
    
    .settings-header {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .settings-group {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .settings-label {
      font-size: 13px;
      color: var(--text);
    }
    
    .settings-control {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .settings-select {
      padding: 8px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 12px;
      min-width: 140px;
      cursor: pointer;
    }
    
    .settings-select:focus {
      outline: none;
      border-color: var(--neon-purple);
    }
    
    .settings-slider {
      width: 120px;
      height: 4px;
      -webkit-appearance: none;
      background: var(--border);
      border-radius: 2px;
      cursor: pointer;
    }
    
    .settings-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      background: var(--neon-purple);
      border-radius: 50%;
      cursor: pointer;
    }
    
    .slider-value {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 40px;
    }
    
    .settings-toggle {
      position: relative;
      width: 44px;
      height: 24px;
    }
    
    .settings-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: 0.2s;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background: var(--text-secondary);
      border-radius: 50%;
      transition: 0.2s;
    }
    
    .settings-toggle input:checked + .toggle-slider {
      background: rgba(139, 92, 246, 0.3);
      border-color: var(--neon-purple);
    }
    
    .settings-toggle input:checked + .toggle-slider:before {
      transform: translateX(20px);
      background: var(--neon-purple);
    }
    
    .toggle-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .color-picker {
      display: flex;
      gap: 8px;
    }
    
    .color-option {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .color-option:hover {
      transform: scale(1.1);
    }
    
    .color-option.active {
      border-color: white;
      box-shadow: 0 0 10px currentColor;
    }
    
    .settings-btn {
      padding: 8px 16px;
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .settings-btn:hover {
      background: rgba(139, 92, 246, 0.25);
      border-color: var(--neon-purple);
    }
    
    .cache-size {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .settings-info-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .storage-bar {
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .storage-used {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-purple), var(--neon-cyan));
      border-radius: 4px;
    }
    
    .storage-stats {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .storage-free {
      color: var(--neon-green);
    }
    
    .about-logo {
      text-align: center;
      margin-bottom: 16px;
    }
    
    .about-logo img {
      width: 80px;
      height: 80px;
      border-radius: 16px;
    }
    
    .about-info {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .about-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .about-version {
      font-size: 13px;
      color: var(--neon-purple);
      margin-bottom: 8px;
    }
    
    .about-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .about-stats {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 20px;
    }
    
    .about-stat {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 12px;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
    }
    
    .about-stat:last-child {
      border-bottom: none;
    }
    
    .about-stat span:first-child {
      color: var(--text-secondary);
    }
    
    .about-stat span:last-child {
      color: var(--text);
    }
    
    .about-links {
      display: flex;
      justify-content: center;
      gap: 16px;
    }
    
    .about-link {
      color: var(--neon-cyan);
      font-size: 12px;
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .about-link:hover {
      color: var(--neon-pink);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* File Drop Overlay */
    .file-drop-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(139, 92, 246, 0.15);
      border: 3px dashed var(--neon-purple);
      z-index: 99998;
      display: none;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    
    .file-drop-overlay.active {
      display: flex;
    }
    
    .file-drop-content {
      background: rgba(20, 15, 35, 0.95);
      border: 2px solid var(--neon-purple);
      border-radius: 16px;
      padding: 40px 60px;
      text-align: center;
      box-shadow: 0 0 40px rgba(139, 92, 246, 0.4);
    }
    
    .file-drop-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-cyan));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .file-drop-icon img {
      width: 40px;
      height: 40px;
    }
    
    .file-drop-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      color: var(--text);
      margin-bottom: 8px;
    }
    
    .file-drop-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    /* Activity Box */
    .activity-box {
      position: fixed;
      bottom: 60px;
      right: 20px;
      width: 360px;
      max-height: 400px;
      background: rgba(20, 15, 35, 0.95);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 9999;
      display: none;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .activity-box.visible {
      display: flex;
      animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .activity-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0, 0, 0, 0.2);
    }
    
    .activity-header-icon {
      width: 24px;
      height: 24px;
    }
    
    .activity-header-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      color: var(--text);
      flex: 1;
    }
    
    .activity-header-count {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 10px;
      background: rgba(139, 92, 246, 0.2);
      color: var(--neon-purple);
    }
    
    .activity-close {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .activity-close:hover {
      background: rgba(255, 0, 170, 0.2);
      color: var(--neon-pink);
    }
    
    .activity-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      max-height: 320px;
    }
    
    .activity-item {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 6px;
      background: rgba(0, 0, 0, 0.2);
      border-left: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .activity-item.loading {
      border-left-color: var(--neon-cyan);
    }
    
    .activity-item.success {
      border-left-color: var(--neon-green);
    }
    
    .activity-item.error {
      border-left-color: var(--neon-pink);
    }
    
    .activity-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    
    .activity-item-icon {
      width: 20px;
      height: 20px;
    }
    
    .activity-item-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .activity-item-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .activity-item-status.loading {
      background: rgba(0, 245, 255, 0.15);
      color: var(--neon-cyan);
    }
    
    .activity-item-status.success {
      background: rgba(34, 197, 94, 0.15);
      color: var(--neon-green);
    }
    
    .activity-item-status.error {
      background: rgba(255, 0, 170, 0.15);
      color: var(--neon-pink);
    }
    
    .activity-item-details {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .activity-item-progress {
      flex: 1;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .activity-item-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-cyan), var(--neon-purple));
      border-radius: 2px;
      transition: width 0.3s ease;
      animation: progressPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes progressPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .activity-item-error {
      margin-top: 8px;
      padding: 8px;
      background: rgba(255, 0, 170, 0.1);
      border-radius: 6px;
      font-size: 10px;
      color: var(--neon-pink);
      font-family: 'JetBrains Mono', monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    
    .activity-empty {
      padding: 30px;
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .activity-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 245, 255, 0.2);
      border-top-color: var(--neon-cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Static debug element to verify page loads -->
  <div id="static-debug" data-testid="static-debug" style="position:fixed;top:50px;left:5px;background:#ff0;color:#000;padding:5px;z-index:99999;font-size:12px;">Page Loaded</div>
  
  <!-- File Drop Overlay -->
  <div id="file-drop-overlay" class="file-drop-overlay" data-testid="file-drop-overlay">
    <div class="file-drop-content">
      <div class="file-drop-icon">
        <img src="/grudgeos/assets/icons/generated/cloud.png" alt="Cloud">
      </div>
      <div class="file-drop-title">Drop to Upload</div>
      <div class="file-drop-subtitle">Files will be saved to Cloud Storage</div>
    </div>
  </div>
  
  <!-- Activity Box -->
  <div id="activity-box" class="activity-box" data-testid="activity-box">
    <div class="activity-header">
      <img src="/grudgeos/assets/icons/generated/cloud.png" alt="Activity" class="activity-header-icon">
      <span class="activity-header-title">Activity</span>
      <span class="activity-header-count" id="activity-count">0</span>
      <button class="activity-close" onclick="closeActivityBox()" data-testid="button-close-activity">X</button>
    </div>
    <div class="activity-list" id="activity-list">
      <div class="activity-empty">No recent activity</div>
    </div>
  </div>
  
  <div id="desktop-shell" data-testid="desktop-shell">
    <div id="desktop-viewport" data-testid="desktop-viewport">
      <div id="desktop" data-testid="desktop">
        <!-- Static fallback icon for debugging - will be replaced by JS -->
        <div class="desktop-icon" data-app="debug-static" data-testid="icon-debug-static" style="left: 20px; top: 20px; display: none;">
          <div class="desktop-icon-img"><img src="/grudgeos/assets/icons/generated/ai-studio.png" alt="debug" style="width:48px;height:48px;border-radius:6px;"></div>
          <div class="desktop-icon-label">Debug Icon</div>
        </div>
      </div>
      <div id="selection-box" data-testid="selection-box"></div>
      <div id="snap-indicator"></div>
      <div id="windows-container"></div>
    </div>
    
    <div id="taskbar" data-testid="taskbar">
      <div id="launcher-btn" data-testid="button-launcher"><img src="/grudgeos/assets/icons/cloudpilot-logo.png" alt="CloudPilot"></div>
      <div id="running-apps"></div>
      <div id="system-tray">
        <div class="tray-icon" title="AI Operations" id="tray-brain" data-testid="tray-brain"><img src="/grudgeos/assets/icons/ai-brain.png" class="tray-img" alt="AI"></div>
        <div class="tray-icon" title="CloudPilot Chat" id="tray-robot" data-testid="tray-robot"><img src="/grudgeos/assets/icons/generated/ai-assistant.png" alt="AI" style="width:20px;height:20px;"></div>
        <div class="tray-icon" title="Activity" id="tray-activity" data-testid="tray-activity" onclick="toggleActivityBox()"><img src="/grudgeos/assets/icons/generated/cloud.png" alt="Activity" style="width:20px;height:20px;"></div>
        <div class="tray-icon" title="System Audio" id="tray-audio" data-testid="tray-audio"><img src="/grudgeos/assets/icons/generated/audio-packages.png" alt="AU" style="width:20px;height:20px;"></div>
        <div class="tray-icon" title="Network Status" id="tray-satellite" data-testid="tray-satellite"><img src="/grudgeos/assets/icons/generated/network.png" alt="NT" style="width:20px;height:20px;"></div>
        <div id="clock"></div>
      </div>
    </div>
  </div>
  
  <div id="context-menu"></div>
  
  <div id="launcher-menu">
    <div class="launcher-header">
      <div class="launcher-logo">G</div>
      <div class="launcher-search">
        <input type="text" placeholder="Search apps & channels..." id="launcher-search-input" data-testid="input-launcher-search">
      </div>
    </div>
    <div class="launcher-sections">
      <div class="launcher-section">
        <div class="launcher-section-header" data-section="apps" data-testid="section-apps">
          <img src="/grudgeos/assets/icons/generated/category-apps.png" alt="AP" class="section-icon-img" style="width:20px;height:20px;border-radius:4px;">
          <span class="section-title">Applications</span>
          <span class="section-arrow"></span>
        </div>
        <div class="launcher-section-content open" id="apps-section">
          <div class="launcher-grid" id="launcher-grid"></div>
        </div>
      </div>
      <div class="launcher-section">
        <div class="launcher-section-header" data-section="channels" data-testid="section-channels">
          <img src="/grudgeos/assets/icons/generated/category-channels.png" alt="CH" class="section-icon-img" style="width:20px;height:20px;border-radius:4px;">
          <span class="section-title">Grudge Channels</span>
          <span class="section-arrow"></span>
        </div>
        <div class="launcher-section-content open" id="channels-section">
          <div class="channel-category" data-testid="category-general">
            <div class="category-header" data-category="general">
              <img src="/grudgeos/assets/icons/generated/category-general.png" alt="GN" class="category-icon-img" style="width:16px;height:16px;border-radius:3px;">
              <span class="category-name">General</span>
              <span class="category-arrow"></span>
            </div>
            <div class="category-channels open">
              <div class="channel-quick-item" data-channel="general-chat" data-type="text" data-testid="channel-general-chat">
                <img src="/grudgeos/assets/icons/generated/channel-text.png" alt="TX" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">General Chat</span>
              </div>
              <div class="channel-quick-item" data-channel="voice-lounge" data-type="voice" data-testid="channel-voice-lounge">
                <img src="/grudgeos/assets/icons/generated/channel-voice.png" alt="VC" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Voice Lounge</span>
                <span class="channel-live"></span>
              </div>
              <div class="channel-quick-item" data-channel="video-room" data-type="video" data-testid="channel-video-room">
                <img src="/grudgeos/assets/icons/generated/channel-video.png" alt="VD" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Video Room</span>
              </div>
            </div>
          </div>
          <div class="channel-category" data-testid="category-development">
            <div class="category-header" data-category="development">
              <img src="/grudgeos/assets/icons/generated/category-dev.png" alt="DV" style="width:16px;height:16px;border-radius:3px;">
              <span class="category-name">Development</span>
              <span class="category-arrow"></span>
            </div>
            <div class="category-channels">
              <div class="channel-quick-item" data-channel="code-review" data-type="text" data-testid="channel-code-review">
                <img src="/grudgeos/assets/icons/generated/channel-text.png" alt="TX" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Code Review</span>
              </div>
              <div class="channel-quick-item" data-channel="pair-programming" data-type="video" data-testid="channel-pair-programming">
                <img src="/grudgeos/assets/icons/generated/channel-video.png" alt="VD" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Pair Programming</span>
              </div>
              <div class="channel-quick-item" data-channel="live-coding" data-type="stream" data-testid="channel-live-coding">
                <img src="/grudgeos/assets/icons/generated/channel-stream.png" alt="ST" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Live Coding</span>
                <span class="channel-badge live">LIVE</span>
              </div>
            </div>
          </div>
          <div class="channel-category" data-testid="category-ai">
            <div class="category-header" data-category="ai">
              <img src="/grudgeos/assets/icons/generated/category-ai.png" alt="AI" style="width:16px;height:16px;border-radius:3px;">
              <span class="category-name">AI Assistants</span>
              <span class="category-arrow"></span>
            </div>
            <div class="category-channels">
              <div class="channel-quick-item" data-channel="ai-chat" data-type="text" data-testid="channel-ai-chat">
                <img src="/grudgeos/assets/icons/generated/ai-assistant.png" alt="AI" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">AI Chat</span>
                <span class="channel-badge ai">AI</span>
              </div>
              <div class="channel-quick-item" data-channel="agent-collab" data-type="text" data-testid="channel-agent-collab">
                <img src="/grudgeos/assets/icons/generated/agent-collab.png" alt="AC" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Agent Collaboration</span>
              </div>
            </div>
          </div>
          <div class="channel-category" data-testid="category-streaming">
            <div class="category-header" data-category="streaming">
              <img src="/grudgeos/assets/icons/generated/category-streaming.png" alt="SM" style="width:16px;height:16px;border-radius:3px;">
              <span class="category-name">Streaming</span>
              <span class="category-arrow"></span>
            </div>
            <div class="category-channels">
              <div class="channel-quick-item" data-channel="watch-party" data-type="stream" data-testid="channel-watch-party">
                <img src="/grudgeos/assets/icons/generated/channel-stream.png" alt="ST" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Watch Party</span>
              </div>
              <div class="channel-quick-item" data-channel="screen-share" data-type="stream" data-testid="channel-screen-share">
                <img src="/grudgeos/assets/icons/generated/screen-share.png" alt="SS" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Screen Share</span>
              </div>
              <div class="channel-quick-item" data-channel="camera-chat" data-type="video" data-testid="channel-camera-chat">
                <img src="/grudgeos/assets/icons/generated/camera.png" alt="CC" style="width:16px;height:16px;border-radius:3px;">
                <span class="channel-name">Camera Chat</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="launcher-footer">
      <div class="user-status">
        <div class="user-avatar" id="launcher-user-avatar">G</div>
        <div class="user-info">
          <span class="user-name" id="launcher-user-name">Guest</span>
          <span class="user-status-indicator" id="launcher-user-status">Offline</span>
        </div>
      </div>
      <div class="quick-actions">
        <button class="quick-action-btn" id="btn-login" title="Sign In to Puter" data-testid="btn-login" style="display:none;"><img src="/grudgeos/assets/icons/generated/sign-in.png" alt="Login" style="width:20px;height:20px;"></button>
        <button class="quick-action-btn" title="Settings" data-testid="btn-settings" onclick="openApp('settings')"><img src="/grudgeos/assets/icons/generated/settings.png" alt="S" style="width:20px;height:20px;"></button>
        <button class="quick-action-btn" id="btn-signout" title="Sign Out" data-testid="btn-signout" style="display:none;"><img src="/grudgeos/assets/icons/generated/sign-out.png" alt="X" style="width:20px;height:20px;"></button>
      </div>
    </div>
  </div>
  
  <div id="ai-console">
    <div class="console-header">
      <div class="console-title"><span><img src="/grudgeos/assets/icons/ai-brain.png" class="console-icon-img" alt="AI"></span> AI Console</div>
      <div class="canvas-close" onclick="toggleConsole()"></div>
    </div>
    <div class="console-tabs">
      <div class="console-tab active" data-tab="logs">Logs</div>
      <div class="console-tab" data-tab="canvas">Canvas</div>
      <div class="console-tab" data-tab="definitions">Definitions</div>
    </div>
    <div class="console-content" id="console-logs">
    </div>
  </div>
  
  <div id="ai-canvas">
    <div class="canvas-header">
      <div class="canvas-title"><img src="/grudgeos/assets/icons/generated/canvas.png" alt="C" style="width:20px;height:20px;border-radius:4px;"> AI Canvas</div>
      <div class="canvas-tabs">
        <div class="canvas-tab active" data-canvas-tab="agents" onclick="switchCanvasTab('agents')" data-testid="canvas-tab-agents">
          <img src="/grudgeos/assets/icons/generated/agent-swarm.png" alt="A" style="width:14px;height:14px;"> Agents
        </div>
        <div class="canvas-tab" data-canvas-tab="scripts" onclick="switchCanvasTab('scripts')" data-testid="canvas-tab-scripts">
          <img src="/grudgeos/assets/icons/generated/terminal.png" alt="S" style="width:14px;height:14px;"> Scripts
        </div>
      </div>
      <div class="canvas-close" onclick="toggleCanvas()" data-testid="button-close-canvas"><img src="/grudgeos/assets/icons/generated/close.png" alt="X" style="width:14px;height:14px;"></div>
    </div>
    <div class="canvas-body" id="canvas-agents-view">
      <div class="canvas-agents-sidebar">
        <div class="canvas-scripts-header">
          <img src="/grudgeos/assets/icons/generated/agent-swarm.png" alt="A" style="width:14px;height:14px;">
          Active Agents
        </div>
        <div class="canvas-agents-list" id="canvas-agents-list" data-testid="canvas-agents-list">
        </div>
      </div>
      <div class="canvas-main">
        <div class="canvas-agent-info" id="canvas-agent-info">
          <div class="canvas-agent-header" id="canvas-agent-header">
            <img src="/grudgeos/assets/icons/generated/ai-studio.png" alt="AI" style="width:32px;height:32px;border-radius:8px;">
            <div class="canvas-agent-name">Select an agent</div>
          </div>
          <div class="canvas-agent-work" id="canvas-agent-work">
            <div class="canvas-empty">
              <div class="canvas-empty-icon"><img src="/grudgeos/assets/icons/generated/agent-swarm.png" alt="A" style="width:48px;height:48px;"></div>
              <div style="font-size:14px;margin-bottom:8px;">AI Agent Canvas</div>
              <div style="font-size:12px;color:var(--text-muted);max-width:300px;">
                Agents will display their work, analysis, and information here. Select an agent to see their current activity.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="canvas-body" id="canvas-scripts-view" style="display:none;">
      <div class="canvas-scripts">
        <div class="canvas-scripts-header">
          <img src="/grudgeos/assets/icons/generated/terminal.png" alt="S" style="width:14px;height:14px;">
          Scripts
        </div>
        <div class="canvas-scripts-list" id="canvas-scripts-list" data-testid="canvas-scripts-list">
        </div>
      </div>
      <div class="canvas-main">
        <div class="canvas-toolbar">
          <button class="canvas-toolbar-btn primary" onclick="runCanvasScript()" data-testid="button-run-script">
            <img src="/grudgeos/assets/icons/generated/run.png" alt="R" style="width:12px;height:12px;"> Run
          </button>
          <button class="canvas-toolbar-btn" onclick="clearCanvasOutput()" data-testid="button-clear-output">
            <img src="/grudgeos/assets/icons/generated/clear.png" alt="C" style="width:12px;height:12px;"> Clear Output
          </button>
          <div style="flex:1;"></div>
          <button class="canvas-toolbar-btn" onclick="newCanvasScript()" data-testid="button-new-script">
            <img src="/grudgeos/assets/icons/generated/add.png" alt="+" style="width:12px;height:12px;"> New Script
          </button>
        </div>
        <div class="canvas-content">
          <div class="canvas-code">
            <div class="canvas-code-header">
              <img src="/grudgeos/assets/icons/generated/code.png" alt="C" style="width:12px;height:12px;">
              <span id="canvas-code-title">Code</span>
            </div>
            <div class="canvas-code-area" id="canvas-code-area" data-testid="canvas-code-area">
              <pre id="canvas-code-display"></pre>
            </div>
          </div>
          <div class="canvas-output">
            <div class="canvas-output-header">
              <img src="/grudgeos/assets/icons/generated/output.png" alt="O" style="width:12px;height:12px;">
              Output
            </div>
            <div class="canvas-output-area" id="canvas-output-area" data-testid="canvas-output-area">
              <div class="canvas-empty">
                <div class="canvas-empty-icon"><img src="/grudgeos/assets/icons/generated/output.png" alt="O" style="width:32px;height:32px;"></div>
                <div>Run a script to see results here</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="console-toggle" id="consoleToggle" title="Toggle AI Console" data-testid="button-toggle-console"><img src="/grudgeos/assets/icons/ai-brain.png" class="toggle-icon-img" alt="AI"></div>
  
  <div id="notification-container"></div>

  <script>
    const ICON_BASE = '/grudgeos/assets/icons/generated/';
    
    function makeIconImg(iconName, size = 32) {
      return `<img src="${ICON_BASE}${iconName}.png" alt="${iconName}" class="app-icon-img" style="width:${size}px;height:${size}px;border-radius:6px;">`;
    }
    
    const apps = {
      aivm: {
        id: 'aivm',
        name: 'AI VM',
        iconPath: 'ai-studio',
        color: 'linear-gradient(135deg, #8b5cf6, #00f5ff)',
        width: 1000,
        height: 700,
        content: 'aivm'
      },
      grudchat: {
        id: 'grudchat',
        name: 'GrudChat',
        iconPath: 'grudge-chat',
        color: 'linear-gradient(135deg, #8b5cf6, #00f5ff)',
        width: 900,
        height: 600,
        content: 'grudchat'
      },
      agentsquad: {
        id: 'agentsquad',
        name: 'Agent Squad',
        iconPath: 'agent-swarm',
        color: 'linear-gradient(135deg, #ff00aa, #8b5cf6)',
        width: 1000,
        height: 700,
        content: 'agentsquad'
      },
      grudgecloud: {
        id: 'grudgecloud',
        name: 'GrudgeCloud',
        iconPath: 'deploy',
        color: 'linear-gradient(135deg, #00f5ff, #3b82f6)',
        width: 700,
        height: 500,
        content: 'grudgecloud'
      },
      aistudio: {
        id: 'aistudio',
        name: 'AI Studio',
        iconPath: 'ai-studio',
        color: 'linear-gradient(135deg, #8b5cf6, #ff00aa)',
        width: 900,
        height: 600,
        content: 'aistudio'
      },
      agentswarm: {
        id: 'agentswarm',
        name: 'Agent Swarm',
        iconPath: 'agent-swarm',
        color: 'linear-gradient(135deg, #ff00aa, #8b5cf6)',
        width: 1000,
        height: 650,
        content: 'agentswarm'
      },
      observer: {
        id: 'observer',
        name: 'Observer',
        iconPath: 'observer',
        color: 'linear-gradient(135deg, #00ff88, #00f5ff)',
        width: 1200,
        height: 700,
        content: 'observer'
      },
      audiopackages: {
        id: 'audiopackages',
        name: 'Audio Packages',
        iconPath: 'audio-packages',
        color: 'linear-gradient(135deg, #ff00aa, #ff6b35)',
        width: 500,
        height: 450,
        content: 'audiopackages'
      },
      gameeditor: {
        id: 'gameeditor',
        name: 'Game Editor',
        iconPath: 'games-launcher',
        color: 'linear-gradient(135deg, #ff6b35, #00ff88)',
        width: 1100,
        height: 700,
        content: 'gameeditor'
      },
      aisystem: {
        id: 'aisystem',
        name: 'AI System',
        iconPath: 'system-overview',
        color: 'linear-gradient(135deg, #00ff88, #00f5ff)',
        width: 550,
        height: 500,
        content: 'aisystem'
      },
      terminal: {
        id: 'terminal',
        name: 'Terminal',
        iconPath: 'terminal',
        color: 'linear-gradient(135deg, #1a1a2e, #00ff88)',
        width: 600,
        height: 400,
        content: 'terminal'
      },
      settings: {
        id: 'settings',
        name: 'Settings',
        iconPath: 'settings',
        color: 'linear-gradient(135deg, #505070, #8b5cf6)',
        width: 680,
        height: 520,
        content: 'settings'
      },
      agentmanager: {
        id: 'agentmanager',
        name: 'Agent Manager',
        iconPath: 'agent-manager',
        color: 'linear-gradient(135deg, #00f5ff, #8b5cf6)',
        width: 720,
        height: 600,
        content: 'agentmanager'
      },
      taskmanager: {
        id: 'taskmanager',
        name: 'Task Manager',
        iconPath: 'task-manager',
        color: 'linear-gradient(135deg, #00ff88, #00f5ff)',
        width: 700,
        height: 550,
        content: 'taskmanager'
      },
      systemmonitor: {
        id: 'systemmonitor',
        name: 'System Monitor',
        iconPath: 'system-monitor',
        color: 'linear-gradient(135deg, #8b5cf6, #00f5ff)',
        width: 750,
        height: 600,
        content: 'systemmonitor'
      },
      networktools: {
        id: 'networktools',
        name: 'Network Tools',
        iconPath: 'network-tools',
        color: 'linear-gradient(135deg, #ff6b35, #00f5ff)',
        width: 800,
        height: 600,
        content: 'networktools'
      },
      pods: {
        id: 'pods',
        name: 'Compute Pods',
        iconPath: 'compute-pods',
        color: 'linear-gradient(135deg, #00ff88, #3b82f6)',
        width: 900,
        height: 650,
        content: 'pods'
      },
      snapshots: {
        id: 'snapshots',
        name: 'Snapshots',
        iconPath: 'storage',
        color: 'linear-gradient(135deg, #a855f7, #8b5cf6)',
        width: 700,
        height: 550,
        content: 'snapshots'
      },
      studio3d: {
        id: 'studio3d',
        name: '3D Studio',
        iconPath: 'creating',
        color: 'linear-gradient(135deg, #ff00aa, #00f5ff)',
        width: 1000,
        height: 700,
        content: 'studio3d'
      },
      wasmrunner: {
        id: 'wasmrunner',
        name: 'WASM Runner',
        iconPath: 'wasm-runner',
        color: 'linear-gradient(135deg, #ff6b35, #8b5cf6)',
        width: 800,
        height: 600,
        content: 'wasmrunner'
      },
      zerotier: {
        id: 'zerotier',
        name: 'ZeroTier VPN',
        iconPath: 'zerotier',
        color: 'linear-gradient(135deg, #ffb900, #00f5ff)',
        width: 850,
        height: 650,
        content: 'zerotier'
      }
    };
    
    let windows = {};
    let windowCounter = 0;
    let focusedWindowId = null;
    let zIndexCounter = 100;
    let launcherOpen = false;
    
    // Grid snap system for accurate drag-drop and sizing
    const GRID = {
      size: 20,           // Grid cell size in pixels
      iconCellW: 100,     // Desktop icon cell width
      iconCellH: 110,     // Desktop icon cell height
      iconMargin: 20,     // Desktop icon margin offset
      snap: (val, cellSize) => Math.round(val / cellSize) * cellSize,
      snapPos: (x, y) => ({ x: GRID.snap(x, GRID.size), y: GRID.snap(y, GRID.size) }),
      snapSize: (w, h) => ({ w: Math.max(400, GRID.snap(w, GRID.size)), h: Math.max(300, GRID.snap(h, GRID.size)) }),
      // Snap icon positions accounting for 20px margin offset
      snapIconPos: (x, y) => ({ 
        x: GRID.iconMargin + GRID.snap(x - GRID.iconMargin, GRID.iconCellW), 
        y: GRID.iconMargin + GRID.snap(y - GRID.iconMargin, GRID.iconCellH) 
      })
    };
    
    async function init() {
      console.log('[GrudgeOS] Init starting...');
      try {
        await loadDesktopSettings();
        console.log('[GrudgeOS] Desktop settings loaded');
        await loadIconPositions();
        console.log('[GrudgeOS] Icon positions loaded');
        await loadGeneratedAssets();
        console.log('[GrudgeOS] Generated assets loaded');
        renderDesktopIcons();
        console.log('[GrudgeOS] Desktop icons rendered');
        renderLauncherGrid();
        console.log('[GrudgeOS] Launcher grid rendered');
        updateClock();
        setInterval(updateClock, 1000);
        setupEventListeners();
        setupFileDrop();
        console.log('[GrudgeOS] Init complete');
      } catch (e) {
        console.error('[GrudgeOS] Init error:', e);
      }
    }
    
    // File drag-drop to cloud storage
    function setupFileDrop() {
      const overlay = document.getElementById('file-drop-overlay');
      let dragCounter = 0;
      
      document.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter++;
        if (e.dataTransfer.types.includes('Files')) {
          overlay.classList.add('active');
        }
      });
      
      document.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter--;
        if (dragCounter <= 0) {
          dragCounter = 0;
          overlay.classList.remove('active');
        }
      });
      
      document.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
      
      document.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        dragCounter = 0;
        overlay.classList.remove('active');
        
        const files = e.dataTransfer.files;
        if (files.length === 0) return;
        
        for (const file of files) {
          await uploadFileToCloud(file);
        }
      });
      
      console.log('[GrudgeOS] File drop handlers initialized');
    }
    
    async function uploadFileToCloud(file) {
      const fileName = file.name;
      const fileSize = file.size;
      const fileType = file.type || 'application/octet-stream';
      const fileCategory = getFileCategory(fileType);
      
      // Create activity item with unique ID
      const activityId = `upload_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
      addActivityItem(activityId, fileName, fileCategory, fileSize);
      
      logToConsole('cloud', `Uploading: ${fileName} (${formatFileSize(fileSize)})`);
      
      try {
        // Read file content
        const content = await readFileAsBase64(file);
        
        // Ensure GrudgeCloud is initialized before uploading
        if (window.GrudgeCloud && !window.GrudgeCloud.initialized) {
          logToConsole('info', 'Waiting for Cloud Storage to initialize...');
          await window.GrudgeCloud.init();
        }
        
        // Try to save to GrudgeCloud
        if (window.GrudgeCloud && window.GrudgeCloud.initialized) {
          const cloudFile = await window.GrudgeCloud.createFile({
            name: fileName,
            type: fileCategory,
            mimeType: fileType,
            size: fileSize,
            path: '/uploads',
            content: content,
            metadata: {
              uploadedAt: new Date().toISOString(),
              originalName: fileName
            }
          });
          
          updateActivityItem(activityId, 'success');
          logToConsole('success', `File saved: ${fileName} (ID: ${cloudFile.id})`);
          
          // Trigger callback if set
          if (window.GrudgeCloud.callbacks.onFileChange) {
            window.GrudgeCloud.callbacks.onFileChange({ action: 'upload', file: cloudFile });
          }
          
          return cloudFile;
        } else {
          // Fallback: save to localStorage when cloud is unavailable
          const localFiles = JSON.parse(localStorage.getItem('grudgeos_files') || '[]');
          const localFile = {
            id: `file_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            name: fileName,
            type: fileCategory,
            mimeType: fileType,
            size: fileSize,
            path: '/uploads',
            content: content,
            createdAt: new Date().toISOString(),
            pendingSync: true
          };
          localFiles.push(localFile);
          localStorage.setItem('grudgeos_files', JSON.stringify(localFiles));
          
          updateActivityItem(activityId, 'success');
          logToConsole('warning', `File saved locally (pending cloud sync): ${fileName}`);
          
          return localFile;
        }
      } catch (error) {
        console.error('[GrudgeOS] File upload error:', error);
        updateActivityItem(activityId, 'error', error.message || 'Unknown error occurred');
        logToConsole('error', `Upload failed: ${fileName} - ${error.message}`);
        return null;
      }
    }
    
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(reader.error);
        reader.readAsDataURL(file);
      });
    }
    
    function getFileCategory(mimeType) {
      if (mimeType.startsWith('image/')) return 'image';
      if (mimeType.startsWith('video/')) return 'video';
      if (mimeType.startsWith('audio/')) return 'audio';
      if (mimeType.startsWith('text/')) return 'text';
      if (mimeType.includes('javascript') || mimeType.includes('json')) return 'code';
      if (mimeType.includes('pdf')) return 'document';
      if (mimeType.includes('zip') || mimeType.includes('tar') || mimeType.includes('rar')) return 'archive';
      return 'file';
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Activity Box Management
    const activityItems = [];
    let activityAutoCloseTimer = null;
    
    function showActivityBox() {
      const box = document.getElementById('activity-box');
      box.classList.add('visible');
      clearActivityAutoClose();
    }
    
    function closeActivityBox() {
      const box = document.getElementById('activity-box');
      box.classList.remove('visible');
      clearActivityAutoClose();
    }
    
    function toggleActivityBox() {
      const box = document.getElementById('activity-box');
      if (box.classList.contains('visible')) {
        closeActivityBox();
      } else {
        showActivityBox();
      }
    }
    
    function clearActivityAutoClose() {
      if (activityAutoCloseTimer) {
        clearTimeout(activityAutoCloseTimer);
        activityAutoCloseTimer = null;
      }
    }
    
    function scheduleActivityAutoClose() {
      clearActivityAutoClose();
      const hasLoading = activityItems.some(item => item.status === 'loading');
      const hasErrors = activityItems.some(item => item.status === 'error');
      
      // Don't auto-close if there are loading items or errors
      if (!hasLoading && !hasErrors) {
        activityAutoCloseTimer = setTimeout(() => {
          closeActivityBox();
        }, 5000);
      }
    }
    
    function addActivityItem(id, name, type, size) {
      const item = {
        id,
        name,
        type,
        size,
        status: 'loading',
        error: null,
        timestamp: Date.now()
      };
      activityItems.unshift(item);
      if (activityItems.length > 20) activityItems.pop();
      renderActivityList();
      showActivityBox();
      return item;
    }
    
    function updateActivityItem(id, status, error = null) {
      const item = activityItems.find(i => i.id === id);
      if (item) {
        item.status = status;
        item.error = error;
        renderActivityList();
        scheduleActivityAutoClose();
      }
    }
    
    function getFileTypeIcon(type) {
      const iconMap = {
        'image': 'art-agent',
        'video': 'video',
        'audio': 'audio-packages',
        'text': 'code',
        'code': 'code',
        'document': 'document',
        'archive': 'archive',
        'file': 'file'
      };
      return iconMap[type] || 'file';
    }
    
    function renderActivityList() {
      const list = document.getElementById('activity-list');
      const countEl = document.getElementById('activity-count');
      
      if (activityItems.length === 0) {
        list.innerHTML = '<div class="activity-empty">No recent activity</div>';
        countEl.textContent = '0';
        return;
      }
      
      const loadingCount = activityItems.filter(i => i.status === 'loading').length;
      countEl.textContent = loadingCount > 0 ? loadingCount : activityItems.length;
      
      list.innerHTML = activityItems.map(item => `
        <div class="activity-item ${item.status}" data-activity-id="${item.id}">
          <div class="activity-item-header">
            ${item.status === 'loading' 
              ? '<div class="activity-spinner"></div>' 
              : `<img src="${ICON_BASE}${getFileTypeIcon(item.type)}.png" alt="${item.type}" class="activity-item-icon">`
            }
            <span class="activity-item-name">${escapeHtml(item.name)}</span>
            <span class="activity-item-status ${item.status}">${item.status === 'loading' ? 'Uploading' : item.status === 'success' ? 'Complete' : 'Failed'}</span>
          </div>
          <div class="activity-item-details">
            <span>${formatFileSize(item.size)}</span>
            ${item.status === 'loading' 
              ? '<div class="activity-item-progress"><div class="activity-item-progress-bar" style="width: 60%;"></div></div>' 
              : `<span>${formatTimeAgo(item.timestamp)}</span>`
            }
          </div>
          ${item.error ? `<div class="activity-item-error">${escapeHtml(item.error)}</div>` : ''}
        </div>
      `).join('');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ago`;
    }
    
    let iconPositions = {};
    let selectedIcons = new Set();
    let isSelecting = false;
    let selectionStart = { x: 0, y: 0 };
    let desktopEventsSetup = false;
    let desktopSettings = { iconBackground: 'gradient', snapToGrid: false };
    
    function organizeDesktopIcons() {
      const desktop = document.getElementById('desktop');
      const viewport = document.getElementById('desktop-viewport');
      const icons = desktop.querySelectorAll('.desktop-icon');
      const vpRect = viewport.getBoundingClientRect();
      
      // Calculate rows based on viewport height, fill columns left-to-right
      const maxRows = Math.max(1, Math.floor((vpRect.height - 40) / GRID.iconCellH)) || 3;
      const startX = 20;
      const startY = 20;
      
      icons.forEach((icon, index) => {
        // Fill by columns (left-to-right), each column fills top-to-bottom
        const row = index % maxRows;
        const col = Math.floor(index / maxRows);
        const newX = startX + col * GRID.iconCellW;
        const newY = startY + row * GRID.iconCellH;
        
        icon.style.transition = 'left 0.3s ease, top 0.3s ease';
        icon.style.left = newX + 'px';
        icon.style.top = newY + 'px';
        
        const appId = icon.dataset.app;
        iconPositions[appId] = { x: newX, y: newY };
        
        setTimeout(() => { icon.style.transition = ''; }, 300);
      });
      
      saveIconPositions();
    }
    
    function renderDesktopIcons() {
      const desktop = document.getElementById('desktop');
      const viewport = document.getElementById('desktop-viewport');
      const desktopApps = ['aivm', 'grudchat', 'agentsquad', 'pods', 'snapshots', 'studio3d', 'wasmrunner', 'grudgecloud', 'aistudio', 'agentswarm', 'observer', 'gameeditor', 'networktools'];
      
      console.log('[GrudgeOS] renderDesktopIcons: desktop element:', desktop);
      console.log('[GrudgeOS] renderDesktopIcons: viewport element:', viewport);
      
      if (!desktop || !viewport) {
        console.error('[GrudgeOS] Desktop or viewport element not found!');
        return;
      }
      
      // Apply icon background class
      viewport.className = `icon-bg-${desktopSettings.iconBackground}`;
      
      // Calculate rows based on viewport height, fill columns left-to-right
      const vpRect = viewport.getBoundingClientRect();
      console.log('[GrudgeOS] Viewport dimensions:', vpRect.width, 'x', vpRect.height);
      const maxRows = Math.max(1, Math.floor((vpRect.height - 40) / GRID.iconCellH)) || 3;
      
      desktopApps.forEach((id, index) => {
        if (!iconPositions[id]) {
          // Fill by columns (left-to-right), each column fills top-to-bottom
          const row = index % maxRows;
          const col = Math.floor(index / maxRows);
          iconPositions[id] = { x: 20 + col * GRID.iconCellW, y: 20 + row * GRID.iconCellH };
        }
      });
      
      // Clear existing content and use DOM methods instead of innerHTML
      desktop.innerHTML = '';
      
      desktopApps.forEach(id => {
        const app = apps[id];
        const pos = iconPositions[id];
        if (!app) {
          console.error('[GrudgeOS] App not found:', id);
          return;
        }
        
        const iconDiv = document.createElement('div');
        iconDiv.className = 'desktop-icon';
        iconDiv.dataset.app = id;
        iconDiv.dataset.testid = 'icon-' + id;
        iconDiv.style.cssText = 'left: ' + pos.x + 'px; top: ' + pos.y + 'px;';
        
        const imgDiv = document.createElement('div');
        imgDiv.className = 'desktop-icon-img';
        const img = document.createElement('img');
        img.src = ICON_BASE + app.iconPath + '.png';
        img.alt = app.iconPath;
        img.className = 'app-icon-img';
        img.style.cssText = 'width:48px;height:48px;border-radius:6px;';
        imgDiv.appendChild(img);
        
        const labelDiv = document.createElement('div');
        labelDiv.className = 'desktop-icon-label';
        labelDiv.textContent = app.name;
        
        iconDiv.appendChild(imgDiv);
        iconDiv.appendChild(labelDiv);
        desktop.appendChild(iconDiv);
      });
      
      const iconCount = desktop.querySelectorAll('.desktop-icon').length;
      console.log('[GrudgeOS] Icons created via DOM. Count:', iconCount);
      
      // Store state for debugging
      window._desktopDebug = {
        iconCount: iconCount,
        htmlLength: desktop.innerHTML.length,
        desktopId: desktop.id,
        timestamp: Date.now(),
        desktopElement: desktop
      };
      
      console.log('[GrudgeOS] Desktop debug state:', JSON.stringify({iconCount: iconCount, htmlLength: desktop.innerHTML.length}));
      
      // Add visible indicator
      let indicator = document.getElementById('icon-count-indicator');
      if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'icon-count-indicator';
        indicator.setAttribute('data-testid', 'icon-count-indicator');
        indicator.style.cssText = 'position: fixed; top: 5px; left: 5px; background: #00ff00; color: black; padding: 5px 10px; z-index: 99999; font-size: 14px; font-weight: bold; border-radius: 4px;';
        document.body.appendChild(indicator);
      }
      indicator.textContent = 'Icons: ' + iconCount;
      
      // Add MutationObserver to track if desktop is modified
      if (!window._desktopObserver) {
        window._desktopObserver = new MutationObserver((mutations) => {
          mutations.forEach(m => {
            if (m.removedNodes.length > 0) {
              console.warn('[GrudgeOS] Desktop nodes REMOVED:', m.removedNodes.length, 'nodes');
              console.trace('[GrudgeOS] Stack trace for removal');
            }
          });
        });
        window._desktopObserver.observe(desktop, { childList: true, subtree: true });
      }
      
      // Verify icons persist after a delay
      setTimeout(() => {
        const currentCount = document.getElementById('desktop')?.querySelectorAll('.desktop-icon').length || 0;
        console.log('[GrudgeOS] Icon verification after 1s: count =', currentCount);
        window._desktopDebug.verifiedCount = currentCount;
        const ind = document.getElementById('icon-count-indicator');
        if (ind) ind.textContent = 'Icons: ' + currentCount + ' (verified)';
      }, 1000);
      
      // Simple per-icon drag with pointer capture
      desktop.querySelectorAll('.desktop-icon').forEach(icon => {
        icon.addEventListener('dblclick', () => openApp(icon.dataset.app));
        setupIconDrag(icon);
      });
      
      if (!desktopEventsSetup) {
        setupDesktopSelection();
        desktopEventsSetup = true;
      }
    }
    
    function setupIconDrag(icon) {
      let offsetX = 0, offsetY = 0;
      let startX = 0, startY = 0;
      let isPointerDown = false;
      let isDragging = false;
      const DRAG_THRESHOLD = 5; // Pixels before drag starts
      
      icon.addEventListener('pointerdown', (e) => {
        if (e.button !== 0) return;
        e.preventDefault();
        icon.setPointerCapture(e.pointerId);
        
        // Store starting position - use icon's current CSS position
        startX = parseInt(icon.style.left) || 0;
        startY = parseInt(icon.style.top) || 0;
        
        // Calculate offset from click point to icon's top-left corner
        const desktop = document.getElementById('desktop');
        const desktopRect = desktop.getBoundingClientRect();
        offsetX = e.clientX - desktopRect.left - startX;
        offsetY = e.clientY - desktopRect.top - startY;
        
        isPointerDown = true;
        isDragging = false;
        
        // Handle selection
        const appId = icon.dataset.app;
        if (!e.ctrlKey && !e.metaKey) {
          selectedIcons.clear();
          document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
        }
        selectedIcons.add(appId);
        icon.classList.add('selected');
      });
      
      icon.addEventListener('pointermove', (e) => {
        if (!isPointerDown) return;
        
        const desktop = document.getElementById('desktop');
        const desktopRect = desktop.getBoundingClientRect();
        
        // Calculate new position
        let newX = e.clientX - desktopRect.left - offsetX;
        let newY = e.clientY - desktopRect.top - offsetY;
        
        // Check if we've moved enough to start dragging
        if (!isDragging) {
          const dx = Math.abs(newX - startX);
          const dy = Math.abs(newY - startY);
          if (dx < DRAG_THRESHOLD && dy < DRAG_THRESHOLD) return;
          isDragging = true;
          icon.classList.add('dragging');
        }
        
        // Clamp to desktop bounds
        newX = Math.max(0, Math.min(newX, desktopRect.width - 90));
        newY = Math.max(0, Math.min(newY, desktopRect.height - 100));
        
        icon.style.left = newX + 'px';
        icon.style.top = newY + 'px';
      });
      
      icon.addEventListener('pointerup', (e) => {
        if (!isPointerDown) return;
        icon.releasePointerCapture(e.pointerId);
        isPointerDown = false;
        icon.classList.remove('dragging');
        
        // Only save position if we actually dragged
        if (isDragging) {
          const appId = icon.dataset.app;
          let x = parseInt(icon.style.left);
          let y = parseInt(icon.style.top);
          
          // Optional snap to grid
          if (desktopSettings.snapToGrid) {
            x = Math.round(x / 100) * 100;
            y = Math.round(y / 110) * 110;
            x = Math.max(0, x);
            y = Math.max(0, y);
            icon.style.left = x + 'px';
            icon.style.top = y + 'px';
          }
          
          // Final clamp
          const desktop = document.getElementById('desktop');
          const desktopRect = desktop.getBoundingClientRect();
          x = Math.min(x, desktopRect.width - 90);
          y = Math.min(y, desktopRect.height - 100);
          
          icon.style.left = x + 'px';
          icon.style.top = y + 'px';
          iconPositions[appId] = { x, y };
          saveIconPositions();
        }
        
        isDragging = false;
      });
    }
    
    function setupDesktopSelection() {
      const viewport = document.getElementById('desktop-viewport');
      const selectionBox = document.getElementById('selection-box');
      
      viewport.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        if (e.target === viewport || e.target.id === 'desktop') {
          selectedIcons.clear();
          document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
          
          isSelecting = true;
          const rect = viewport.getBoundingClientRect();
          selectionStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
          selectionBox.style.left = selectionStart.x + 'px';
          selectionBox.style.top = selectionStart.y + 'px';
          selectionBox.style.width = '0px';
          selectionBox.style.height = '0px';
          selectionBox.style.display = 'block';
        }
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isSelecting) return;
        const viewport = document.getElementById('desktop-viewport');
        const selectionBox = document.getElementById('selection-box');
        const rect = viewport.getBoundingClientRect();
        
        const currentX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
        const currentY = Math.max(0, Math.min(e.clientY - rect.top, rect.height));
        
        const left = Math.min(selectionStart.x, currentX);
        const top = Math.min(selectionStart.y, currentY);
        const width = Math.abs(currentX - selectionStart.x);
        const height = Math.abs(currentY - selectionStart.y);
        
        selectionBox.style.left = left + 'px';
        selectionBox.style.top = top + 'px';
        selectionBox.style.width = width + 'px';
        selectionBox.style.height = height + 'px';
      });
      
      document.addEventListener('mouseup', () => {
        if (isSelecting) {
          isSelecting = false;
          const selectionBox = document.getElementById('selection-box');
          selectionBox.style.display = 'none';
        }
      });
    }
    
    const ICON_LAYOUT_VERSION = 3; // Increment to reset icon positions on layout change
    
    async function saveIconPositions() {
      const data = { version: ICON_LAYOUT_VERSION, positions: iconPositions };
      if (typeof puter !== 'undefined') {
        try {
          await puter.kv.set('grudgeos_icon_positions', JSON.stringify(data));
        } catch(e) {
          localStorage.setItem('grudgeos_icon_positions', JSON.stringify(data));
        }
      } else {
        localStorage.setItem('grudgeos_icon_positions', JSON.stringify(data));
      }
    }
    
    async function loadIconPositions() {
      let saved = null;
      if (typeof puter !== 'undefined' && puter.kv) {
        try {
          const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000));
          saved = await Promise.race([puter.kv.get('grudgeos_icon_positions'), timeoutPromise]);
        } catch(e) {
          saved = localStorage.getItem('grudgeos_icon_positions');
        }
      } else {
        saved = localStorage.getItem('grudgeos_icon_positions');
      }
      
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data.version === ICON_LAYOUT_VERSION && data.positions) {
            iconPositions = data.positions;
          } else {
            iconPositions = {};
          }
        } catch(e) {
          iconPositions = {};
        }
      }
    }
    
    function renderLauncherGrid() {
      const grid = document.getElementById('launcher-grid');
      grid.innerHTML = Object.values(apps).map(app => `
        <div class="launcher-app" data-app="${app.id}" data-testid="launcher-${app.id}">
          <div class="launcher-app-icon">${makeIconImg(app.iconPath, 40)}</div>
          <div class="launcher-app-name">${app.name}</div>
        </div>
      `).join('');
      
      grid.querySelectorAll('.launcher-app').forEach(item => {
        item.addEventListener('click', () => {
          openApp(item.dataset.app);
          toggleLauncher();
        });
      });
    }
    
    function openApp(appId) {
      const app = apps[appId];
      if (!app) return;
      
      const existing = Object.values(windows).find(w => w.appId === appId && !w.minimized);
      if (existing) {
        focusWindow(existing.id);
        return;
      }
      
      const winId = 'win_' + (++windowCounter);
      const offsetX = (windowCounter % 5) * 30;
      const offsetY = (windowCounter % 5) * 30;
      
      const windowData = {
        id: winId,
        appId: appId,
        title: app.name,
        iconPath: app.iconPath,
        color: app.color,
        x: 100 + offsetX,
        y: 50 + offsetY,
        width: app.width,
        height: app.height,
        minimized: false,
        maximized: false
      };
      
      windows[winId] = windowData;
      createWindowElement(windowData, app.content);
      updateTaskbar();
      focusWindow(winId);
    }
    
    function createWindowElement(win, contentType) {
      const container = document.getElementById('windows-container');
      const el = document.createElement('div');
      el.className = 'window';
      el.id = win.id;
      el.style.left = win.x + 'px';
      el.style.top = win.y + 'px';
      el.style.width = win.width + 'px';
      el.style.height = win.height + 'px';
      el.style.zIndex = ++zIndexCounter;
      
      el.innerHTML = `
        <div class="window-titlebar">
          <span class="window-icon">${makeIconImg(win.iconPath, 20)}</span>
          <span class="window-title">${win.title}</span>
          <div class="window-controls">
            <div class="window-btn minimize" data-testid="btn-minimize-${win.id}"></div>
            <div class="window-btn maximize" data-testid="btn-maximize-${win.id}"></div>
            <div class="window-btn close" data-testid="btn-close-${win.id}"></div>
          </div>
        </div>
        <div class="window-content">${getAppContent(contentType)}</div>
        <div class="resize-handle se"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle s"></div>
      `;
      
      container.appendChild(el);
      setupWindowEvents(el, win.id);
      
      // Initialize settings navigation if this is the settings app
      if (contentType === 'settings') {
        initSettingsNav(el);
      }
      
      // Initialize NetworkTools if this is the networktools app
      if (contentType === 'networktools') {
        const nettoolsApp = el.querySelector('#nettools-app');
        if (nettoolsApp) {
          window.setupNetworkToolsHandlers?.(nettoolsApp);
          // Also start stats monitor after a brief delay
          setTimeout(() => window.initNetworkTools?.(), 50);
        }
      }
    }
    
    function initSettingsNav(windowEl) {
      const navItems = windowEl.querySelectorAll('.settings-nav-item');
      const sections = windowEl.querySelectorAll('.settings-section');
      
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const sectionId = item.dataset.section;
          
          navItems.forEach(n => n.classList.remove('active'));
          item.classList.add('active');
          
          sections.forEach(s => {
            s.classList.remove('active');
            if (s.id === 'settings-' + sectionId) {
              s.classList.add('active');
            }
          });
        });
      });
      
      // Color picker handling
      const colorOptions = windowEl.querySelectorAll('.color-option');
      colorOptions.forEach(opt => {
        opt.addEventListener('click', () => {
          colorOptions.forEach(c => c.classList.remove('active'));
          opt.classList.add('active');
        });
      });
      
      // Slider value display
      const uiScale = windowEl.querySelector('#ui-scale');
      if (uiScale) {
        const valueSpan = uiScale.parentElement.querySelector('.slider-value');
        uiScale.addEventListener('input', () => {
          valueSpan.textContent = uiScale.value + '%';
        });
      }
      
      const aiTemp = windowEl.querySelector('#ai-temp');
      if (aiTemp) {
        const valueSpan = aiTemp.parentElement.querySelector('.slider-value');
        aiTemp.addEventListener('input', () => {
          valueSpan.textContent = (aiTemp.value / 100).toFixed(1);
        });
      }
      
      // Clear cache button
      const clearCache = windowEl.querySelector('#clear-cache');
      if (clearCache) {
        clearCache.addEventListener('click', () => {
          clearCache.textContent = 'Clearing...';
          setTimeout(() => {
            clearCache.textContent = 'Clear Cache';
            const sizeSpan = clearCache.parentElement.querySelector('.cache-size');
            if (sizeSpan) sizeSpan.textContent = '0 MB';
          }, 1000);
        });
      }
      
      // Desktop settings
      const iconBgSelect = windowEl.querySelector('#icon-bg-select');
      if (iconBgSelect) {
        iconBgSelect.value = desktopSettings.iconBackground;
        iconBgSelect.addEventListener('change', () => {
          desktopSettings.iconBackground = iconBgSelect.value;
          applyIconBackground();
          saveDesktopSettings();
        });
      }
      
      const snapGridToggle = windowEl.querySelector('#snap-grid-toggle');
      if (snapGridToggle) {
        snapGridToggle.checked = desktopSettings.snapToGrid;
        snapGridToggle.addEventListener('change', () => {
          desktopSettings.snapToGrid = snapGridToggle.checked;
          saveDesktopSettings();
        });
      }
      
      const resetIconsBtn = windowEl.querySelector('#reset-icons-btn');
      if (resetIconsBtn) {
        resetIconsBtn.addEventListener('click', () => {
          iconPositions = {};
          renderDesktopIcons();
          saveIconPositions();
        });
      }
    }
    
    function applyIconBackground() {
      const viewport = document.getElementById('desktop-viewport');
      viewport.className = `icon-bg-${desktopSettings.iconBackground}`;
    }
    
    async function saveDesktopSettings() {
      if (typeof puter !== 'undefined') {
        try {
          await puter.kv.set('grudgeos_desktop_settings', JSON.stringify(desktopSettings));
        } catch(e) {
          console.log('Could not save desktop settings:', e);
        }
      }
    }
    
    async function loadDesktopSettings() {
      if (typeof puter !== 'undefined' && puter.kv) {
        try {
          const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000));
          const saved = await Promise.race([puter.kv.get('grudgeos_desktop_settings'), timeoutPromise]);
          if (saved) {
            desktopSettings = { ...desktopSettings, ...JSON.parse(saved) };
          }
        } catch(e) {
          // Silently continue with defaults
        }
      }
    }
    
    function getAppContent(contentType) {
      switch(contentType) {
        case 'grudgecloud':
          return `<div id="grudgecloud-app" class="grudgecloud-wrapper" style="height: 100%;"></div>`;
        case 'agentsquad':
          return `
            <div id="agent-squad-app" data-testid="agent-squad-app" style="display:flex;height:100%;background:linear-gradient(180deg,#1a1a2e 0%,#16161d 100%);font-family:'Rajdhani',sans-serif;">
              <div style="width:220px;background:rgba(18,18,31,0.95);border-right:1px solid rgba(139,92,246,0.2);display:flex;flex-direction:column;">
                <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 12px;border-bottom:1px solid rgba(80,80,112,0.2);">
                  <span style="font-weight:700;color:#e8e8ff;font-size:14px;">Agent Squad</span>
                  <button style="padding:4px 10px;background:linear-gradient(135deg,#8b5cf6,#00f5ff);border:none;border-radius:4px;color:#fff;font-size:11px;font-weight:600;cursor:pointer;" data-testid="btn-new-squad">+ New</button>
                </div>
                <div id="squad-list" style="padding:8px;">
                  <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(139,92,246,0.15);border-radius:6px;border-left:3px solid #8b5cf6;cursor:pointer;">
                    <img src="/grudgeos/assets/icons/generated/agent-squad.png" alt="SQ" style="width:20px;height:20px;border-radius:4px;">
                    <div style="flex:1;">
                      <div style="color:#e8e8ff;font-weight:600;font-size:13px;">Code Ninjas</div>
                      <div style="color:#8b8b9b;font-size:11px;">4 agents</div>
                    </div>
                  </div>
                </div>
                <div id="squad-agents" style="flex:1;overflow-y:auto;padding:8px;">
                  <div style="color:#8b8b9b;font-size:11px;text-transform:uppercase;padding:8px 12px;letter-spacing:0.5px;">Active Agents</div>
                  <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;border-radius:4px;" data-agent="orchestrator">
                    <span style="width:8px;height:8px;background:#00ff88;border-radius:50%;box-shadow:0 0 6px #00ff88;"></span>
                    <img src="/grudgeos/assets/icons/generated/orchestrator.png" alt="O" style="width:20px;height:20px;border-radius:4px;">
                    <span style="color:#e8e8ff;font-size:13px;">Orchestrator</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;border-radius:4px;" data-agent="code-agent">
                    <span style="width:8px;height:8px;background:#00ff88;border-radius:50%;box-shadow:0 0 6px #00ff88;"></span>
                    <img src="/grudgeos/assets/icons/generated/code-agent.png" alt="CA" style="width:20px;height:20px;border-radius:4px;">
                    <span style="color:#e8e8ff;font-size:13px;">Code Agent</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;border-radius:4px;" data-agent="art-agent">
                    <span style="width:8px;height:8px;background:#f59e0b;border-radius:50%;"></span>
                    <img src="/grudgeos/assets/icons/generated/art-agent.png" alt="AA" style="width:20px;height:20px;border-radius:4px;">
                    <span style="color:#a0a0c0;font-size:13px;">Art Agent</span>
                  </div>
                  <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;border-radius:4px;" data-agent="analyst">
                    <span style="width:8px;height:8px;background:#f59e0b;border-radius:50%;"></span>
                    <img src="/grudgeos/assets/icons/generated/observer.png" alt="AG" style="width:20px;height:20px;border-radius:4px;">
                    <span style="color:#a0a0c0;font-size:13px;">Analyst</span>
                  </div>
                </div>
              </div>
              <div style="flex:1;display:flex;flex-direction:column;min-width:0;">
                <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(18,18,31,0.9);border-bottom:1px solid rgba(80,80,112,0.2);">
                  <div style="display:flex;gap:4px;">
                    <button style="padding:8px 14px;background:rgba(139,92,246,0.2);border:none;border-radius:4px;color:#00f5ff;font-size:12px;font-weight:600;cursor:pointer;" data-tab="terminals" data-testid="tab-terminals">Terminals</button>
                    <button style="padding:8px 14px;background:transparent;border:none;border-radius:4px;color:#8b8b9b;font-size:12px;cursor:pointer;" data-tab="rest" data-testid="tab-rest">REST Client</button>
                    <button style="padding:8px 14px;background:transparent;border:none;border-radius:4px;color:#8b8b9b;font-size:12px;cursor:pointer;" data-tab="tasks" data-testid="tab-tasks">Tasks</button>
                    <button style="padding:8px 14px;background:transparent;border:none;border-radius:4px;color:#8b8b9b;font-size:12px;cursor:pointer;" data-tab="comms" data-testid="tab-comms">Comms</button>
                  </div>
                  <div style="display:flex;gap:6px;">
                    <button style="padding:6px 12px;background:rgba(80,80,112,0.3);border:none;border-radius:4px;color:#e8e8ff;font-size:11px;cursor:pointer;" data-testid="btn-add-terminal">+ Terminal</button>
                    <button style="padding:6px 12px;background:linear-gradient(135deg,#00ff88,#00f5ff);border:none;border-radius:4px;color:#0a0a12;font-size:11px;font-weight:600;cursor:pointer;" data-testid="btn-run-all">Run All</button>
                  </div>
                </div>
                <div id="squad-panel" style="flex:1;padding:12px;overflow:auto;">
                  <div id="terminal-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:12px;">
                    <div style="background:rgba(10,10,18,0.9);border:1px solid rgba(80,80,112,0.3);border-radius:8px;overflow:hidden;" data-agent="orchestrator">
                      <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(139,92,246,0.1);border-bottom:1px solid rgba(80,80,112,0.2);">
                        <span style="display:flex;align-items:center;gap:6px;color:#e8e8ff;font-size:12px;font-weight:600;"><img src="/grudgeos/assets/icons/generated/orchestrator.png" alt="O" style="width:16px;height:16px;border-radius:3px;"> Orchestrator</span>
                        <div style="display:flex;gap:4px;">
                          <button style="padding:4px 8px;background:rgba(80,80,112,0.3);border:none;border-radius:3px;color:#8b8b9b;font-size:10px;cursor:pointer;">Clear</button>
                          <button style="padding:4px 8px;background:rgba(80,80,112,0.3);border:none;border-radius:3px;color:#8b8b9b;font-size:10px;cursor:pointer;"></button>
                        </div>
                      </div>
                      <div style="padding:12px;height:150px;overflow-y:auto;font-family:monospace;font-size:12px;color:#00ff88;line-height:1.6;">
                        <div style="color:#8b5cf6;">&gt; agent status</div>
                        <div>Agent orchestrator: Ready</div>
                        <div style="color:#8b5cf6;">&gt; task list</div>
                        <div>No pending tasks</div>
                        <div style="color:#8b5cf6;">&gt; _</div>
                      </div>
                      <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(0,0,0,0.3);border-top:1px solid rgba(80,80,112,0.2);">
                        <span style="color:#8b5cf6;font-family:monospace;">&gt;</span>
                        <input type="text" placeholder="Enter command..." style="flex:1;background:transparent;border:none;color:#e8e8ff;font-family:monospace;font-size:12px;outline:none;" data-testid="input-term-orchestrator">
                      </div>
                    </div>
                    <div style="background:rgba(10,10,18,0.9);border:1px solid rgba(80,80,112,0.3);border-radius:8px;overflow:hidden;" data-agent="code-agent">
                      <div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(0,255,136,0.1);border-bottom:1px solid rgba(80,80,112,0.2);">
                        <span style="display:flex;align-items:center;gap:6px;color:#e8e8ff;font-size:12px;font-weight:600;"><img src="/grudgeos/assets/icons/generated/code-agent.png" alt="CA" style="width:16px;height:16px;border-radius:3px;"> Code Agent</span>
                        <div style="display:flex;gap:4px;">
                          <button style="padding:4px 8px;background:rgba(80,80,112,0.3);border:none;border-radius:3px;color:#8b8b9b;font-size:10px;cursor:pointer;">Clear</button>
                          <button style="padding:4px 8px;background:rgba(80,80,112,0.3);border:none;border-radius:3px;color:#8b8b9b;font-size:10px;cursor:pointer;"></button>
                        </div>
                      </div>
                      <div style="padding:12px;height:150px;overflow-y:auto;font-family:monospace;font-size:12px;color:#00ff88;line-height:1.6;">
                        <div style="color:#00ff88;">&gt; help</div>
                        <div>Available commands:</div>
                        <div style="color:#a0a0c0;">  echo, pwd, cd, ls, env, export, clear</div>
                        <div style="color:#a0a0c0;">  rest, agent, task</div>
                        <div style="color:#00ff88;">&gt; _</div>
                      </div>
                      <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(0,0,0,0.3);border-top:1px solid rgba(80,80,112,0.2);">
                        <span style="color:#00ff88;font-family:monospace;">&gt;</span>
                        <input type="text" placeholder="Enter command..." style="flex:1;background:transparent;border:none;color:#e8e8ff;font-family:monospace;font-size:12px;outline:none;" data-testid="input-term-code">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'aivm':
          return `<iframe src="/grudgeos/index.html" style="width:100%;height:100%;border:none;"></iframe>`;
        case 'aistudio':
          return `<iframe src="/grudgeos/ai-studio.html"></iframe>`;
        case 'agentswarm':
          return `<iframe src="/grudgeos/agent-swarm.html"></iframe>`;
        case 'observer':
          return `<iframe src="/grudgeos/observer-agent.html"></iframe>`;
        case 'gameeditor':
          return `
            <div class="ge-pro-editor" data-testid="gameeditor-app">
              <!-- Top Toolbar -->
              <div class="ge-toolbar">
                <div class="ge-toolbar-left">
                  <img src="/grudgeos/assets/icons/generated/games-launcher.png" alt="GE" style="width:20px;height:20px;border-radius:3px;">
                  <span class="ge-toolbar-title">Game Editor Pro</span>
                  <div class="ge-toolbar-divider"></div>
                  <button class="ge-tool-btn active" data-tool="select" title="Select (Q)" data-testid="btn-tool-select">
                    <img src="/grudgeos/assets/icons/generated/observer-agent.png" style="width:14px;height:14px;">
                  </button>
                  <button class="ge-tool-btn" data-tool="move" title="Move (W)" data-testid="btn-tool-move">
                    <img src="/grudgeos/assets/icons/generated/network-tools.png" style="width:14px;height:14px;">
                  </button>
                  <button class="ge-tool-btn" data-tool="rotate" title="Rotate (E)" data-testid="btn-tool-rotate">
                    <img src="/grudgeos/assets/icons/generated/studio3d.png" style="width:14px;height:14px;">
                  </button>
                  <button class="ge-tool-btn" data-tool="scale" title="Scale (R)" data-testid="btn-tool-scale">
                    <img src="/grudgeos/assets/icons/generated/ai-brain.png" style="width:14px;height:14px;">
                  </button>
                </div>
                <div class="ge-toolbar-center">
                  <button class="ge-play-btn" id="ge-play-btn" data-testid="btn-play-game">
                    <span class="play-icon"></span> Play
                  </button>
                  <button class="ge-pause-btn" id="ge-pause-btn" data-testid="btn-pause-game"></button>
                  <button class="ge-stop-btn" id="ge-stop-btn" data-testid="btn-stop-game"></button>
                </div>
                <div class="ge-toolbar-right">
                  <span class="ge-device-indicator" id="ge-device-indicator">
                    <span class="status-indicator ready"></span>
                    <span id="ge-active-device">Keyboard/Mouse</span>
                  </span>
                </div>
              </div>
              
              <!-- Main Editor Area -->
              <div class="ge-main-area">
                <!-- Left Panel: Hierarchy -->
                <div class="ge-left-panel">
                  <div class="ge-panel-header">
                    <span>Scene Hierarchy</span>
                    <button class="ge-panel-btn" data-testid="btn-add-object">+</button>
                  </div>
                  <div class="ge-hierarchy-tree" id="ge-hierarchy">
                    <div class="ge-tree-item root" data-id="scene">
                      <span class="ge-tree-expand"></span>
                      <span class="ge-tree-icon"></span>
                      <span class="ge-tree-name">Main Scene</span>
                    </div>
                    <div class="ge-tree-item" data-id="player" data-parent="scene" style="padding-left:24px;">
                      <span class="ge-tree-expand"></span>
                      <span class="ge-tree-icon"></span>
                      <span class="ge-tree-name">Player</span>
                    </div>
                    <div class="ge-tree-item" data-id="player-mesh" data-parent="player" style="padding-left:40px;">
                      <span class="ge-tree-icon"></span>
                      <span class="ge-tree-name">Mesh</span>
                    </div>
                    <div class="ge-tree-item" data-id="player-camera" data-parent="player" style="padding-left:40px;">
                      <span class="ge-tree-icon"></span>
                      <span class="ge-tree-name">Camera</span>
                    </div>
                    <div class="ge-tree-item" data-id="environment" data-parent="scene" style="padding-left:24px;">
                      <span class="ge-tree-expand"></span>
                      <span class="ge-tree-icon"></span>
                      <span class="ge-tree-name">Environment</span>
                    </div>
                    <div class="ge-tree-item" data-id="lights" data-parent="scene" style="padding-left:24px;">
                      <span class="ge-tree-expand"></span>
                      <span class="ge-tree-icon"></span>
                      <span class="ge-tree-name">Lights</span>
                    </div>
                    <div class="ge-tree-item" data-id="ai-agents" data-parent="scene" style="padding-left:24px;">
                      <span class="ge-tree-expand"></span>
                      <span class="ge-tree-icon"></span>
                      <span class="ge-tree-name">AI Agents</span>
                    </div>
                  </div>
                </div>
                
                <!-- Center: Viewport with Tabs -->
                <div class="ge-center-area">
                  <div class="ge-viewport-tabs">
                    <button class="ge-viewport-tab active" data-view="scene" data-testid="tab-scene">Scene</button>
                    <button class="ge-viewport-tab" data-view="game" data-testid="tab-game">Game</button>
                    <button class="ge-viewport-tab" data-view="input" data-testid="tab-input">Input Config</button>
                    <button class="ge-viewport-tab" data-view="camera" data-testid="tab-camera">Camera</button>
                    <button class="ge-viewport-tab" data-view="scripts" data-testid="tab-scripts">Scripts</button>
                  </div>
                  
                  <!-- Scene View -->
                  <div class="ge-viewport-content active" id="ge-view-scene">
                    <canvas id="game-canvas" data-testid="game-canvas"></canvas>
                    <div class="ge-viewport-overlay">
                      <div class="ge-camera-mode" id="ge-camera-mode-display">Third Person</div>
                      <div class="ge-controls-hint">WASD Move | Mouse Look | Shift Sprint | Space Jump | Click to capture</div>
                    </div>
                    <div class="ge-gizmo-controls">
                      <button class="ge-gizmo-btn active" data-gizmo="local">Local</button>
                      <button class="ge-gizmo-btn" data-gizmo="world">World</button>
                    </div>
                  </div>
                  
                  <!-- Game View (Play Mode) -->
                  <div class="ge-viewport-content" id="ge-view-game" style="display:none;">
                    <div class="ge-game-preview">
                      <div class="ge-game-stats">
                        <span id="ge-fps">60 FPS</span>
                        <span id="ge-draw-calls">Draw: 128</span>
                        <span id="ge-tris">Tris: 45.2K</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Input Configuration View -->
                  <div class="ge-viewport-content" id="ge-view-input" style="display:none;">
                    <div class="ge-config-panel">
                      <div class="ge-config-header">
                        <h3>Input Action Mapping</h3>
                        <p>Configure keyboard, mouse, and gamepad bindings for game actions</p>
                      </div>
                      
                      <div class="ge-config-section">
                        <div class="ge-config-section-title">Movement Actions</div>
                        <div class="ge-action-mapping">
                          <div class="ge-action-row">
                            <span class="ge-action-name">Move Forward</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind" data-action="moveForward" data-device="keyboard">W</span>
                              <span class="ge-key-bind" data-action="moveForward" data-device="gamepad">L-Stick </span>
                            </div>
                            <button class="ge-rebind-btn" data-testid="btn-rebind-forward">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Move Back</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind" data-action="moveBack" data-device="keyboard">S</span>
                              <span class="ge-key-bind" data-action="moveBack" data-device="gamepad">L-Stick </span>
                            </div>
                            <button class="ge-rebind-btn" data-testid="btn-rebind-back">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Move Left</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind" data-action="moveLeft" data-device="keyboard">A</span>
                              <span class="ge-key-bind" data-action="moveLeft" data-device="gamepad">L-Stick </span>
                            </div>
                            <button class="ge-rebind-btn" data-testid="btn-rebind-left">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Move Right</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind" data-action="moveRight" data-device="keyboard">D</span>
                              <span class="ge-key-bind" data-action="moveRight" data-device="gamepad">L-Stick </span>
                            </div>
                            <button class="ge-rebind-btn" data-testid="btn-rebind-right">Rebind</button>
                          </div>
                        </div>
                      </div>
                      
                      <div class="ge-config-section">
                        <div class="ge-config-section-title">Combat Actions</div>
                        <div class="ge-action-mapping">
                          <div class="ge-action-row">
                            <span class="ge-action-name">Attack / Fire</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind">LMB</span>
                              <span class="ge-key-bind">RT</span>
                            </div>
                            <button class="ge-rebind-btn">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Block / Aim</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind">RMB</span>
                              <span class="ge-key-bind">LT</span>
                            </div>
                            <button class="ge-rebind-btn">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Reload</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind">R</span>
                              <span class="ge-key-bind">X</span>
                            </div>
                            <button class="ge-rebind-btn">Rebind</button>
                          </div>
                        </div>
                      </div>
                      
                      <div class="ge-config-section">
                        <div class="ge-config-section-title">Character Actions</div>
                        <div class="ge-action-mapping">
                          <div class="ge-action-row">
                            <span class="ge-action-name">Jump</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind">Space</span>
                              <span class="ge-key-bind">A</span>
                            </div>
                            <button class="ge-rebind-btn">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Sprint</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind">Shift</span>
                              <span class="ge-key-bind">L3</span>
                            </div>
                            <button class="ge-rebind-btn">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Crouch</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind">Ctrl</span>
                              <span class="ge-key-bind">B</span>
                            </div>
                            <button class="ge-rebind-btn">Rebind</button>
                          </div>
                          <div class="ge-action-row">
                            <span class="ge-action-name">Interact</span>
                            <div class="ge-bindings">
                              <span class="ge-key-bind">E</span>
                              <span class="ge-key-bind">Y</span>
                            </div>
                            <button class="ge-rebind-btn">Rebind</button>
                          </div>
                        </div>
                      </div>
                      
                      <div class="ge-config-section">
                        <div class="ge-config-section-title">Input Settings</div>
                        <div class="ge-input-settings">
                          <div class="ge-setting-row">
                            <label>Mouse Sensitivity</label>
                            <input type="range" min="0.1" max="3" step="0.1" value="1" id="ge-mouse-sens" data-testid="slider-mouse-sens">
                            <span id="ge-mouse-sens-val">1.0</span>
                          </div>
                          <div class="ge-setting-row">
                            <label>Invert Y-Axis</label>
                            <input type="checkbox" id="ge-invert-y" data-testid="checkbox-invert-y">
                          </div>
                          <div class="ge-setting-row">
                            <label>Gamepad Dead Zone</label>
                            <input type="range" min="0.05" max="0.3" step="0.01" value="0.15" id="ge-deadzone" data-testid="slider-deadzone">
                            <span id="ge-deadzone-val">0.15</span>
                          </div>
                          <div class="ge-setting-row">
                            <label>Input Smoothing</label>
                            <input type="checkbox" id="ge-smoothing" checked data-testid="checkbox-smoothing">
                          </div>
                          <div class="ge-setting-row">
                            <label>Aim Assist (Gamepad)</label>
                            <input type="range" min="0" max="1" step="0.1" value="0.5" id="ge-aim-assist" data-testid="slider-aim-assist">
                            <span id="ge-aim-assist-val">0.5</span>
                          </div>
                        </div>
                      </div>
                      
                      <div class="ge-config-actions">
                        <button class="ge-btn-primary" onclick="window.saveInputConfig()" data-testid="btn-save-input">Save Configuration</button>
                        <button class="ge-btn-secondary" onclick="window.resetInputConfig()" data-testid="btn-reset-input">Reset to Defaults</button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Camera Configuration View -->
                  <div class="ge-viewport-content" id="ge-view-camera" style="display:none;">
                    <div class="ge-config-panel">
                      <div class="ge-config-header">
                        <h3>Camera Systems</h3>
                        <p>Configure camera modes, behaviors, and transitions</p>
                      </div>
                      
                      <div class="ge-camera-modes">
                        <div class="ge-camera-mode-card active" data-mode="fps" data-testid="cam-fps">
                          <div class="ge-cam-icon"></div>
                          <div class="ge-cam-info">
                            <div class="ge-cam-name">First Person (FPS)</div>
                            <div class="ge-cam-desc">Camera attached to character head, direct aim</div>
                          </div>
                        </div>
                        <div class="ge-camera-mode-card" data-mode="thirdperson" data-testid="cam-thirdperson">
                          <div class="ge-cam-icon"></div>
                          <div class="ge-cam-info">
                            <div class="ge-cam-name">Third Person Chase</div>
                            <div class="ge-cam-desc">Over-the-shoulder follow camera with collision</div>
                          </div>
                        </div>
                        <div class="ge-camera-mode-card" data-mode="rts" data-testid="cam-rts">
                          <div class="ge-cam-icon"></div>
                          <div class="ge-cam-info">
                            <div class="ge-cam-name">RTS / Top-Down</div>
                            <div class="ge-cam-desc">Strategic view with pan, zoom, rotate</div>
                          </div>
                        </div>
                        <div class="ge-camera-mode-card" data-mode="freeflow" data-testid="cam-freeflow">
                          <div class="ge-cam-icon"></div>
                          <div class="ge-cam-info">
                            <div class="ge-cam-name">Free Flow / Spectator</div>
                            <div class="ge-cam-desc">Unrestricted flight camera for exploration</div>
                          </div>
                        </div>
                        <div class="ge-camera-mode-card" data-mode="followpath" data-testid="cam-followpath">
                          <div class="ge-cam-icon"></div>
                          <div class="ge-cam-info">
                            <div class="ge-cam-name">Follow Path / Cinematic</div>
                            <div class="ge-cam-desc">Spline-based camera for cutscenes</div>
                          </div>
                        </div>
                        <div class="ge-camera-mode-card" data-mode="orbital" data-testid="cam-orbital">
                          <div class="ge-cam-icon"></div>
                          <div class="ge-cam-info">
                            <div class="ge-cam-name">Orbital / Turntable</div>
                            <div class="ge-cam-desc">Rotate around target point for showcases</div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="ge-config-section">
                        <div class="ge-config-section-title">Active Camera Settings</div>
                        <div class="ge-camera-settings">
                          <div class="ge-setting-row">
                            <label>Field of View</label>
                            <input type="range" min="45" max="120" step="1" value="75" id="ge-cam-fov" data-testid="slider-fov">
                            <span id="ge-cam-fov-val">75</span>
                          </div>
                          <div class="ge-setting-row">
                            <label>Follow Distance</label>
                            <input type="range" min="2" max="20" step="0.5" value="5" id="ge-cam-dist" data-testid="slider-distance">
                            <span id="ge-cam-dist-val">5m</span>
                          </div>
                          <div class="ge-setting-row">
                            <label>Height Offset</label>
                            <input type="range" min="0" max="5" step="0.1" value="1.5" id="ge-cam-height" data-testid="slider-height">
                            <span id="ge-cam-height-val">1.5m</span>
                          </div>
                          <div class="ge-setting-row">
                            <label>Smoothing Speed</label>
                            <input type="range" min="1" max="20" step="1" value="8" id="ge-cam-smooth" data-testid="slider-smooth">
                            <span id="ge-cam-smooth-val">8</span>
                          </div>
                          <div class="ge-setting-row">
                            <label>Collision Detection</label>
                            <input type="checkbox" id="ge-cam-collision" checked data-testid="checkbox-collision">
                          </div>
                          <div class="ge-setting-row">
                            <label>Auto-Level Horizon</label>
                            <input type="checkbox" id="ge-cam-autolevel" checked data-testid="checkbox-autolevel">
                          </div>
                        </div>
                      </div>
                      
                      <div class="ge-config-actions">
                        <button class="ge-btn-primary" onclick="window.saveCameraConfig()" data-testid="btn-save-camera">Apply Camera</button>
                        <button class="ge-btn-secondary" onclick="window.testCameraMode()" data-testid="btn-test-camera">Test in Scene</button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Scripts View -->
                  <div class="ge-viewport-content" id="ge-view-scripts" style="display:none;">
                    <div class="ge-config-panel">
                      <div class="ge-config-header">
                        <h3>Game Scripts</h3>
                        <p>AI behaviors, game logic, and arena templates</p>
                      </div>
                      
                      <div class="ge-scripts-grid">
                        <div class="ge-script-card" data-script="ai-worker" data-testid="script-ai-worker">
                          <div class="ge-script-icon"></div>
                          <div class="ge-script-name">AI Worker Arena</div>
                          <div class="ge-script-desc">State machine AI for worker NPCs</div>
                          <button class="ge-btn-sm">Edit Script</button>
                        </div>
                        <div class="ge-script-card" data-script="combat-ai" data-testid="script-combat-ai">
                          <div class="ge-script-icon"></div>
                          <div class="ge-script-name">Combat AI</div>
                          <div class="ge-script-desc">Attack, defend, patrol behaviors</div>
                          <button class="ge-btn-sm">Edit Script</button>
                        </div>
                        <div class="ge-script-card" data-script="pathfinding" data-testid="script-pathfinding">
                          <div class="ge-script-icon"></div>
                          <div class="ge-script-name">Pathfinding</div>
                          <div class="ge-script-desc">A* navigation and waypoints</div>
                          <button class="ge-btn-sm">Edit Script</button>
                        </div>
                        <div class="ge-script-card" data-script="spawner" data-testid="script-spawner">
                          <div class="ge-script-icon">+</div>
                          <div class="ge-script-name">Entity Spawner</div>
                          <div class="ge-script-desc">Wave spawning system</div>
                          <button class="ge-btn-sm">Edit Script</button>
                        </div>
                        <div class="ge-script-card" data-script="vehicle" data-testid="script-vehicle">
                          <div class="ge-script-icon"></div>
                          <div class="ge-script-name">Vehicle Controller</div>
                          <div class="ge-script-desc">Physics-based vehicle handling</div>
                          <button class="ge-btn-sm">Edit Script</button>
                        </div>
                        <div class="ge-script-card" data-script="inventory" data-testid="script-inventory">
                          <div class="ge-script-icon"></div>
                          <div class="ge-script-name">Inventory System</div>
                          <div class="ge-script-desc">Items, slots, and equipment</div>
                          <button class="ge-btn-sm">Edit Script</button>
                        </div>
                      </div>
                      
                      <div class="ge-script-templates">
                        <div class="ge-config-section-title">Quick Templates</div>
                        <div class="ge-template-btns">
                          <button class="ge-template-btn" data-testid="template-fps-shooter">FPS Shooter</button>
                          <button class="ge-template-btn" data-testid="template-rpg">Action RPG</button>
                          <button class="ge-template-btn" data-testid="template-platformer">Platformer</button>
                          <button class="ge-template-btn" data-testid="template-rts">RTS</button>
                          <button class="ge-template-btn" data-testid="template-racing">Racing</button>
                          <button class="ge-template-btn" data-testid="template-survival">Survival</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Right Panel: Inspector -->
                <div class="ge-right-panel">
                  <div class="ge-panel-header">
                    <span>Inspector</span>
                  </div>
                  <div class="ge-inspector" id="ge-inspector">
                    <div class="ge-inspector-title">
                      <span id="ge-selected-name">Player</span>
                      <span class="ge-active-tag">Active</span>
                    </div>
                    
                    <div class="ge-component">
                      <div class="ge-component-header">
                        <span class="ge-component-expand"></span>
                        <span>Transform</span>
                      </div>
                      <div class="ge-component-body">
                        <div class="ge-prop-row">
                          <label>Position</label>
                          <div class="ge-vec3">
                            <input type="number" value="0" step="0.1" class="ge-input-sm" id="ge-pos-x">
                            <input type="number" value="0" step="0.1" class="ge-input-sm" id="ge-pos-y">
                            <input type="number" value="0" step="0.1" class="ge-input-sm" id="ge-pos-z">
                          </div>
                        </div>
                        <div class="ge-prop-row">
                          <label>Rotation</label>
                          <div class="ge-vec3">
                            <input type="number" value="0" step="1" class="ge-input-sm" id="ge-rot-x">
                            <input type="number" value="0" step="1" class="ge-input-sm" id="ge-rot-y">
                            <input type="number" value="0" step="1" class="ge-input-sm" id="ge-rot-z">
                          </div>
                        </div>
                        <div class="ge-prop-row">
                          <label>Scale</label>
                          <div class="ge-vec3">
                            <input type="number" value="1" step="0.1" class="ge-input-sm" id="ge-scale-x">
                            <input type="number" value="1" step="0.1" class="ge-input-sm" id="ge-scale-y">
                            <input type="number" value="1" step="0.1" class="ge-input-sm" id="ge-scale-z">
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="ge-component">
                      <div class="ge-component-header">
                        <span class="ge-component-expand"></span>
                        <span>Character Controller</span>
                      </div>
                      <div class="ge-component-body">
                        <div class="ge-prop-row">
                          <label>State</label>
                          <span class="ge-state-badge" id="ge-char-state">IDLE</span>
                        </div>
                        <div class="ge-prop-row">
                          <label>Move Speed</label>
                          <input type="number" value="5" step="0.5" class="ge-input-sm" id="ge-move-speed">
                        </div>
                        <div class="ge-prop-row">
                          <label>Sprint Mult</label>
                          <input type="number" value="1.8" step="0.1" class="ge-input-sm" id="ge-sprint-mult">
                        </div>
                        <div class="ge-prop-row">
                          <label>Jump Force</label>
                          <input type="number" value="8" step="0.5" class="ge-input-sm" id="ge-jump-force">
                        </div>
                        <div class="ge-prop-row">
                          <label>Grounded</label>
                          <span id="ge-grounded">Yes</span>
                        </div>
                      </div>
                    </div>
                    
                    <div class="ge-component">
                      <div class="ge-component-header">
                        <span class="ge-component-expand"></span>
                        <span>Input Axes</span>
                      </div>
                      <div class="ge-component-body">
                        <div class="ge-axis-viz">
                          <div class="ge-axis-row">
                            <span class="ge-axis-label">Move X</span>
                            <div class="ge-axis-bar"><div class="ge-axis-fill" id="ge-axis-mx"></div></div>
                          </div>
                          <div class="ge-axis-row">
                            <span class="ge-axis-label">Move Y</span>
                            <div class="ge-axis-bar"><div class="ge-axis-fill" id="ge-axis-my"></div></div>
                          </div>
                          <div class="ge-axis-row">
                            <span class="ge-axis-label">Look X</span>
                            <div class="ge-axis-bar"><div class="ge-axis-fill" id="ge-axis-lx"></div></div>
                          </div>
                          <div class="ge-axis-row">
                            <span class="ge-axis-label">Look Y</span>
                            <div class="ge-axis-bar"><div class="ge-axis-fill" id="ge-axis-ly"></div></div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="ge-component">
                      <div class="ge-component-header">
                        <span class="ge-component-expand"></span>
                        <span>Actions</span>
                      </div>
                      <div class="ge-component-body">
                        <div class="ge-action-grid">
                          <div class="ge-action-indicator" id="ge-act-jump">Jump</div>
                          <div class="ge-action-indicator" id="ge-act-sprint">Sprint</div>
                          <div class="ge-action-indicator" id="ge-act-crouch">Crouch</div>
                          <div class="ge-action-indicator" id="ge-act-attack">Attack</div>
                        </div>
                      </div>
                    </div>
                    
                    <button class="ge-add-component-btn" data-testid="btn-add-component">+ Add Component</button>
                  </div>
                </div>
              </div>
              
              <!-- Bottom Panel: Asset Browser -->
              <div class="ge-bottom-panel">
                <div class="ge-asset-tabs">
                  <button class="ge-asset-tab active" data-asset="prefabs">Prefabs</button>
                  <button class="ge-asset-tab" data-asset="models">Models</button>
                  <button class="ge-asset-tab" data-asset="materials">Materials</button>
                  <button class="ge-asset-tab" data-asset="scripts">Scripts</button>
                  <button class="ge-asset-tab" data-asset="audio">Audio</button>
                </div>
                <div class="ge-asset-grid" id="ge-assets">
                  <div class="ge-asset-item" draggable="true" data-asset="player-prefab">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Player</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="enemy-prefab">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Enemy</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="npc-prefab">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">NPC</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="prop-crate">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Crate</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="prop-barrel">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Barrel</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="light-point">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Point Light</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="camera">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Camera</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="spawn-point">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Spawn Point</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="trigger-zone">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Trigger Zone</div>
                  </div>
                  <div class="ge-asset-item" draggable="true" data-asset="waypoint">
                    <div class="ge-asset-icon"></div>
                    <div class="ge-asset-name">Waypoint</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'audiopackages':
          return `
            <div class="app-content">
              <div class="app-header">Audio Packages</div>
              <div class="app-section">
                <div class="app-section-title">Installed Packages</div>
                <div class="audio-item">
                  <img src="/grudgeos/assets/icons/generated/games-launcher.png" alt="GM" style="width:32px;height:32px;border-radius:6px;">
                  <div class="audio-info">
                    <div class="audio-name">Game SFX Pack</div>
                    <div class="audio-size">45 sounds - 12.3 MB</div>
                  </div>
                </div>
                <div class="audio-item">
                  <img src="/grudgeos/assets/icons/generated/audio-packages.png" alt="AU" style="width:32px;height:32px;border-radius:6px;">
                  <div class="audio-info">
                    <div class="audio-name">Ambient Music</div>
                    <div class="audio-size">8 tracks - 34.5 MB</div>
                  </div>
                </div>
                <div class="audio-item">
                  <img src="/grudgeos/assets/icons/generated/audio-packages.png" alt="VO" style="width:32px;height:32px;border-radius:6px;">
                  <div class="audio-info">
                    <div class="audio-name">UI Sounds</div>
                    <div class="audio-size">25 sounds - 2.1 MB</div>
                  </div>
                </div>
              </div>
              <button class="btn">Browse More Packages</button>
            </div>
          `;
        case 'aisystem':
          return `
            <div class="app-content">
              <div class="app-header">AI System Management</div>
              <div class="app-section">
                <div class="app-section-title">Available Models</div>
                <div class="ai-model-card active">
                  <div class="ai-model-icon" style="background: linear-gradient(135deg, #8b5cf6, #3b82f6)"><img src="/grudgeos/assets/icons/ai-brain.png" class="model-icon-img" alt="AI"></div>
                  <div class="ai-model-info">
                    <div class="ai-model-name">Claude Sonnet 4</div>
                    <div class="ai-model-desc">Best for code generation</div>
                  </div>
                  <div class="ai-status-dot"></div>
                </div>
                <div class="ai-model-card">
                  <div class="ai-model-icon" style="background: linear-gradient(135deg, #00ff88, #00f5ff)">AI</div>
                  <div class="ai-model-info">
                    <div class="ai-model-name">GPT-4o</div>
                    <div class="ai-model-desc">General purpose AI</div>
                  </div>
                  <div class="ai-status-dot"></div>
                </div>
                <div class="ai-model-card">
                  <div class="ai-model-icon" style="background: linear-gradient(135deg, #ff6b35, #ff00aa)"></div>
                  <div class="ai-model-info">
                    <div class="ai-model-name">Gemini Pro</div>
                    <div class="ai-model-desc">Google's multimodal AI</div>
                  </div>
                  <div class="ai-status-dot"></div>
                </div>
              </div>
              <div class="app-section">
                <div class="app-section-title">Auto Selection</div>
                <div class="status-item"><span>Code Tasks</span><span class="status-value">Claude Sonnet 4</span></div>
                <div class="status-item"><span>Creative Tasks</span><span class="status-value">GPT-4o</span></div>
                <div class="status-item"><span>Analysis</span><span class="status-value">Gemini Pro</span></div>
              </div>
            </div>
          `;
        case 'terminal':
          return `
            <div class="terminal-app" id="terminal-app" style="background: #0a0a0f; font-family: 'JetBrains Mono', monospace; height: 100%; display: flex; flex-direction: column;">
              <div class="terminal-header" style="padding: 12px 16px; border-bottom: 1px solid rgba(100, 200, 180, 0.2); background: rgba(20, 20, 30, 0.9);">
                <div style="color: #70d4a8; font-size: 13px; font-weight: 600;">GrudgeOS Terminal v1.0</div>
                <div style="color: #6868a0; font-size: 11px;">Secure sandboxed JavaScript execution via QuickJS WASM</div>
              </div>
              <div class="terminal-output" id="terminal-output" style="flex: 1; overflow-y: auto; padding: 16px; font-size: 13px; line-height: 1.6;"></div>
              <div class="terminal-input-row" style="display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-top: 1px solid rgba(100, 200, 180, 0.15); background: rgba(15, 15, 25, 0.95);">
                <span style="color: #70d4a8; font-weight: 600;">guest@grudgeos:~$</span>
                <input type="text" id="terminal-input" class="terminal-cmd-input" placeholder="Type a command..." data-testid="input-terminal" autocomplete="off" style="flex: 1; background: transparent; border: none; outline: none; color: #e0e0f0; font-family: inherit; font-size: 13px;">
              </div>
            </div>
          `;
        case 'settings':
          return `
            <div class="settings-app" id="settings-app">
              <div class="settings-sidebar">
                <div class="settings-nav-item active" data-section="appearance" data-testid="nav-appearance">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                  <span>Appearance</span>
                </div>
                <div class="settings-nav-item" data-section="ai" data-testid="nav-ai">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a4 4 0 0 1 4 4v1a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/><path d="M16 11v1a4 4 0 1 1-8 0v-1"/><path d="M12 19v3"/><path d="M8 22h8"/></svg>
                  <span>AI Settings</span>
                </div>
                <div class="settings-nav-item" data-section="storage" data-testid="nav-storage">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                  <span>Storage</span>
                </div>
                <div class="settings-nav-item" data-section="agents" data-testid="nav-agents">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="3"/><path d="M7 11V8a5 5 0 0 1 10 0v3"/></svg>
                  <span>Agents</span>
                </div>
                <div class="settings-nav-item" data-section="desktop" data-testid="nav-desktop">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8"/><path d="M12 17v4"/></svg>
                  <span>Desktop</span>
                </div>
                <div class="settings-nav-item" data-section="security" data-testid="nav-security">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                  <span>Security</span>
                </div>
                <div class="settings-nav-item" data-section="about" data-testid="nav-about">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                  <span>About</span>
                </div>
              </div>
              <div class="settings-content">
                <div class="settings-section active" id="settings-appearance">
                  <div class="settings-header">Appearance</div>
                  <div class="settings-group">
                    <div class="settings-label">Theme</div>
                    <div class="settings-control">
                      <select class="settings-select" id="theme-select" data-testid="select-theme">
                        <option value="cyberpunk" selected>Cyberpunk Neon</option>
                        <option value="midnight">Midnight Blue</option>
                        <option value="matrix">Matrix Green</option>
                        <option value="sakura">Sakura Pink</option>
                      </select>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Accent Color</div>
                    <div class="settings-control color-picker">
                      <div class="color-option active" data-color="#8b5cf6" style="background: #8b5cf6" data-testid="color-purple"></div>
                      <div class="color-option" data-color="#00f5ff" style="background: #00f5ff" data-testid="color-cyan"></div>
                      <div class="color-option" data-color="#ff00aa" style="background: #ff00aa" data-testid="color-pink"></div>
                      <div class="color-option" data-color="#00ff88" style="background: #00ff88" data-testid="color-green"></div>
                      <div class="color-option" data-color="#ff6b35" style="background: #ff6b35" data-testid="color-orange"></div>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">UI Scale</div>
                    <div class="settings-control">
                      <input type="range" min="80" max="120" value="100" class="settings-slider" id="ui-scale" data-testid="slider-scale">
                      <span class="slider-value">100%</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Window Effects</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="blur-effects" data-testid="toggle-blur">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Blur & Glow Effects</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Animations</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="animations" data-testid="toggle-animations">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Enable Animations</span>
                    </div>
                  </div>
                </div>
                <div class="settings-section" id="settings-ai">
                  <div class="settings-header">AI Settings</div>
                  <div class="settings-group">
                    <div class="settings-label">Default AI Model</div>
                    <div class="settings-control">
                      <select class="settings-select" id="ai-model" data-testid="select-ai-model">
                        <option value="claude">Claude Sonnet 4</option>
                        <option value="gpt4o" selected>GPT-4o</option>
                        <option value="gemini">Gemini Pro</option>
                        <option value="deepseek">DeepSeek</option>
                      </select>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Temperature</div>
                    <div class="settings-control">
                      <input type="range" min="0" max="100" value="70" class="settings-slider" id="ai-temp" data-testid="slider-temp">
                      <span class="slider-value">0.7</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Auto-Learn Preferences</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="ai-learn" data-testid="toggle-learn">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Learn from interactions</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Code Assistance</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="code-assist" data-testid="toggle-code-assist">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Auto-complete & suggestions</span>
                    </div>
                  </div>
                </div>
                <div class="settings-section" id="settings-storage">
                  <div class="settings-header">Storage</div>
                  <div class="settings-info-card">
                    <div class="storage-bar">
                      <div class="storage-used" style="width: 35%"></div>
                    </div>
                    <div class="storage-stats">
                      <span>3.5 GB used of 10 GB</span>
                      <span class="storage-free">6.5 GB free</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Cache Management</div>
                    <div class="settings-control">
                      <button class="settings-btn" id="clear-cache" data-testid="btn-clear-cache">Clear Cache</button>
                      <span class="cache-size">128 MB</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Auto-Save</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="auto-save" data-testid="toggle-autosave">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Save files automatically</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Puter Cloud Sync</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="cloud-sync" data-testid="toggle-sync">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Sync to Puter KV</span>
                    </div>
                  </div>
                </div>
                <div class="settings-section" id="settings-agents">
                  <div class="settings-header">Agent Settings</div>
                  <div class="settings-group">
                    <div class="settings-label">Max Concurrent Agents</div>
                    <div class="settings-control">
                      <select class="settings-select" id="max-agents" data-testid="select-max-agents">
                        <option value="3">3 Agents</option>
                        <option value="5" selected>5 Agents</option>
                        <option value="10">10 Agents</option>
                        <option value="unlimited">Unlimited</option>
                      </select>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Agent Memory</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="agent-memory" data-testid="toggle-agent-memory">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Persistent memory across sessions</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Agent Notifications</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="agent-notify" data-testid="toggle-agent-notify">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Show task completion alerts</span>
                    </div>
                  </div>
                </div>
                <div class="settings-section" id="settings-desktop">
                  <div class="settings-header">Desktop</div>
                  <div class="settings-group">
                    <div class="settings-label">Icon Background</div>
                    <div class="settings-control">
                      <select class="settings-select" id="icon-bg-select" data-testid="select-icon-bg">
                        <option value="gradient">Gradient (Purple-Pink)</option>
                        <option value="dark">Dark</option>
                        <option value="transparent">Transparent</option>
                        <option value="glass">Glass (Blur)</option>
                      </select>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Snap Icons to Grid</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" id="snap-grid-toggle" data-testid="toggle-snap-grid">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">Align icons when dropped</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Reset Icon Positions</div>
                    <div class="settings-control">
                      <button class="settings-btn" id="reset-icons-btn" data-testid="btn-reset-icons">Reset to Default</button>
                    </div>
                  </div>
                </div>
                <div class="settings-section" id="settings-security">
                  <div class="settings-header">Security</div>
                  <div class="settings-group">
                    <div class="settings-label">Sandbox Mode</div>
                    <div class="settings-control">
                      <label class="settings-toggle">
                        <input type="checkbox" checked id="sandbox-mode" data-testid="toggle-sandbox">
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label">QuickJS WASM isolation</span>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Code Execution</div>
                    <div class="settings-control">
                      <select class="settings-select" id="exec-mode" data-testid="select-exec-mode">
                        <option value="sandboxed" selected>Sandboxed Only</option>
                        <option value="verified">Verified Scripts</option>
                        <option value="all">All (Not Recommended)</option>
                      </select>
                    </div>
                  </div>
                  <div class="settings-group">
                    <div class="settings-label">Session Timeout</div>
                    <div class="settings-control">
                      <select class="settings-select" id="session-timeout" data-testid="select-timeout">
                        <option value="15">15 minutes</option>
                        <option value="30" selected>30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="never">Never</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="settings-section" id="settings-about">
                  <div class="settings-header">About GrudgeOS</div>
                  <div class="about-logo">
                    <img src="/grudgeos/assets/agents/cloudpilot.png" alt="CloudPilot" onerror="this.style.display='none'">
                  </div>
                  <div class="about-info">
                    <div class="about-title">GrudgeOS AI Studio</div>
                    <div class="about-version">Version 1.0.0</div>
                    <div class="about-desc">Autonomous AI Cloud Management Platform</div>
                  </div>
                  <div class="about-stats">
                    <div class="about-stat"><span>Puter SDK</span><span>v2</span></div>
                    <div class="about-stat"><span>AI Models</span><span>4 Active</span></div>
                    <div class="about-stat"><span>Agents</span><span>8 Available</span></div>
                    <div class="about-stat"><span>Sandbox</span><span>QuickJS WASM</span></div>
                  </div>
                  <div class="about-links">
                    <a href="https://puter.com" target="_blank" class="about-link" data-testid="link-puter">Puter.com</a>
                    <a href="#" class="about-link" data-testid="link-docs">Documentation</a>
                    <a href="#" class="about-link" data-testid="link-support">Support</a>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'agentmanager':
          return `
            <div class="agent-manager-content" id="agentmanager-app" style="height: 100%; overflow-y: auto;">
              <div style="padding: 40px; text-align: center; color: #9090b0;">Loading Agent Registry...</div>
            </div>
          `;
        case 'taskmanager':
          return `
            <div class="taskmanager-content" id="taskmanager-app">
              <div class="tm-header">
                <div class="tm-tabs">
                  <div class="tm-tab active" data-tab="processes">Processes</div>
                  <div class="tm-tab" data-tab="performance">Performance</div>
                  <div class="tm-tab" data-tab="agents">AI Agents</div>
                  <div class="tm-tab" data-tab="memory">Memory</div>
                </div>
                <div class="tm-actions">
                  <button class="tm-btn" data-testid="btn-end-task">End Task</button>
                  <button class="tm-btn primary" data-testid="btn-new-process">New Process</button>
                </div>
              </div>
              <div class="tm-body">
                <div class="tm-panel processes active" id="tm-processes">
                  <div class="tm-table-header">
                    <div class="tm-col name">Name</div>
                    <div class="tm-col status">Status</div>
                    <div class="tm-col cpu">CPU</div>
                    <div class="tm-col memory">Memory</div>
                    <div class="tm-col priority">Priority</div>
                  </div>
                  <div class="tm-table-body" id="process-list"></div>
                </div>
                <div class="tm-panel performance" id="tm-performance">
                  <div class="perf-grid">
                    <div class="perf-card">
                      <div class="perf-title">CPU Usage</div>
                      <div class="perf-chart" id="cpu-chart"></div>
                      <div class="perf-value"><span id="cpu-value">0</span>%</div>
                    </div>
                    <div class="perf-card">
                      <div class="perf-title">Memory Usage</div>
                      <div class="perf-chart" id="memory-chart"></div>
                      <div class="perf-value"><span id="mem-value">0</span> MB</div>
                    </div>
                    <div class="perf-card">
                      <div class="perf-title">Network I/O</div>
                      <div class="perf-chart" id="network-chart"></div>
                      <div class="perf-value"><span id="net-value">0</span> KB/s</div>
                    </div>
                    <div class="perf-card">
                      <div class="perf-title">GRD-17 Compression</div>
                      <div class="perf-chart" id="grd-chart"></div>
                      <div class="perf-value"><span id="grd-value">0</span>% ratio</div>
                    </div>
                  </div>
                </div>
                <div class="tm-panel agents" id="tm-agents">
                  <div class="tm-table-header">
                    <div class="tm-col name">Agent</div>
                    <div class="tm-col model">Model</div>
                    <div class="tm-col status">Status</div>
                    <div class="tm-col tasks">Tasks</div>
                  </div>
                  <div class="tm-table-body" id="agent-process-list"></div>
                </div>
                <div class="tm-panel memory" id="tm-memory">
                  <div class="memory-overview">
                    <div class="memory-bar-container">
                      <div class="memory-bar" id="virtual-mem-bar"></div>
                      <div class="memory-label">Virtual Memory: <span id="vmem-used">0</span> / <span id="vmem-total">16384</span> MB</div>
                    </div>
                    <div class="memory-bar-container">
                      <div class="memory-bar swap" id="swap-bar"></div>
                      <div class="memory-label">Swap Space: <span id="swap-used">0</span> / <span id="swap-total">8192</span> MB</div>
                    </div>
                    <div class="memory-bar-container">
                      <div class="memory-bar cache" id="cache-bar"></div>
                      <div class="memory-label">Cache: <span id="cache-used">0</span> / <span id="cache-total">4096</span> MB</div>
                    </div>
                  </div>
                  <div class="memory-stats">
                    <div class="mem-stat"><span>GRD-17 Compression</span><span id="grd-compression">Active</span></div>
                    <div class="mem-stat"><span>Compression Ratio</span><span id="grd-ratio">3.7:1</span></div>
                    <div class="mem-stat"><span>Data Saved</span><span id="data-saved">2.4 GB</span></div>
                    <div class="mem-stat"><span>Memory Efficiency</span><span id="mem-efficiency">94.2%</span></div>
                  </div>
                </div>
              </div>
              <div class="tm-footer">
                <div class="tm-stat">Processes: <span id="process-count">0</span></div>
                <div class="tm-stat">CPU: <span id="footer-cpu">0</span>%</div>
                <div class="tm-stat">Memory: <span id="footer-mem">0</span>%</div>
                <div class="tm-stat">Uptime: <span id="uptime">00:00:00</span></div>
              </div>
            </div>
          `;
        case 'systemmonitor':
          return `
            <div class="sysmon-content" id="sysmon-app">
              <div class="sysmon-header">
                <div class="sysmon-title">GRD-17 System Monitor</div>
                <div class="sysmon-status">
                  <span class="status-dot active"></span>
                  <span>All Systems Operational</span>
                </div>
              </div>
              <div class="sysmon-grid">
                <div class="sysmon-card large">
                  <div class="sysmon-card-header">
                    <img src="/grudgeos/assets/icons/generated/system-monitor.png" alt="SY" style="width:20px;height:20px;border-radius:4px;">
                    <span>System Overview</span>
                  </div>
                  <div class="sysmon-card-body">
                    <div class="sys-row"><span>OS Version</span><span>GrudgeOS 1.0.0</span></div>
                    <div class="sys-row"><span>Kernel</span><span>GRD-17 Core</span></div>
                    <div class="sys-row"><span>Architecture</span><span>WebAssembly x64</span></div>
                    <div class="sys-row"><span>Uptime</span><span id="sys-uptime">00:00:00</span></div>
                    <div class="sys-row"><span>Boot Time</span><span id="boot-time">--</span></div>
                  </div>
                </div>
                <div class="sysmon-card">
                  <div class="sysmon-card-header">
                    <img src="/grudgeos/assets/icons/generated/compute-pods.png" alt="CP" style="width:20px;height:20px;border-radius:4px;">
                    <span>CPU</span>
                  </div>
                  <div class="sysmon-card-body">
                    <div class="gauge-container">
                      <svg class="gauge" viewBox="0 0 100 50">
                        <path class="gauge-bg" d="M10,50 A40,40 0 0,1 90,50"/>
                        <path class="gauge-fill cpu" id="cpu-gauge" d="M10,50 A40,40 0 0,1 90,50"/>
                      </svg>
                      <div class="gauge-value" id="cpu-gauge-val">0%</div>
                    </div>
                    <div class="sys-row small"><span>Cores</span><span>8 Virtual</span></div>
                    <div class="sys-row small"><span>Threads</span><span>16</span></div>
                    <div class="sys-row small"><span>Frequency</span><span id="cpu-freq">3.2 GHz</span></div>
                  </div>
                </div>
                <div class="sysmon-card">
                  <div class="sysmon-card-header">
                    <img src="/grudgeos/assets/icons/generated/memory.png" alt="ME" style="width:20px;height:20px;border-radius:4px;">
                    <span>Memory</span>
                  </div>
                  <div class="sysmon-card-body">
                    <div class="gauge-container">
                      <svg class="gauge" viewBox="0 0 100 50">
                        <path class="gauge-bg" d="M10,50 A40,40 0 0,1 90,50"/>
                        <path class="gauge-fill memory" id="mem-gauge" d="M10,50 A40,40 0 0,1 90,50"/>
                      </svg>
                      <div class="gauge-value" id="mem-gauge-val">0%</div>
                    </div>
                    <div class="sys-row small"><span>Total</span><span>16 GB</span></div>
                    <div class="sys-row small"><span>Used</span><span id="mem-used">0 GB</span></div>
                    <div class="sys-row small"><span>Available</span><span id="mem-avail">16 GB</span></div>
                  </div>
                </div>
                <div class="sysmon-card">
                  <div class="sysmon-card-header">
                    <img src="/grudgeos/assets/icons/generated/grd-compression.png" alt="GR" style="width:20px;height:20px;border-radius:4px;">
                    <span>GRD-17 Compression</span>
                  </div>
                  <div class="sysmon-card-body">
                    <div class="grd-stats">
                      <div class="grd-stat-item">
                        <div class="grd-stat-value" id="grd-ratio-val">3.7:1</div>
                        <div class="grd-stat-label">Ratio</div>
                      </div>
                      <div class="grd-stat-item">
                        <div class="grd-stat-value" id="grd-saved-val">2.4 GB</div>
                        <div class="grd-stat-label">Saved</div>
                      </div>
                      <div class="grd-stat-item">
                        <div class="grd-stat-value" id="grd-eff-val">94%</div>
                        <div class="grd-stat-label">Efficiency</div>
                      </div>
                    </div>
                    <div class="sys-row small"><span>Algorithm</span><span>GRD-17 Adaptive</span></div>
                    <div class="sys-row small"><span>Mode</span><span>Optimal</span></div>
                  </div>
                </div>
                <div class="sysmon-card">
                  <div class="sysmon-card-header">
                    <img src="/grudgeos/assets/icons/generated/network.png" alt="NT" style="width:20px;height:20px;border-radius:4px;">
                    <span>Network</span>
                  </div>
                  <div class="sysmon-card-body">
                    <div class="net-stats">
                      <div class="net-stat">
                        <span class="net-arrow up"></span>
                        <span id="net-up">0 KB/s</span>
                      </div>
                      <div class="net-stat">
                        <span class="net-arrow down"></span>
                        <span id="net-down">0 KB/s</span>
                      </div>
                    </div>
                    <div class="sys-row small"><span>Latency</span><span id="net-latency">12ms</span></div>
                    <div class="sys-row small"><span>Connections</span><span id="net-conn">4</span></div>
                  </div>
                </div>
                <div class="sysmon-card">
                  <div class="sysmon-card-header">
                    <img src="/grudgeos/assets/icons/generated/ai-assistant.png" alt="AI" style="width:20px;height:20px;border-radius:4px;">
                    <span>AI Subsystem</span>
                  </div>
                  <div class="sysmon-card-body">
                    <div class="sys-row small"><span>Active Agents</span><span id="ai-agents">4</span></div>
                    <div class="sys-row small"><span>Tasks Queue</span><span id="ai-queue">0</span></div>
                    <div class="sys-row small"><span>API Calls</span><span id="ai-calls">0</span></div>
                    <div class="sys-row small"><span>Model</span><span id="ai-model">Auto</span></div>
                  </div>
                </div>
                <div class="sysmon-card wide">
                  <div class="sysmon-card-header">
                    <img src="/grudgeos/assets/icons/generated/storage.png" alt="ST" style="width:20px;height:20px;border-radius:4px;">
                    <span>Storage</span>
                  </div>
                  <div class="sysmon-card-body storage">
                    <div class="storage-bar-wrapper">
                      <div class="storage-bar">
                        <div class="storage-used" id="storage-used-bar"></div>
                      </div>
                      <div class="storage-labels">
                        <span id="storage-used-label">0 GB used</span>
                        <span id="storage-total-label">of 50 GB</span>
                      </div>
                    </div>
                    <div class="storage-breakdown">
                      <div class="storage-item"><span class="dot projects"></span><span>Projects</span><span id="storage-projects">0 MB</span></div>
                      <div class="storage-item"><span class="dot assets"></span><span>Assets</span><span id="storage-assets">0 MB</span></div>
                      <div class="storage-item"><span class="dot games"></span><span>Games</span><span id="storage-games">0 MB</span></div>
                      <div class="storage-item"><span class="dot other"></span><span>Other</span><span id="storage-other">0 MB</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'grudchat':
          return `
            <div id="grudchat-app" data-testid="grudchat-app" style="display:flex;height:100%;background:linear-gradient(180deg,#1a1a2e 0%,#16161d 100%);font-family:'Rajdhani',sans-serif;position:relative;">
              <div style="width:240px;background:rgba(18,18,31,0.95);border-right:1px solid rgba(139,92,246,0.2);display:flex;flex-direction:column;">
                <div style="display:flex;align-items:center;gap:10px;padding:14px 16px;background:rgba(139,92,246,0.1);border-bottom:1px solid rgba(139,92,246,0.3);">
                  <img src="/grudgeos/assets/icons/generated/grudchat.png" alt="GG" style="width:24px;height:24px;border-radius:4px;">
                  <span style="flex:1;font-weight:700;color:#e8e8ff;font-size:14px;">GrudgeGameZone</span>
                  <button style="background:none;border:none;color:#8b8b9b;cursor:pointer;" data-testid="btn-server-menu"></button>
                </div>
                <div id="grudchat-channels" style="flex:1;overflow-y:auto;padding:8px;">
                  <div style="padding:8px;color:#8b8b9b;font-size:12px;">
                    <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;background:rgba(139,92,246,0.15);border-radius:4px;margin-bottom:4px;cursor:pointer;color:#00f5ff;">
                      <span style="color:#8b8b9b;">#</span><span>agent-swarm</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:4px;margin-bottom:4px;cursor:pointer;color:#a0a0c0;">
                      <span style="color:#8b8b9b;">#</span><span>general</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:4px;margin-bottom:4px;cursor:pointer;color:#a0a0c0;">
                      <span style="color:#8b8b9b;">#</span><span>ai-tasks</span>
                    </div>
                  </div>
                </div>
                <div id="grudchat-user-panel" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(10,10,18,0.9);border-top:1px solid rgba(80,80,112,0.2);">
                  <img src="/grudgeos/assets/icons/generated/user-avatar.png" alt="U" style="width:32px;height:32px;border-radius:50%;">
                  <div style="flex:1;">
                    <div style="font-weight:600;color:#e8e8ff;font-size:13px;">Guest</div>
                    <div style="font-size:11px;color:#00ff88;">Online</div>
                  </div>
                  <div style="display:flex;gap:4px;">
                    <button style="width:28px;height:28px;background:rgba(80,80,112,0.3);border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" data-testid="btn-mute"><img src="/grudgeos/assets/icons/generated/mute.png" alt="M" style="width:14px;height:14px;"></button>
                    <button style="width:28px;height:28px;background:rgba(80,80,112,0.3);border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" data-testid="btn-settings"><img src="/grudgeos/assets/icons/generated/settings.png" alt="S" style="width:14px;height:14px;"></button>
                  </div>
                </div>
              </div>
              <div style="flex:1;display:flex;flex-direction:column;min-width:0;">
                <div id="grudchat-channel-header" style="display:flex;align-items:center;gap:10px;padding:12px 16px;background:rgba(18,18,31,0.9);border-bottom:1px solid rgba(80,80,112,0.2);">
                  <span style="color:#8b8b9b;font-size:18px;">#</span>
                  <span style="flex:1;font-weight:700;color:#e8e8ff;font-size:15px;">agent-swarm</span>
                  <div style="display:flex;gap:8px;">
                    <button style="width:28px;height:28px;background:rgba(80,80,112,0.2);border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" data-testid="btn-search"><img src="/grudgeos/assets/icons/generated/search.png" alt="SR" style="width:14px;height:14px;"></button>
                    <button style="width:28px;height:28px;background:rgba(80,80,112,0.2);border:none;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;" data-testid="btn-members"><img src="/grudgeos/assets/icons/generated/members.png" alt="MX" style="width:14px;height:14px;"></button>
                  </div>
                </div>
                <div id="grudchat-messages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px;">
                  <div style="display:flex;gap:12px;">
                    <img src="/grudgeos/assets/agents/agent-purple.png" alt="A" style="width:40px;height:40px;border-radius:50%;">
                    <div style="flex:1;">
                      <div style="display:flex;align-items:baseline;gap:8px;">
                        <span style="font-weight:700;color:#8b5cf6;">Orchestrator</span>
                        <span style="font-size:11px;color:#505070;">Today at 10:32</span>
                      </div>
                      <div style="color:#e8e8ff;font-size:14px;line-height:1.5;margin-top:4px;">Welcome to the Agent Swarm channel. All agents report status here.</div>
                    </div>
                  </div>
                  <div style="display:flex;gap:12px;">
                    <img src="/grudgeos/assets/agents/agent-green.png" alt="A" style="width:40px;height:40px;border-radius:50%;">
                    <div style="flex:1;">
                      <div style="display:flex;align-items:baseline;gap:8px;">
                        <span style="font-weight:700;color:#00ff88;">Code Agent</span>
                        <span style="font-size:11px;color:#505070;">Today at 10:33</span>
                      </div>
                      <div style="color:#e8e8ff;font-size:14px;line-height:1.5;margin-top:4px;">Ready for code tasks. QuickJS sandbox initialized.</div>
                    </div>
                  </div>
                </div>
                <div id="grudchat-input-area" style="display:flex;align-items:center;gap:8px;padding:12px 16px;background:rgba(18,18,31,0.9);border-top:1px solid rgba(80,80,112,0.2);">
                  <button style="width:36px;height:36px;background:rgba(139,92,246,0.2);border:none;border-radius:50%;color:#8b5cf6;font-size:18px;cursor:pointer;" data-testid="btn-attach">+</button>
                  <input type="text" id="grudchat-input" placeholder="Message #agent-swarm" data-testid="input-message" style="flex:1;background:rgba(30,30,50,0.8);border:1px solid rgba(80,80,112,0.3);border-radius:8px;padding:10px 14px;color:#e8e8ff;font-size:14px;outline:none;">
                  <button id="grudchat-send" data-testid="btn-send" style="padding:8px 16px;background:linear-gradient(135deg,#8b5cf6,#00f5ff);border:none;border-radius:6px;color:#fff;font-weight:600;cursor:pointer;">Send</button>
                </div>
              </div>
            </div>
          `;
        case 'networktools':
          return `
            <div class="nettools-content" id="nettools-app" data-testid="networktools-app">
              <div class="nettools-header">
                <div class="nettools-title">
                  <img src="/grudgeos/assets/icons/generated/network.png" alt="NT" style="width:24px;height:24px;border-radius:4px;">
                  <span>Network Tools Container Hub</span>
                </div>
                <div class="nettools-stats" id="nettools-stats">
                  <span class="stat-item"><span class="stat-label">Running:</span><span class="stat-value" id="net-running">0</span></span>
                  <span class="stat-item"><span class="stat-label">CPU:</span><span class="stat-value" id="net-cpu">0%</span></span>
                  <span class="stat-item"><span class="stat-label">Memory:</span><span class="stat-value" id="net-mem">0 MB</span></span>
                </div>
              </div>
              <div class="nettools-tabs">
                <button class="nettools-tab active" data-tab="containers" data-testid="tab-containers">Containers</button>
                <button class="nettools-tab" data-tab="tools" data-testid="tab-tools">Available Tools</button>
                <button class="nettools-tab" data-tab="logs" data-testid="tab-logs">Logs</button>
              </div>
              <div class="nettools-body">
                <div class="nettools-tab-content active" id="nettools-containers">
                  <div class="containers-grid" id="containers-grid">
                    <div class="no-containers">No containers running. Deploy a tool to get started.</div>
                  </div>
                </div>
                <div class="nettools-tab-content" id="nettools-tools">
                  <div class="tools-section">
                    <h3 class="tools-section-title">Scanning Tools</h3>
                    <div class="tools-grid" id="scanning-tools">
                      <div class="nettool-card" data-tool-id="nmap" data-testid="tool-nmap">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">Nmap Scanner</span><span class="nettool-image">nmap:latest</span></div></div>
                        <p class="nettool-desc">Network exploration and security auditing</p>
                        <div class="nettool-resources"><span>CPU: 0.5</span><span>RAM: 256MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-nmap" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                      <div class="nettool-card" data-tool-id="masscan" data-testid="tool-masscan">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">Masscan</span><span class="nettool-image">masscan:latest</span></div></div>
                        <p class="nettool-desc">High-speed TCP port scanner</p>
                        <div class="nettool-resources"><span>CPU: 0.8</span><span>RAM: 256MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-masscan" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                      <div class="nettool-card" data-tool-id="nikto" data-testid="tool-nikto">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">Nikto</span><span class="nettool-image">nikto:latest</span></div></div>
                        <p class="nettool-desc">Web server vulnerability scanner</p>
                        <div class="nettool-resources"><span>CPU: 0.5</span><span>RAM: 256MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-nikto" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                    </div>
                  </div>
                  <div class="tools-section">
                    <h3 class="tools-section-title">Analysis Tools</h3>
                    <div class="tools-grid" id="analysis-tools">
                      <div class="nettool-card" data-tool-id="wireshark" data-testid="tool-wireshark">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">Wireshark</span><span class="nettool-image">wireshark:latest</span></div></div>
                        <p class="nettool-desc">Network protocol analyzer and packet capture</p>
                        <div class="nettool-resources"><span>CPU: 1.0</span><span>RAM: 512MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-wireshark" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                      <div class="nettool-card" data-tool-id="tcpdump" data-testid="tool-tcpdump">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">TCPDump</span><span class="nettool-image">tcpdump:latest</span></div></div>
                        <p class="nettool-desc">Command-line packet analyzer</p>
                        <div class="nettool-resources"><span>CPU: 0.3</span><span>RAM: 128MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-tcpdump" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                    </div>
                  </div>
                  <div class="tools-section">
                    <h3 class="tools-section-title">Utility Tools</h3>
                    <div class="tools-grid" id="utility-tools">
                      <div class="nettool-card" data-tool-id="netcat" data-testid="tool-netcat">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">Netcat</span><span class="nettool-image">netcat:alpine</span></div></div>
                        <p class="nettool-desc">TCP/UDP networking utility</p>
                        <div class="nettool-resources"><span>CPU: 0.1</span><span>RAM: 64MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-netcat" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                      <div class="nettool-card" data-tool-id="curl" data-testid="tool-curl">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">cURL</span><span class="nettool-image">curl:alpine</span></div></div>
                        <p class="nettool-desc">Command-line HTTP client</p>
                        <div class="nettool-resources"><span>CPU: 0.1</span><span>RAM: 64MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-curl" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                      <div class="nettool-card" data-tool-id="dns-tools" data-testid="tool-dns-tools">
                        <div class="nettool-header"><span class="nettool-icon"></span><div class="nettool-info"><span class="nettool-name">DNS Tools</span><span class="nettool-image">dnsutils:latest</span></div></div>
                        <p class="nettool-desc">DNS lookup and diagnostics (dig, nslookup)</p>
                        <div class="nettool-resources"><span>CPU: 0.1</span><span>RAM: 64MB</span></div>
                        <div class="nettool-actions"><button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-dns-tools" style="background:linear-gradient(135deg,#ff6b35,#ff8f5a,#00f5ff);color:#000;font-weight:700;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;min-height:38px;font-family:Rajdhani,sans-serif;">Deploy</button></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="nettools-tab-content" id="nettools-logs">
                  <div class="logs-selector">
                    <select id="logs-container-select" data-testid="select-logs-container">
                      <option value="">Select container...</option>
                    </select>
                  </div>
                  <div class="logs-output" id="logs-output">
                    <div class="logs-placeholder">Select a container to view logs</div>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'pods':
          return `
            <div class="pods-content" data-testid="pods-app">
              <div class="pods-header">
                <div class="pods-title">
                  <img src="/grudgeos/assets/icons/generated/compute-pods.png" alt="CP" style="width:24px;height:24px;border-radius:4px;">
                  <span>Compute Pods Dashboard</span>
                </div>
                <div class="pods-stats" id="pods-stats">
                  <span class="stat-item"><span class="stat-label">Active:</span><span class="stat-value" id="pods-active">0</span></span>
                  <span class="stat-item"><span class="stat-label">Queued:</span><span class="stat-value" id="pods-queued">0</span></span>
                  <span class="stat-item"><span class="stat-label">Completed:</span><span class="stat-value" id="pods-completed">0</span></span>
                </div>
              </div>
              <div class="pods-tabs">
                <button class="pods-tab active" data-tab="pods-list" data-testid="tab-pods-list">Pods</button>
                <button class="pods-tab" data-tab="jobs-queue" data-testid="tab-jobs-queue">Job Queue</button>
                <button class="pods-tab" data-tab="job-submit" data-testid="tab-job-submit">Submit Job</button>
              </div>
              <div class="pods-body">
                <div class="pods-tab-content active" id="pods-list-panel">
                  <div class="pods-grid" id="pods-grid">
                    <div class="no-pods">No pods running. Pods are created automatically when jobs are submitted.</div>
                  </div>
                  <button class="pods-action-btn" onclick="createNewPod()" data-testid="btn-create-pod">+ Create Pod</button>
                </div>
                <div class="pods-tab-content" id="jobs-queue-panel">
                  <div class="jobs-list" id="jobs-list">
                    <div class="no-jobs">No jobs in queue</div>
                  </div>
                </div>
                <div class="pods-tab-content" id="job-submit-panel">
                  <div class="job-form">
                    <label>Job Type</label>
                    <select id="job-type" data-testid="select-job-type">
                      <option value="code">Code Execution</option>
                      <option value="ai">AI Task</option>
                      <option value="transform">Data Transform</option>
                    </select>
                    <label>Code/Prompt</label>
                    <textarea id="job-code" rows="8" placeholder="Enter code or prompt..." data-testid="input-job-code"></textarea>
                    <label>Priority</label>
                    <select id="job-priority" data-testid="select-job-priority">
                      <option value="normal">Normal</option>
                      <option value="high">High</option>
                      <option value="low">Low</option>
                    </select>
                    <button class="pods-action-btn" onclick="submitPodJob()" data-testid="btn-submit-job">Submit Job</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'snapshots':
          return `
            <div class="snapshots-content" data-testid="snapshots-app">
              <div class="snapshots-header">
                <div class="snapshots-title">
                  ${makeIconImg('snapshots', 24)}
                  <span>Snapshot Manager</span>
                </div>
                <button class="snapshot-create-btn" onclick="createSnapshot()" data-testid="btn-create-snapshot">+ New Snapshot</button>
              </div>
              <div class="snapshots-tabs">
                <button class="snapshots-tab active" data-tab="snapshots-list" data-testid="tab-snapshots-list">All Snapshots</button>
                <button class="snapshots-tab" data-tab="snapshots-create" data-testid="tab-snapshots-create">Create</button>
                <button class="snapshots-tab" data-tab="snapshots-import" data-testid="tab-snapshots-import">Import/Export</button>
              </div>
              <div class="snapshots-body">
                <div class="snapshots-tab-content active" id="snapshots-list-panel">
                  <div class="snapshots-list" id="snapshots-list">
                    <div class="no-snapshots">No snapshots yet. Create one to save your workspace state.</div>
                  </div>
                </div>
                <div class="snapshots-tab-content" id="snapshots-create-panel">
                  <div class="snapshot-form">
                    <label>Snapshot Name</label>
                    <input type="text" id="snapshot-name" placeholder="My Snapshot" data-testid="input-snapshot-name">
                    <label>Type</label>
                    <select id="snapshot-type" data-testid="select-snapshot-type">
                      <option value="full">Full System</option>
                      <option value="workspace">Workspace Only</option>
                      <option value="squad">Agent Squad</option>
                      <option value="agent">Single Agent</option>
                    </select>
                    <label>Description</label>
                    <textarea id="snapshot-desc" rows="3" placeholder="Optional description..." data-testid="input-snapshot-desc"></textarea>
                    <button class="snapshot-action-btn" onclick="createSnapshotFromForm()" data-testid="btn-save-snapshot">Create Snapshot</button>
                  </div>
                </div>
                <div class="snapshots-tab-content" id="snapshots-import-panel">
                  <div class="import-export-section">
                    <h4>Export Snapshot</h4>
                    <select id="export-snapshot-select" data-testid="select-export-snapshot">
                      <option value="">Select snapshot to export...</option>
                    </select>
                    <button class="snapshot-action-btn" onclick="exportSelectedSnapshot()" data-testid="btn-export-snapshot">Export JSON</button>
                    <h4 style="margin-top:20px;">Import Snapshot</h4>
                    <textarea id="import-snapshot-json" rows="6" placeholder="Paste snapshot JSON here..." data-testid="input-import-json"></textarea>
                    <button class="snapshot-action-btn" onclick="importSnapshotFromJson()" data-testid="btn-import-snapshot">Import</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'studio3d':
          return `
            <div class="studio3d-content" data-testid="studio3d-app">
              <div class="studio3d-header">
                <div class="studio3d-title">
                  ${makeIconImg('canvas', 24)}
                  <span>Canvas Studio</span>
                </div>
              </div>
              <div class="studio3d-tabs">
                <button class="studio3d-tab" data-tab="grudge-engine" data-testid="tab-grudge-engine">Grudge Engine</button>
                <button class="studio3d-tab active" data-tab="viz" data-testid="tab-viz">3D Visualization</button>
                <button class="studio3d-tab" data-tab="aiconsole" data-testid="tab-aiconsole">AI Console</button>
              </div>
              <div class="studio3d-tab-content" id="studio3d-grudge-engine-panel">
                <iframe 
                  src="/grudgeos/gapps/grudge-engine/index.html" 
                  style="width:100%;height:100%;border:none;background:#0a0a0f;"
                  data-testid="grudge-engine-iframe"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope"
                ></iframe>
              </div>
              <div class="studio3d-tab-content active" id="studio3d-viz-panel">
                <div class="studio3d-body" style="flex:1;display:flex;">
                  <div style="flex:1;display:flex;flex-direction:column;">
                    <div class="studio3d-controls" style="padding:10px;">
                      <button class="studio3d-btn" onclick="visualizeAgents3D()" data-testid="btn-viz-agents">Agents</button>
                      <button class="studio3d-btn" onclick="visualizePods3D()" data-testid="btn-viz-pods">Pods</button>
                      <button class="studio3d-btn" onclick="visualizeNetwork3D()" data-testid="btn-viz-network">Network</button>
                    </div>
                    <canvas id="webgl-canvas" data-testid="webgl-canvas" style="flex:1;"></canvas>
                  </div>
                  <div class="studio3d-sidebar">
                    <h4>Scene Info</h4>
                    <div class="scene-info" id="scene-info">
                      <p>Nodes: <span id="node-count">0</span></p>
                      <p>Edges: <span id="edge-count">0</span></p>
                      <p>Type: <span id="scene-type">-</span></p>
                    </div>
                    <h4>Camera</h4>
                    <div class="camera-controls">
                      <button onclick="resetCamera()" data-testid="btn-reset-camera">Reset</button>
                      <button onclick="zoomIn3D()" data-testid="btn-zoom-in">Zoom In</button>
                      <button onclick="zoomOut3D()" data-testid="btn-zoom-out">Zoom Out</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="studio3d-tab-content" id="studio3d-aiconsole-panel">
                <div class="ai-console-content">
                  <div class="ai-console-main">
                    <div class="ai-gen-section">
                      <h4>${makeIconImg('ai-studio', 18)} Text to Image</h4>
                      <div class="ai-gen-form">
                        <textarea id="txt2img-prompt" placeholder="Describe the image you want to generate..." data-testid="input-txt2img"></textarea>
                        <button class="ai-gen-btn" onclick="generateAIImage()" data-testid="btn-gen-image">Generate Image</button>
                      </div>
                      <div class="ai-gen-result" id="txt2img-result">
                        <div class="ai-gen-placeholder">Generated image will appear here</div>
                      </div>
                    </div>
                    <div class="ai-gen-section">
                      <h4>${makeIconImg('game-editor', 18)} Text to Video</h4>
                      <div class="ai-gen-form">
                        <textarea id="txt2vid-prompt" placeholder="Describe the video you want to generate..." data-testid="input-txt2vid"></textarea>
                        <button class="ai-gen-btn" onclick="generateAIVideo()" data-testid="btn-gen-video">Generate Video</button>
                      </div>
                      <div class="ai-gen-result" id="txt2vid-result">
                        <div class="ai-gen-placeholder">Generated video will appear here</div>
                      </div>
                    </div>
                  </div>
                  <div class="ai-console-sidebar">
                    <h4 style="color:var(--neon-cyan);margin-bottom:16px;">Generated Assets</h4>
                    <div class="ai-asset-list" id="ai-asset-list">
                      <div class="ai-gen-placeholder" style="font-size:12px;">No assets generated yet</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'wasmrunner':
          return `
            <div class="wasm-content" data-testid="wasm-app">
              <div class="wasm-header">
                <div class="wasm-title">
                  <img src="/grudgeos/assets/icons/generated/wasm-runner.png" alt="WA" style="width:24px;height:24px;border-radius:4px;">
                  <span>WebAssembly Runner</span>
                </div>
                <div class="wasm-status" id="wasm-status">
                  <span class="status-indicator ready"></span>
                  <span>Ready</span>
                </div>
              </div>
              <div class="wasm-tabs">
                <button class="wasm-tab active" data-tab="wasm-modules" data-testid="tab-wasm-modules">Modules</button>
                <button class="wasm-tab" data-tab="wasm-execute" data-testid="tab-wasm-execute">Execute</button>
                <button class="wasm-tab" data-tab="wasm-memory" data-testid="tab-wasm-memory">Memory</button>
              </div>
              <div class="wasm-body">
                <div class="wasm-tab-content active" id="wasm-modules-panel">
                  <div class="wasm-modules-list" id="wasm-modules-list">
                    <div class="no-modules">No WASM modules loaded</div>
                  </div>
                  <div class="wasm-load-section">
                    <label>Load Module (Base64 or URL)</label>
                    <input type="text" id="wasm-module-input" placeholder="Paste base64 or enter URL..." data-testid="input-wasm-module">
                    <button class="wasm-action-btn" onclick="loadWasmModule()" data-testid="btn-load-wasm">Load Module</button>
                  </div>
                </div>
                <div class="wasm-tab-content" id="wasm-execute-panel">
                  <div class="wasm-execute-form">
                    <label>Select Module</label>
                    <select id="wasm-exec-module" data-testid="select-wasm-module">
                      <option value="">Select module...</option>
                    </select>
                    <label>Function</label>
                    <select id="wasm-exec-fn" data-testid="select-wasm-fn">
                      <option value="">Select function...</option>
                    </select>
                    <label>Arguments (comma separated)</label>
                    <input type="text" id="wasm-exec-args" placeholder="arg1, arg2, ..." data-testid="input-wasm-args">
                    <button class="wasm-action-btn" onclick="executeWasmFn()" data-testid="btn-exec-wasm">Execute</button>
                    <div class="wasm-result" id="wasm-result">
                      <label>Result:</label>
                      <pre id="wasm-result-output">-</pre>
                    </div>
                  </div>
                </div>
                <div class="wasm-tab-content" id="wasm-memory-panel">
                  <div class="wasm-memory-view">
                    <label>Memory Inspector</label>
                    <div class="memory-controls">
                      <input type="number" id="mem-offset" value="0" min="0" data-testid="input-mem-offset">
                      <input type="number" id="mem-length" value="256" min="1" max="4096" data-testid="input-mem-length">
                      <button onclick="inspectMemory()" data-testid="btn-inspect-mem">Inspect</button>
                    </div>
                    <pre class="memory-dump" id="memory-dump">No memory to display</pre>
                  </div>
                </div>
              </div>
            </div>
          `;
        case 'zerotier':
          return `
            <div class="zerotier-content" data-testid="zerotier-app" style="height:100%;display:flex;flex-direction:column;background:#0d0d1a;">
              <div class="zt-header" style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid rgba(255,185,0,0.3);background:linear-gradient(90deg,rgba(255,185,0,0.1),transparent);">
                <div style="display:flex;align-items:center;gap:12px;">
                  <img src="/grudgeos/assets/icons/generated/zerotier.png" alt="ZT" style="width:32px;height:32px;border-radius:6px;">
                  <div>
                    <div style="font-size:18px;font-weight:600;color:#ffb900;">ZeroTier Network Manager</div>
                    <div style="font-size:12px;color:#9090b0;">Create, host, and connect to virtual networks</div>
                  </div>
                </div>
                <div class="zt-status" id="zt-status" style="display:flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);border-radius:20px;">
                  <span style="width:8px;height:8px;background:#00ff88;border-radius:50%;animation:pulse 2s infinite;"></span>
                  <span style="color:#00ff88;font-size:13px;">Service Ready</span>
                </div>
              </div>
              
              <div class="zt-tabs" style="display:flex;gap:4px;padding:12px 20px;border-bottom:1px solid rgba(139,92,246,0.2);">
                <button class="zt-tab active" data-tab="zt-connect" style="padding:10px 20px;background:rgba(255,185,0,0.2);border:1px solid rgba(255,185,0,0.4);color:#ffb900;border-radius:8px;cursor:pointer;font-weight:500;" data-testid="tab-zt-connect">Connect</button>
                <button class="zt-tab" data-tab="zt-create" style="padding:10px 20px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);color:#9090b0;border-radius:8px;cursor:pointer;font-weight:500;" data-testid="tab-zt-create">Create Network</button>
                <button class="zt-tab" data-tab="zt-servers" style="padding:10px 20px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);color:#9090b0;border-radius:8px;cursor:pointer;font-weight:500;" data-testid="tab-zt-servers">Game Servers</button>
                <button class="zt-tab" data-tab="zt-peers" style="padding:10px 20px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.2);color:#9090b0;border-radius:8px;cursor:pointer;font-weight:500;" data-testid="tab-zt-peers">Connected Peers</button>
              </div>
              
              <div class="zt-body" style="flex:1;overflow-y:auto;padding:20px;">
                <!-- Connect Tab -->
                <div class="zt-tab-content active" id="zt-connect-panel">
                  <div style="max-width:600px;">
                    <h3 style="color:#00f5ff;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                      <img src="/grudgeos/assets/icons/generated/network.png" alt="" style="width:24px;height:24px;"> Join a ZeroTier Network
                    </h3>
                    <div style="background:rgba(20,20,40,0.8);border:1px solid rgba(139,92,246,0.3);border-radius:12px;padding:24px;margin-bottom:20px;">
                      <label style="display:block;color:#c0c0e0;margin-bottom:8px;font-size:14px;">Network ID (16-character hex)</label>
                      <input type="text" id="zt-network-id" placeholder="e.g. a84ac5c10a7ebb5f" maxlength="16" style="width:100%;padding:14px;background:rgba(10,10,20,0.8);border:1px solid rgba(255,185,0,0.3);border-radius:8px;color:#fff;font-size:16px;font-family:monospace;letter-spacing:2px;" data-testid="input-zt-network-id">
                      <div style="display:flex;gap:12px;margin-top:16px;">
                        <button onclick="joinZeroTierNetwork()" style="flex:1;padding:14px;background:linear-gradient(135deg,#ffb900,#ff6b00);border:none;border-radius:8px;color:#000;font-weight:600;cursor:pointer;font-size:15px;" data-testid="btn-join-zt">Join Network</button>
                        <button onclick="leaveZeroTierNetwork()" style="padding:14px 24px;background:rgba(255,0,110,0.2);border:1px solid rgba(255,0,110,0.4);border-radius:8px;color:#ff006e;font-weight:500;cursor:pointer;" data-testid="btn-leave-zt">Leave</button>
                      </div>
                    </div>
                    
                    <div style="background:rgba(0,245,255,0.05);border:1px solid rgba(0,245,255,0.2);border-radius:12px;padding:20px;">
                      <h4 style="color:#00f5ff;margin-bottom:12px;">Quick Start Guide</h4>
                      <ol style="color:#9090b0;font-size:14px;line-height:1.8;padding-left:20px;">
                        <li>Get a Network ID from <a href="https://my.zerotier.com" target="_blank" style="color:#ffb900;">my.zerotier.com</a> or create one in the "Create Network" tab</li>
                        <li>Enter the 16-character Network ID above</li>
                        <li>Click "Join Network" to connect</li>
                        <li>Ask the network admin to authorize your device</li>
                        <li>Once authorized, you'll get a virtual IP for the network</li>
                      </ol>
                    </div>
                  </div>
                </div>
                
                <!-- Create Network Tab -->
                <div class="zt-tab-content" id="zt-create-panel" style="display:none;">
                  <div style="max-width:700px;">
                    <h3 style="color:#8b5cf6;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                      <img src="/grudgeos/assets/icons/generated/creating.png" alt="" style="width:24px;height:24px;"> Create a New Network
                    </h3>
                    <div style="background:rgba(20,20,40,0.8);border:1px solid rgba(139,92,246,0.3);border-radius:12px;padding:24px;margin-bottom:20px;">
                      <div style="margin-bottom:20px;">
                        <label style="display:block;color:#c0c0e0;margin-bottom:8px;font-size:14px;">Network Name</label>
                        <input type="text" id="zt-create-name" placeholder="My Game Server Network" style="width:100%;padding:14px;background:rgba(10,10,20,0.8);border:1px solid rgba(139,92,246,0.3);border-radius:8px;color:#fff;font-size:15px;" data-testid="input-zt-create-name">
                      </div>
                      <div style="margin-bottom:20px;">
                        <label style="display:block;color:#c0c0e0;margin-bottom:8px;font-size:14px;">Network Type</label>
                        <select id="zt-create-type" style="width:100%;padding:14px;background:rgba(10,10,20,0.8);border:1px solid rgba(139,92,246,0.3);border-radius:8px;color:#fff;font-size:15px;" data-testid="select-zt-type">
                          <option value="private">Private (Requires Authorization)</option>
                          <option value="public">Public (Anyone can join)</option>
                        </select>
                      </div>
                      <div style="margin-bottom:20px;">
                        <label style="display:block;color:#c0c0e0;margin-bottom:8px;font-size:14px;">IP Range</label>
                        <select id="zt-create-range" style="width:100%;padding:14px;background:rgba(10,10,20,0.8);border:1px solid rgba(139,92,246,0.3);border-radius:8px;color:#fff;font-size:15px;" data-testid="select-zt-range">
                          <option value="10.147.17.0/24">10.147.17.0/24 (254 hosts)</option>
                          <option value="10.147.18.0/24">10.147.18.0/24 (254 hosts)</option>
                          <option value="192.168.191.0/24">192.168.191.0/24 (254 hosts)</option>
                        </select>
                      </div>
                      <button onclick="createZeroTierNetwork()" style="width:100%;padding:14px;background:linear-gradient(135deg,#8b5cf6,#00f5ff);border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;font-size:15px;" data-testid="btn-create-zt">Create Network</button>
                    </div>
                    
                    <div id="zt-created-networks" style="margin-top:20px;">
                      <h4 style="color:#c0c0e0;margin-bottom:12px;">Your Networks</h4>
                      <div style="color:#606080;font-size:14px;padding:20px;text-align:center;background:rgba(20,20,40,0.5);border-radius:8px;">No networks created yet. Create one above to get started.</div>
                    </div>
                  </div>
                </div>
                
                <!-- Game Servers Tab -->
                <div class="zt-tab-content" id="zt-servers-panel" style="display:none;">
                  <h3 style="color:#ff006e;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <img src="/grudgeos/assets/icons/generated/games-launcher.png" alt="" style="width:24px;height:24px;"> Game Server Templates
                  </h3>
                  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;">
                    <div class="zt-server-card" style="background:rgba(20,20,40,0.8);border:1px solid rgba(255,0,110,0.3);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s;" onclick="hostGameServer('minecraft')">
                      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <div style="width:48px;height:48px;background:linear-gradient(135deg,#8b4513,#228b22);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;">M</div>
                        <div>
                          <div style="font-weight:600;color:#fff;">Minecraft Server</div>
                          <div style="font-size:12px;color:#9090b0;">Java/Bedrock compatible</div>
                        </div>
                      </div>
                      <div style="font-size:13px;color:#7070a0;">Host your own Minecraft server accessible via ZeroTier VPN. LAN-like gameplay across the internet.</div>
                    </div>
                    
                    <div class="zt-server-card" style="background:rgba(20,20,40,0.8);border:1px solid rgba(0,245,255,0.3);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s;" onclick="hostGameServer('terraria')">
                      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <div style="width:48px;height:48px;background:linear-gradient(135deg,#4682b4,#32cd32);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;">T</div>
                        <div>
                          <div style="font-weight:600;color:#fff;">Terraria Server</div>
                          <div style="font-size:12px;color:#9090b0;">Multiplayer sandbox</div>
                        </div>
                      </div>
                      <div style="font-size:13px;color:#7070a0;">2D sandbox adventure with friends. Private network ensures low latency and security.</div>
                    </div>
                    
                    <div class="zt-server-card" style="background:rgba(20,20,40,0.8);border:1px solid rgba(139,92,246,0.3);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s;" onclick="hostGameServer('valheim')">
                      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <div style="width:48px;height:48px;background:linear-gradient(135deg,#2f4f4f,#8b0000);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;">V</div>
                        <div>
                          <div style="font-weight:600;color:#fff;">Valheim Server</div>
                          <div style="font-size:12px;color:#9090b0;">Viking survival co-op</div>
                        </div>
                      </div>
                      <div style="font-size:13px;color:#7070a0;">Dedicated Valheim world for your clan. ZeroTier provides stable P2P connections.</div>
                    </div>
                    
                    <div class="zt-server-card" style="background:rgba(20,20,40,0.8);border:1px solid rgba(0,255,136,0.3);border-radius:12px;padding:20px;cursor:pointer;transition:all 0.2s;" onclick="hostGameServer('custom')">
                      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <div style="width:48px;height:48px;background:linear-gradient(135deg,#8b5cf6,#00f5ff);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:24px;">+</div>
                        <div>
                          <div style="font-weight:600;color:#fff;">Custom Server</div>
                          <div style="font-size:12px;color:#9090b0;">Any game or service</div>
                        </div>
                      </div>
                      <div style="font-size:13px;color:#7070a0;">Configure any game server or service to use ZeroTier networking. Full control.</div>
                    </div>
                  </div>
                  
                  <div id="zt-active-servers" style="margin-top:30px;">
                    <h4 style="color:#c0c0e0;margin-bottom:12px;">Active Game Servers</h4>
                    <div style="color:#606080;font-size:14px;padding:20px;text-align:center;background:rgba(20,20,40,0.5);border-radius:8px;">No game servers running. Select a template above to get started.</div>
                  </div>
                </div>
                
                <!-- Connected Peers Tab -->
                <div class="zt-tab-content" id="zt-peers-panel" style="display:none;">
                  <h3 style="color:#00ff88;margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <img src="/grudgeos/assets/icons/generated/members.png" alt="" style="width:24px;height:24px;"> Network Peers
                  </h3>
                  <div id="zt-peers-list" style="display:grid;gap:12px;">
                    <div style="color:#606080;font-size:14px;padding:40px;text-align:center;background:rgba(20,20,40,0.5);border-radius:8px;">Not connected to any network. Join a network in the Connect tab to see peers.</div>
                  </div>
                </div>
              </div>
              
              <div class="zt-footer" style="padding:12px 20px;border-top:1px solid rgba(139,92,246,0.2);background:rgba(10,10,20,0.5);display:flex;justify-content:space-between;align-items:center;">
                <div style="color:#7070a0;font-size:12px;">
                  ZeroTier creates secure peer-to-peer networks. <a href="https://zerotier.com/download" target="_blank" style="color:#ffb900;">Download ZeroTier Client</a>
                </div>
                <div style="display:flex;gap:12px;">
                  <button onclick="refreshZeroTierStatus()" style="padding:8px 16px;background:rgba(139,92,246,0.2);border:1px solid rgba(139,92,246,0.3);border-radius:6px;color:#8b5cf6;cursor:pointer;font-size:13px;" data-testid="btn-refresh-zt">Refresh Status</button>
                </div>
              </div>
            </div>
          `;
        default:
          return '<div class="app-content">Content</div>';
      }
    }
    
    function setupWindowEvents(el, winId) {
      const titlebar = el.querySelector('.window-titlebar');
      const minimizeBtn = el.querySelector('.minimize');
      const maximizeBtn = el.querySelector('.maximize');
      const closeBtn = el.querySelector('.close');
      
      el.addEventListener('mousedown', () => focusWindow(winId));
      
      let dragStartX, dragStartY, winStartX, winStartY;
      let wasSnapped = false;
      let dragMoveThreshold = 5;
      let hasMoved = false;
      let pendingSnap = null;
      let cursorOffsetX = 0, cursorOffsetY = 0;
      
      const onDragMove = (e) => {
        const clientX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
        const clientY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
        
        const dx = clientX - dragStartX;
        const dy = clientY - dragStartY;
        
        if (!hasMoved && (Math.abs(dx) > dragMoveThreshold || Math.abs(dy) > dragMoveThreshold)) {
          hasMoved = true;
          if (wasSnapped) {
            const snappedWidth = windows[winId].width;
            const snappedHeight = windows[winId].height;
            const restoredWidth = windows[winId].savedDimensions?.width || snappedWidth;
            const restoredHeight = windows[winId].savedDimensions?.height || snappedHeight;
            
            const grabRatioX = snappedWidth > 0 ? Math.max(0, Math.min(1, cursorOffsetX / snappedWidth)) : 0.5;
            const grabRatioY = snappedHeight > 0 ? Math.max(0, Math.min(1, cursorOffsetY / snappedHeight)) : 0;
            
            clearWindowSplitState(el, winId);
            windows[winId].maximized = false;
            windows[winId].splitState = null;
            
            const viewport = document.getElementById('desktop-viewport');
            const viewRect = viewport.getBoundingClientRect();
            const relX = clientX - viewRect.left;
            const relY = clientY - viewRect.top;
            
            const newOffsetX = grabRatioX * restoredWidth;
            const newOffsetY = grabRatioY * restoredHeight;
            
            const taskbarHeight = 56;
            const minX = -restoredWidth + 100;
            const maxX = viewRect.width - restoredWidth;
            const maxY = Math.max(0, viewRect.height - taskbarHeight - restoredHeight);
            
            windows[winId].x = Math.max(minX, Math.min(maxX, relX - newOffsetX));
            windows[winId].y = Math.max(0, Math.min(maxY, relY - newOffsetY));
            el.style.left = windows[winId].x + 'px';
            el.style.top = windows[winId].y + 'px';
            dragStartX = clientX;
            dragStartY = clientY;
            winStartX = windows[winId].x;
            winStartY = windows[winId].y;
            return;
          }
        }
        
        if (!hasMoved) return;
        
        const viewport = document.getElementById('desktop-viewport');
        const viewRect = viewport.getBoundingClientRect();
        const snapThreshold = 30;
        const snapIndicator = document.getElementById('snap-indicator');
        
        pendingSnap = null;
        snapIndicator.style.display = 'none';
        
        const relX = clientX - viewRect.left;
        const relY = clientY - viewRect.top;
        
        if (relX >= 0 && relX <= viewRect.width && relY >= 0 && relY <= viewRect.height) {
          if (relX < snapThreshold) {
            pendingSnap = 'split-left';
            snapIndicator.style.display = 'block';
            snapIndicator.style.left = '0';
            snapIndicator.style.top = '0';
            snapIndicator.style.width = '50%';
            snapIndicator.style.height = 'calc(100% - 56px)';
          } else if (relX > viewRect.width - snapThreshold) {
            pendingSnap = 'split-right';
            snapIndicator.style.display = 'block';
            snapIndicator.style.left = '50%';
            snapIndicator.style.top = '0';
            snapIndicator.style.width = '50%';
            snapIndicator.style.height = 'calc(100% - 56px)';
          } else if (relY < snapThreshold) {
            pendingSnap = 'maximized';
            snapIndicator.style.display = 'block';
            snapIndicator.style.left = '0';
            snapIndicator.style.top = '0';
            snapIndicator.style.width = '100%';
            snapIndicator.style.height = 'calc(100% - 56px)';
          }
        }
        
        const taskbarHeight = 56;
        const winWidth = windows[winId].width || 400;
        const winHeight = windows[winId].height || 300;
        const minX = -winWidth + 100;
        const maxX = viewRect.width - winWidth;
        const maxY = Math.max(0, viewRect.height - taskbarHeight - winHeight);
        
        windows[winId].x = Math.max(minX, Math.min(maxX, winStartX + dx));
        windows[winId].y = Math.max(0, Math.min(maxY, winStartY + dy));
        
        el.style.left = windows[winId].x + 'px';
        el.style.top = windows[winId].y + 'px';
      };
      
      const onDragEnd = () => {
        const snapIndicator = document.getElementById('snap-indicator');
        snapIndicator.style.display = 'none';
        
        if (pendingSnap) {
          snapWindow(winId, pendingSnap);
        } else {
          // Snap window position to grid
          const snapped = GRID.snapPos(windows[winId].x, windows[winId].y);
          windows[winId].x = Math.max(0, snapped.x);
          windows[winId].y = Math.max(0, snapped.y);
          el.style.left = windows[winId].x + 'px';
          el.style.top = windows[winId].y + 'px';
        }
        pendingSnap = null;
        
        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('touchend', onDragEnd);
        document.body.style.userSelect = '';
        document.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = '');
      };
      
      const startDrag = (e) => {
        if (e.target.classList.contains('window-btn')) return;
        
        wasSnapped = !!(windows[winId].maximized || windows[winId].splitState);
        hasMoved = false;
        
        const clientX = e.clientX || (e.touches && e.touches[0].clientX) || 0;
        const clientY = e.clientY || (e.touches && e.touches[0].clientY) || 0;
        
        const viewport = document.getElementById('desktop-viewport');
        const viewRect = viewport.getBoundingClientRect();
        
        dragStartX = clientX;
        dragStartY = clientY;
        winStartX = windows[winId].x;
        winStartY = windows[winId].y;
        
        cursorOffsetX = (clientX - viewRect.left) - windows[winId].x;
        cursorOffsetY = (clientY - viewRect.top) - windows[winId].y;
        
        document.body.style.userSelect = 'none';
        document.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = 'none');
        
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchmove', onDragMove, { passive: true });
        document.addEventListener('touchend', onDragEnd);
        
        e.preventDefault();
      };
      
      titlebar.addEventListener('mousedown', startDrag);
      titlebar.addEventListener('touchstart', startDrag, { passive: false });
      
      el.querySelectorAll('.resize-handle').forEach(handle => {
        let isResizing = false;
        let resizeStartX, resizeStartY, startWidth, startHeight;
        
        handle.addEventListener('mousedown', (e) => {
          if (windows[winId].maximized) return;
          isResizing = true;
          resizeStartX = e.clientX;
          resizeStartY = e.clientY;
          startWidth = windows[winId].width;
          startHeight = windows[winId].height;
          e.preventDefault();
          e.stopPropagation();
          
          const onMouseMove = (e) => {
            if (!isResizing) return;
            
            const dx = e.clientX - resizeStartX;
            const dy = e.clientY - resizeStartY;
            const taskbarHeight = 56;
            
            if (handle.classList.contains('e') || handle.classList.contains('se')) {
              windows[winId].width = Math.max(400, startWidth + dx);
              el.style.width = windows[winId].width + 'px';
            }
            
            if (handle.classList.contains('s') || handle.classList.contains('se')) {
              const maxHeight = window.innerHeight - taskbarHeight - windows[winId].y;
              windows[winId].height = Math.max(300, Math.min(maxHeight, startHeight + dy));
              el.style.height = windows[winId].height + 'px';
            }
          };
          
          const onMouseUp = () => {
            isResizing = false;
            // Snap window size to grid, then clamp to max bounds
            const taskbarHeight = 56;
            const maxHeight = window.innerHeight - taskbarHeight - windows[winId].y;
            const snapped = GRID.snapSize(windows[winId].width, windows[winId].height);
            windows[winId].width = snapped.w;
            windows[winId].height = Math.min(snapped.h, maxHeight);
            el.style.width = windows[winId].width + 'px';
            el.style.height = windows[winId].height + 'px';
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
          };
          
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', onMouseUp);
        });
      });
      
      minimizeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        windows[winId].minimized = true;
        el.classList.add('minimized');
        updateTaskbar();
      });
      
      maximizeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        windows[winId].maximized = !windows[winId].maximized;
        el.classList.toggle('maximized');
      });
      
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const appId = windows[winId]?.appId;
        if (appId === 'gameeditor' && window.stopGameEditor) {
          window.stopGameEditor();
        }
        el.remove();
        delete windows[winId];
        updateTaskbar();
      });
      
      titlebar.addEventListener('dblclick', (e) => {
        if (e.target.classList.contains('window-btn')) return;
        maximizeBtn.click();
      });
      
      el.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showContextMenu(e.clientX, e.clientY, [
          { label: 'Minimize', icon: '', action: () => minimizeBtn.click() },
          { label: windows[winId].maximized ? 'Restore' : 'Maximize', icon: '', action: () => maximizeBtn.click() },
          { divider: true },
          { label: 'Split Left', icon: '', action: () => snapWindow(winId, 'split-left') },
          { label: 'Split Right', icon: '', action: () => snapWindow(winId, 'split-right') },
          { divider: true },
          { label: 'Close', icon: '', action: () => closeBtn.click() }
        ]);
      });
    }
    
    function clearWindowSplitState(el, winId) {
      el.classList.remove('maximized', 'split-left', 'split-right', 'split-top', 'split-bottom');
      const win = windows[winId];
      
      if (win.savedDimensions) {
        win.x = win.savedDimensions.x;
        win.y = win.savedDimensions.y;
        win.width = win.savedDimensions.width;
        win.height = win.savedDimensions.height;
        win.savedDimensions = null;
      }
      
      el.style.left = win.x + 'px';
      el.style.top = win.y + 'px';
      el.style.width = win.width + 'px';
      el.style.height = win.height + 'px';
    }
    
    function snapWindow(winId, snapType) {
      const el = document.getElementById(winId);
      if (!el) return;
      
      const viewport = document.getElementById('desktop-viewport');
      const viewRect = viewport.getBoundingClientRect();
      const taskbarHeight = 56;
      
      if (!windows[winId].savedDimensions) {
        windows[winId].savedDimensions = {
          x: windows[winId].x,
          y: windows[winId].y,
          width: windows[winId].width,
          height: windows[winId].height
        };
      }
      
      el.classList.remove('maximized', 'split-left', 'split-right', 'split-top', 'split-bottom');
      el.classList.add(snapType);
      windows[winId].splitState = snapType;
      windows[winId].maximized = (snapType === 'maximized');
      
      switch(snapType) {
        case 'split-left':
          windows[winId].x = 0;
          windows[winId].y = 0;
          windows[winId].width = Math.floor(viewRect.width / 2);
          windows[winId].height = viewRect.height - taskbarHeight;
          break;
        case 'split-right':
          windows[winId].x = Math.floor(viewRect.width / 2);
          windows[winId].y = 0;
          windows[winId].width = Math.floor(viewRect.width / 2);
          windows[winId].height = viewRect.height - taskbarHeight;
          break;
        case 'maximized':
          windows[winId].x = 0;
          windows[winId].y = 0;
          windows[winId].width = viewRect.width;
          windows[winId].height = viewRect.height - taskbarHeight;
          break;
      }
      
      focusWindow(winId);
    }
    
    function focusWindow(winId) {
      focusedWindowId = winId;
      document.querySelectorAll('.window').forEach(w => w.classList.remove('focused'));
      const el = document.getElementById(winId);
      if (el) {
        el.classList.add('focused');
        el.style.zIndex = ++zIndexCounter;
      }
      updateTaskbar();
    }
    
    function updateTaskbar() {
      const container = document.getElementById('running-apps');
      container.innerHTML = Object.values(windows).map(win => `
        <div class="taskbar-app ${win.id === focusedWindowId && !win.minimized ? 'active' : ''}" 
             data-winid="${win.id}" data-testid="taskbar-${win.appId}">
          <span class="taskbar-app-icon">${makeIconImg(win.iconPath, 20)}</span>
          <span class="taskbar-app-title">${win.title}</span>
        </div>
      `).join('');
      
      container.querySelectorAll('.taskbar-app').forEach(item => {
        item.addEventListener('click', () => {
          const winId = item.dataset.winid;
          const win = windows[winId];
          if (win.minimized) {
            win.minimized = false;
            document.getElementById(winId).classList.remove('minimized');
            focusWindow(winId);
          } else if (focusedWindowId === winId) {
            win.minimized = true;
            document.getElementById(winId).classList.add('minimized');
          } else {
            focusWindow(winId);
          }
          updateTaskbar();
        });
        
        item.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          const winId = item.dataset.winid;
          showContextMenu(e.clientX, e.clientY, [
            { label: 'Restore', icon: '', action: () => {
              windows[winId].minimized = false;
              document.getElementById(winId).classList.remove('minimized');
              focusWindow(winId);
              updateTaskbar();
            }},
            { label: 'Close', icon: '', action: () => {
              document.getElementById(winId).remove();
              delete windows[winId];
              updateTaskbar();
            }}
          ]);
        });
      });
    }
    
    function toggleLauncher() {
      launcherOpen = !launcherOpen;
      document.getElementById('launcher-menu').style.display = launcherOpen ? 'block' : 'none';
    }
    
    function showContextMenu(x, y, items) {
      const menu = document.getElementById('context-menu');
      menu.innerHTML = items.map(item => {
        if (item.divider) return '<div class="context-divider"></div>';
        const iconHtml = item.iconPath ? makeIconImg(item.iconPath, 16) : (item.icon || '');
        return `<div class="context-item" data-action="${item.label}">
          <span class="ctx-icon">${iconHtml}</span>
          <span>${item.label}</span>
        </div>`;
      }).join('');
      
      menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
      menu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
      menu.style.display = 'block';
      
      menu.querySelectorAll('.context-item').forEach((el, i) => {
        const item = items.filter(it => !it.divider)[i];
        if (item) {
          el.addEventListener('click', () => {
            item.action();
            menu.style.display = 'none';
          });
        }
      });
    }
    
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = 
        now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }
    
    function setupEventListeners() {
      document.getElementById('launcher-btn').addEventListener('click', toggleLauncher);
      
      document.addEventListener('click', (e) => {
        const contextMenu = document.getElementById('context-menu');
        const launcherMenu = document.getElementById('launcher-menu');
        
        if (contextMenu && !contextMenu.contains(e.target)) {
          contextMenu.style.display = 'none';
        }
        
        if (launcherMenu && !launcherMenu.contains(e.target) && !document.getElementById('launcher-btn').contains(e.target)) {
          launcherOpen = false;
          launcherMenu.style.display = 'none';
        }
      });
      
      document.getElementById('desktop').addEventListener('contextmenu', (e) => {
        if (e.target.id === 'desktop' || e.target.closest('#desktop') && !e.target.closest('.desktop-icon')) {
          e.preventDefault();
          showContextMenu(e.clientX, e.clientY, [
            { label: 'Organize Icons', iconPath: 'ui-layout', action: organizeDesktopIcons },
            { label: 'New Folder', iconPath: 'file-manager', action: () => {} },
            { label: 'Refresh', iconPath: 'repeating', action: () => location.reload() },
            { divider: true },
            { label: 'Display Settings', iconPath: 'settings', action: () => openApp('settings') },
            { label: 'Terminal', iconPath: 'terminal', action: () => openApp('terminal') }
          ]);
        }
      });
      
      document.getElementById('desktop').addEventListener('click', (e) => {
        if (e.target.id === 'desktop') {
          document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
        }
      });
      
      document.getElementById('consoleToggle').addEventListener('click', toggleConsole);
      
      setupTrayIcons();
      
      document.getElementById('btn-login').addEventListener('click', handlePuterLogin);
      document.getElementById('btn-signout').addEventListener('click', handlePuterLogout);
      
      document.querySelectorAll('.console-tab').forEach(tab => {
        tab.addEventListener('click', () => switchConsoleTab(tab.dataset.tab));
      });
      
      // Section header toggles
      document.querySelectorAll('.launcher-section-header').forEach(header => {
        header.addEventListener('click', () => {
          const section = header.nextElementSibling;
          const arrow = header.querySelector('.section-arrow');
          section.classList.toggle('open');
          arrow.textContent = section.classList.contains('open') ? '' : '';
        });
      });
      
      // Channel category toggles
      document.querySelectorAll('.category-header').forEach(header => {
        header.addEventListener('click', () => {
          const channels = header.nextElementSibling;
          const arrow = header.querySelector('.category-arrow');
          channels.classList.toggle('open');
          arrow.textContent = channels.classList.contains('open') ? '' : '';
        });
      });
      
      // Channel item clicks
      document.querySelectorAll('.channel-quick-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const channelId = item.dataset.channel;
          const channelType = item.dataset.type;
          openChannel(channelId, channelType);
          toggleLauncher();
        });
      });
      
      // Search functionality
      document.getElementById('launcher-search-input').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        filterLauncherItems(query);
      });
      
      // Load user info
      loadUserInfo();
    }
    
    function filterLauncherItems(query) {
      if (!query) {
        document.querySelectorAll('.launcher-app, .channel-quick-item').forEach(el => {
          el.style.display = '';
        });
        return;
      }
      
      document.querySelectorAll('.launcher-app').forEach(app => {
        const name = app.querySelector('.launcher-app-name').textContent.toLowerCase();
        app.style.display = name.includes(query) ? '' : 'none';
      });
      
      document.querySelectorAll('.channel-quick-item').forEach(item => {
        const name = item.querySelector('.channel-name').textContent.toLowerCase();
        item.style.display = name.includes(query) ? '' : 'none';
      });
    }
    
    async function loadUserInfo() {
      if (!window.PuterAuth) {
        updateAuthUI({ isAuthenticated: false, isOnline: false });
        return;
      }
      
      const result = await window.PuterAuth.init();
      updateAuthUI({
        user: result.user,
        isAuthenticated: result.authenticated,
        isOnline: !result.offline
      });
      
      window.PuterAuth.onAuthChange(updateAuthUI);
    }
    
    function updateAuthUI(state) {
      const nameEl = document.getElementById('launcher-user-name');
      const avatarEl = document.getElementById('launcher-user-avatar');
      const statusEl = document.getElementById('launcher-user-status');
      const loginBtn = document.getElementById('btn-login');
      const logoutBtn = document.getElementById('btn-signout');
      
      if (state.isAuthenticated && state.user) {
        nameEl.textContent = state.user.username || 'User';
        avatarEl.textContent = (state.user.username || 'U')[0].toUpperCase();
        statusEl.textContent = 'Online';
        statusEl.className = 'user-status-indicator online';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'flex';
      } else {
        nameEl.textContent = 'Guest';
        avatarEl.textContent = 'G';
        statusEl.textContent = state.isOnline ? 'Guest Mode' : 'Offline';
        statusEl.className = 'user-status-indicator ' + (state.isOnline ? 'away' : 'offline');
        loginBtn.style.display = 'flex';
        logoutBtn.style.display = 'none';
      }
    }
    
    async function handlePuterLogin() {
      if (!window.PuterAuth) {
        showNotification('Puter services not available', 'error');
        return;
      }
      const result = await window.PuterAuth.login();
      if (result.success) {
        showNotification(`Welcome, ${result.user.username}!`, 'success');
      }
    }
    
    async function handlePuterLogout() {
      if (!window.PuterAuth) return;
      const result = await window.PuterAuth.logout();
      if (result.success) {
        showNotification('Signed out successfully', 'info');
      }
    }
    
    const VMSound = {
      ctx: null,
      enabled: true,
      volume: 0.3,
      
      init() {
        if (!this.ctx) {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        return this.ctx;
      },
      
      play(type) {
        if (!this.enabled) return;
        try {
          const ctx = this.init();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          
          switch(type) {
            case 'notification':
              osc.type = 'sine';
              osc.frequency.setValueAtTime(880, ctx.currentTime);
              osc.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.1);
              gain.gain.setValueAtTime(this.volume, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 0.2);
              break;
            case 'error':
              osc.type = 'square';
              osc.frequency.setValueAtTime(200, ctx.currentTime);
              osc.frequency.setValueAtTime(150, ctx.currentTime + 0.1);
              gain.gain.setValueAtTime(this.volume * 0.5, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 0.3);
              break;
            case 'success':
              osc.type = 'sine';
              osc.frequency.setValueAtTime(523, ctx.currentTime);
              osc.frequency.setValueAtTime(659, ctx.currentTime + 0.08);
              osc.frequency.setValueAtTime(784, ctx.currentTime + 0.16);
              gain.gain.setValueAtTime(this.volume, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 0.3);
              break;
            case 'click':
              osc.type = 'sine';
              osc.frequency.setValueAtTime(1000, ctx.currentTime);
              gain.gain.setValueAtTime(this.volume * 0.3, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.05);
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 0.05);
              break;
            case 'ai-response':
              osc.type = 'triangle';
              osc.frequency.setValueAtTime(440, ctx.currentTime);
              osc.frequency.exponentialRampToValueAtTime(880, ctx.currentTime + 0.15);
              gain.gain.setValueAtTime(this.volume * 0.4, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
              osc.start(ctx.currentTime);
              osc.stop(ctx.currentTime + 0.25);
              break;
          }
        } catch(e) {
          console.log('Audio not available:', e);
        }
      },
      
      toggle() {
        this.enabled = !this.enabled;
        return this.enabled;
      }
    };
    
    let networkOnline = true;
    let aiOperations = [];
    
    function setupTrayIcons() {
      const brainIcon = document.getElementById('tray-brain');
      const robotIcon = document.getElementById('tray-robot');
      const audioIcon = document.getElementById('tray-audio');
      const satelliteIcon = document.getElementById('tray-satellite');
      
      brainIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        VMSound.play('click');
        showContextMenu(e.clientX, e.clientY - 150, [
          { label: 'AI Operations', iconPath: 'ai-subsystem', action: () => openApp('taskmanager') },
          { label: 'Agent Console', iconPath: 'ai-assistant', action: () => toggleConsole() },
          { divider: true },
          { label: `Active Tasks: ${aiOperations.length}`, iconPath: 'task-manager', action: () => {} },
          { label: 'View All Agents', iconPath: 'agent-manager', action: () => openApp('agentmanager') }
        ]);
      });
      
      robotIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        VMSound.play('click');
        openCloudPilotChat();
      });
      
      audioIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        const enabled = VMSound.toggle();
        audioIcon.innerHTML = enabled ? '<span style="color:#00ff88;"></span>' : '<span style="color:#ff006e;"></span>';
        audioIcon.title = enabled ? 'System Audio (On)' : 'System Audio (Off)';
        audioIcon.dataset.enabled = enabled ? 'true' : 'false';
        if (enabled) VMSound.play('success');
      });
      audioIcon.dataset.enabled = 'true';
      
      satelliteIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        VMSound.play('click');
        showContextMenu(e.clientX, e.clientY - 120, [
          { label: networkOnline ? '<span style="color:#00ff88;"> Online</span>' : '<span style="color:#ff006e;"> Offline</span>', icon: '', action: () => {} },
          { divider: true },
          { label: networkOnline ? 'Go Offline' : 'Go Online', iconPath: networkOnline ? 'offline' : 'online', action: () => toggleNetworkMode() },
          { label: 'Network Tools', iconPath: 'network-tools', action: () => openApp('networktools') },
          { label: 'Connection Status', iconPath: 'network', action: () => showNetworkStatus() }
        ]);
      });
    }
    
    function openCloudPilotChat() {
      VMSound.play('notification');
      
      const winId = 'cloudpilot_chat';
      if (windows[winId]) {
        focusWindow(winId);
        return;
      }
      
      const windowData = {
        id: winId,
        appId: 'cloudpilot',
        title: 'CloudPilot AI Chat',
        iconPath: 'ai-assistant',
        color: 'linear-gradient(135deg, #8b5cf6, #00f5ff)',
        x: 200,
        y: 100,
        width: 500,
        height: 600,
        minimized: false,
        maximized: false
      };
      
      windows[winId] = windowData;
      
      const container = document.getElementById('windows-container');
      const el = document.createElement('div');
      el.className = 'window';
      el.id = winId;
      el.style.cssText = `left:${windowData.x}px; top:${windowData.y}px; width:${windowData.width}px; height:${windowData.height}px; z-index:${++zIndexCounter}`;
      
      el.innerHTML = `
        <div class="window-titlebar">
          <span class="window-icon">${makeIconImg('ai-assistant', 20)}</span>
          <span class="window-title">CloudPilot AI Chat</span>
          <div class="window-controls">
            <div class="window-btn minimize"></div>
            <div class="window-btn maximize"></div>
            <div class="window-btn close"></div>
          </div>
        </div>
        <div class="window-content" style="display:flex; flex-direction:column; background:var(--bg-dark);">
          <div id="cloudpilot-messages" style="flex:1; overflow-y:auto; padding:16px;">
            <div style="text-align:center; color:var(--text-muted); padding:20px;">
              <div style="margin-bottom:16px;">${makeIconImg('ai-assistant', 64)}</div>
              <div style="font-size:18px; color:var(--neon-cyan); margin-bottom:8px;">CloudPilot AI</div>
              <div>Your AI assistant for cloud operations and code generation.</div>
              <div style="margin-top:16px; color:var(--text-secondary);">Ask me anything about your project!</div>
            </div>
          </div>
          <div style="padding:12px; border-top:1px solid var(--border); display:flex; gap:8px;">
            <input type="text" id="cloudpilot-input" placeholder="Type your message..." style="flex:1; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:12px; color:var(--text); font-size:14px;" data-testid="input-cloudpilot">
            <button onclick="sendCloudPilotMessage()" style="background:linear-gradient(135deg, var(--neon-purple), var(--neon-cyan)); border:none; border-radius:8px; padding:12px 20px; color:white; cursor:pointer; font-weight:600;" data-testid="btn-send-cloudpilot">Send</button>
          </div>
        </div>
        <div class="resize-handle se"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle s"></div>
      `;
      
      container.appendChild(el);
      setupWindowEvents(el, winId);
      updateTaskbar();
      focusWindow(winId);
      
      const input = document.getElementById('cloudpilot-input');
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') sendCloudPilotMessage();
      });
    }
    
    async function sendCloudPilotMessage() {
      const input = document.getElementById('cloudpilot-input');
      const messages = document.getElementById('cloudpilot-messages');
      const userMessage = input.value.trim();
      
      if (!userMessage) return;
      input.value = '';
      
      messages.innerHTML += `
        <div style="display:flex; justify-content:flex-end; margin-bottom:12px;">
          <div style="background:linear-gradient(135deg, var(--neon-purple), var(--neon-cyan)); padding:12px 16px; border-radius:16px 16px 4px 16px; max-width:80%;">
            ${escapeHtml(userMessage)}
          </div>
        </div>
      `;
      messages.scrollTop = messages.scrollHeight;
      
      const loadingId = 'loading_' + Date.now();
      messages.innerHTML += `
        <div id="${loadingId}" style="display:flex; margin-bottom:12px;">
          <div style="background:var(--bg-card); border:1px solid var(--border); padding:12px 16px; border-radius:16px 16px 16px 4px; color:var(--text-muted);">
            <span class="typing-indicator">Thinking...</span>
          </div>
        </div>
      `;
      messages.scrollTop = messages.scrollHeight;
      
      try {
        if (typeof puter === 'undefined') throw new Error('AI service not available');
        const response = await puter.ai.chat(userMessage, { model: 'claude-3-5-sonnet' });
        const loading = document.getElementById(loadingId);
        if (loading) loading.remove();
        
        VMSound.play('ai-response');
        
        messages.innerHTML += `
          <div style="display:flex; margin-bottom:12px;">
            <div style="background:var(--bg-card); border:1px solid var(--border); padding:12px 16px; border-radius:16px 16px 16px 4px; max-width:80%;">
              <div style="color:var(--neon-cyan); font-size:12px; margin-bottom:6px;"><img src="/grudgeos/assets/icons/generated/ai-assistant.png" alt="AI" style="width:16px;height:16px;border-radius:3px;margin-right:4px;vertical-align:middle;"> CloudPilot</div>
              <div style="white-space:pre-wrap;">${escapeHtml(response)}</div>
            </div>
          </div>
        `;
        messages.scrollTop = messages.scrollHeight;
      } catch (e) {
        const loading = document.getElementById(loadingId);
        if (loading) loading.remove();
        VMSound.play('error');
        
        messages.innerHTML += `
          <div style="display:flex; margin-bottom:12px;">
            <div style="background:rgba(255,0,100,0.1); border:1px solid var(--neon-pink); padding:12px 16px; border-radius:16px 16px 16px 4px;">
              <div style="color:var(--neon-pink);">Error: ${e.message || 'Could not get AI response'}</div>
            </div>
          </div>
        `;
        messages.scrollTop = messages.scrollHeight;
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function toggleNetworkMode() {
      networkOnline = !networkOnline;
      const icon = document.getElementById('tray-satellite');
      icon.style.color = networkOnline ? 'var(--neon-green)' : 'var(--neon-pink)';
      
      VMSound.play(networkOnline ? 'success' : 'error');
      logToConsole('system', `Network mode: ${networkOnline ? 'Online' : 'Offline'}`);
      
      showNotification(networkOnline ? 'Network Online' : 'Network Offline', networkOnline ? 'success' : 'warning');
    }
    
    function showNetworkStatus() {
      const info = {
        online: navigator.onLine,
        connection: navigator.connection ? {
          type: navigator.connection.effectiveType,
          downlink: navigator.connection.downlink + ' Mbps'
        } : 'N/A'
      };
      
      logToConsole('info', `Network Status: ${JSON.stringify(info, null, 2)}`);
      toggleConsole();
    }
    
    function showNotification(title, type = 'info') {
      const container = document.getElementById('notification-container');
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.innerHTML = `<span>${type === 'success' ? '' : type === 'warning' ? '' : ''}</span> ${title}`;
      notif.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 12px 20px; 
        background: var(--bg-glass); border: 1px solid ${type === 'success' ? 'var(--neon-green)' : type === 'warning' ? 'var(--neon-orange)' : 'var(--neon-cyan)'};
        border-radius: 8px; color: var(--text); z-index: 10001; animation: slideIn 0.3s ease;
      `;
      container.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }
    
    function addAIOperation(name, status = 'running') {
      aiOperations.push({ name, status, time: new Date() });
      updateBrainIndicator();
    }
    
    function updateBrainIndicator() {
      const brain = document.getElementById('tray-brain');
      const activeCount = aiOperations.filter(op => op.status === 'running').length;
      if (activeCount > 0) {
        brain.style.animation = 'pulse 1s infinite';
      } else {
        brain.style.animation = '';
      }
    }
    
    function openChannel(channelId, channelType) {
      logToConsole('event', `Opening channel: ${channelId} (${channelType})`);
      
      const channelNames = {
        'general-chat': 'General Chat',
        'voice-lounge': 'Voice Lounge',
        'video-room': 'Video Room',
        'code-review': 'Code Review',
        'pair-programming': 'Pair Programming',
        'live-coding': 'Live Coding',
        'ai-chat': 'AI Chat',
        'agent-collab': 'Agent Collaboration',
        'watch-party': 'Watch Party',
        'screen-share': 'Screen Share',
        'camera-chat': 'Camera Chat'
      };
      
      const channelIcons = {
        'text': 'TX',
        'voice': 'VC',
        'video': 'VD',
        'stream': 'ST'
      };
      
      const winId = 'channel_' + channelId;
      
      if (windows[winId]) {
        focusWindow(winId);
        return;
      }
      
      const windowData = {
        id: winId,
        appId: 'channel',
        title: channelNames[channelId] || channelId,
        icon: channelIcons[channelType] || '',
        color: 'linear-gradient(135deg, #8b5cf6, #00f5ff)',
        x: 150 + Math.random() * 100,
        y: 80 + Math.random() * 50,
        width: 450,
        height: 550,
        minimized: false,
        maximized: false
      };
      
      windows[winId] = windowData;
      createChannelWindow(windowData, channelId, channelType);
      updateTaskbar();
      focusWindow(winId);
    }
    
    function createChannelWindow(win, channelId, channelType) {
      const container = document.getElementById('windows-container');
      const el = document.createElement('div');
      el.className = 'window channel-window';
      el.id = win.id;
      el.style.left = win.x + 'px';
      el.style.top = win.y + 'px';
      el.style.width = win.width + 'px';
      el.style.height = win.height + 'px';
      el.style.zIndex = ++zIndexCounter;
      
      el.innerHTML = `
        <div class="window-titlebar" style="background: linear-gradient(90deg, rgba(139, 92, 246, 0.4), rgba(0, 245, 255, 0.3));">
          <span class="window-icon">${win.icon}</span>
          <span class="window-title">${win.title}</span>
          <span class="channel-type-tag">${channelType.toUpperCase()}</span>
          <div class="window-controls">
            <div class="window-btn minimize" data-testid="btn-minimize-${win.id}"></div>
            <div class="window-btn maximize" data-testid="btn-maximize-${win.id}"></div>
            <div class="window-btn close" data-testid="btn-close-${win.id}"></div>
          </div>
        </div>
        <div class="window-content channel-content">
          ${getChannelContent(channelId, channelType)}
        </div>
        <div class="resize-handle se"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle s"></div>
      `;
      
      container.appendChild(el);
      setupWindowEvents(el, win.id);
      setupChannelEvents(el, channelId, channelType);
    }
    
    function getChannelContent(channelId, channelType) {
      const commonHeader = `
        <div class="channel-panel-header">
          <div class="channel-members-count">
            <img src="/grudgeos/assets/icons/generated/members.png" alt="MX" style="width:16px;height:16px;border-radius:3px;vertical-align:middle;"> <span id="member-count-${channelId}">0</span> online
          </div>
          <div class="channel-actions">
            ${channelType === 'voice' || channelType === 'video' ? 
              `<button class="channel-action-btn" data-action="mute" title="Mute" data-testid="btn-mute-${channelId}"><img src="/grudgeos/assets/icons/generated/mute.png" alt="M" style="width:20px;height:20px;"></button>
               <button class="channel-action-btn" data-action="deafen" title="Deafen" data-testid="btn-deafen-${channelId}"><img src="/grudgeos/assets/icons/generated/deafen.png" alt="D" style="width:20px;height:20px;"></button>` : ''}
            ${channelType === 'video' ? 
              `<button class="channel-action-btn" data-action="camera" title="Camera" data-testid="btn-camera-${channelId}"><img src="/grudgeos/assets/icons/generated/camera.png" alt="C" style="width:20px;height:20px;"></button>` : ''}
            ${channelType === 'stream' ? 
              `<button class="channel-action-btn primary" data-action="go-live" title="Go Live" data-testid="btn-live-${channelId}"><span style="color:#ff006e;"></span> GO LIVE</button>` : ''}
            <button class="channel-action-btn" data-action="settings" title="Settings" data-testid="btn-settings-${channelId}"><img src="/grudgeos/assets/icons/generated/settings.png" alt="S" style="width:20px;height:20px;"></button>
          </div>
        </div>
      `;
      
      if (channelType === 'voice') {
        return `
          ${commonHeader}
          <div class="voice-participants-grid" id="participants-${channelId}">
            <div class="voice-participant self">
              <img src="/grudgeos/assets/icons/generated/user-avatar.png" alt="U" class="participant-avatar" style="width:48px;height:48px;border-radius:50%;">
              <div class="participant-name">You</div>
              <div class="participant-status">
                <span class="status-icon muted" style="color:#ff006e;"></span>
              </div>
            </div>
          </div>
          <div class="voice-controls-bar">
            <button class="voice-control" data-action="mute" data-testid="btn-toggle-mute-${channelId}">
              <img src="/grudgeos/assets/icons/generated/mute.png" alt="M" style="width:20px;height:20px;">
              <span class="label">Mute</span>
            </button>
            <button class="voice-control danger" data-action="disconnect" data-testid="btn-disconnect-${channelId}">
              <img src="/grudgeos/assets/icons/generated/disconnect.png" alt="X" style="width:20px;height:20px;">
              <span class="label">Leave</span>
            </button>
          </div>
        `;
      }
      
      if (channelType === 'video') {
        return `
          ${commonHeader}
          <div class="video-grid" id="video-${channelId}">
            <div class="video-tile self">
              <video id="local-video-${channelId}" autoplay muted playsinline></video>
              <div class="video-label">You</div>
            </div>
          </div>
          <div class="video-controls-bar">
            <button class="video-control" data-action="mute" data-testid="btn-toggle-mute-${channelId}">
              <img src="/grudgeos/assets/icons/generated/mute.png" alt="M" style="width:20px;height:20px;">
            </button>
            <button class="video-control" data-action="camera" data-testid="btn-toggle-camera-${channelId}">
              <img src="/grudgeos/assets/icons/generated/camera.png" alt="CA" style="width:20px;height:20px;">
            </button>
            <button class="video-control" data-action="screen" data-testid="btn-toggle-screen-${channelId}">
              <img src="/grudgeos/assets/icons/generated/screen-share.png" alt="SC" style="width:20px;height:20px;">
            </button>
            <button class="video-control danger" data-action="disconnect" data-testid="btn-disconnect-${channelId}">
              <img src="/grudgeos/assets/icons/generated/disconnect.png" alt="X" style="width:20px;height:20px;">
            </button>
          </div>
        `;
      }
      
      if (channelType === 'stream') {
        return `
          ${commonHeader}
          <div class="stream-layout">
            <div class="stream-player" id="stream-${channelId}">
              <div class="stream-placeholder">
                <img src="/grudgeos/assets/icons/generated/live-stream.png" alt="ST" style="width:40px;height:40px;border-radius:8px;">
                <p>No active stream</p>
                <button class="btn-start-stream" data-testid="btn-start-stream-${channelId}">Start Streaming</button>
              </div>
            </div>
            <div class="stream-chat">
              <div class="stream-chat-messages" id="stream-chat-${channelId}"></div>
              <div class="stream-chat-input">
                <input type="text" placeholder="Send a message..." data-testid="input-stream-chat-${channelId}">
                <button data-testid="btn-send-stream-${channelId}"><img src="/grudgeos/assets/icons/generated/deploy.png" alt=">" style="width:16px;height:16px;border-radius:3px;"></button>
              </div>
            </div>
          </div>
        `;
      }
      
      // Default: text channel
      return `
        ${commonHeader}
        <div class="chat-messages" id="messages-${channelId}">
          <div class="chat-welcome">
            <div class="welcome-icon"><img src="/grudgeos/assets/icons/generated/grudge-chat.png" alt="CH" style="width:40px;height:40px;border-radius:8px;"></div>
            <h3>Welcome to #${channelId.replace(/-/g, ' ')}</h3>
            <p>This is the beginning of the channel. Start a conversation!</p>
          </div>
        </div>
        <div class="chat-input-container">
          <button class="input-action" data-action="attach" data-testid="btn-attach-${channelId}"><img src="/grudgeos/assets/icons/generated/file-manager.png" alt="+" style="width:18px;height:18px;border-radius:3px;"></button>
          <button class="input-action" data-action="emoji" data-testid="btn-emoji-${channelId}" style="font-size:16px;">:)</button>
          <input type="text" class="chat-input" placeholder="Type a message..." id="input-${channelId}" data-testid="input-message-${channelId}">
          <button class="send-button" data-testid="btn-send-${channelId}"><img src="/grudgeos/assets/icons/generated/deploy.png" alt=">" style="width:18px;height:18px;border-radius:3px;"></button>
        </div>
      `;
    }
    
    function setupChannelEvents(el, channelId, channelType) {
      // Chat input handling
      const chatInput = el.querySelector('.chat-input');
      const sendBtn = el.querySelector('.send-button');
      
      if (chatInput && sendBtn) {
        const sendMessage = () => {
          const content = chatInput.value.trim();
          if (!content) return;
          
          appendChatMessage(channelId, {
            author: { name: 'You', avatar: '<img src="/grudgeos/assets/icons/generated/user-avatar.png" alt="U" style="width:32px;height:32px;border-radius:50%;">' },
            content,
            timestamp: new Date()
          });
          
          chatInput.value = '';
          
          // AI response for AI channels
          if (channelId === 'ai-chat' || channelId === 'agent-collab') {
            simulateAIResponse(channelId, content);
          }
        };
        
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') sendMessage();
        });
      }
      
      // Voice/Video controls
      el.querySelectorAll('.voice-control, .video-control').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.dataset.action;
          handleMediaControl(action, channelId, channelType, btn);
        });
      });
      
      // Stream start
      const startStreamBtn = el.querySelector('.btn-start-stream');
      if (startStreamBtn) {
        startStreamBtn.addEventListener('click', () => startStreaming(channelId));
      }
    }
    
    function appendChatMessage(channelId, message) {
      const container = document.getElementById(`messages-${channelId}`);
      if (!container) return;
      
      const msgEl = document.createElement('div');
      msgEl.className = 'chat-message';
      msgEl.innerHTML = `
        <div class="message-avatar">${message.author.avatar || message.author.name[0]}</div>
        <div class="message-body">
          <div class="message-header">
            <span class="message-author">${message.author.name}</span>
            <span class="message-time">${formatTime(message.timestamp)}</span>
          </div>
          <div class="message-content">${escapeHtml(message.content)}</div>
        </div>
      `;
      
      container.appendChild(msgEl);
      container.scrollTop = container.scrollHeight;
    }
    
    function formatTime(date) {
      return new Date(date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    function escapeHtml(text) {
      return text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    
    async function simulateAIResponse(channelId, userMessage) {
      setTimeout(() => {
        appendChatMessage(channelId, {
          author: { name: 'AI Assistant', avatar: '<img src="/grudgeos/assets/icons/generated/ai-assistant.png" alt="AI" style="width:32px;height:32px;border-radius:50%;">' },
          content: `I received your message: "${userMessage}". How can I help you further?`,
          timestamp: new Date()
        });
      }, 1000);
    }
    
    function handleMediaControl(action, channelId, channelType, btn) {
      logToConsole('event', `Media control: ${action} on ${channelId}`);
      
      if (action === 'disconnect') {
        const winId = 'channel_' + channelId;
        const el = document.getElementById(winId);
        if (el) {
          el.remove();
          delete windows[winId];
          updateTaskbar();
        }
      } else {
        btn.classList.toggle('active');
      }
    }
    
    async function startStreaming(channelId) {
      logToConsole('event', `Starting stream on ${channelId}`);
      
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: { cursor: 'always' },
          audio: true
        });
        
        const player = document.getElementById(`stream-${channelId}`);
        if (player) {
          player.innerHTML = `
            <video autoplay playsinline></video>
            <div class="stream-overlay">
              <span class="live-badge"><span style="color:#ff006e;"></span> LIVE</span>
              <button class="stop-stream-btn" data-testid="btn-stop-stream-${channelId}">Stop Streaming</button>
            </div>
          `;
          
          const video = player.querySelector('video');
          video.srcObject = stream;
          
          player.querySelector('.stop-stream-btn').addEventListener('click', () => {
            stream.getTracks().forEach(track => track.stop());
            player.innerHTML = `
              <div class="stream-placeholder">
                <span></span>
                <p>Stream ended</p>
                <button class="btn-start-stream" data-testid="btn-start-stream-${channelId}">Start Streaming</button>
              </div>
            `;
          });
        }
        
        logToConsole('ai', `Stream started on channel: ${channelId}`);
      } catch (e) {
        logToConsole('error', `Failed to start stream: ${e.message}`);
      }
    }
    
    let consoleVisible = false;
    let canvasVisible = false;
    let consoleLogs = [];
    
    const GrudgeDefinitions = {
      terms: {
        'swarm': { category: 'agents', desc: 'Multiple AI agents working together on a task', related: ['orchestrator', 'delegation'] },
        'orchestrator': { category: 'agents', desc: 'The main AI agent that coordinates and delegates to other agents', related: ['swarm', 'task'] },
        'observer': { category: 'agents', desc: 'An AI that watches and logs all activity for pattern recognition', related: ['logging', 'patterns'] },
        'canvas': { category: 'ui', desc: 'Visual space where AI can draw diagrams and visualizations', related: ['visualization', 'communication'] },
        'console': { category: 'ui', desc: 'Log viewer for AI activity and messages', related: ['logging', 'debug'] },
        'insight': { category: 'ai', desc: 'A learned pattern or observation from user behavior', related: ['learning', 'patterns'] },
        'task': { category: 'workflow', desc: 'A unit of work that can be delegated to agents', related: ['swarm', 'delegation'] },
        'memory': { category: 'storage', desc: 'Persistent storage of learned behaviors and preferences', related: ['puter.kv', 'learning'] }
      },
      
      get(term) {
        return this.terms[term.toLowerCase()] || null;
      },
      
      render() {
        return Object.entries(this.terms).map(([term, data]) => `
          <div class="console-log" style="border-left-color: var(--neon-purple);">
            <div class="console-log-header">
              <span class="console-log-type" style="color: var(--neon-purple);">${data.category}</span>
            </div>
            <div style="font-weight: 600; margin-bottom: 4px;">${term}</div>
            <div class="console-log-msg">${data.desc}</div>
            <div style="margin-top: 6px; font-size: 10px; color: var(--text-muted);">
              Related: ${data.related.join(', ')}
            </div>
          </div>
        `).join('');
      }
    };
    
    function toggleConsole() {
      consoleVisible = !consoleVisible;
      document.getElementById('ai-console').classList.toggle('visible', consoleVisible);
      document.getElementById('consoleToggle').classList.toggle('active', consoleVisible);
    }
    
    function toggleCanvas() {
      canvasVisible = !canvasVisible;
      document.getElementById('ai-canvas').classList.toggle('visible', canvasVisible);
      if (canvasVisible) {
        if (activeCanvasTab === 'agents') {
          initCanvasAgents();
        } else {
          initCanvasScripts();
        }
      }
    }
    
    const canvasScripts = [
      {
        id: 'fibonacci',
        name: 'Fibonacci Sequence',
        type: 'algorithm',
        code: `// Generate Fibonacci sequence
function fibonacci(n) {
  const seq = [0, 1];
  for (let i = 2; i < n; i++) {
    seq.push(seq[i-1] + seq[i-2]);
  }
  return seq.slice(0, n);
}

const result = fibonacci(10);
console.log('Fibonacci(10):', result);
return result;`,
        lastRun: null
      },
      {
        id: 'primes',
        name: 'Prime Numbers',
        type: 'algorithm',
        code: `// Find prime numbers up to n
function sieveOfEratosthenes(n) {
  const primes = [];
  const sieve = new Array(n + 1).fill(true);
  sieve[0] = sieve[1] = false;
  
  for (let i = 2; i <= n; i++) {
    if (sieve[i]) {
      primes.push(i);
      for (let j = i * i; j <= n; j += i) {
        sieve[j] = false;
      }
    }
  }
  return primes;
}

const result = sieveOfEratosthenes(50);
console.log('Primes up to 50:', result);
return result;`,
        lastRun: null
      },
      {
        id: 'sort',
        name: 'QuickSort Demo',
        type: 'algorithm',
        code: `// QuickSort implementation
function quickSort(arr) {
  if (arr.length <= 1) return arr;
  
  const pivot = arr[Math.floor(arr.length / 2)];
  const left = arr.filter(x => x < pivot);
  const middle = arr.filter(x => x === pivot);
  const right = arr.filter(x => x > pivot);
  
  return [...quickSort(left), ...middle, ...quickSort(right)];
}

const unsorted = [64, 34, 25, 12, 22, 11, 90];
console.log('Unsorted:', unsorted);

const sorted = quickSort(unsorted);
console.log('Sorted:', sorted);
return sorted;`,
        lastRun: null
      },
      {
        id: 'stats',
        name: 'Statistics Calculator',
        type: 'data',
        code: `// Calculate statistics for a dataset
function calculateStats(data) {
  const n = data.length;
  const sum = data.reduce((a, b) => a + b, 0);
  const mean = sum / n;
  
  const sortedData = [...data].sort((a, b) => a - b);
  const median = n % 2 === 0
    ? (sortedData[n/2 - 1] + sortedData[n/2]) / 2
    : sortedData[Math.floor(n/2)];
  
  const variance = data.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
  const stdDev = Math.sqrt(variance);
  
  return { n, sum, mean, median, variance, stdDev, min: sortedData[0], max: sortedData[n-1] };
}

const dataset = [23, 45, 67, 12, 89, 34, 56, 78, 90, 11];
console.log('Dataset:', dataset);

const stats = calculateStats(dataset);
console.log('Statistics:', stats);
return stats;`,
        lastRun: null
      },
      {
        id: 'factorial',
        name: 'Factorial Calculator',
        type: 'math',
        code: `// Calculate factorial with memoization
const memo = {};

function factorial(n) {
  if (n <= 1) return 1;
  if (memo[n]) return memo[n];
  memo[n] = n * factorial(n - 1);
  return memo[n];
}

const results = [];
for (let i = 0; i <= 10; i++) {
  results.push({ n: i, factorial: factorial(i) });
  console.log(\`\${i}! = \${factorial(i)}\`);
}
return results;`,
        lastRun: null
      },
      {
        id: 'colors',
        name: 'Color Generator',
        type: 'utility',
        code: `// Generate a color palette
function hslToHex(h, s, l) {
  s /= 100;
  l /= 100;
  const a = s * Math.min(l, 1 - l);
  const f = n => {
    const k = (n + h / 30) % 12;
    const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
    return Math.round(255 * color).toString(16).padStart(2, '0');
  };
  return '#' + f(0) + f(8) + f(4);
}

function generatePalette(baseHue, count) {
  const palette = [];
  for (let i = 0; i < count; i++) {
    const hue = (baseHue + (i * 360 / count)) % 360;
    palette.push({
      hue,
      hex: hslToHex(hue, 70, 50),
      name: \`Color \${i + 1}\`
    });
  }
  return palette;
}

const palette = generatePalette(280, 6);
console.log('Generated palette:', palette);
return palette;`,
        lastRun: null
      }
    ];
    
    let activeCanvasScript = null;
    let canvasOutputLogs = [];
    let activeCanvasTab = 'agents';
    let activeCanvasAgent = null;
    
    const canvasAgents = [
      {
        id: 'orchestrator',
        name: 'Orchestrator',
        icon: 'ai-studio',
        status: 'active',
        task: 'Coordinating agent tasks',
        work: [
          { type: 'analysis', time: Date.now() - 60000, content: 'Analyzed system state and distributed tasks to specialist agents.' },
          { type: 'info', time: Date.now() - 45000, content: 'Current workload: 3 active tasks, 2 pending reviews.' },
          { type: 'result', time: Date.now() - 30000, content: 'Task delegation complete. Code Agent handling optimization, Art Agent preparing assets.' }
        ]
      },
      {
        id: 'code-agent',
        name: 'Code Agent',
        icon: 'code',
        status: 'active',
        task: 'Optimizing render loop',
        work: [
          { type: 'analysis', time: Date.now() - 120000, content: 'Identified performance bottleneck in main render loop. CPU usage spikes during particle effects.' },
          { type: 'code', time: Date.now() - 90000, content: 'Proposed optimization:', code: `// Optimized particle batch rendering
function renderParticles(particles) {
  const batch = new Float32Array(particles.length * 4);
  particles.forEach((p, i) => {
    batch[i*4] = p.x;
    batch[i*4+1] = p.y;
    batch[i*4+2] = p.size;
    batch[i*4+3] = p.alpha;
  });
  gl.bufferData(gl.ARRAY_BUFFER, batch, gl.DYNAMIC_DRAW);
  gl.drawArrays(gl.POINTS, 0, particles.length);
}` },
          { type: 'result', time: Date.now() - 60000, content: 'Optimization applied. Frame rate improved from 45fps to 60fps.' }
        ]
      },
      {
        id: 'art-agent',
        name: 'Art Agent',
        icon: 'art-agent',
        status: 'idle',
        task: 'Waiting for assets',
        work: [
          { type: 'info', time: Date.now() - 180000, content: 'Generated color palette based on user preferences: Purple/Cyan neon theme.' },
          { type: 'result', time: Date.now() - 150000, content: 'Created 5 icon variants for agent avatars in purple, green, blue, orange, and red.' }
        ]
      },
      {
        id: 'analyst',
        name: 'Analyst Agent',
        icon: 'analytics',
        status: 'active',
        task: 'Monitoring user patterns',
        work: [
          { type: 'analysis', time: Date.now() - 300000, content: 'User session analysis complete. Most used features: Terminal (45%), AI Chat (30%), File Editor (25%).' },
          { type: 'info', time: Date.now() - 240000, content: 'Detected preference: User prefers keyboard shortcuts over mouse navigation.' },
          { type: 'result', time: Date.now() - 200000, content: 'Recommendation: Add more keyboard shortcuts to frequently used actions.' }
        ]
      },
      {
        id: 'observer',
        name: 'Observer Agent',
        icon: 'observer',
        status: 'active',
        task: 'Watching system events',
        work: [
          { type: 'info', time: Date.now() - 600000, content: 'System event log: 127 events recorded in last hour.' },
          { type: 'analysis', time: Date.now() - 500000, content: 'Pattern detected: User frequently opens Terminal after AI Chat sessions.' },
          { type: 'result', time: Date.now() - 400000, content: 'Insight stored: Consider adding "Run in Terminal" action to AI Chat responses.' }
        ]
      }
    ];
    
    function switchCanvasTab(tab) {
      activeCanvasTab = tab;
      document.querySelectorAll('.canvas-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.canvas-tab[data-canvas-tab="${tab}"]`).classList.add('active');
      
      document.getElementById('canvas-agents-view').style.display = tab === 'agents' ? 'flex' : 'none';
      document.getElementById('canvas-scripts-view').style.display = tab === 'scripts' ? 'flex' : 'none';
      
      if (tab === 'agents') {
        initCanvasAgents();
      } else {
        initCanvasScripts();
      }
    }
    
    function initCanvasAgents() {
      renderCanvasAgentsList();
      if (canvasAgents.length > 0 && !activeCanvasAgent) {
        selectCanvasAgent(canvasAgents[0].id);
      }
    }
    
    function renderCanvasAgentsList() {
      const list = document.getElementById('canvas-agents-list');
      if (!list) return;
      
      list.innerHTML = canvasAgents.map(agent => `
        <div class="canvas-agent-item ${activeCanvasAgent?.id === agent.id ? 'active' : ''}" 
             onclick="selectCanvasAgent('${agent.id}')"
             data-testid="agent-item-${agent.id}">
          <div class="canvas-agent-item-header">
            <img src="${ICON_BASE}${agent.icon}.png" alt="${agent.name}" style="width:20px;height:20px;border-radius:4px;">
            <span class="canvas-agent-item-name">${agent.name}</span>
            <span class="canvas-agent-item-status ${agent.status}">${agent.status}</span>
          </div>
          <div class="canvas-agent-item-task">${agent.task}</div>
        </div>
      `).join('');
    }
    
    function selectCanvasAgent(id) {
      activeCanvasAgent = canvasAgents.find(a => a.id === id);
      if (!activeCanvasAgent) return;
      
      renderCanvasAgentsList();
      
      document.getElementById('canvas-agent-header').innerHTML = `
        <img src="${ICON_BASE}${activeCanvasAgent.icon}.png" alt="${activeCanvasAgent.name}" style="width:32px;height:32px;border-radius:8px;">
        <div>
          <div class="canvas-agent-name">${activeCanvasAgent.name}</div>
          <div style="font-size:11px;color:var(--text-muted);">${activeCanvasAgent.task}</div>
        </div>
        <span class="canvas-agent-item-status ${activeCanvasAgent.status}" style="margin-left:auto;">${activeCanvasAgent.status}</span>
      `;
      
      renderAgentWork();
      logToConsole('event', `Viewing agent: ${activeCanvasAgent.name}`);
    }
    
    function renderAgentWork() {
      const workArea = document.getElementById('canvas-agent-work');
      if (!workArea || !activeCanvasAgent) return;
      
      if (activeCanvasAgent.work.length === 0) {
        workArea.innerHTML = `
          <div class="canvas-empty">
            <div class="canvas-empty-icon"><img src="${ICON_BASE}${activeCanvasAgent.icon}.png" alt="A" style="width:48px;height:48px;"></div>
            <div>No recent activity from this agent</div>
          </div>
        `;
        return;
      }
      
      workArea.innerHTML = activeCanvasAgent.work.map(item => `
        <div class="agent-work-item">
          <div class="agent-work-item-header">
            <span class="agent-work-item-type ${item.type}">${item.type}</span>
            <span>${formatTimeAgo(item.time)}</span>
          </div>
          <div class="agent-work-item-content">${item.content}</div>
          ${item.code ? `<div class="agent-work-code">${escapeHtml(item.code)}</div>` : ''}
        </div>
      `).join('');
    }
    
    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      return `${hours}h ago`;
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function agentPopOut(agentId, type, content, code = null) {
      const agent = canvasAgents.find(a => a.id === agentId);
      if (!agent) return;
      
      agent.work.unshift({
        type,
        time: Date.now(),
        content,
        code
      });
      
      if (agent.work.length > 20) agent.work.pop();
      
      if (!canvasVisible) {
        toggleCanvas();
      }
      
      if (activeCanvasTab !== 'agents') {
        switchCanvasTab('agents');
      }
      
      selectCanvasAgent(agentId);
      
      logToConsole('ai', `${agent.name}: ${content.substring(0, 50)}...`);
    }
    
    function initCanvasScripts() {
      renderCanvasScriptsList();
      if (canvasScripts.length > 0 && !activeCanvasScript) {
        selectCanvasScript(canvasScripts[0].id);
      }
    }
    
    function renderCanvasScriptsList() {
      const list = document.getElementById('canvas-scripts-list');
      if (!list) return;
      
      list.innerHTML = canvasScripts.map(script => `
        <div class="canvas-script-item ${activeCanvasScript?.id === script.id ? 'active' : ''}" 
             onclick="selectCanvasScript('${script.id}')"
             data-testid="script-item-${script.id}">
          <div class="canvas-script-name">${script.name}</div>
          <div class="canvas-script-meta">
            <span>${script.type}</span>
            ${script.lastRun ? `<span>Last: ${new Date(script.lastRun).toLocaleTimeString()}</span>` : ''}
          </div>
        </div>
      `).join('');
    }
    
    function selectCanvasScript(id) {
      activeCanvasScript = canvasScripts.find(s => s.id === id);
      if (!activeCanvasScript) return;
      
      renderCanvasScriptsList();
      
      document.getElementById('canvas-code-title').textContent = activeCanvasScript.name;
      document.getElementById('canvas-code-display').textContent = activeCanvasScript.code;
      
      logToConsole('event', `Selected script: ${activeCanvasScript.name}`);
    }
    
    function runCanvasScript() {
      if (!activeCanvasScript) {
        addCanvasOutput('error', 'No script selected');
        return;
      }
      
      canvasOutputLogs = [];
      const outputArea = document.getElementById('canvas-output-area');
      outputArea.innerHTML = '';
      
      addCanvasOutput('info', `Running: ${activeCanvasScript.name}...`);
      
      const originalConsoleLog = console.log;
      const logs = [];
      console.log = (...args) => {
        logs.push(args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' '));
        originalConsoleLog.apply(console, args);
      };
      
      try {
        const wrappedCode = `(function() { ${activeCanvasScript.code} })()`;
        const result = eval(wrappedCode);
        
        console.log = originalConsoleLog;
        
        logs.forEach(log => addCanvasOutput('info', log));
        
        if (result !== undefined) {
          const resultStr = typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result);
          addCanvasOutput('success', 'Result:', resultStr);
        } else {
          addCanvasOutput('success', 'Script completed successfully');
        }
        
        activeCanvasScript.lastRun = Date.now();
        renderCanvasScriptsList();
        
        logToConsole('ai', `Script "${activeCanvasScript.name}" executed successfully`);
        
      } catch (error) {
        console.log = originalConsoleLog;
        addCanvasOutput('error', `Error: ${error.message}`);
        logToConsole('error', `Script error: ${error.message}`);
      }
    }
    
    function addCanvasOutput(type, message, value = null) {
      const outputArea = document.getElementById('canvas-output-area');
      if (!outputArea) return;
      
      const item = document.createElement('div');
      item.className = `canvas-output-item ${type}`;
      item.innerHTML = message + (value ? `<div class="canvas-output-value">${value}</div>` : '');
      
      outputArea.appendChild(item);
      outputArea.scrollTop = outputArea.scrollHeight;
    }
    
    function clearCanvasOutput() {
      const outputArea = document.getElementById('canvas-output-area');
      if (outputArea) {
        outputArea.innerHTML = `
          <div class="canvas-empty">
            <div class="canvas-empty-icon"><img src="/grudgeos/assets/icons/generated/output.png" alt="O" style="width:32px;height:32px;"></div>
            <div>Run a script to see results here</div>
          </div>
        `;
      }
    }
    
    function newCanvasScript() {
      const name = prompt('Enter script name:');
      if (!name) return;
      
      const newScript = {
        id: 'custom_' + Date.now(),
        name: name,
        type: 'custom',
        code: `// ${name}\n// Write your code here\n\nconst result = "Hello from " + "${name}";\nconsole.log(result);\nreturn result;`,
        lastRun: null
      };
      
      canvasScripts.unshift(newScript);
      renderCanvasScriptsList();
      selectCanvasScript(newScript.id);
      
      logToConsole('event', `Created new script: ${name}`);
    }
    
    function switchConsoleTab(tab) {
      document.querySelectorAll('.console-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.console-tab[data-tab="${tab}"]`).classList.add('active');
      
      const content = document.getElementById('console-logs');
      
      if (tab === 'logs') {
        renderConsoleLogs();
      } else if (tab === 'canvas') {
        content.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <div style="font-size: 48px; margin-bottom: 16px;"><img src="/grudgeos/assets/icons/generated/canvas.png" style="width:48px;height:48px;" alt="Canvas"></div>
            <div style="color: var(--text-secondary); margin-bottom: 16px;">AI Canvas for visualizations</div>
            <button class="btn" onclick="toggleCanvas()" style="font-size: 12px;">Open Canvas</button>
          </div>
        `;
      } else if (tab === 'definitions') {
        content.innerHTML = `
          <div style="margin-bottom: 16px;">
            <div style="font-family: 'Orbitron', sans-serif; font-size: 12px; color: var(--neon-purple); margin-bottom: 8px;">GRUDGE DEFINITIONS LIBRARY</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Shared vocabulary for AI agent collaboration</div>
          </div>
          ${GrudgeDefinitions.render()}
        `;
      }
    }
    
    function logToConsole(type, message, source = 'system') {
      const log = {
        type,
        message,
        source,
        time: new Date()
      };
      consoleLogs.unshift(log);
      if (consoleLogs.length > 100) consoleLogs.pop();
      
      if (document.querySelector('.console-tab.active')?.dataset.tab === 'logs') {
        renderConsoleLogs();
      }
    }
    
    function renderConsoleLogs() {
      const content = document.getElementById('console-logs');
      if (consoleLogs.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
            <div style="font-size: 32px; margin-bottom: 12px;"><img src="/grudgeos/assets/icons/generated/terminal.png" style="width:32px;height:32px;" alt="Logs"></div>
            <div>No logs yet. AI activity will appear here.</div>
          </div>
        `;
        return;
      }
      
      content.innerHTML = consoleLogs.map(log => `
        <div class="console-log ${log.type}">
          <div class="console-log-header">
            <span class="console-log-type">${log.type}</span>
            <span class="console-log-time">${log.time.toLocaleTimeString()}</span>
          </div>
          <div class="console-log-msg">${log.message}</div>
        </div>
      `).join('');
    }
    
    function showNotification(title, message, actions = [], icon = '<img src="/grudgeos/assets/icons/ai-brain.png" class="notif-icon-img" alt="AI">') {
      const container = document.getElementById('notification-container');
      const id = 'notif_' + Date.now();
      
      const el = document.createElement('div');
      el.className = 'notification';
      el.id = id;
      
      el.innerHTML = `
        <div class="notification-header">
          <div class="notification-icon">${icon}</div>
          <span class="notification-title">${title}</span>
          <span class="notification-close" onclick="closeNotification('${id}')"></span>
        </div>
        <div class="notification-content">${message}</div>
        ${actions.length ? `
          <div class="notification-actions">
            ${actions.map(a => `<button class="notification-btn ${a.primary ? 'primary' : 'secondary'}" onclick="${a.action}">${a.label}</button>`).join('')}
          </div>
        ` : ''}
      `;
      
      container.appendChild(el);
      
      logToConsole('ai', `Notification: ${title} - ${message}`);
      
      setTimeout(() => closeNotification(id), 8000);
    }
    
    function closeNotification(id) {
      const el = document.getElementById(id);
      if (el) {
        el.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => el.remove(), 300);
      }
    }
    
    async function aiProactiveCheck() {
      if (typeof puter === 'undefined') {
        logToConsole('system', 'Running in offline mode - Puter services unavailable');
        return;
      }
      try {
        const user = await puter.auth.getUser();
        if (user) {
          setTimeout(() => {
            const notifId = 'welcome_' + Date.now();
            const container = document.getElementById('notification-container');
            const el = document.createElement('div');
            el.className = 'notification';
            el.id = notifId;
            el.innerHTML = `
              <div class="notification-header">
                <div class="notification-icon"><img src="/grudgeos/assets/icons/generated/ai-assistant.png" class="notif-icon-img" alt="AI" style="width:24px;height:24px;"></div>
                <span class="notification-title">Welcome to GrudgeOS</span>
                <span class="notification-close" data-testid="btn-notif-close" onclick="this.closest('.notification').remove()"></span>
              </div>
              <div class="notification-content">Your AI agents are ready. Open the AI Console to see activity logs and the Grudge Definitions library.</div>
              <div class="notification-actions">
                <button class="notification-btn primary" data-testid="btn-open-console" onclick="toggleConsole(); this.closest('.notification').remove();">Open Console</button>
                <button class="notification-btn secondary" data-testid="btn-dismiss-notif" onclick="this.closest('.notification').remove();">Dismiss</button>
              </div>
            `;
            container.appendChild(el);
            setTimeout(() => { if (document.getElementById(notifId)) document.getElementById(notifId).remove(); }, 15000);
          }, 2000);
          
          logToConsole('system', `User authenticated: ${user.username}`);
          logToConsole('ai', 'AI agents initialized and ready');
          logToConsole('event', 'Desktop environment loaded');
        }
      } catch (e) {
        logToConsole('system', 'Guest mode - sign in for full features');
      }
    }
    
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'ai_notification') {
        showNotification(e.data.title, e.data.message, e.data.actions, e.data.icon);
      }
      if (e.data && e.data.type === 'ai_log') {
        logToConsole(e.data.logType || 'ai', e.data.message, e.data.source);
      }
    });
    
    // ============ PODS MANAGER UI ============
    let podsVisualizer = null;
    
    async function initPodsUI() {
      const podsGrid = document.getElementById('pods-grid');
      if (!podsGrid || !window.podManager) return;
      
      await window.podManager.initialize();
      refreshPodsUI();
      
      if (!window._podsRefreshInterval) {
        window._podsRefreshInterval = setInterval(() => {
          if (document.getElementById('pods-grid')) {
            refreshPodsUI();
          }
        }, 2000);
      }
    }
    
    function refreshPodsUI() {
      if (!window.podManager) return;
      
      const stats = window.podManager.getStats();
      const activeEl = document.getElementById('pods-active');
      const queuedEl = document.getElementById('pods-queued');
      const completedEl = document.getElementById('pods-completed');
      
      if (activeEl) activeEl.textContent = stats.activePods;
      if (queuedEl) queuedEl.textContent = stats.queuedJobs;
      if (completedEl) completedEl.textContent = stats.completedJobs;
      
      const podsGrid = document.getElementById('pods-grid');
      if (podsGrid) {
        const pods = window.podManager.getAllPods();
        if (pods.length === 0) {
          podsGrid.innerHTML = '<div class="no-pods">No pods running. Pods are created automatically when jobs are submitted.</div>';
        } else {
          podsGrid.innerHTML = pods.map(pod => `
            <div class="pod-card" data-pod-id="${pod.id}">
              <div class="pod-card-header">
                <span class="pod-name">${pod.name}</span>
                <span class="pod-status ${pod.status}">${pod.status}</span>
              </div>
              <div class="pod-stats">
                <div>Jobs: ${pod.stats.jobsCompleted} completed, ${pod.stats.jobsFailed} failed</div>
                <div>Runtime: ${pod.runtime}</div>
              </div>
            </div>
          `).join('');
        }
      }
      
      const jobsList = document.getElementById('jobs-list');
      if (jobsList) {
        const jobs = [...window.podManager.getJobQueue(), ...window.podManager.getCompletedJobs(10)];
        if (jobs.length === 0) {
          jobsList.innerHTML = '<div class="no-jobs">No jobs in queue</div>';
        } else {
          jobsList.innerHTML = jobs.slice(0, 20).map(job => `
            <div class="job-item">
              <div class="job-item-info">
                <span class="job-item-type">${job.type}</span>
                <span class="job-item-id">${job.id}</span>
              </div>
              <span class="job-item-status ${job.status}">${job.status}</span>
            </div>
          `).join('');
        }
      }
    }
    
    function createNewPod() {
      if (window.podManager) {
        window.podManager.createPod({ name: `Pod-${Date.now().toString(36)}` });
        refreshPodsUI();
      }
    }
    
    function submitPodJob() {
      if (!window.podManager) return;
      
      const type = document.getElementById('job-type')?.value || 'code';
      const code = document.getElementById('job-code')?.value || '';
      const priority = document.getElementById('job-priority')?.value || 'normal';
      
      if (!code.trim()) {
        alert('Please enter code or prompt');
        return;
      }
      
      window.podManager.submitJob({ type, code, priority });
      document.getElementById('job-code').value = '';
      refreshPodsUI();
    }
    
    // ============ SNAPSHOTS MANAGER UI ============
    async function initSnapshotsUI() {
      const snapshotsList = document.getElementById('snapshots-list');
      if (!snapshotsList || !window.snapshotManager) return;
      
      await window.snapshotManager.initialize();
      refreshSnapshotsUI();
    }
    
    function refreshSnapshotsUI() {
      if (!window.snapshotManager) return;
      
      const snapshots = window.snapshotManager.listSnapshots();
      const snapshotsList = document.getElementById('snapshots-list');
      const exportSelect = document.getElementById('export-snapshot-select');
      
      if (snapshotsList) {
        if (snapshots.length === 0) {
          snapshotsList.innerHTML = '<div class="no-snapshots">No snapshots yet. Create one to save your workspace state.</div>';
        } else {
          snapshotsList.innerHTML = snapshots.map(snap => `
            <div class="snapshot-card" data-snapshot-id="${snap.id}">
              <div class="snapshot-card-header">
                <span class="snapshot-name">${snap.name}</span>
                <span class="pod-status ${snap.type}">${snap.type}</span>
              </div>
              <div class="snapshot-meta">
                <div>Created: ${new Date(snap.createdAt).toLocaleString()}</div>
                <div>Size: ${((snap.size || 0) / 1024).toFixed(1)} KB</div>
              </div>
              <div style="margin-top:10px;display:flex;gap:8px;">
                <button class="studio3d-btn" onclick="restoreSnapshotById('${snap.id}')">Restore</button>
                <button class="studio3d-btn" onclick="deleteSnapshotById('${snap.id}')">Delete</button>
              </div>
            </div>
          `).join('');
        }
      }
      
      if (exportSelect) {
        exportSelect.innerHTML = '<option value="">Select snapshot to export...</option>' +
          snapshots.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      }
    }
    
    async function createSnapshot() {
      if (!window.snapshotManager) return;
      await window.snapshotManager.createSnapshot({ name: `Quick Snapshot ${new Date().toLocaleTimeString()}`, type: 'full' });
      refreshSnapshotsUI();
    }
    
    async function createSnapshotFromForm() {
      if (!window.snapshotManager) return;
      
      const name = document.getElementById('snapshot-name')?.value || 'Unnamed';
      const type = document.getElementById('snapshot-type')?.value || 'full';
      const description = document.getElementById('snapshot-desc')?.value || '';
      
      await window.snapshotManager.createSnapshot({ name, type, description });
      refreshSnapshotsUI();
    }
    
    async function restoreSnapshotById(id) {
      if (!window.snapshotManager) return;
      if (confirm('Restore this snapshot? Current state will be overwritten.')) {
        await window.snapshotManager.restoreSnapshot(id);
        alert('Snapshot restored!');
      }
    }
    
    async function deleteSnapshotById(id) {
      if (!window.snapshotManager) return;
      if (confirm('Delete this snapshot?')) {
        await window.snapshotManager.deleteSnapshot(id);
        refreshSnapshotsUI();
      }
    }
    
    async function exportSelectedSnapshot() {
      if (!window.snapshotManager) return;
      const select = document.getElementById('export-snapshot-select');
      if (!select?.value) return;
      
      const json = await window.snapshotManager.exportSnapshot(select.value);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `snapshot-${select.value}.json`;
      a.click();
    }
    
    async function importSnapshotFromJson() {
      if (!window.snapshotManager) return;
      const json = document.getElementById('import-snapshot-json')?.value;
      if (!json) return;
      
      try {
        await window.snapshotManager.importSnapshot(json);
        document.getElementById('import-snapshot-json').value = '';
        refreshSnapshotsUI();
        alert('Snapshot imported!');
      } catch (e) {
        alert('Failed to import: ' + e.message);
      }
    }
    
    // ============ 3D STUDIO UI ============
    let studio3dVisualizer = null;
    
    async function initStudio3D() {
      const canvas = document.getElementById('webgl-canvas');
      if (!canvas) return;
      
      canvas.width = canvas.clientWidth || 600;
      canvas.height = canvas.clientHeight || 400;
      
      studio3dVisualizer = new WebGLVisualizer('webgl-canvas');
      await studio3dVisualizer.initialize(canvas);
      studio3dVisualizer.startAnimation();
      
      // Auto-load agents visualization so it's not blank
      const agents = ['orchestrator', 'code-agent', 'art-agent', 'analyst', 'lua-agent', 'network-agent'];
      studio3dVisualizer.visualizeAgents(agents);
      updateSceneInfo();
    }
    
    function updateSceneInfo() {
      if (!studio3dVisualizer) return;
      document.getElementById('node-count').textContent = studio3dVisualizer.nodes.length;
      document.getElementById('edge-count').textContent = studio3dVisualizer.edges.length;
      document.getElementById('scene-type').textContent = studio3dVisualizer.activeScene?.type || 'Custom';
    }
    
    function visualizeAgents3D() {
      if (!studio3dVisualizer) return;
      const agents = ['orchestrator', 'code-agent', 'art-agent', 'analyst', 'lua-agent', 'network-agent'];
      studio3dVisualizer.visualizeAgents(agents);
      updateSceneInfo();
    }
    
    function visualizePods3D() {
      if (!studio3dVisualizer || !window.podManager) return;
      const pods = window.podManager.getAllPods();
      if (pods.length === 0) {
        studio3dVisualizer.visualizePods([
          { id: 'demo-1', status: 'idle' },
          { id: 'demo-2', status: 'busy' },
          { id: 'demo-3', status: 'warming' }
        ]);
      } else {
        studio3dVisualizer.visualizePods(pods);
      }
      updateSceneInfo();
    }
    
    function visualizeNetwork3D() {
      if (!studio3dVisualizer) return;
      studio3dVisualizer.visualizeNetwork({
        nodes: [
          { id: 'client', type: 'client', position: [-2, 0, 0], color: '#00f5ff' },
          { id: 'server', type: 'server', position: [0, 0, 0], color: '#8b5cf6' },
          { id: 'db', type: 'database', position: [2, 0, 0], color: '#00ff88' }
        ],
        edges: [
          { from: 'client', to: 'server' },
          { from: 'server', to: 'db' }
        ]
      });
      updateSceneInfo();
    }
    
    function resetCamera() {
      if (!studio3dVisualizer) return;
      studio3dVisualizer.camera.position = [0, 0, 5];
      studio3dVisualizer.camera.target = [0, 0, 0];
    }
    
    function zoomIn3D() {
      if (!studio3dVisualizer) return;
      studio3dVisualizer.camera.position[2] = Math.max(1, studio3dVisualizer.camera.position[2] - 0.5);
    }
    
    function zoomOut3D() {
      if (!studio3dVisualizer) return;
      studio3dVisualizer.camera.position[2] = Math.min(20, studio3dVisualizer.camera.position[2] + 0.5);
    }
    
    // ============ AI CONSOLE (txt2img / txt2video) ============
    let generatedAssets = [];
    
    function initStudio3DTabs() {
      const container = document.querySelector('.studio3d-content');
      if (!container) return;
      
      const tabs = container.querySelectorAll('.studio3d-tab');
      const panels = container.querySelectorAll('.studio3d-tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const targetTab = tab.dataset.tab;
          
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          panels.forEach(p => {
            p.classList.remove('active');
            if (p.id === `studio3d-${targetTab}-panel`) {
              p.classList.add('active');
            }
          });
        });
      });
    }
    
    async function generateAIImage() {
      const promptEl = document.getElementById('txt2img-prompt');
      const resultEl = document.getElementById('txt2img-result');
      if (!promptEl || !resultEl) return;
      
      const prompt = promptEl.value.trim();
      if (!prompt) {
        resultEl.innerHTML = '<div class="ai-gen-placeholder" style="color:var(--neon-pink);">Please enter a prompt</div>';
        return;
      }
      
      resultEl.innerHTML = '<div class="ai-gen-loading"><div class="spinner"></div><span>Generating image...</span></div>';
      
      try {
        if (typeof puter === 'undefined') throw new Error('Puter not available');
        
        const response = await puter.ai.txt2img(prompt);
        const imageUrl = response?.url || response;
        
        if (!imageUrl) throw new Error('No image URL returned');
        
        const asset = {
          id: 'img_' + Date.now(),
          type: 'image',
          prompt: prompt,
          url: imageUrl,
          createdAt: new Date().toISOString()
        };
        generatedAssets.unshift(asset);
        saveGeneratedAssets();
        renderAssetList();
        
        resultEl.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:10px;align-items:center;">
            <img src="${imageUrl}" alt="Generated" style="max-width:100%;max-height:350px;border-radius:8px;">
            <button class="studio3d-btn" onclick="showLinkMenu('${asset.id}', event)" data-testid="btn-link-${asset.id}">Link to Project</button>
          </div>
        `;
      } catch (err) {
        console.error('txt2img error:', err);
        resultEl.innerHTML = `<div class="ai-gen-placeholder" style="color:var(--neon-pink);">Error: ${err.message}</div>`;
      }
    }
    
    async function generateAIVideo() {
      const promptEl = document.getElementById('txt2vid-prompt');
      const resultEl = document.getElementById('txt2vid-result');
      if (!promptEl || !resultEl) return;
      
      const prompt = promptEl.value.trim();
      if (!prompt) {
        resultEl.innerHTML = '<div class="ai-gen-placeholder" style="color:var(--neon-pink);">Please enter a prompt</div>';
        return;
      }
      
      resultEl.innerHTML = '<div class="ai-gen-loading"><div class="spinner"></div><span>Generating video (this may take a minute)...</span></div>';
      
      try {
        if (typeof puter === 'undefined') throw new Error('Puter not available');
        
        const response = await puter.ai.txt2vid(prompt);
        const videoUrl = response?.url || response;
        
        if (!videoUrl) throw new Error('No video URL returned');
        
        const asset = {
          id: 'vid_' + Date.now(),
          type: 'video',
          prompt: prompt,
          url: videoUrl,
          createdAt: new Date().toISOString()
        };
        generatedAssets.unshift(asset);
        saveGeneratedAssets();
        renderAssetList();
        
        resultEl.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:10px;align-items:center;">
            <video src="${videoUrl}" controls autoplay loop muted style="max-width:100%;max-height:350px;border-radius:8px;"></video>
            <button class="studio3d-btn" onclick="showLinkMenu('${asset.id}', event)" data-testid="btn-link-${asset.id}">Link to Project</button>
          </div>
        `;
      } catch (err) {
        console.error('txt2vid error:', err);
        resultEl.innerHTML = `<div class="ai-gen-placeholder" style="color:var(--neon-pink);">Error: ${err.message}</div>`;
      }
    }
    
    function renderAssetList() {
      const listEl = document.getElementById('ai-asset-list');
      if (!listEl) return;
      
      if (generatedAssets.length === 0) {
        listEl.innerHTML = '<div class="ai-gen-placeholder" style="font-size:12px;">No assets generated yet</div>';
        return;
      }
      
      listEl.innerHTML = generatedAssets.map(asset => `
        <div class="ai-asset-item" data-asset="${asset.id}">
          ${asset.type === 'image' 
            ? `<img class="ai-asset-thumb" src="${asset.url}" alt="thumb">`
            : `<video class="ai-asset-thumb" src="${asset.url}" muted></video>`
          }
          <div class="ai-asset-info">
            <div class="ai-asset-name">${asset.prompt.substring(0, 30)}${asset.prompt.length > 30 ? '...' : ''}</div>
            <div class="ai-asset-type">${asset.type === 'image' ? 'Image' : 'Video'}</div>
          </div>
          <div class="ai-asset-actions">
            <button onclick="showLinkMenu('${asset.id}', event)" title="Link">Link</button>
            <button onclick="deleteAsset('${asset.id}')" title="Delete">Del</button>
          </div>
        </div>
      `).join('');
    }
    
    function showLinkMenu(assetId, event) {
      event.stopPropagation();
      
      // Remove any existing menu
      const existing = document.querySelector('.link-asset-menu');
      if (existing) existing.remove();
      
      const asset = generatedAssets.find(a => a.id === assetId);
      if (!asset) return;
      
      const menu = document.createElement('div');
      menu.className = 'link-asset-menu';
      menu.innerHTML = `
        <div class="link-asset-menu-item" onclick="linkAssetTo('${assetId}', 'favicon')">Set as Favicon</div>
        <div class="link-asset-menu-item" onclick="linkAssetTo('${assetId}', 'app-icon')">Set as App Icon</div>
        <div class="link-asset-menu-item" onclick="linkAssetTo('${assetId}', 'project-hero')">Set as Project Hero</div>
        <div class="link-asset-menu-item" onclick="downloadAsset('${assetId}')">Download</div>
        <div class="link-asset-menu-item" onclick="copyAssetUrl('${assetId}')">Copy URL</div>
      `;
      
      const rect = event.target.getBoundingClientRect();
      menu.style.position = 'fixed';
      menu.style.left = rect.left + 'px';
      menu.style.top = (rect.bottom + 5) + 'px';
      
      document.body.appendChild(menu);
      
      const closeMenu = () => {
        menu.remove();
        document.removeEventListener('click', closeMenu);
      };
      setTimeout(() => document.addEventListener('click', closeMenu), 0);
    }
    
    async function linkAssetTo(assetId, target) {
      const asset = generatedAssets.find(a => a.id === assetId);
      if (!asset) return;
      
      try {
        if (target === 'favicon') {
          // Set as favicon
          let link = document.querySelector("link[rel*='icon']") || document.createElement('link');
          link.type = 'image/x-icon';
          link.rel = 'shortcut icon';
          link.href = asset.url;
          document.getElementsByTagName('head')[0].appendChild(link);
          showNotification('Favicon updated!', 'success');
        } else if (target === 'app-icon') {
          // Store as app icon in puter.kv
          if (typeof puter !== 'undefined') {
            await puter.kv.set('grudgeos_custom_app_icon', asset.url);
            showNotification('App icon saved!', 'success');
          }
        } else if (target === 'project-hero') {
          // Store as project hero in puter.kv
          if (typeof puter !== 'undefined') {
            await puter.kv.set('grudgeos_project_hero', asset.url);
            showNotification('Project hero saved!', 'success');
          }
        }
      } catch (err) {
        console.error('Link asset error:', err);
        showNotification('Failed to link asset', 'error');
      }
    }
    
    function downloadAsset(assetId) {
      const asset = generatedAssets.find(a => a.id === assetId);
      if (!asset) return;
      
      const a = document.createElement('a');
      a.href = asset.url;
      a.download = `${asset.type}_${Date.now()}.${asset.type === 'image' ? 'png' : 'mp4'}`;
      a.click();
    }
    
    function copyAssetUrl(assetId) {
      const asset = generatedAssets.find(a => a.id === assetId);
      if (!asset) return;
      
      navigator.clipboard.writeText(asset.url).then(() => {
        showNotification('URL copied to clipboard!', 'success');
      });
    }
    
    function deleteAsset(assetId) {
      generatedAssets = generatedAssets.filter(a => a.id !== assetId);
      saveGeneratedAssets();
      renderAssetList();
    }
    
    async function saveGeneratedAssets() {
      if (typeof puter !== 'undefined') {
        try {
          await puter.kv.set('grudgeos_ai_assets', JSON.stringify(generatedAssets));
        } catch (e) {
          console.log('Could not save AI assets:', e);
        }
      }
    }
    
    async function loadGeneratedAssets() {
      if (typeof puter !== 'undefined' && puter.kv) {
        try {
          const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 2000));
          const saved = await Promise.race([puter.kv.get('grudgeos_ai_assets'), timeoutPromise]);
          if (saved) {
            generatedAssets = JSON.parse(saved);
          }
        } catch (e) {
          // Silently continue with empty assets
        }
      }
    }
    
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notifications');
      if (!container) return;
      
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.innerHTML = `
        <div class="notification-content">
          <span class="notification-icon">${type === 'success' ? '' : type === 'error' ? '' : ''}</span>
          <span>${message}</span>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()"></button>
      `;
      container.appendChild(notif);
      
      setTimeout(() => notif.remove(), 4000);
    }
    
    // ============ WASM RUNNER UI ============
    async function initWasmUI() {
      const modulesList = document.getElementById('wasm-modules-list');
      if (!modulesList || !window.wasmRuntime) return;
      
      await window.wasmRuntime.initialize();
      refreshWasmUI();
    }
    
    function refreshWasmUI() {
      if (!window.wasmRuntime) return;
      
      const modules = window.wasmRuntime.listModules();
      const modulesList = document.getElementById('wasm-modules-list');
      const moduleSelect = document.getElementById('wasm-exec-module');
      
      if (modulesList) {
        if (modules.length === 0) {
          modulesList.innerHTML = '<div class="no-modules">No WASM modules loaded</div>';
        } else {
          modulesList.innerHTML = modules.map(m => `
            <div class="wasm-module-item">
              <div>
                <div class="wasm-module-name">${m.name}</div>
                <div class="wasm-module-exports">Exports: ${m.exports.join(', ')}</div>
              </div>
              <span class="status-indicator ${m.status}"></span>
            </div>
          `).join('');
        }
      }
      
      if (moduleSelect) {
        moduleSelect.innerHTML = '<option value="">Select module...</option>' +
          modules.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        
        moduleSelect.onchange = () => {
          const fnSelect = document.getElementById('wasm-exec-fn');
          const selectedModule = modules.find(m => m.id === moduleSelect.value);
          if (fnSelect && selectedModule) {
            fnSelect.innerHTML = '<option value="">Select function...</option>' +
              selectedModule.exports.map(fn => `<option value="${fn}">${fn}</option>`).join('');
          }
        };
      }
    }
    
    async function loadWasmModule() {
      if (!window.wasmRuntime) return;
      
      const input = document.getElementById('wasm-module-input')?.value;
      if (!input) return;
      
      try {
        if (input.startsWith('http')) {
          await window.wasmRuntime.loadModule({ path: input, name: 'Remote Module' });
        } else {
          await window.wasmRuntime.loadModule({ base64: input, name: 'Base64 Module' });
        }
        document.getElementById('wasm-module-input').value = '';
        refreshWasmUI();
      } catch (e) {
        alert('Failed to load module: ' + e.message);
      }
    }
    
    function executeWasmFn() {
      if (!window.wasmRuntime) return;
      
      const moduleId = document.getElementById('wasm-exec-module')?.value;
      const fnName = document.getElementById('wasm-exec-fn')?.value;
      const argsStr = document.getElementById('wasm-exec-args')?.value || '';
      
      if (!moduleId || !fnName) return;
      
      try {
        const args = argsStr.split(',').map(a => {
          const n = parseFloat(a.trim());
          return isNaN(n) ? a.trim() : n;
        }).filter(a => a !== '');
        
        const result = window.wasmRuntime.callFunction(moduleId, fnName, ...args);
        document.getElementById('wasm-result-output').textContent = JSON.stringify(result, null, 2);
      } catch (e) {
        document.getElementById('wasm-result-output').textContent = 'Error: ' + e.message;
      }
    }
    
    function inspectMemory() {
      if (!window.wasmRuntime || !window.wasmRuntime.memory) return;
      
      const offset = parseInt(document.getElementById('mem-offset')?.value || '0');
      const length = parseInt(document.getElementById('mem-length')?.value || '256');
      
      try {
        const bytes = window.wasmRuntime.readFromMemory(offset, Math.min(length, 4096));
        const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
        document.getElementById('memory-dump').textContent = hex;
      } catch (e) {
        document.getElementById('memory-dump').textContent = 'Error: ' + e.message;
      }
    }
    
    // Initialize managers on page load (just the managers, not UI)
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(async () => {
        if (window.podManager) await window.podManager.initialize();
        if (window.snapshotManager) await window.snapshotManager.initialize();
        if (window.wasmRuntime) await window.wasmRuntime.initialize();
      }, 500);
    });
    
    // Tab switching for new apps
    document.addEventListener('click', (e) => {
      const podsTab = e.target.closest('.pods-tab');
      const snapshotsTab = e.target.closest('.snapshots-tab');
      const wasmTab = e.target.closest('.wasm-tab');
      
      if (podsTab) {
        const tab = podsTab.dataset.tab;
        document.querySelectorAll('.pods-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.pods-tab-content').forEach(c => c.classList.remove('active'));
        podsTab.classList.add('active');
        document.getElementById(tab + '-panel')?.classList.add('active');
      }
      
      if (snapshotsTab) {
        const tab = snapshotsTab.dataset.tab;
        document.querySelectorAll('.snapshots-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.snapshots-tab-content').forEach(c => c.classList.remove('active'));
        snapshotsTab.classList.add('active');
        document.getElementById(tab + '-panel')?.classList.add('active');
      }
      
      if (wasmTab) {
        const tab = wasmTab.dataset.tab;
        document.querySelectorAll('.wasm-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.wasm-tab-content').forEach(c => c.classList.remove('active'));
        wasmTab.classList.add('active');
        document.getElementById(tab + '-panel')?.classList.add('active');
      }
    });
    
    // Initialize 3D studio when window opens
    const originalSetupWindowContent = window.setupWindowContent;
    window.setupWindowContent = function(el, appId) {
      if (originalSetupWindowContent) originalSetupWindowContent(el, appId);
      
      if (appId === 'studio3d') {
        setTimeout(() => {
          initStudio3D();
          initStudio3DTabs();
          renderAssetList();
        }, 100);
      }
      if (appId === 'pods') {
        setTimeout(initPodsUI, 100);
      }
      if (appId === 'snapshots') {
        setTimeout(initSnapshotsUI, 100);
      }
      if (appId === 'wasmrunner') {
        setTimeout(initWasmUI, 100);
      }
    };
    
    init();
    aiProactiveCheck();
  </script>
  <script src="lib/puter-auth.js"></script>
  <script src="lib/puter-service.js"></script>
  <script src="lib/agent-ai-service.js"></script>
  <script src="lib/deploy-service.js"></script>
  <script src="lib/grudchat-service.js"></script>
  <script src="lib/agent-runner.js"></script>
  <script src="lib/grudge-cloud.js"></script>
  <script src="lib/grudge-channels.js"></script>
  <script src="lib/channel-ui.js"></script>
  <script src="lib/system-monitor.js"></script>
  <script>
    (function initGrudgeCloudSystem() {
      let retryCount = 0;
      const maxRetries = 3;
      
      function registerAllApps() {
        if (!window.GrudgeCloud) {
          if (retryCount < maxRetries) {
            retryCount++;
            setTimeout(registerAllApps, 500);
            return;
          }
          console.log('[GrudgeOS] Running in offline mode (GrudgeCloud unavailable)');
          initAgentRegistryOnly();
          return;
        }
        
        window.GrudgeCloud.init().then(async () => {
          window.GrudgeCloud.registerApp({ id: 'grudchat', name: 'GrudChat', iconPath: 'grudge-chat', category: 'communication' });
          window.GrudgeCloud.registerApp({ id: 'aistudio', name: 'AI Studio', iconPath: 'ai-studio', category: 'development' });
          window.GrudgeCloud.registerApp({ id: 'agentswarm', name: 'Agent Swarm', iconPath: 'agent-swarm', category: 'ai' });
          window.GrudgeCloud.registerApp({ id: 'observer', name: 'Observer', iconPath: 'observer', category: 'monitoring' });
          window.GrudgeCloud.registerApp({ id: 'gameeditor', name: 'Game Editor', iconPath: 'games-launcher', category: 'development' });
          window.GrudgeCloud.registerApp({ id: 'audiopackages', name: 'Audio Packages', iconPath: 'audio-packages', category: 'media' });
          window.GrudgeCloud.registerApp({ id: 'agentmanager', name: 'Agent Manager', iconPath: 'agent-manager', category: 'ai' });
          window.GrudgeCloud.registerApp({ id: 'networktools', name: 'Network Tools', iconPath: 'network-tools', category: 'network' });
          window.GrudgeCloud.registerApp({ id: 'terminal', name: 'Terminal', iconPath: 'terminal', category: 'system' });
          window.GrudgeCloud.registerApp({ id: 'settings', name: 'Settings', iconPath: 'settings', category: 'system' });
          window.GrudgeCloud.registerApp({ id: 'aisystem', name: 'AI System', iconPath: 'system-overview', category: 'ai' });
          window.GrudgeCloud.registerApp({ id: 'taskmanager', name: 'Task Manager', iconPath: 'task-manager', category: 'system' });
          window.GrudgeCloud.registerApp({ id: 'systemmonitor', name: 'System Monitor', iconPath: 'system-monitor', category: 'system' });
          window.GrudgeCloud.registerApp({ id: 'devtools', name: 'Dev Tools', iconPath: 'dev-tools', category: 'development' });
          console.log('[GrudgeOS] Apps registered with GrudgeCloud');
          
          if (window.AgentRegistry) {
            await window.AgentRegistry.init();
            console.log('[GrudgeOS] AgentRegistry initialized with ' + window.AgentRegistry.getAllAgents().length + ' agents');
          }
        }).catch(e => {
          console.log('[GrudgeOS] GrudgeCloud init (guest mode):', e.message);
          initAgentRegistryOnly();
        });
      }
      
      function initAgentRegistryOnly() {
        if (window.AgentRegistry) {
          window.AgentRegistry.init().then(() => {
            console.log('[GrudgeOS] AgentRegistry initialized (offline mode)');
          });
        }
      }

      setTimeout(registerAllApps, 500);

      window.initGrudgeCloudApp = function() {
        const container = document.getElementById('grudgecloud-app');
        if (container && window.GrudgeCloudUI) {
          window.GrudgeCloudUI.render(container);
        }
      };

      window.initTaskManager = function() {
        const container = document.getElementById('taskmanager-app');
        if (container && window.GRD17Monitor) {
          window.GRD17Monitor.init();
          window.GRD17Monitor.setupTabEvents(container);
        }
      };

      window.initSystemMonitor = function() {
        if (window.GRD17Monitor) {
          window.GRD17Monitor.init();
        }
      };

      let gameEditorInstance = null;
      
      window.initGameEditor = function() {
        const container = document.querySelector('.ge-pro-editor');
        if (!container) return;
        
        const canvas = document.getElementById('game-canvas');
        const hasGameDeps = canvas && window.InputManager && window.ThirdPersonCamera && window.CharacterController;
        
        let ctx, input, camera, character;
        let lastTime = performance.now();
        let running = true;
        let currentCameraMode = 'thirdperson';
        let isPlaying = false;
        
        // Editor state
        const editorState = {
          selectedObject: 'player',
          activeTool: 'select',
          inputConfig: {
            mouseSens: 1.0,
            invertY: false,
            deadzone: 0.15,
            smoothing: true,
            aimAssist: 0.5
          },
          cameraConfig: {
            mode: 'thirdperson',
            fov: 75,
            distance: 5,
            height: 1.5,
            smoothSpeed: 8,
            collision: true,
            autoLevel: true
          }
        };
        
        // Initialize game systems if available
        if (hasGameDeps) {
          canvas.width = canvas.parentElement?.clientWidth || 640;
          canvas.height = canvas.parentElement?.clientHeight || 400;
          ctx = canvas.getContext('2d');
          input = new window.InputManager();
          camera = new window.ThirdPersonCamera({ distance: 5, pitch: -20 });
          character = new window.CharacterController({ position: { x: 0, y: 0, z: 0 } });
          
          input.initialize(canvas);
          camera.initialize(input);
          character.initialize(input, camera);
        }
        
        // Viewport tab switching
        const viewportTabs = container.querySelectorAll('.ge-viewport-tab');
        const viewportContents = container.querySelectorAll('.ge-viewport-content');
        
        viewportTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            viewportTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            viewportContents.forEach(c => {
              c.style.display = 'none';
              c.classList.remove('active');
            });
            
            const viewId = 'ge-view-' + tab.dataset.view;
            const targetView = document.getElementById(viewId);
            if (targetView) {
              targetView.style.display = 'flex';
              targetView.classList.add('active');
            }
          });
        });
        
        // Tool button switching
        const toolBtns = container.querySelectorAll('.ge-tool-btn');
        toolBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            toolBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            editorState.activeTool = btn.dataset.tool;
          });
        });
        
        // Hierarchy item selection
        const treeItems = container.querySelectorAll('.ge-tree-item');
        treeItems.forEach(item => {
          item.addEventListener('click', () => {
            treeItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            editorState.selectedObject = item.dataset.id;
            
            const nameEl = document.getElementById('ge-selected-name');
            if (nameEl) nameEl.textContent = item.querySelector('.ge-tree-name')?.textContent || item.dataset.id;
          });
        });
        
        // Camera mode presets with actual camera settings
        const cameraModePresets = {
          fps: { distance: 0.1, minDistance: 0.1, maxDistance: 0.5, offset: { x: 0, y: 1.7, z: 0 }, smoothing: 0.05, fov: 90, minPitch: -89, maxPitch: 89 },
          thirdperson: { distance: 5, minDistance: 1.5, maxDistance: 15, offset: { x: 0.5, y: 1.5, z: 0 }, smoothing: 0.1, fov: 60, minPitch: -60, maxPitch: 60 },
          rts: { distance: 15, minDistance: 8, maxDistance: 30, offset: { x: 0, y: 0, z: 0 }, smoothing: 0.15, fov: 45, minPitch: -75, maxPitch: -45 },
          freeflow: { distance: 0, minDistance: 0, maxDistance: 0, offset: { x: 0, y: 2, z: 0 }, smoothing: 0.08, fov: 75, minPitch: -89, maxPitch: 89 },
          followpath: { distance: 8, minDistance: 5, maxDistance: 12, offset: { x: 0, y: 2, z: 0 }, smoothing: 0.2, fov: 55, minPitch: -45, maxPitch: 45, cinematic: true },
          orbital: { distance: 8, minDistance: 3, maxDistance: 20, offset: { x: 0, y: 1, z: 0 }, smoothing: 0.12, fov: 50, minPitch: -80, maxPitch: 80 }
        };
        
        function applyCameraMode(mode) {
          if (!camera) return;
          const preset = cameraModePresets[mode];
          if (!preset) return;
          
          // Apply to camera object
          camera.distance = preset.distance;
          camera.targetDistance = preset.distance;
          camera.minDistance = preset.minDistance;
          camera.maxDistance = preset.maxDistance;
          camera.offset = { ...camera.offset, ...preset.offset };
          camera.smoothing = preset.smoothing;
          camera.fov = preset.fov;
          camera.targetFov = preset.fov;
          camera.minPitch = preset.minPitch;
          camera.maxPitch = preset.maxPitch;
          
          // Handle cinematic mode with path data (uses position and rotation properties)
          if (preset.cinematic) {
            camera.cinematicMode = true;
            camera.cinematicProgress = 0;
            camera.cinematicDuration = 8; // 8 second loop
            camera.cinematicPath = [
              { position: { x: 0, y: 3, z: -8 }, rotation: { x: -15, y: 0, z: 0 } },
              { position: { x: 5, y: 4, z: -5 }, rotation: { x: -20, y: 45, z: 0 } },
              { position: { x: 8, y: 3, z: 0 }, rotation: { x: -10, y: 90, z: 0 } },
              { position: { x: 5, y: 4, z: 5 }, rotation: { x: -20, y: 135, z: 0 } },
              { position: { x: 0, y: 3, z: 8 }, rotation: { x: -15, y: 180, z: 0 } }
            ];
          } else {
            camera.cinematicMode = false;
          }
          
          // Update editorState to keep in sync
          editorState.cameraConfig.fov = preset.fov;
          editorState.cameraConfig.distance = preset.distance;
          editorState.cameraConfig.height = preset.offset.y;
          editorState.cameraConfig.smoothSpeed = Math.round(preset.smoothing * 100); // Convert 0-0.2 to 0-20 range
          
          // Update UI sliders to reflect new values (smoothSpeed is 0-100 in UI)
          const fovSlider = document.getElementById('ge-cam-fov');
          const distSlider = document.getElementById('ge-cam-dist');
          const heightSlider = document.getElementById('ge-cam-height');
          const smoothSlider = document.getElementById('ge-cam-smooth');
          const fovVal = document.getElementById('ge-cam-fov-val');
          const distVal = document.getElementById('ge-cam-dist-val');
          const heightVal = document.getElementById('ge-cam-height-val');
          const smoothVal = document.getElementById('ge-cam-smooth-val');
          
          if (fovSlider) { fovSlider.value = preset.fov; if (fovVal) fovVal.textContent = preset.fov + ''; }
          if (distSlider) { distSlider.value = preset.distance; if (distVal) distVal.textContent = preset.distance + 'm'; }
          if (heightSlider) { heightSlider.value = preset.offset.y; if (heightVal) heightVal.textContent = preset.offset.y + 'm'; }
          if (smoothSlider) { smoothSlider.value = editorState.cameraConfig.smoothSpeed; if (smoothVal) smoothVal.textContent = editorState.cameraConfig.smoothSpeed; }
          
          console.log('[GameEditor] Applied camera mode:', mode, preset);
        }
        
        // Camera mode selection
        const cameraModeCards = container.querySelectorAll('.ge-camera-mode-card');
        cameraModeCards.forEach(card => {
          card.addEventListener('click', () => {
            cameraModeCards.forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            currentCameraMode = card.dataset.mode;
            editorState.cameraConfig.mode = currentCameraMode;
            
            // Apply actual camera settings
            applyCameraMode(currentCameraMode);
            
            const modeDisplay = document.getElementById('ge-camera-mode-display');
            if (modeDisplay) {
              const modeNames = {
                fps: 'First Person',
                thirdperson: 'Third Person',
                rts: 'RTS / Top-Down',
                freeflow: 'Free Flow',
                followpath: 'Cinematic',
                orbital: 'Orbital'
              };
              modeDisplay.textContent = modeNames[currentCameraMode] || currentCameraMode;
            }
          });
        });
        
        // Asset tab switching
        const assetTabs = container.querySelectorAll('.ge-asset-tab');
        assetTabs.forEach(tab => {
          tab.addEventListener('click', () => {
            assetTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
          });
        });
        
        // Gizmo controls
        const gizmoBtns = container.querySelectorAll('.ge-gizmo-btn');
        gizmoBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            gizmoBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
          });
        });
        
        // Input config sliders
        function setupSlider(id, valId, callback) {
          const slider = document.getElementById(id);
          const valEl = document.getElementById(valId);
          if (slider) {
            slider.addEventListener('input', (e) => {
              const val = parseFloat(e.target.value);
              if (valEl) valEl.textContent = val.toFixed(val < 10 ? 2 : 0) + (id.includes('fov') ? '' : id.includes('dist') || id.includes('height') ? 'm' : '');
              if (callback) callback(val);
            });
          }
        }
        
        setupSlider('ge-mouse-sens', 'ge-mouse-sens-val', (v) => { 
          editorState.inputConfig.mouseSens = v; 
          if (input) input.sensitivity.mouse = v;
          if (camera) camera.sensitivity = { x: v * 0.3, y: v * (editorState.inputConfig.invertY ? -0.25 : 0.25) };
        });
        setupSlider('ge-deadzone', 'ge-deadzone-val', (v) => { 
          editorState.inputConfig.deadzone = v; 
          if (input) input.deadzone = v;
        });
        setupSlider('ge-aim-assist', 'ge-aim-assist-val', (v) => { editorState.inputConfig.aimAssist = v; });
        setupSlider('ge-cam-fov', 'ge-cam-fov-val', (v) => { 
          editorState.cameraConfig.fov = v; 
          if (camera) { camera.fov = v; camera.targetFov = v; }
        });
        setupSlider('ge-cam-dist', 'ge-cam-dist-val', (v) => { 
          editorState.cameraConfig.distance = v; 
          if (camera) { camera.distance = v; camera.targetDistance = v; }
        });
        setupSlider('ge-cam-height', 'ge-cam-height-val', (v) => { 
          editorState.cameraConfig.height = v; 
          if (camera && camera.offset) camera.offset.y = v;
        });
        setupSlider('ge-cam-smooth', 'ge-cam-smooth-val', (v) => { 
          editorState.cameraConfig.smoothSpeed = v; 
          if (camera) camera.smoothing = v / 100;
        });
        
        // Checkbox handlers
        const invertYCheckbox = document.getElementById('ge-invert-y');
        if (invertYCheckbox) {
          invertYCheckbox.addEventListener('change', (e) => {
            editorState.inputConfig.invertY = e.target.checked;
            if (camera) {
              const sens = editorState.inputConfig.mouseSens;
              camera.sensitivity.y = sens * (e.target.checked ? -0.25 : 0.25);
            }
          });
        }
        
        const smoothingCheckbox = document.getElementById('ge-smoothing');
        if (smoothingCheckbox) {
          smoothingCheckbox.addEventListener('change', (e) => {
            editorState.inputConfig.smoothing = e.target.checked;
            if (input && input.smoothing) input.smoothing.enabled = e.target.checked;
          });
        }
        
        const collisionCheckbox = document.getElementById('ge-cam-collision');
        if (collisionCheckbox) {
          collisionCheckbox.addEventListener('change', (e) => {
            editorState.cameraConfig.collision = e.target.checked;
            if (camera) camera.collisionEnabled = e.target.checked;
          });
        }
        
        const autoLevelCheckbox = document.getElementById('ge-cam-autolevel');
        if (autoLevelCheckbox) {
          autoLevelCheckbox.addEventListener('change', (e) => {
            editorState.cameraConfig.autoLevel = e.target.checked;
            // Auto-level would reset pitch when enabled - implement if needed
          });
        }
        
        // Play/Pause/Stop buttons
        const playBtn = document.getElementById('ge-play-btn');
        const pauseBtn = document.getElementById('ge-pause-btn');
        const stopBtn = document.getElementById('ge-stop-btn');
        
        if (playBtn) {
          playBtn.addEventListener('click', () => {
            isPlaying = true;
            playBtn.style.opacity = '0.5';
            console.log('[GameEditor] Play mode activated');
          });
        }
        
        if (pauseBtn) {
          pauseBtn.addEventListener('click', () => {
            isPlaying = !isPlaying;
            console.log('[GameEditor] ' + (isPlaying ? 'Resumed' : 'Paused'));
          });
        }
        
        if (stopBtn) {
          stopBtn.addEventListener('click', () => {
            isPlaying = false;
            if (playBtn) playBtn.style.opacity = '1';
            if (character) character.teleport({ x: 0, y: 0, z: 0 });
            console.log('[GameEditor] Stopped');
          });
        }
        
        // Apply settings to game systems (matches InputManager and ThirdPersonCamera class properties)
        function applyInputConfig() {
          if (!input) return;
          // InputManager has: sensitivity.mouse, smoothing.enabled, smoothing.factor, deadzone
          input.sensitivity.mouse = editorState.inputConfig.mouseSens;
          input.smoothing.enabled = editorState.inputConfig.smoothing;
          input.deadzone = editorState.inputConfig.deadzone;
          
          // ThirdPersonCamera uses its own sensitivity
          if (camera) {
            camera.sensitivity = { 
              x: editorState.inputConfig.mouseSens * 0.3, 
              y: editorState.inputConfig.mouseSens * (editorState.inputConfig.invertY ? -0.25 : 0.25)
            };
          }
        }
        
        function applyCameraConfig() {
          if (!camera) return;
          // ThirdPersonCamera has: fov, distance, offset.y, smoothing (number), collisionEnabled
          camera.fov = editorState.cameraConfig.fov;
          camera.targetFov = editorState.cameraConfig.fov;
          camera.distance = editorState.cameraConfig.distance;
          camera.targetDistance = editorState.cameraConfig.distance;
          camera.offset.y = editorState.cameraConfig.height;
          camera.smoothing = editorState.cameraConfig.smoothSpeed / 100; // Convert to 0-0.2 range
          camera.collisionEnabled = editorState.cameraConfig.collision;
        }
        
        // Load saved configs from Puter KV
        async function loadConfigs() {
          if (typeof puter !== 'undefined' && puter.kv) {
            try {
              const savedInput = await puter.kv.get('ge_input_config');
              if (savedInput) {
                editorState.inputConfig = { ...editorState.inputConfig, ...JSON.parse(savedInput) };
                applyInputConfig();
                // Update UI sliders
                const sensSlider = document.getElementById('ge-mouse-sens');
                const sensVal = document.getElementById('ge-mouse-sens-val');
                if (sensSlider) sensSlider.value = editorState.inputConfig.mouseSens;
                if (sensVal) sensVal.textContent = editorState.inputConfig.mouseSens.toFixed(1);
              }
              
              const savedCamera = await puter.kv.get('ge_camera_config');
              if (savedCamera) {
                editorState.cameraConfig = { ...editorState.cameraConfig, ...JSON.parse(savedCamera) };
                applyCameraConfig();
                // Activate saved camera mode
                const modeCard = container.querySelector(`.ge-camera-mode-card[data-mode="${editorState.cameraConfig.mode}"]`);
                if (modeCard) modeCard.click();
              }
            } catch (e) {
              console.log('[GameEditor] Using default configs');
            }
          }
        }
        
        // Config save/reset functions
        window.saveInputConfig = function() {
          applyInputConfig();
          if (typeof puter !== 'undefined' && puter.kv) {
            puter.kv.set('ge_input_config', JSON.stringify(editorState.inputConfig));
          }
          console.log('[GameEditor] Input config saved and applied:', editorState.inputConfig);
        };
        
        window.resetInputConfig = function() {
          editorState.inputConfig = { mouseSens: 1.0, invertY: false, deadzone: 0.15, smoothing: true, aimAssist: 0.5 };
          applyInputConfig();
          // Reset UI
          const sensSlider = document.getElementById('ge-mouse-sens');
          const sensVal = document.getElementById('ge-mouse-sens-val');
          if (sensSlider) sensSlider.value = 1.0;
          if (sensVal) sensVal.textContent = '1.0';
          console.log('[GameEditor] Input config reset to defaults');
        };
        
        window.saveCameraConfig = function() {
          applyCameraConfig();
          if (typeof puter !== 'undefined' && puter.kv) {
            puter.kv.set('ge_camera_config', JSON.stringify(editorState.cameraConfig));
          }
          console.log('[GameEditor] Camera config saved and applied:', editorState.cameraConfig);
        };
        
        window.testCameraMode = function() {
          applyCameraConfig();
          viewportTabs[0]?.click();
          console.log('[GameEditor] Testing camera mode:', currentCameraMode);
        };
        
        // Load configs on init
        loadConfigs();
        
        // Scene rendering
        function renderScene() {
          if (!ctx || !canvas) return;
          
          ctx.fillStyle = '#0a0a0f';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          
          ctx.strokeStyle = 'rgba(0, 245, 255, 0.08)';
          const gridSize = 40;
          for (let x = 0; x <= canvas.width; x += gridSize) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
          }
          for (let y = 0; y <= canvas.height; y += gridSize) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
          }
          
          if (!character) return;
          
          const state = character.getState();
          const camView = camera?.getViewMatrix() || { position: { x: 0, z: 0 } };
          
          const screenX = canvas.width / 2 + state.position.x * 20 - camView.position.x * 5;
          const screenY = canvas.height / 2 - state.position.z * 20 + camView.position.z * 5;
          
          ctx.save();
          ctx.translate(screenX, screenY);
          ctx.rotate(-state.rotation.y * Math.PI / 180);
          
          const charColor = state.isSprinting ? '#ff6b35' : state.isCrouching ? '#8b5cf6' : '#00ff88';
          ctx.fillStyle = charColor;
          ctx.beginPath();
          ctx.moveTo(0, -15);
          ctx.lineTo(-10, 10);
          ctx.lineTo(10, 10);
          ctx.closePath();
          ctx.fill();
          
          ctx.strokeStyle = '#00f5ff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(0, 0, 20, 0, Math.PI * 2);
          ctx.stroke();
          
          ctx.restore();
        }
        
        function updateUI() {
          if (!character || !input || !camera) return;
          
          const state = character.getState();
          const move = input.getMovementVector();
          const look = input.getLookVector();
          
          const stateEl = document.getElementById('ge-char-state');
          if (stateEl) stateEl.textContent = state.state.toUpperCase();
          
          const groundedEl = document.getElementById('ge-grounded');
          if (groundedEl) groundedEl.textContent = state.isGrounded ? 'Yes' : 'No';
          
          const deviceLabel = document.getElementById('ge-active-device');
          if (deviceLabel) deviceLabel.textContent = input.activeDevice?.replace('_', '/') || 'Keyboard/Mouse';
          
          // Update position inputs
          const posX = document.getElementById('ge-pos-x');
          const posY = document.getElementById('ge-pos-y');
          const posZ = document.getElementById('ge-pos-z');
          if (posX) posX.value = state.position.x.toFixed(1);
          if (posY) posY.value = state.position.y.toFixed(1);
          if (posZ) posZ.value = state.position.z.toFixed(1);
          
          // Update axis bars
          updateAxisBar('ge-axis-mx', move.x);
          updateAxisBar('ge-axis-my', move.y);
          updateAxisBar('ge-axis-lx', Math.max(-1, Math.min(1, look.x / 10)));
          updateAxisBar('ge-axis-ly', Math.max(-1, Math.min(1, look.y / 10)));
          
          // Update action indicators
          updateActionIndicator('ge-act-jump', input.isPressed('jump'));
          updateActionIndicator('ge-act-sprint', state.isSprinting);
          updateActionIndicator('ge-act-crouch', state.isCrouching);
          updateActionIndicator('ge-act-attack', input.isPressed('attack'));
        }
        
        function updateAxisBar(id, value) {
          const el = document.getElementById(id);
          if (!el) return;
          const width = Math.abs(value) * 50;
          const left = value >= 0 ? 50 : 50 - width;
          el.style.left = left + '%';
          el.style.width = width + '%';
        }
        
        function updateActionIndicator(id, active) {
          const el = document.getElementById(id);
          if (el) el.classList.toggle('active', active);
        }
        
        function gameLoop() {
          if (!running) return;
          
          const now = performance.now();
          const deltaTime = Math.min((now - lastTime) / 1000, 0.1);
          lastTime = now;
          
          if (hasGameDeps && (isPlaying || true)) {
            input.update(deltaTime);
            camera.update(deltaTime);
            character.update(deltaTime);
          }
          
          renderScene();
          updateUI();
          
          requestAnimationFrame(gameLoop);
        }
        
        window.resetGameController = function() {
          if (character) character.teleport({ x: 0, y: 0, z: 0 });
          if (camera) camera.reset();
        };
        
        gameEditorInstance = { 
          input, camera, character, editorState,
          stop: () => { 
            running = false; 
            if (input) {
              input.exitPointerLock();
              input.destroy();
            }
            console.log('[GameEditor] Stopped and cleaned up');
          } 
        };
        
        if (hasGameDeps) gameLoop();
        console.log('[GameEditor Pro] Initialized with Input, Camera, Controller systems');
      };
      
      window.stopGameEditor = function() {
        if (gameEditorInstance) {
          gameEditorInstance.stop();
          gameEditorInstance = null;
        }
      };

      window.initAgentManager = function() {
        const container = document.getElementById('agentmanager-app');
        if (container && window.AgentRegistry) {
          renderAgentManagerUI(container);
        }
      };

      window.initGrudChat = async function() {
        const container = document.getElementById('grudchat-app');
        if (!container || !window.grudChat) return;

        const gc = window.grudChat;
        
        // Check for existing session (Keep me logged in)
        const session = await gc.getSession();
        const loginModal = document.getElementById('grudchat-login');
        
        if (session && session.rememberMe) {
          // Auto-login with saved session
          await gc.refreshSession();
          renderGrudChatUI(container, gc, session);
        } else {
          // Show login modal
          if (loginModal) loginModal.style.display = 'flex';
          setupGrudChatLogin(container, gc);
        }
      };

      function setupGrudChatLogin(container, gc) {
        const loginModal = document.getElementById('grudchat-login');
        const loginBtn = document.getElementById('login-submit');
        const guestBtn = document.getElementById('login-guest');
        const usernameInput = document.getElementById('login-username');
        const rememberCheckbox = document.getElementById('login-remember');

        if (loginBtn) {
          loginBtn.addEventListener('click', async () => {
            const username = usernameInput?.value.trim() || 'User';
            const remember = rememberCheckbox?.checked || false;
            
            const userData = { username, avatar: '<img src="/grudgeos/assets/icons/generated/user-avatar.png" alt="U" style="width:32px;height:32px;border-radius:50%;">' };
            if (remember) {
              await gc.saveSession(userData);
            }
            
            loginModal.style.display = 'none';
            renderGrudChatUI(container, gc, { ...userData, rememberMe: remember });
          });
        }

        if (guestBtn) {
          guestBtn.addEventListener('click', () => {
            loginModal.style.display = 'none';
            renderGrudChatUI(container, gc, { username: 'Guest', avatar: '<img src="/grudgeos/assets/icons/generated/user-avatar.png" alt="G" style="width:32px;height:32px;border-radius:50%;">', guest: true });
          });
        }
      }

      async function renderGrudChatUI(container, gc, session) {
        // Update user panel
        const userPanel = document.getElementById('grudchat-user-panel');
        if (userPanel) {
          const userName = userPanel.querySelector('.user-name');
          const userAvatar = userPanel.querySelector('.user-avatar');
          if (userName) userName.textContent = session.username || 'Guest';
          if (userAvatar) userAvatar.innerHTML = session.avatar || '<img src="/grudgeos/assets/icons/generated/user-avatar.png" alt="U" style="width:32px;height:32px;border-radius:50%;">';
        }

        // Initialize and render channels
        const template = gc.getTemplateChannels();
        const channelsContainer = document.getElementById('grudchat-channels');
        
        if (channelsContainer) {
          channelsContainer.innerHTML = template.categories.map(cat => {
            return '<div class="channel-category" data-category="' + cat.id + '">' +
              '<div class="category-header">' +
                '<span class="category-toggle"></span>' +
                '<span class="category-name">' + cat.name.toUpperCase() + '</span>' +
              '</div>' +
              '<div class="category-channels">' +
                cat.channels.map(ch => {
                  const typeIcon = ch.type === 'voice' ? 'VC' : (ch.type === 'stat' ? '' : '#');
                  return '<div class="channel-item ' + ch.type + (ch.readOnly ? ' readonly' : '') + '" data-channel="' + ch.id + '" data-type="' + ch.type + '" data-testid="channel-' + ch.id + '">' +
                    '<span class="channel-type-icon">' + typeIcon + '</span>' +
                    '<span class="channel-name">' + ch.name + '</span>' +
                  '</div>';
                }).join('') +
              '</div>' +
            '</div>';
          }).join('');

          // Attach channel click events
          channelsContainer.querySelectorAll('.channel-item').forEach(item => {
            item.addEventListener('click', () => {
              const channelId = item.dataset.channel;
              const channelType = item.dataset.type;
              const channelName = item.querySelector('.channel-name').textContent;
              
              // Update active state
              channelsContainer.querySelectorAll('.channel-item').forEach(c => c.classList.remove('active'));
              item.classList.add('active');
              
              // Update header
              const header = document.getElementById('grudchat-channel-header');
              if (header) {
                header.querySelector('.channel-icon').textContent = channelType === 'voice' ? 'VC' : 'TX';
                header.querySelector('.channel-name').textContent = channelName;
              }
              
              // Enable input for text channels
              const input = document.getElementById('grudchat-input');
              const sendBtn = document.getElementById('grudchat-send');
              if (channelType === 'text' && !item.classList.contains('readonly')) {
                if (input) { input.disabled = false; input.placeholder = 'Message ' + channelName; }
                if (sendBtn) sendBtn.disabled = false;
              } else {
                if (input) { input.disabled = true; input.placeholder = channelType === 'voice' ? 'Voice channel' : 'Read-only channel'; }
                if (sendBtn) sendBtn.disabled = true;
              }

              // Clear messages
              const messagesArea = document.getElementById('grudchat-messages');
              if (messagesArea) {
                if (channelType === 'voice') {
                  messagesArea.innerHTML = '<div class="voice-channel-ui"><div class="voice-icon"><img src="/grudgeos/assets/icons/generated/audio.png" alt="VC" style="width:40px;height:40px;border-radius:8px;"></div><div class="voice-text">Voice Channel</div><button class="join-voice-btn" data-testid="btn-join-voice">Join Voice</button></div>';
                } else if (channelType === 'stat') {
                  messagesArea.innerHTML = '<div class="stat-display"><div class="stat-value">' + channelName + '</div></div>';
                } else {
                  messagesArea.innerHTML = '<div class="messages-placeholder">No messages yet in ' + channelName + '</div>';
                }
              }
            });
          });

          // Category toggle
          channelsContainer.querySelectorAll('.category-header').forEach(header => {
            header.addEventListener('click', () => {
              const category = header.closest('.channel-category');
              category.classList.toggle('collapsed');
              header.querySelector('.category-toggle').textContent = category.classList.contains('collapsed') ? '' : '';
            });
          });
        }

        // Setup message sending
        const input = document.getElementById('grudchat-input');
        const sendBtn = document.getElementById('grudchat-send');
        
        const sendMessage = async () => {
          if (!input || !input.value.trim()) return;
          const content = input.value.trim();
          input.value = '';
          
          const messagesArea = document.getElementById('grudchat-messages');
          if (messagesArea) {
            const placeholder = messagesArea.querySelector('.messages-placeholder');
            if (placeholder) placeholder.remove();
            
            const msgEl = document.createElement('div');
            msgEl.className = 'message';
            msgEl.innerHTML = '<div class="message-avatar">' + (session.avatar || '<img src="/grudgeos/assets/icons/generated/user-avatar.png" alt="U" style="width:32px;height:32px;border-radius:50%;">') + '</div>' +
              '<div class="message-content">' +
                '<div class="message-header">' +
                  '<span class="message-author">' + (session.username || 'Guest') + '</span>' +
                  '<span class="message-time">' + new Date().toLocaleTimeString() + '</span>' +
                '</div>' +
                '<div class="message-text">' + content + '</div>' +
              '</div>';
            messagesArea.appendChild(msgEl);
            messagesArea.scrollTop = messagesArea.scrollHeight;
          }
        };

        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
        if (input) input.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
      }

      window.initNetworkTools = async function() {
        const container = document.getElementById('nettools-app');
        if (!container) {
          console.warn('[NetworkTools] Container element not found');
          return;
        }
        
        // Prevent duplicate full initialization (event handlers are already set up via delegation)
        if (container.dataset.fullInit) {
          return;
        }
        container.dataset.fullInit = 'true';
        
        // Wait for NetworkContainers to be available (retry up to 10 times)
        let nc = window.NetworkContainers;
        let retries = 0;
        while (!nc && retries < 10) {
          await new Promise(r => setTimeout(r, 100));
          nc = window.NetworkContainers;
          retries++;
        }
        
        if (!nc) {
          console.warn('[NetworkTools] NetworkContainers not available, creating fallback');
          if (typeof NetworkContainers !== 'undefined') {
            window.NetworkContainers = new NetworkContainers();
            nc = window.NetworkContainers;
          } else {
            console.error('[NetworkTools] NetworkContainers class not defined');
            return;
          }
        }
        
        try {
          await nc.initialize();
          console.log('[NetworkTools] Initialized with', nc.getTools().length, 'tools');
          startNetworkToolsMonitor(container, nc);
        } catch (e) {
          console.error('[NetworkTools] Initialization error:', e);
        }
      };

      function renderNetworkToolsUI(container, nc) {
        const scanningTools = document.getElementById('scanning-tools');
        const analysisTools = document.getElementById('analysis-tools');
        const utilityTools = document.getElementById('utility-tools');
        
        const scanningList = nc.getToolsByCategory('scanning');
        const analysisList = nc.getToolsByCategory('analysis');
        const utilityList = nc.getToolsByCategory('utility');
        
        console.log('[NetworkTools] Rendering tools:', {
          scanning: scanningList.length,
          analysis: analysisList.length,
          utility: utilityList.length
        });
        
        if (scanningTools) {
          scanningTools.innerHTML = scanningList.map(t => renderNetToolCard(t, nc)).join('');
        } else {
          console.warn('[NetworkTools] scanning-tools element not found');
        }
        if (analysisTools) {
          analysisTools.innerHTML = analysisList.map(t => renderNetToolCard(t, nc)).join('');
        } else {
          console.warn('[NetworkTools] analysis-tools element not found');
        }
        if (utilityTools) {
          utilityTools.innerHTML = utilityList.map(t => renderNetToolCard(t, nc)).join('');
        } else {
          console.warn('[NetworkTools] utility-tools element not found');
        }
        
        updateContainersGrid(nc);
        updateLogsSelector(nc);
      }

      function renderNetToolCard(tool, nc) {
        const container = nc.getContainer(tool.id);
        const isRunning = container?.status === 'running';
        return `
          <div class="nettool-card ${isRunning ? 'running' : ''}" data-tool-id="${tool.id}" data-testid="tool-${tool.id}">
            <div class="nettool-header">
              <span class="nettool-icon">${tool.icon}</span>
              <div class="nettool-info">
                <span class="nettool-name">${tool.name}</span>
                <span class="nettool-image">${tool.image}</span>
              </div>
              ${isRunning ? '<span class="nettool-status running">Running</span>' : ''}
            </div>
            <p class="nettool-desc">${tool.description}</p>
            <div class="nettool-resources">
              <span>CPU: ${tool.resources.cpu}</span>
              <span>RAM: ${tool.resources.memory}</span>
            </div>
            <div class="nettool-actions">
              ${isRunning ? 
                '<button class="btn-stop" data-action="stop" data-testid="btn-stop-' + tool.id + '">Stop</button>' +
                '<button class="btn-restart" data-action="restart" data-testid="btn-restart-' + tool.id + '">Restart</button>' :
                '<button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-' + tool.id + '">Deploy</button>'
              }
            </div>
          </div>
        `;
      }

      function updateContainersGrid(nc) {
        const grid = document.getElementById('containers-grid');
        if (!grid) return;
        
        const containers = nc.getAllContainers();
        if (containers.length === 0) {
          grid.innerHTML = '<div class="no-containers">No containers deployed. Go to Available Tools to deploy.</div>';
          return;
        }
        
        grid.innerHTML = containers.map(c => {
          return `
            <div class="container-card ${c.status}" data-container-id="${c.toolId}" data-testid="container-${c.toolId}">
              <div class="container-header">
                <span class="container-icon">${c.toolIcon}</span>
                <div class="container-info">
                  <span class="container-name">${c.toolName}</span>
                  <span class="container-id">${c.containerId}</span>
                </div>
                <span class="container-status ${c.status}">${c.status}</span>
              </div>
              <div class="container-metrics">
                <div class="metric">
                  <span class="metric-label">Uptime</span>
                  <span class="metric-value">${nc.formatUptime(c.uptime)}</span>
                </div>
                <div class="metric">
                  <span class="metric-label">CPU</span>
                  <span class="metric-value">${(c.cpu || 0).toFixed(1)}%</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Memory</span>
                  <span class="metric-value">${(c.memory || 0).toFixed(0)} MB</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Network</span>
                  <span class="metric-value">${nc.formatBytes(c.network?.rx || 0)} ${nc.formatBytes(c.network?.tx || 0)}</span>
                </div>
              </div>
              <div class="container-actions">
                ${c.status === 'running' ? 
                  '<button class="btn-exec" data-action="exec" data-testid="btn-exec-' + c.toolId + '">Execute</button>' +
                  '<button class="btn-stop" data-action="stop" data-testid="btn-stop-c-' + c.toolId + '">Stop</button>' +
                  '<button class="btn-logs" data-action="logs" data-testid="btn-logs-' + c.toolId + '">Logs</button>' :
                  '<button class="btn-start" data-action="start" data-testid="btn-start-' + c.toolId + '">Start</button>' +
                  '<button class="btn-remove" data-action="remove" data-testid="btn-remove-' + c.toolId + '">Remove</button>'
                }
              </div>
            </div>
          `;
        }).join('');
        
        attachContainerEvents(nc);
      }

      function attachContainerEvents(nc) {
        document.querySelectorAll('.container-card button').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.container-card');
            const containerId = card.dataset.containerId;
            const action = e.target.dataset.action;
            
            if (action === 'stop') await nc.stop(containerId);
            if (action === 'start') await nc.start(containerId);
            if (action === 'remove') await nc.remove(containerId);
            if (action === 'logs') showContainerLogs(containerId, nc);
            if (action === 'exec') showExecPrompt(containerId, nc);
            
            updateContainersGrid(nc);
            updateLogsSelector(nc);
          });
        });
      }

      function updateLogsSelector(nc) {
        const select = document.getElementById('logs-container-select');
        if (!select) return;
        
        const containers = nc.getAllContainers();
        select.innerHTML = '<option value="">Select container...</option>' +
          containers.map(c => {
            return '<option value="' + c.toolId + '">' + c.toolName + ' (' + c.containerId + ')</option>';
          }).join('');
      }

      function showContainerLogs(containerId, nc) {
        document.querySelectorAll('.nettools-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nettools-tab-content').forEach(c => c.classList.remove('active'));
        document.querySelector('.nettools-tab[data-tab="logs"]').classList.add('active');
        document.getElementById('nettools-logs').classList.add('active');
        
        const select = document.getElementById('logs-container-select');
        if (select) select.value = containerId;
        
        renderLogs(containerId, nc);
      }

      function renderLogs(containerId, nc) {
        const output = document.getElementById('logs-output');
        if (!output) return;
        
        const logs = nc.getLogs(containerId);
        if (logs.length === 0) {
          output.innerHTML = '<div class="logs-placeholder">No logs available</div>';
          return;
        }
        
        output.innerHTML = logs.map(log => 
          '<div class="log-line"><span class="log-time">' + new Date(log.timestamp).toLocaleTimeString() + '</span><span class="log-msg">' + log.message + '</span></div>'
        ).join('');
        
        output.scrollTop = output.scrollHeight;
      }

      function showExecPrompt(containerId, nc) {
        const tool = nc.getTool(containerId);
        const cmd = prompt('Execute command in ' + tool.name + ':\\n\\nAvailable commands: ' + tool.commands.join(', '));
        if (cmd) {
          nc.execute(containerId, cmd).then(result => {
            if (result.success) {
              showContainerLogs(containerId, nc);
            }
          });
        }
      }

      function setupNetworkToolsEvents(container, nc) {
        container.querySelectorAll('.nettools-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            container.querySelectorAll('.nettools-tab').forEach(t => t.classList.remove('active'));
            container.querySelectorAll('.nettools-tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('nettools-' + tab.dataset.tab).classList.add('active');
          });
        });
        
        container.querySelectorAll('.nettool-card button').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.nettool-card');
            const toolId = card.dataset.toolId;
            const action = e.target.dataset.action;
            
            if (action === 'deploy') await nc.deploy(toolId);
            if (action === 'stop') await nc.stop(toolId);
            if (action === 'restart') await nc.restart(toolId);
            
            renderNetworkToolsUI(container, nc);
            setupNetworkToolsEvents(container, nc);
          });
        });
        
        const logsSelect = document.getElementById('logs-container-select');
        if (logsSelect) {
          logsSelect.addEventListener('change', () => {
            if (logsSelect.value) renderLogs(logsSelect.value, nc);
          });
        }
      }

      let netToolsMonitorInterval = null;
      function startNetworkToolsMonitor(container, nc) {
        if (netToolsMonitorInterval) clearInterval(netToolsMonitorInterval);
        
        netToolsMonitorInterval = setInterval(() => {
          const stats = nc.getStats();
          const runningEl = document.getElementById('net-running');
          const cpuEl = document.getElementById('net-cpu');
          const memEl = document.getElementById('net-mem');
          
          if (runningEl) runningEl.textContent = stats.containersRunning;
          if (cpuEl) cpuEl.textContent = stats.totalCpu + '%';
          if (memEl) memEl.textContent = stats.totalMemory;
          
          if (document.getElementById('nettools-containers')?.classList.contains('active')) {
            updateContainersGrid(nc);
          }
        }, 2000);
      }

      function renderAgentManagerUI(container) {
        const registry = window.AgentRegistry;
        if (!registry.initialized) {
          registry.init().then(() => renderAgentManagerContent(container));
        } else {
          renderAgentManagerContent(container);
        }
      }

      function renderAgentManagerContent(container) {
        const registry = window.AgentRegistry;
        const agents = registry.getAllAgents();
        const tools = registry.getAllTools();
        
        container.innerHTML = `
          <div class="agent-manager-tabs">
            <button class="am-tab active" data-tab="agents">Agents (${agents.length})</button>
            <button class="am-tab" data-tab="tools">Dev Tools (${tools.length})</button>
            <button class="am-tab" data-tab="learning">Learning Cycles</button>
          </div>
          
          <div class="am-tab-content active" id="am-agents-tab">
            <div class="am-section">
              <h3 class="am-section-title">Core Agents (Always Active)</h3>
              <div class="am-agents-grid">
                ${registry.getCoreAgents().map(a => renderAgentCard(a)).join('')}
              </div>
            </div>
            <div class="am-section">
              <h3 class="am-section-title">Specialist Agents</h3>
              <div class="am-agents-grid">
                ${registry.getSpecialistAgents().map(a => renderAgentCard(a)).join('')}
              </div>
            </div>
          </div>
          
          <div class="am-tab-content" id="am-tools-tab">
            <div class="am-section">
              <h3 class="am-section-title">Execution Tools</h3>
              <div class="am-tools-grid">
                ${registry.getToolsByCategory('execution').map(t => renderToolCard(t)).join('')}
              </div>
            </div>
            <div class="am-section">
              <h3 class="am-section-title">Preview Tools</h3>
              <div class="am-tools-grid">
                ${registry.getToolsByCategory('preview').map(t => renderToolCard(t)).join('')}
              </div>
            </div>
            <div class="am-section">
              <h3 class="am-section-title">AI-Powered Tools</h3>
              <div class="am-tools-grid">
                ${registry.getToolsByCategory('ai').map(t => renderToolCard(t)).join('')}
              </div>
            </div>
            <div class="am-section">
              <h3 class="am-section-title">Debugging Tools</h3>
              <div class="am-tools-grid">
                ${registry.getToolsByCategory('debugging').map(t => renderToolCard(t)).join('')}
              </div>
            </div>
            <div class="am-section">
              <h3 class="am-section-title">Build Tools</h3>
              <div class="am-tools-grid">
                ${registry.getToolsByCategory('build').map(t => renderToolCard(t)).join('')}
              </div>
            </div>
          </div>
          
          <div class="am-tab-content" id="am-learning-tab">
            <div class="am-learning-cycle">
              <h3 class="am-section-title">Agent Learning Lifecycle</h3>
              <div class="learning-stages">
                <div class="learning-stage"><img src="/grudgeos/assets/icons/generated/creating.png" alt="CR" style="width:24px;height:24px;border-radius:4px;"><span>Creating</span></div>
                <div class="learning-arrow"></div>
                <div class="learning-stage"><img src="/grudgeos/assets/icons/generated/learning.png" alt="LR" style="width:24px;height:24px;border-radius:4px;"><span>Learning</span></div>
                <div class="learning-arrow"></div>
                <div class="learning-stage"><img src="/grudgeos/assets/icons/generated/repeating.png" alt="RP" style="width:24px;height:24px;border-radius:4px;"><span>Repeating</span></div>
                <div class="learning-arrow"></div>
                <div class="learning-stage"><img src="/grudgeos/assets/icons/generated/reiterating.png" alt="RI" style="width:24px;height:24px;border-radius:4px;"><span>Reiterating</span></div>
                <div class="learning-arrow"></div>
                <div class="learning-stage success"><img src="/grudgeos/assets/icons/generated/succeeding.png" alt="OK" style="width:24px;height:24px;border-radius:4px;"><span>Succeeding</span></div>
              </div>
              <div class="am-agents-learning">
                ${agents.map(a => renderAgentLearningRow(a, registry)).join('')}
              </div>
            </div>
          </div>
        `;
        
        container.querySelectorAll('.am-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            container.querySelectorAll('.am-tab').forEach(t => t.classList.remove('active'));
            container.querySelectorAll('.am-tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById('am-' + tab.dataset.tab + '-tab').classList.add('active');
          });
        });
        
        container.querySelectorAll('.agent-toggle').forEach(btn => {
          btn.addEventListener('click', () => {
            const agentId = btn.dataset.agentId;
            const agent = registry.getAgent(agentId);
            if (agent.status === 'active') {
              registry.deactivateAgent(agentId);
            } else {
              registry.activateAgent(agentId);
            }
            renderAgentManagerContent(container);
          });
        });
      }
      
      function renderAgentCard(agent) {
        const statusClass = agent.status === 'active' ? 'active' : 'dormant';
        const stateColors = {
          ready: '#00f5ff',
          creating: '#ff6b35',
          learning: '#8b5cf6',
          repeating: '#3b82f6',
          reiterating: '#00ff88',
          succeeding: '#00ff88'
        };
        return `
          <div class="am-agent-card ${statusClass}">
            <div class="am-agent-header">
              <span class="am-agent-icon">${agent.icon}</span>
              <div class="am-agent-info">
                <span class="am-agent-name">${agent.name}</span>
                <span class="am-agent-role">${agent.role}</span>
              </div>
              <span class="am-agent-status ${statusClass}">${agent.status}</span>
            </div>
            <p class="am-agent-desc">${agent.description}</p>
            <div class="am-agent-meta">
              <span class="am-agent-model">Model: ${agent.preferredModel}</span>
              <span class="am-agent-level">Lv.${agent.level} (${agent.xp}xp)</span>
            </div>
            <div class="am-agent-langs">
              ${agent.languages.map(l => '<span class="lang-tag">' + l + '</span>').join('')}
            </div>
            <div class="am-agent-state" style="border-color: ${stateColors[agent.learningState] || '#505070'}">
              State: ${agent.learningState}
            </div>
            ${agent.type !== 'core' ? '<button class="agent-toggle" data-agent-id="' + agent.id + '">' + (agent.status === 'active' ? 'Deactivate' : 'Activate') + '</button>' : ''}
          </div>
        `;
      }
      
      function renderToolCard(tool) {
        return `
          <div class="am-tool-card">
            <span class="am-tool-icon">${tool.icon}</span>
            <div class="am-tool-info">
              <span class="am-tool-name">${tool.name}</span>
              <span class="am-tool-desc">${tool.description}</span>
            </div>
            <div class="am-tool-langs">
              ${tool.supportedLanguages.slice(0, 3).map(l => '<span class="lang-tag">' + l + '</span>').join('')}
            </div>
          </div>
        `;
      }
      
      function renderAgentLearningRow(agent, registry) {
        const info = registry.getLearningCycleInfo(agent.id);
        return `
          <div class="am-learning-row">
            <span class="learning-agent-icon">${agent.icon}</span>
            <span class="learning-agent-name">${agent.name}</span>
            <div class="learning-progress-bar">
              <div class="learning-progress-fill" style="width: ${info.progress}%"></div>
            </div>
            <span class="learning-state">${info.currentState}</span>
            <span class="learning-tasks">${agent.tasksCompleted} tasks</span>
          </div>
        `;
      }

      const checkOpenApp = setInterval(() => {
        if (typeof openApp === 'function') {
          clearInterval(checkOpenApp);
          const originalOpenApp = openApp;
          window.openApp = function(appId) {
            originalOpenApp(appId);
            if (window.GrudgeCloud) {
              window.GrudgeCloud.updateAppStats(appId, {
                launches: (window.GrudgeCloud.getApp(appId)?.stats?.launches || 0) + 1
              });
            }
            if (appId === 'grudgecloud') {
              setTimeout(() => window.initGrudgeCloudApp(), 100);
            }
            if (appId === 'taskmanager') {
              setTimeout(() => window.initTaskManager(), 100);
            }
            if (appId === 'systemmonitor') {
              setTimeout(() => window.initSystemMonitor(), 100);
            }
            if (appId === 'agentmanager') {
              setTimeout(() => window.initAgentManager(), 100);
            }
            if (appId === 'networktools') {
              setTimeout(() => window.initNetworkTools(), 100);
            }
            if (appId === 'grudchat') {
              setTimeout(() => window.initGrudChat(), 100);
            }
            if (appId === 'gameeditor') {
              setTimeout(() => window.initGameEditor(), 100);
            }
            if (appId === 'agentsquad') {
              setTimeout(() => window.initAgentSquad(), 100);
            }
            if (appId === 'terminal') {
              setTimeout(() => window.initTerminal(), 100);
            }
            if (appId === 'zerotier') {
              setTimeout(() => window.initZeroTier(), 100);
            }
          };
        }
      }, 100);
      
      // Shared NetworkTools handler setup function - prevents duplicate handlers via guard
      window.setupNetworkToolsHandlers = function(nettoolsApp) {
        if (!nettoolsApp || nettoolsApp.dataset.handlersSet) return;
        nettoolsApp.dataset.handlersSet = 'true';
        console.log('[NetworkTools] Setting up event delegation handlers...');
        
        // Single event delegation handler for all clicks
        nettoolsApp.addEventListener('click', async (e) => {
          // Handle tab clicks - scope selection to this container
          const tab = e.target.closest('.nettools-tab');
          if (tab) {
            nettoolsApp.querySelectorAll('.nettools-tab').forEach(t => t.classList.remove('active'));
            nettoolsApp.querySelectorAll('.nettools-tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            // Scope to this container to support multi-window
            const targetContent = nettoolsApp.querySelector('#nettools-' + tab.dataset.tab);
            if (targetContent) targetContent.classList.add('active');
            return;
          }
          
          // Handle deploy/stop/restart button clicks via delegation
          const btn = e.target.closest('.nettool-actions button');
          if (btn) {
            const card = btn.closest('.nettool-card');
            const toolId = card?.dataset.toolId;
            const action = btn.dataset.action;
            if (!toolId || !action) return;
            
            if (window.NetworkContainers) {
              const nc = window.NetworkContainers;
              await nc.initialize();
              if (action === 'deploy') await nc.deploy(toolId);
              if (action === 'stop') await nc.stop(toolId);
              if (action === 'restart') await nc.restart(toolId);
              
              // Update card status
              const container = nc.getContainer(toolId);
              const isRunning = container?.status === 'running';
              card.classList.toggle('running', isRunning);
              const actionsDiv = card.querySelector('.nettool-actions');
              if (actionsDiv) {
                actionsDiv.innerHTML = isRunning ? 
                  '<button class="btn-stop" data-action="stop" data-testid="btn-stop-' + toolId + '">Stop</button>' +
                  '<button class="btn-restart" data-action="restart" data-testid="btn-restart-' + toolId + '">Restart</button>' :
                  '<button class="btn-deploy" data-action="deploy" data-testid="btn-deploy-' + toolId + '">Deploy</button>';
              }
              
              // Add/remove status badge
              const header = card.querySelector('.nettool-header');
              let statusBadge = header?.querySelector('.nettool-status');
              if (isRunning && header && !statusBadge) {
                statusBadge = document.createElement('span');
                statusBadge.className = 'nettool-status running';
                statusBadge.textContent = 'Running';
                header.appendChild(statusBadge);
              } else if (!isRunning && statusBadge) {
                statusBadge.remove();
              }
            }
          }
        });
      };
      
      // NetworkTools initialization is handled by createWindowElement
      // No MutationObserver needed - it was causing potential conflicts
    })();
  </script>
  
  <script>
    // Terminal Initialization
    window.initTerminal = function() {
      const output = document.getElementById('terminal-output');
      const input = document.getElementById('terminal-input');
      if (!output || !input) return;
      
      // Command history
      const history = [];
      let historyIndex = -1;
      
      // Available commands
      const commands = {
        help: () => {
          return `Available commands:
  help     - Show this help message
  clear    - Clear the terminal
  echo     - Echo a message
  date     - Show current date and time
  whoami   - Show current user
  ls       - List files (simulated)
  pwd      - Print working directory
  uname    - System information
  env      - Environment variables
  puter    - Puter.js status
  ai       - AI model status
  agents   - List available agents
  version  - Show GrudgeOS version`;
        },
        clear: () => {
          output.innerHTML = '';
          return null;
        },
        echo: (args) => args.join(' ') || '',
        date: () => new Date().toString(),
        whoami: () => window.PuterAuth?.getUsername() || 'guest',
        ls: () => 'Desktop  Documents  Downloads  Projects  .config',
        pwd: () => '/home/guest',
        uname: () => 'GrudgeOS 1.0.0 - WebOS powered by Puter.js',
        env: () => {
          const online = typeof puter !== 'undefined' ? 'true' : 'false';
          return `PUTER_AVAILABLE=${online}
USER=${window.PuterAuth?.getUsername() || 'guest'}
HOME=/home/guest
SHELL=/bin/grudgesh
TERM=xterm-256color`;
        },
        puter: () => {
          if (typeof puter === 'undefined') return 'Puter.js: Offline';
          return `Puter.js: Online
Auth: ${window.PuterAuth?.isAuthenticated ? 'Logged in as ' + window.PuterAuth.getUsername() : 'Guest mode'}
Storage: puter.kv available
AI: Free unlimited access (GPT-4o, Claude, Gemini)`;
        },
        ai: () => {
          return `AI Models Available:
  claude-3-5-sonnet  - Anthropic Claude (best for code)
  gpt-4o             - OpenAI GPT-4o (general purpose)
  gemini-pro         - Google Gemini (multimodal)
  deepseek           - DeepSeek (open source)
  
All models accessible via Puter.js for free!`;
        },
        agents: () => {
          if (!window.AgentRegistry) return 'AgentRegistry not loaded';
          const agents = window.AgentRegistry.getAllAgents();
          return agents.map(a => `  ${a.icon} ${a.name} [${a.status}]`).join('\n');
        },
        version: () => 'GrudgeOS v1.0.0\nCloudPilot AI Studio\nBuilt with Puter.js'
      };
      
      function printLine(text, className = '') {
        const line = document.createElement('div');
        line.style.cssText = `color: ${className === 'error' ? '#ff6b6b' : className === 'success' ? '#70d4a8' : '#c0c0e0'}; margin-bottom: 4px; white-space: pre-wrap;`;
        line.textContent = text;
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;
      }
      
      function printPrompt(cmd) {
        const line = document.createElement('div');
        line.style.cssText = 'margin-bottom: 4px; display: flex; gap: 8px;';
        const promptSpan = document.createElement('span');
        promptSpan.style.color = '#70d4a8';
        promptSpan.textContent = 'guest@grudgeos:~$';
        const cmdSpan = document.createElement('span');
        cmdSpan.style.color = '#e0e0f0';
        cmdSpan.textContent = cmd;
        line.appendChild(promptSpan);
        line.appendChild(cmdSpan);
        output.appendChild(line);
      }
      
      // Welcome message
      printLine('Welcome to GrudgeOS Terminal', 'success');
      printLine('Type "help" for available commands\n');
      
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const cmd = input.value.trim();
          if (!cmd) return;
          
          history.unshift(cmd);
          historyIndex = -1;
          
          printPrompt(cmd);
          
          const parts = cmd.split(' ');
          const command = parts[0].toLowerCase();
          const args = parts.slice(1);
          
          if (commands[command]) {
            const result = commands[command](args);
            if (result !== null) {
              printLine(result);
            }
          } else {
            printLine(`Command not found: ${command}. Type 'help' for available commands.`, 'error');
          }
          
          input.value = '';
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (historyIndex < history.length - 1) {
            historyIndex++;
            input.value = history[historyIndex];
          }
        } else if (e.key === 'ArrowDown') {
          e.preventDefault();
          if (historyIndex > 0) {
            historyIndex--;
            input.value = history[historyIndex];
          } else {
            historyIndex = -1;
            input.value = '';
          }
        }
      });
      
      // Focus input when clicking terminal
      document.getElementById('terminal-app')?.addEventListener('click', () => input.focus());
      input.focus();
    };
  </script>
  
  <script>
    // Agent Squad Initialization
    window.initAgentSquad = async function() {
      const container = document.getElementById('agent-squad-app');
      if (!container || !window.agentSquad) return;

      await window.agentSquad.initialize();
      
      // Create default squad if none exists
      let squads = window.agentSquad.getAllSquads();
      if (squads.length === 0) {
        const defaultSquad = await window.agentSquad.createSquad({
          name: 'Code Ninjas',
          agents: ['orchestrator', 'code-agent', 'art-agent', 'analyst'],
          autoAssign: true
        });
        
        // Create terminals for each agent
        for (const agentId of defaultSquad.agents) {
          await window.agentSquad.assignAgentToSquad(defaultSquad.id, agentId);
        }
      }

      // Get first squad
      squads = window.agentSquad.getAllSquads();
      const activeSquad = squads[0];

      // Initialize REST clients for each agent
      const restClients = {};
      for (const agentId of ['orchestrator', 'code-agent', 'art-agent', 'analyst']) {
        restClients[agentId] = new window.AIRestClient(agentId);
        await restClients[agentId].initialize();
      }
      window.squadRestClients = restClients;

      // Wire up terminal inputs
      const terminalInputs = container.querySelectorAll('.terminal-input');
      terminalInputs.forEach(input => {
        input.addEventListener('keydown', async (e) => {
          if (e.key === 'Enter') {
            const command = input.value.trim();
            if (!command) return;

            const termWindow = input.closest('.terminal-window');
            const agentId = termWindow.dataset.agent;
            const output = termWindow.querySelector('.terminal-output');

            // Find terminal ID for this agent
            let terminalId = null;
            for (const [id, term] of window.agentSquad.terminals) {
              if (term.agentId === agentId) {
                terminalId = id;
                break;
              }
            }

            if (!terminalId) {
              // Create terminal if not exists
              const squad = window.agentSquad.squads.values().next().value;
              if (squad) {
                const term = window.agentSquad.createTerminalForAgent(agentId, squad.id);
                terminalId = term.id;
              }
            }

            if (terminalId) {
              const result = await window.agentSquad.executeCommand(terminalId, command);
              
              // Add command to output
              const cmdLine = document.createElement('div');
              cmdLine.className = 'term-line prompt';
              cmdLine.textContent = '> ' + command;
              output.appendChild(cmdLine);

              if (result.output) {
                const outLine = document.createElement('div');
                outLine.className = 'term-line' + (result.exitCode !== 0 ? ' error' : '');
                outLine.textContent = result.output;
                output.appendChild(outLine);
              }

              // Add new prompt
              const promptLine = document.createElement('div');
              promptLine.className = 'term-line prompt';
              promptLine.textContent = '> _';
              output.appendChild(promptLine);

              output.scrollTop = output.scrollHeight;
            }

            input.value = '';
          }
        });
      });

      // Wire up REST client using AIRestClient
      const restSendBtn = container.querySelector('#rest-send');
      const restMethodSelect = container.querySelector('#rest-method');
      const restUrlInput = container.querySelector('#rest-url');
      const responseBody = container.querySelector('#response-body');
      const responseMeta = container.querySelector('#response-meta');
      
      // Use the orchestrator's REST client as main client
      const mainRestClient = restClients['orchestrator'];

      if (restSendBtn && mainRestClient) {
        restSendBtn.addEventListener('click', async () => {
          const method = restMethodSelect.value;
          const url = restUrlInput.value.trim();
          
          if (!url) {
            responseBody.textContent = 'Please enter a URL';
            return;
          }

          responseBody.textContent = 'Sending request...';
          responseMeta.textContent = '';

          // Collect query params from UI
          const queryParams = [];
          const paramRows = container.querySelectorAll('#rest-params .param-row');
          paramRows.forEach(row => {
            const key = row.querySelector('.param-key')?.value?.trim();
            const value = row.querySelector('.param-value')?.value?.trim();
            if (key) queryParams.push({ key, value, enabled: true });
          });

          // Create temporary request in collection
          let collId = mainRestClient.collections[0]?.id;
          if (!collId) {
            const coll = mainRestClient.createCollection('Quick Requests');
            collId = coll.id;
          }

          const tempRequest = mainRestClient.createRequest(collId, {
            name: `${method} ${url}`,
            method,
            url,
            queryParams
          });

          try {
            const result = await mainRestClient.executeRequest(tempRequest.id);
            
            responseMeta.textContent = `${result.status} ${result.statusText} - ${result.time}ms - ${result.size} bytes`;
            responseMeta.style.color = result.status < 400 ? '#00ff88' : '#ff6b6b';

            if (typeof result.body === 'object') {
              responseBody.textContent = JSON.stringify(result.body, null, 2);
            } else {
              responseBody.textContent = result.body;
            }

            // Show test results if any
            if (result.tests && result.tests.length > 0) {
              const testOutput = result.tests.map(t => `${t.passed ? 'PASS' : 'FAIL'}: ${t.type}`).join('\n');
              responseBody.textContent += '\n\n--- Tests ---\n' + testOutput;
            }
          } catch (error) {
            responseBody.textContent = 'Error: ' + error.message;
            responseMeta.textContent = 'Failed';
            responseMeta.style.color = '#ff6b6b';
          }
        });
      } else if (restSendBtn) {
        // Fallback to basic fetch if REST client not available
        restSendBtn.addEventListener('click', async () => {
          const method = restMethodSelect.value;
          const url = restUrlInput.value.trim();
          
          if (!url) {
            responseBody.textContent = 'Please enter a URL';
            return;
          }

          responseBody.textContent = 'Sending request...';
          responseMeta.textContent = '';

          try {
            const startTime = performance.now();
            const response = await fetch(url, { method });
            const endTime = performance.now();
            
            const status = response.status;
            const statusText = response.statusText;
            const time = Math.round(endTime - startTime);

            responseMeta.textContent = `${status} ${statusText} - ${time}ms`;
            responseMeta.style.color = status < 400 ? '#00ff88' : '#ff6b6b';

            const text = await response.text();
            try {
              const json = JSON.parse(text);
              responseBody.textContent = JSON.stringify(json, null, 2);
            } catch {
              responseBody.textContent = text;
            }
          } catch (error) {
            responseBody.textContent = 'Error: ' + error.message;
            responseMeta.textContent = 'Failed';
            responseMeta.style.color = '#ff6b6b';
          }
        });
      }

      // Wire up REST tabs
      const restTabs = container.querySelectorAll('.rest-tab');
      restTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          restTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
        });
      });

      // Wire up toolbar tabs
      const toolbarTabs = container.querySelectorAll('.toolbar-tab');
      toolbarTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          toolbarTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
        });
      });

      // Wire up agent selection
      const agentItems = container.querySelectorAll('.agent-item');
      agentItems.forEach(item => {
        item.addEventListener('click', () => {
          agentItems.forEach(i => i.classList.remove('selected'));
          item.classList.add('selected');
        });
      });

      // Wire up add parameter button
      const addParamBtn = container.querySelector('.add-param-btn');
      const paramsPanel = container.querySelector('#rest-params');
      if (addParamBtn && paramsPanel) {
        addParamBtn.addEventListener('click', () => {
          const row = document.createElement('div');
          row.className = 'param-row';
          row.innerHTML = `
            <input type="text" placeholder="Key" class="param-key">
            <input type="text" placeholder="Value" class="param-value">
            <button class="param-remove"></button>
          `;
          paramsPanel.insertBefore(row, addParamBtn);
          
          row.querySelector('.param-remove').addEventListener('click', () => {
            row.remove();
          });
        });
      }

      // Wire up clear terminal buttons
      const clearBtns = container.querySelectorAll('.term-btn');
      clearBtns.forEach(btn => {
        if (btn.textContent === 'Clear') {
          btn.addEventListener('click', () => {
            const output = btn.closest('.terminal-window').querySelector('.terminal-output');
            output.innerHTML = '<div class="term-line prompt">> _</div>';
          });
        }
      });

      console.log('[AgentSquad] UI initialized');
    };
  </script>
  
  <script>
    // ZeroTier VPN Manager Initialization
    window.initZeroTier = function() {
      const container = document.querySelector('.zerotier-content');
      if (!container) return;
      
      // ZeroTier state storage
      let ztState = {
        networks: [],
        connectedNetwork: null,
        peers: [],
        activeServers: []
      };
      
      // Load state from Puter KV if available
      async function loadZTState() {
        if (typeof puter !== 'undefined' && puter.kv) {
          try {
            const saved = await puter.kv.get('zerotier_state');
            if (saved) {
              ztState = { ...ztState, ...JSON.parse(saved) };
              renderNetworks();
              renderPeers();
              renderServers();
            }
          } catch (e) {
            console.log('[ZeroTier] Using local state');
          }
        }
      }
      
      async function saveZTState() {
        if (typeof puter !== 'undefined' && puter.kv) {
          try {
            await puter.kv.set('zerotier_state', JSON.stringify(ztState));
          } catch (e) {
            console.log('[ZeroTier] Could not persist state');
          }
        }
      }
      
      // Tab switching
      const tabs = container.querySelectorAll('.zt-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => {
            t.style.background = 'rgba(139,92,246,0.1)';
            t.style.borderColor = 'rgba(139,92,246,0.2)';
            t.style.color = '#9090b0';
            t.classList.remove('active');
          });
          tab.style.background = 'rgba(255,185,0,0.2)';
          tab.style.borderColor = 'rgba(255,185,0,0.4)';
          tab.style.color = '#ffb900';
          tab.classList.add('active');
          
          const panels = container.querySelectorAll('.zt-tab-content');
          panels.forEach(p => p.style.display = 'none');
          
          const targetPanel = container.querySelector('#' + tab.dataset.tab + '-panel');
          if (targetPanel) targetPanel.style.display = 'block';
        });
      });
      
      // Join network function
      window.joinZeroTierNetwork = function() {
        const networkIdInput = container.querySelector('#zt-network-id');
        const networkId = networkIdInput?.value?.trim();
        
        if (!networkId || networkId.length !== 16) {
          showZTNotification('Please enter a valid 16-character Network ID', 'error');
          return;
        }
        
        // Validate hex format
        if (!/^[0-9a-fA-F]{16}$/.test(networkId)) {
          showZTNotification('Network ID must be 16 hexadecimal characters', 'error');
          return;
        }
        
        ztState.connectedNetwork = {
          id: networkId,
          name: 'Network ' + networkId.substring(0, 8),
          status: 'pending',
          joinedAt: new Date().toISOString()
        };
        
        // Simulate connection process
        updateZTStatus('Connecting...', '#ffb900');
        
        setTimeout(() => {
          ztState.connectedNetwork.status = 'connected';
          ztState.connectedNetwork.virtualIP = '10.147.17.' + Math.floor(Math.random() * 200 + 10);
          updateZTStatus('Connected', '#00ff88');
          showZTNotification('Successfully joined network! Virtual IP: ' + ztState.connectedNetwork.virtualIP, 'success');
          
          // Add some simulated peers
          ztState.peers = [
            { name: 'Host Server', ip: '10.147.17.1', status: 'online', latency: Math.floor(Math.random() * 50 + 5) + 'ms' },
            { name: 'Player-' + Math.floor(Math.random() * 999), ip: '10.147.17.' + Math.floor(Math.random() * 200 + 10), status: 'online', latency: Math.floor(Math.random() * 100 + 10) + 'ms' }
          ];
          
          renderPeers();
          saveZTState();
        }, 2000);
        
        networkIdInput.value = '';
        saveZTState();
      };
      
      // Leave network function
      window.leaveZeroTierNetwork = function() {
        if (!ztState.connectedNetwork) {
          showZTNotification('Not connected to any network', 'error');
          return;
        }
        
        ztState.connectedNetwork = null;
        ztState.peers = [];
        updateZTStatus('Service Ready', '#00ff88');
        renderPeers();
        showZTNotification('Left the network', 'success');
        saveZTState();
      };
      
      // Create network function
      window.createZeroTierNetwork = function() {
        const nameInput = container.querySelector('#zt-create-name');
        const typeSelect = container.querySelector('#zt-create-type');
        const rangeSelect = container.querySelector('#zt-create-range');
        
        const name = nameInput?.value?.trim() || 'My Network';
        const type = typeSelect?.value || 'private';
        const range = rangeSelect?.value || '10.147.17.0/24';
        
        // Generate a fake network ID
        const networkId = Array.from({ length: 16 }, () => 
          '0123456789abcdef'.charAt(Math.floor(Math.random() * 16))
        ).join('');
        
        const network = {
          id: networkId,
          name: name,
          type: type,
          ipRange: range,
          createdAt: new Date().toISOString(),
          members: 1
        };
        
        ztState.networks.push(network);
        renderNetworks();
        saveZTState();
        
        nameInput.value = '';
        showZTNotification('Network created! ID: ' + networkId, 'success');
      };
      
      // Host game server
      window.hostGameServer = function(serverType) {
        if (!ztState.connectedNetwork) {
          showZTNotification('Please join a ZeroTier network first', 'error');
          return;
        }
        
        const serverNames = {
          minecraft: 'Minecraft Server',
          terraria: 'Terraria Server',
          valheim: 'Valheim Server',
          custom: 'Custom Server'
        };
        
        const server = {
          id: 'srv-' + Date.now(),
          type: serverType,
          name: serverNames[serverType] || 'Game Server',
          status: 'starting',
          port: 25565 + ztState.activeServers.length,
          createdAt: new Date().toISOString()
        };
        
        ztState.activeServers.push(server);
        renderServers();
        
        setTimeout(() => {
          server.status = 'running';
          renderServers();
          showZTNotification(server.name + ' is now running on port ' + server.port, 'success');
          saveZTState();
        }, 3000);
      };
      
      // Refresh status
      window.refreshZeroTierStatus = function() {
        updateZTStatus('Checking...', '#ffb900');
        setTimeout(() => {
          if (ztState.connectedNetwork) {
            updateZTStatus('Connected', '#00ff88');
          } else {
            updateZTStatus('Service Ready', '#00ff88');
          }
          showZTNotification('Status refreshed', 'success');
        }, 1000);
      };
      
      // Render functions
      function renderNetworks() {
        const container = document.querySelector('#zt-created-networks');
        if (!container) return;
        
        if (ztState.networks.length === 0) {
          container.innerHTML = `
            <h4 style="color:#c0c0e0;margin-bottom:12px;">Your Networks</h4>
            <div style="color:#606080;font-size:14px;padding:20px;text-align:center;background:rgba(20,20,40,0.5);border-radius:8px;">No networks created yet. Create one above to get started.</div>
          `;
          return;
        }
        
        container.innerHTML = `
          <h4 style="color:#c0c0e0;margin-bottom:12px;">Your Networks (${ztState.networks.length})</h4>
          ${ztState.networks.map(net => `
            <div style="background:rgba(20,20,40,0.8);border:1px solid rgba(139,92,246,0.3);border-radius:8px;padding:16px;margin-bottom:12px;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-weight:600;color:#fff;">${net.name}</div>
                  <div style="font-size:12px;color:#9090b0;font-family:monospace;margin-top:4px;">${net.id}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:12px;color:${net.type === 'private' ? '#8b5cf6' : '#00ff88'};">${net.type}</div>
                  <div style="font-size:11px;color:#7070a0;margin-top:4px;">${net.ipRange}</div>
                </div>
              </div>
              <div style="display:flex;gap:8px;margin-top:12px;">
                <button onclick="navigator.clipboard.writeText('${net.id}')" style="padding:6px 12px;background:rgba(0,245,255,0.1);border:1px solid rgba(0,245,255,0.3);border-radius:4px;color:#00f5ff;cursor:pointer;font-size:12px;">Copy ID</button>
                <button onclick="deleteZTNetwork('${net.id}')" style="padding:6px 12px;background:rgba(255,0,110,0.1);border:1px solid rgba(255,0,110,0.3);border-radius:4px;color:#ff006e;cursor:pointer;font-size:12px;">Delete</button>
              </div>
            </div>
          `).join('')}
        `;
      }
      
      function renderPeers() {
        const container = document.querySelector('#zt-peers-list');
        if (!container) return;
        
        if (ztState.peers.length === 0) {
          container.innerHTML = `<div style="color:#606080;font-size:14px;padding:40px;text-align:center;background:rgba(20,20,40,0.5);border-radius:8px;">Not connected to any network. Join a network in the Connect tab to see peers.</div>`;
          return;
        }
        
        container.innerHTML = ztState.peers.map(peer => `
          <div style="background:rgba(20,20,40,0.8);border:1px solid rgba(0,255,136,0.3);border-radius:8px;padding:16px;display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:40px;height:40px;background:linear-gradient(135deg,#00ff88,#00f5ff);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                <img src="/grudgeos/assets/icons/generated/user-avatar.png" style="width:24px;height:24px;filter:brightness(0);">
              </div>
              <div>
                <div style="font-weight:500;color:#fff;">${peer.name}</div>
                <div style="font-size:12px;color:#00f5ff;font-family:monospace;">${peer.ip}</div>
              </div>
            </div>
            <div style="text-align:right;">
              <div style="font-size:12px;color:${peer.status === 'online' ? '#00ff88' : '#ff006e'};">${peer.status}</div>
              <div style="font-size:11px;color:#7070a0;margin-top:2px;">${peer.latency}</div>
            </div>
          </div>
        `).join('');
      }
      
      function renderServers() {
        const container = document.querySelector('#zt-active-servers');
        if (!container) return;
        
        if (ztState.activeServers.length === 0) {
          container.innerHTML = `
            <h4 style="color:#c0c0e0;margin-bottom:12px;">Active Game Servers</h4>
            <div style="color:#606080;font-size:14px;padding:20px;text-align:center;background:rgba(20,20,40,0.5);border-radius:8px;">No game servers running. Select a template above to get started.</div>
          `;
          return;
        }
        
        container.innerHTML = `
          <h4 style="color:#c0c0e0;margin-bottom:12px;">Active Game Servers (${ztState.activeServers.length})</h4>
          ${ztState.activeServers.map(srv => `
            <div style="background:rgba(20,20,40,0.8);border:1px solid rgba(255,0,110,0.3);border-radius:8px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
              <div>
                <div style="font-weight:600;color:#fff;">${srv.name}</div>
                <div style="font-size:12px;color:#9090b0;">Port: ${srv.port}</div>
              </div>
              <div style="display:flex;align-items:center;gap:12px;">
                <span style="padding:4px 12px;background:${srv.status === 'running' ? 'rgba(0,255,136,0.2)' : 'rgba(255,185,0,0.2)'};border-radius:12px;font-size:12px;color:${srv.status === 'running' ? '#00ff88' : '#ffb900'};">${srv.status}</span>
                <button onclick="stopGameServer('${srv.id}')" style="padding:6px 12px;background:rgba(255,0,110,0.1);border:1px solid rgba(255,0,110,0.3);border-radius:4px;color:#ff006e;cursor:pointer;font-size:12px;">Stop</button>
              </div>
            </div>
          `).join('')}
        `;
      }
      
      window.deleteZTNetwork = function(networkId) {
        ztState.networks = ztState.networks.filter(n => n.id !== networkId);
        renderNetworks();
        saveZTState();
        showZTNotification('Network deleted', 'success');
      };
      
      window.stopGameServer = function(serverId) {
        ztState.activeServers = ztState.activeServers.filter(s => s.id !== serverId);
        renderServers();
        saveZTState();
        showZTNotification('Server stopped', 'success');
      };
      
      function updateZTStatus(text, color) {
        const status = container.querySelector('#zt-status');
        if (status) {
          status.innerHTML = `
            <span style="width:8px;height:8px;background:${color};border-radius:50%;animation:pulse 2s infinite;"></span>
            <span style="color:${color};font-size:13px;">${text}</span>
          `;
          status.style.borderColor = color + '4d';
          status.style.background = color + '1a';
        }
      }
      
      function showZTNotification(message, type) {
        if (typeof showNotification === 'function') {
          showNotification(message, type === 'error' ? 'error' : 'success');
        } else {
          console.log('[ZeroTier] ' + message);
        }
      }
      
      // Initialize - render defaults first, then load persisted state
      renderNetworks();
      renderPeers();
      renderServers();
      loadZTState();
      console.log('[ZeroTier] VPN Manager initialized');
    };
  </script>
</body>
</html>
